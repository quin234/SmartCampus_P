<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>{{ college.name }} - SmartCampus</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/admin/admin.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Section visibility */
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .sidebar-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-color);
            cursor: pointer;
            padding: 8px;
        }
        @media (max-width: 768px) {
            .sidebar-toggle {
                display: block;
            }
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                width: 100%;
            }
        }
        /* Horizontal Top Navigation Bar */
        .top-nav-menu {
            position: fixed;
            top: 70px;
            left: 260px;
            right: 0;
            height: 50px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 999;
            display: flex;
            align-items: center;
            padding: 0 24px;
            overflow-x: auto;
            white-space: nowrap;
        }
        .top-nav-menu::-webkit-scrollbar {
            height: 4px;
        }
        .top-nav-menu::-webkit-scrollbar-track {
            background: transparent;
        }
        .top-nav-menu::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }
        .top-nav-menu-list {
            display: flex;
            align-items: center;
            gap: 8px;
            list-style: none;
            margin: 0;
            padding: 0;
            width: 100%;
        }
        .top-nav-menu-item {
            margin: 0;
        }
        .top-nav-menu-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            color: var(--text-light);
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }
        .top-nav-menu-link:hover {
            background: var(--light-color);
            color: var(--primary-color);
        }
        .top-nav-menu-link.active {
            background: var(--primary-color);
            color: white;
        }
        .top-nav-menu-link i {
            font-size: 16px;
        }
        @media (max-width: 768px) {
            .top-nav-menu {
                padding: 0 16px;
            }
            .top-nav-menu-link {
                padding: 8px 12px;
                font-size: 13px;
            }
        }
        /* Adjust sidebar and main-content for new top menu bar */
        .sidebar {
            top: 70px !important;
            height: calc(100vh - 70px) !important;
        }
        .main-content {
            margin-top: 120px !important;
        }
        @media (max-width: 768px) {
            .sidebar {
                top: 70px !important;
                height: calc(100vh - 70px) !important;
            }
            .main-content {
                margin-top: 70px !important;
            }
            .top-nav-menu {
                top: 70px;
                left: 0;
            }
        }
        /* Page header with button */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-color, #1f2937);
            margin: 0;
            line-height: 1.2;
            flex: 1;
            min-width: 0;
        }
        
        .page-subtitle {
            font-size: 14px;
            color: var(--text-light, #6b7280);
            margin: 0;
            line-height: 1.4;
            display: block;
        }
        
        /* Special handling for dashboard header: title and subtitle should stack together on desktop */
        .page-header .page-title + .page-subtitle {
            flex-basis: 100%;
            order: 2;
            margin-top: 6px;
            width: 100%;
        }
        
        .page-header .page-title:not(:only-child):not(:last-child) {
            flex-basis: 100%;
            width: 100%;
        }
        
        /* When there's a button, adjust layout */
        .page-header .btn {
            order: 3;
            flex-shrink: 0;
            align-self: flex-start;
        }
        
        /* Mobile Responsive Page Header */
        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                margin-bottom: 24px;
                gap: 8px;
            }
            
            .page-title {
                font-size: 24px;
                width: 100%;
                flex-basis: auto;
                order: 1;
            }
            
            .page-subtitle {
                font-size: 13px;
                width: 100%;
                margin-top: 4px;
                flex-basis: auto;
                order: 2;
            }
            
            .page-header .btn {
                order: 3;
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .page-header {
                margin-bottom: 20px;
                gap: 6px;
            }
            
            .page-title {
                font-size: 20px;
            }
            
            .page-subtitle {
                font-size: 12px;
                line-height: 1.5;
                margin-top: 2px;
            }
        }
        /* Search box */
        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }
        .search-box i {
            position: absolute;
            left: 12px;
            color: var(--text-light);
        }
        .search-box input {
            padding-left: 40px;
        }
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-top: 24px;
            padding: 16px;
        }
        .btn-pagination {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-pagination:hover:not(:disabled) {
            background: var(--bg-hover);
            border-color: var(--primary-color);
        }
        .btn-pagination:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .page-info {
            color: var(--text-light);
            font-size: 14px;
        }
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        /* Units Grid Styles */
        .units-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        .unit-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .unit-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
            transform: translateY(-2px);
        }
        .units-search-results {
            min-height: 200px;
        }
        .units-grid-container {
            min-height: 200px;
        }
        .error-row {
            text-align: center;
            padding: 40px 20px;
            color: #dc3545;
        }
        .error-message {
            display: none;
            padding: 20px;
            text-align: center;
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            border-radius: 8px;
            border-left: 4px solid #dc3545;
        }
        .error-message:not(:empty) {
            display: block;
        }
        .form-group .error-message {
            padding: 8px 0;
            text-align: left;
            font-size: 14px;
            margin-top: 4px;
        }
        .loading-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        .loading-state i {
            font-size: 32px;
            color: #007bff;
        }
        .empty-state p {
            font-size: 16px;
            margin: 0;
        }
        /* Loading row */
        .loading-row {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }
        .loading-row i {
            margin-right: 8px;
        }
        /* Action buttons */
        .actions {
            display: flex;
            gap: 8px;
        }
        .btn-icon {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s;
            font-size: 16px;
        }
        .btn-icon.btn-edit:hover {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary-color);
        }
        .btn-icon.btn-delete:hover {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }
        /* Toast container */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 24px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow-lg);
            min-width: 300px;
            animation: slideInRight 0.3s ease;
        }
        .toast.success {
            border-left: 4px solid var(--success-color);
        }
        .toast.error {
            border-left: 4px solid var(--danger-color);
        }
        .toast.info {
            border-left: 4px solid var(--info-color);
        }
        .toast.warning {
            border-left: 4px solid var(--warning-color);
        }
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 32px;
            padding: 4px;
            background: var(--bg-light);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            overflow-x: auto;
            scrollbar-width: thin;
        }
        .tabs::-webkit-scrollbar {
            height: 4px;
        }
        .tabs::-webkit-scrollbar-track {
            background: transparent;
        }
        .tabs::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }
        
        /* Hide scrollbar for export section tabs */
        #export-section .tabs {
            overflow-x: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        #export-section .tabs::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .tab-btn {
            padding: 14px 28px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-light);
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
            position: relative;
            min-width: fit-content;
        }
        .tab-btn i {
            font-size: 16px;
            transition: transform 0.3s ease;
        }
        .tab-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.5);
        }
        .tab-btn:hover i {
            transform: scale(1.1);
        }
        .tab-btn.active {
            color: var(--primary-color);
            background: #ffffff;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        .tab-btn.active::before {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 40%;
            height: 3px;
            background: var(--primary-color);
            border-radius: 2px 2px 0 0;
        }
        .tab-btn.active i {
            color: var(--primary-color);
        }
        
        /* Enhanced styling for inner tabs in College Settings */
        #college-settings-tab-content .tabs {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 6px;
        }
        #college-settings-tab-content .tab-btn {
            padding: 16px 32px;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        #college-settings-tab-content .tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-card-hover);
        }
        #college-settings-tab-content .tab-btn.active {
            background: var(--bg-card-hover);
            box-shadow: var(--shadow);
            color: var(--text-primary);
            font-weight: 600;
        }
        #college-settings-tab-content .tab-btn.active::before {
            width: 50%;
            height: 4px;
            background: var(--primary-light);
        }
        #college-settings-tab-content .tab-btn.active i {
            color: var(--primary-light);
        }
        
        @media (max-width: 768px) {
            .tabs {
                gap: 2px;
                padding: 3px;
            }
            .tab-btn {
                padding: 12px 20px;
                font-size: 14px;
            }
            #college-settings-tab-content .tab-btn {
                padding: 14px 24px;
                font-size: 13px;
            }
        }
        .tab-content {
            display: none;
        }
        .college-settings-tab-content {
            opacity:1;
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .college-settings-tab-content.active {
            /* keep absolute positioning so offsetParent remains the container */
            position: absolute;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto;
            animation: fadeIn 0.18s ease-in-out;
            display: block;
        }
       
        .academic-config-tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .academic-config-tab-content.active {
            display: block;
        }
        /* Make Academic Configuration forms compact and centered */
        .academic-config-tab-content .content-card {
            max-width: 700px;
            margin: 0 auto;
        }
        
        /* Make transcript template section full width */
        #transcript-template-top-content .content-card,
        #transcript-template-tab-content .content-card {
            max-width: 100%;
            margin: 0;
        }
        
        #transcript-template-top-content .card-body,
        #transcript-template-tab-content .card-body {
            padding: 32px;
            width: 100%;
        }
        
        /* Ensure mapping section uses full width */
        #transcript-template-mapping-section {
            width: 100%;
        }
        .academic-config-tab-content .card-body {
            padding: 32px;
        }
        /* Ensure form groups have proper spacing */
        .academic-config-tab-content .form-group {
            margin-bottom: 24px;
        }
        /* Student List Filters - Responsive */
        #student-list-tab-content .form-group {
            min-width: 0; /* Allow grid items to shrink */
        }
        
        .student-list-filters-grid {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1.2fr auto;
            gap: 16px;
            align-items: end;
        }
        
        @media (max-width: 1024px) {
            .student-list-filters-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 12px !important;
            }
            .student-list-filters-grid > button {
                grid-column: 1 / -1;
                justify-self: start;
            }
        }
        
        @media (max-width: 768px) {
            .student-list-filters-grid {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            .student-list-filters-grid > button {
                grid-column: 1;
                width: 100%;
            }
        }
        
        /* Make two-column layouts responsive within the constrained width */
        .academic-config-tab-content .form-group > div[style*="grid-template-columns"] {
            grid-template-columns: 1fr !important;
            gap: 16px !important;
        }
        @media (min-width: 640px) {
            .academic-config-tab-content .form-group > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr 1fr !important;
            }
        }
        /* Responsive adjustments for mobile */
        @media (max-width: 768px) {
            .academic-config-tab-content .content-card {
                max-width: 100%;
                margin: 0;
            }
            .academic-config-tab-content .card-body {
                padding: 20px;
            }
        }
        .tab-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        .tab-btn.disabled:hover {
            background: transparent;
            color: var(--text-secondary);
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Enhanced content card styling within tabs */
        .college-settings-tab-content .content-card {
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            transition: box-shadow 0.3s ease;
        }
        .college-settings-tab-content .content-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }
        .college-settings-tab-content .card-header {
            border-bottom: 1px solid var(--border-color);
            padding: 20px 24px;
        }
        .college-settings-tab-content .card-body {
            padding: 24px;
        }
        .tab-content.active {
            display: block;
        }
        /* Export Tab Content */
        .export-tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .export-tab-content.active {
            display: block;
        }
        
        /* Timetable Tab Styles */
        .timetable-tabs {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 6px;
            margin-bottom: 24px;
            border-radius: var(--border-radius);
        }
        .timetable-tabs .tab-btn {
            padding: 16px 32px;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            border-radius: var(--border-radius);
        }
        .timetable-tabs .tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-card-hover);
        }
        .timetable-tabs .tab-btn.active {
            background: var(--bg-card-hover);
            box-shadow: var(--shadow);
            color: var(--text-primary);
            font-weight: 600;
        }
        .timetable-tabs .tab-btn.active i {
            color: var(--primary-light);
        }
        
        .timetable-tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .timetable-tab-content.active {
            display: block;
        }
        
        /* Timetable Forms Container */
        .timetable-forms-container {
            min-height: 200px;
            position: relative;
        }
        .timetable-forms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .timetable-form-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }
        .timetable-form-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--border-light);
            background: var(--bg-card-hover);
        }
        .timetable-form-field {
            margin-bottom: 16px;
        }
        .timetable-form-field:last-child {
            margin-bottom: 0;
        }
        .timetable-form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        .timetable-form-value {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
            word-wrap: break-word;
        }
        .timetable-form-value.empty {
            color: var(--text-disabled);
            font-style: italic;
        }
        .timetable-form-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        .timetable-form-actions .btn-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .timetable-form-actions .btn-icon:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-light);
            transform: translateY(-1px);
        }
        .timetable-form-actions .btn-icon.btn-danger:hover {
            background: rgba(220, 38, 38, 0.1);
            border-color: var(--danger-color);
            color: var(--danger-light);
        }
        .timetable-form-actions .btn-icon.btn-edit:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--primary-light);
            color: var(--primary-light);
        }
        .timetable-form-actions .btn-icon.btn-view:hover {
            background: rgba(5, 150, 105, 0.1);
            border-color: var(--success-light);
            color: var(--success-light);
        }
        
        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        .loading-state i {
            font-size: 32px;
            margin-bottom: 12px;
            color: var(--text-muted);
        }
        
        /* Timetable Filters */
        .timetable-filters {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .timetable-filter {
            min-width: 150px;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background: var(--bg-input);
            font-size: 13px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .timetable-filter:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        
        /* Timetable Card Header */
        #timetable-section .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-card);
        }
        #timetable-section .card-title {
            display: flex;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        #timetable-section .card-title i {
            color: var(--text-secondary);
        }
        
        /* Badge Styles for Timetable */
        .timetable-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--bg-card-hover);
            color: var(--text-secondary);
        }
        
        @media (max-width: 768px) {
            .timetable-tabs .tab-btn {
                padding: 14px 24px;
                font-size: 14px;
            }
            .timetable-filters {
                flex-direction: column;
                align-items: stretch;
            }
            .timetable-filter {
                width: 100%;
            }
            #timetable-section .card-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .timetable-forms-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Settings display */
        .settings-display {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        .setting-item {
            display: flex;
            padding: 12px;
            background: var(--bg-hover);
            border-radius: 8px;
        }
        .setting-item label {
            font-weight: 600;
            min-width: 150px;
            color: var(--text-light);
        }
        .setting-item span {
            color: var(--text-color);
        }
        
        /* Professional File Upload Component */
        .file-upload-container {
            margin-top: 8px;
        }
        .file-input-hidden {
            display: none;
        }
        .file-upload-area {
            position: relative;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        .file-upload-area:hover {
            border-color: #475569;
            background: linear-gradient(135deg, #cbd5e1 0%, #e2e8f0 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(71, 85, 105, 0.15);
        }
        .file-upload-area.drag-over {
            border-color: #64748b;
            background: linear-gradient(135deg, #94a3b8 0%, #cbd5e1 100%);
            border-style: solid;
            box-shadow: 0 8px 24px rgba(71, 85, 105, 0.25);
        }
        .file-upload-area.has-preview {
            padding: 20px;
        }
        .file-upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        .file-upload-icon {
            font-size: 48px;
            color: #475569;
            margin-bottom: 8px;
            transition: transform 0.3s ease;
        }
        .file-upload-area:hover .file-upload-icon {
            transform: scale(1.1) translateY(-4px);
        }
        .file-upload-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .file-upload-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }
        .file-upload-subtitle {
            font-size: 14px;
            color: #64748b;
            margin: 0;
        }
        .file-upload-formats {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 8px;
        }
        .format-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #e0e7ff;
            color: #4f46e5;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }
        .file-upload-size {
            font-size: 12px;
            color: #94a3b8;
            margin: 8px 0 0 0;
        }
        .file-upload-preview {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .preview-image-wrapper {
            position: relative;
            width: 100%;
            max-height: 400px;
            border-radius: 8px;
            overflow: hidden;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
        }
        .preview-image-wrapper img {
            width: 100%;
            height: auto;
            max-height: 400px;
            object-fit: contain;
            display: block;
        }
        .preview-remove-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .preview-remove-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }
        .preview-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .preview-filename {
            font-size: 14px;
            font-weight: 500;
            color: #1e293b;
            margin: 0;
            flex: 1;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .preview-filesize {
            font-size: 12px;
            color: #64748b;
            margin: 0;
        }
        .file-upload-error {
            margin-top: 12px;
            padding: 12px 16px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            color: #dc2626;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .file-upload-error i {
            font-size: 16px;
        }
        
        /* Nominal Roll Sign-In List Professional Styling */
        #nominal-roll-list-modal .modal-body {
            background: var(--bg-card);
            padding: 20px;
        }
        #nominal-roll-list-modal .form-label {
            color: var(--text-primary) !important;
        }
        #nominal-roll-list-modal .form-label i {
            color: var(--text-secondary) !important;
        }
        #nominal-roll-list-modal .form-select {
            color: var(--text-primary) !important;
        }
        #nominal-roll-list-modal .modal-title {
            color: var(--text-primary) !important;
        }
        
        /* Result Modal - Centered and Properly Sized */
        #result-modal .modal-content {
            max-width: 600px;
            width: 90%;
            margin: 0 auto;
            position: relative;
            top: 50%;
            transform: translateY(-50%);
        }
        
        @media (max-width: 768px) {
            #result-modal .modal-content {
                max-width: 95%;
                width: 95%;
                margin: 20px auto;
                top: 20px;
                transform: none;
            }
        }
        
        /* Report Editor Modal - 90% screen size */
        #report-editor-modal .modal-content {
            width: 90vw;
            height: 90vh;
            max-width: none;
            max-height: none;
            margin: 5vh auto;
            position: relative;
            top: 0;
            transform: none;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        
        #report-editor-modal .modal-body {
            flex: 1;
            overflow: hidden;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        #report-editor-modal .report-editor-container {
            flex: 1;
            overflow: hidden;
            height: 100%;
        }
        
        @media (max-width: 768px) {
            #report-editor-modal .modal-content {
                width: 95vw;
                height: 95vh;
                margin: 2.5vh auto;
            }
        }
        
        /* Mobile Message for Report Editor */
        .report-editor-mobile-message {
            display: none;
            text-align: center;
            padding: 60px 20px;
            background: var(--bg-white);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .report-editor-mobile-message i {
            font-size: 64px;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .report-editor-mobile-message h2 {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0 0 12px 0;
        }
        
        .report-editor-mobile-message p {
            font-size: 16px;
            color: var(--text-light);
            margin: 0;
        }
        
        @media (max-width: 1024px) {
            /* Hide report editor on tablets and mobile */
            #report-section .report-editor-container {
                display: none !important;
            }
            
            /* Show mobile message */
            .report-editor-mobile-message {
                display: block;
            }
            
            /* Hide modal report editor on mobile */
            #report-editor-modal .report-editor-container {
                display: none !important;
            }
            
            /* Show mobile message in modal */
            #report-editor-modal .report-editor-mobile-message {
                display: block;
            }
        }
        
        /* Print styles for report editor - ensure table borders and colors are preserved */
        @media print {
            /* Hide grid overlay in print */
            .canvas-grid-overlay,
            [data-print-ignore="true"],
            #canvas-guides,
            #modal-canvas-guides {
                display: none !important;
            }
            
            /* Ensure table borders are always visible in print */
            .report-element table,
            .report-element table th,
            .report-element table td {
                border: 1px solid #000000 !important;
                border-collapse: collapse !important;
            }
            
            /* Preserve background and text colors in print */
            .report-element {
                background: #ffffff !important;
                color: #000000 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .report-element table {
                background: #ffffff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .report-element table th,
            .report-element table td {
                background: #ffffff !important;
                color: #000000 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        
        /* Ensure grid overlay doesn't interfere with content */
        .canvas-grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        /* Ensure report elements are above grid */
        .report-element {
            position: relative;
            z-index: 10;
        }
        
        .nominal-roll-header-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            align-items: center;
            flex-wrap: wrap;
        }
        .nominal-roll-search-wrapper {
            position: relative;
            flex: 1;
            min-width: 300px;
        }
        .nominal-roll-search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 16px;
            pointer-events: none;
        }
        .nominal-roll-search-input {
            width: 100%;
            padding: 10px 14px 10px 40px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 13px;
            background: var(--bg-input);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        .nominal-roll-search-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .nominal-roll-search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-card-hover);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        .nominal-roll-search-clear:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        .nominal-roll-actions {
            display: flex;
            gap: 8px;
        }
        .btn-icon-only {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .nominal-roll-filters {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }
        .nominal-roll-filters-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            user-select: none;
        }
        .nominal-roll-filters-header i,
        .nominal-roll-filters-header span {
            color: var(--text-primary);
        }
        .nominal-roll-filters-header i {
            color: var(--text-secondary);
            font-size: 18px;
        }
        .nominal-roll-filters-header span {
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }
        .nominal-roll-filters-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            transition: transform 0.3s ease;
        }
        .nominal-roll-filters-toggle:hover {
            color: var(--text-primary);
        }
        .nominal-roll-filters-toggle.rotated #nominal-roll-filters-icon {
            transform: rotate(180deg);
        }
        .nominal-roll-filters-content {
            padding: 16px;
            display: block;
            background: var(--bg-card);
        }
        .nominal-roll-filters-content.collapsed {
            display: none;
        }
        .nominal-roll-filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        .nominal-roll-filters-actions {
            display: flex;
            justify-content: flex-end;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            margin-top: 12px;
        }
        .nominal-roll-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .nominal-roll-summary-item {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-left: 3px solid;
            border-radius: var(--border-radius);
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }
        .nominal-roll-summary-item:nth-child(1) {
            border-left-color: var(--primary-light);
            background: var(--bg-card);
        }
        .nominal-roll-summary-item:nth-child(2) {
            border-left-color: var(--success-light);
            background: var(--bg-card);
        }
        .nominal-roll-summary-item:nth-child(3) {
            border-left-color: var(--warning-light);
            background: var(--bg-card);
        }
        .nominal-roll-summary-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            background: var(--bg-card-hover);
        }
        .nominal-roll-summary-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-size: 18px;
            flex-shrink: 0;
            box-shadow: var(--shadow-sm);
            background: var(--bg-card-hover);
        }
        .nominal-roll-summary-content {
            flex: 1;
            min-width: 0;
        }
        .nominal-roll-summary-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 2px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .nominal-roll-summary-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }
        .nominal-roll-table-container {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            position: relative;
        }
        .nominal-roll-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: var(--border-radius);
            transition: opacity 0.3s ease;
        }
        .nominal-roll-loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
            display: none;
        }
        .nominal-roll-spinner-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .nominal-roll-spinner {
            position: relative;
            width: 60px;
            height: 60px;
        }
        .spinner-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: var(--primary-light);
            border-radius: 50%;
            animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        }
        .spinner-ring:nth-child(1) {
            animation-delay: -0.45s;
            border-top-color: var(--primary-light);
        }
        .spinner-ring:nth-child(2) {
            animation-delay: -0.3s;
            border-top-color: var(--primary-color);
            width: 80%;
            height: 80%;
            top: 10%;
            left: 10%;
        }
        .spinner-ring:nth-child(3) {
            animation-delay: -0.15s;
            border-top-color: var(--primary-dark);
            width: 60%;
            height: 60%;
            top: 20%;
            left: 20%;
        }
        .spinner-ring:nth-child(4) {
            border-top-color: var(--primary-lighter);
            width: 40%;
            height: 40%;
            top: 30%;
            left: 30%;
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        .spinner-text {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            margin: 0;
            text-align: center;
        }
        .table-wrapper {
            overflow-x: auto;
        }
        .nominal-roll-table {
            width: 100%;
            border-collapse: collapse;
        }
        .nominal-roll-table thead {
            background: var(--bg-card-hover);
        }
        .nominal-roll-table thead th {
            padding: 12px 14px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--border-color);
        }
        .nominal-roll-table thead th .table-header-content i {
            color: var(--text-secondary);
        }
        .table-header-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .table-header-content i {
            color: var(--text-secondary);
            font-size: 13px;
        }
        .nominal-roll-table tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s ease;
            background: var(--bg-card);
        }
        .nominal-roll-table tbody tr:nth-child(even) {
            background: var(--bg-card-hover);
        }
        .nominal-roll-table tbody tr:hover {
            background: var(--bg-card-hover);
        }
        .nominal-roll-table tbody td {
            padding: 12px 14px;
            color: var(--text-primary);
            font-size: 13px;
        }
        .nominal-roll-table tbody td:first-child {
            font-weight: 600;
            color: var(--text-primary);
        }
        .loading-state-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 60px 20px;
            color: var(--text-primary);
        }
        .loading-state-content i {
            font-size: 24px;
        }
        .nominal-roll-empty-state {
            text-align: center;
            padding: 40px 20px;
            background: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        .empty-state-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            background: var(--bg-card-hover);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            font-size: 28px;
        }
        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }
        .empty-state-message {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0 0 24px 0;
        }
        .nominal-roll-pagination {
            margin-top: 20px;
            padding: 14px 16px;
            background: var(--bg-card);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        .nominal-roll-pagination * {
            color: var(--text-primary) !important;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-badge.signed-in {
            background: rgba(5, 150, 105, 0.2);
            color: var(--success-light);
            border: 1px solid var(--success-color);
        }
        .status-badge.not-signed-in {
            background: rgba(217, 119, 6, 0.2);
            color: var(--warning-light);
            border: 1px solid var(--warning-color);
        }
        .status-badge i {
            font-size: 10px;
        }
        
        /* Filters bar */
        .filters-bar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .form-select {
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-color);
            font-size: 14px;
        }
        /* Grade badges */
        .badge-grade-A { background: #64748b; }
        .badge-grade-B { background: #475569; }
        .badge-grade-C { background: #334155; }
        .badge-grade-D { background: #1e293b; }
        .badge-grade-F { background: #991b1b; }
        .badge-grade-N/A { background: var(--secondary-color); }
        /* Global unit searchable select */
        .global-unit-select-wrapper {
            position: relative;
        }
        .searchable-select {
            position: relative;
        }
        .searchable-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1e293b;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 4px;
        }
        .searchable-select-dropdown .search-result-item {
            padding: 5px;
            
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        .searchable-select-dropdown .search-result-item:hover {
            background: grey;
        }
        .searchable-select-dropdown .search-result-item:last-child {
            border-bottom: none;
        }
        .searchable-select-dropdown .no-results {
            padding: 20px;
            text-align: center;
        }
        #selected-global-unit {
            clear: both;
        }
        /* Fix input field visibility for global course and unit search */
        #course-global-course-search,
        #unit-global-unit-search {
            background-color: #1e293b !important;
            color: #f8fafc !important;
            border: 2px solid var(--border-color, #475569) !important;
        }
        #course-global-course-search:focus,
        #unit-global-unit-search:focus {
            background-color: #1e293b !important;
            color: #f8fafc !important;
            border-color: var(--primary-color, #3b82f6) !important;
        }
        #course-global-course-search::placeholder,
        #unit-global-unit-search::placeholder {
            color: #94a3b8 !important;
        }
        /* Badge styles */
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: 500;
        }
        .badge-info {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        /* Header Redesign - Better Organization for Bell Icon and Staff/Profile */
        .navbar-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .navbar-actions-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Notification Button - Compact Design */
        .notifications {
            position: relative;
        }
        
        .notification-btn {
            position: relative;
            background: none;
            border: none;
            font-size: 18px;
            color: var(--text-light, #6b7280);
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }
        
        .notification-btn:hover {
            background: var(--light-color, rgba(59, 130, 246, 0.1));
            color: var(--primary-color, #3b82f6);
        }
        
        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--danger-color, #ef4444);
            color: white;
            font-size: 9px;
            font-weight: 600;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 16px;
            height: 16px;
            text-align: center;
            display: none;
            line-height: 12px;
        }
        
        .notification-badge.show,
        .notification-badge:not(:empty) {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Profile Dropdown - Compact Design */
        .profile-dropdown {
            position: relative;
        }
        
        .profile-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .profile-btn:hover {
            background: var(--light-color, rgba(59, 130, 246, 0.1));
        }
        
        .profile-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-color, #3b82f6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .profile-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
            min-width: 0;
            flex: 1;
        }
        
        .profile-name {
            font-weight: 500;
            color: var(--text-color, #1f2937);
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }
        
        .profile-role {
            font-weight: 400;
            color: var(--text-light, #6b7280);
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }
        
        .profile-chevron {
            font-size: 10px;
            color: var(--text-light, #6b7280);
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }
        
        .profile-dropdown.active .profile-chevron {
            transform: rotate(180deg);
        }
        
        /* Notification Menu - Responsive */
        .notification-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 320px;
            max-width: calc(100vw - 32px);
            background: var(--bg-card, #1e1e1e);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1001;
            overflow: hidden;
            border: 1px solid var(--border-color, #3a3a3a);
        }
        
        .notification-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color, #3a3a3a);
            background: var(--bg-card-hover, #2a2a2a);
        }
        
        .notification-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color, #ffffff);
        }
        
        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color, #3a3a3a);
            cursor: pointer;
            transition: background 0.2s;
            background: var(--bg-card, #1e1e1e);
        }
        
        .notification-item:hover {
            background: var(--bg-card-hover, #2a2a2a);
        }
        
        .notification-item:last-child {
            border-bottom: none;
        }
        
        .notification-item.priority-urgent {
            border-left: 3px solid #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .notification-item.priority-high {
            border-left: 3px solid #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        
        .notification-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border-color, #3a3a3a);
            background: var(--bg-card-hover, #2a2a2a);
            text-align: center;
        }
        
        .notification-footer a {
            color: var(--primary-color, #3b82f6);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }
        
        .notification-footer a:hover {
            text-decoration: underline;
        }
        
        .no-notifications {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-light, #b0b0b0);
            font-size: 14px;
        }
        
        .notification-menu.active {
            display: block;
        }
        
        /* Profile Menu - Responsive */
        .profile-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 200px;
            min-width: 180px;
            background: var(--bg-card, white);
            border: 1px solid var(--border-color, #e5e7eb);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1001;
            overflow: hidden;
        }
        
        .profile-menu.active {
            display: block;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .navbar-content {
                padding: 0 12px;
            }
            
            .navbar-right {
                gap: 4px;
            }
            
            .navbar-actions-group {
                gap: 4px;
            }
            
            /* Smaller notification button on mobile */
            .notification-btn {
                width: 36px;
                height: 36px;
                padding: 4px;
                font-size: 16px;
            }
            
            .notification-badge {
                font-size: 8px;
                min-width: 14px;
                height: 14px;
                top: 1px;
                right: 1px;
                padding: 1px 4px;
            }
            
            /* Compact profile button on mobile */
            .profile-btn {
                padding: 4px 6px;
                gap: 6px;
            }
            
            .profile-avatar {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .profile-name {
                font-size: 12px;
                max-width: 80px;
            }
            
            .profile-role {
                font-size: 10px;
                max-width: 80px;
            }
            
            .profile-chevron {
                font-size: 9px;
            }
            
            /* Adjust notification menu for mobile */
            .notification-menu {
                width: calc(100vw - 24px);
                right: -12px;
                max-height: calc(100vh - 100px);
            }
            
            .notification-item {
                padding: 14px 12px;
            }
            
            .notification-item > div {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            .notification-header {
                padding: 12px;
            }
            
            .notification-header h3 {
                font-size: 14px;
            }
            
            .notification-footer {
                padding: 10px 12px;
            }
            
            .notification-footer a {
                font-size: 13px;
            }
            
            /* Adjust profile menu for mobile */
            .profile-menu {
                width: 180px;
                right: 0;
            }
            
            /* Hide profile name on very small screens */
            @media (max-width: 480px) {
                .profile-name {
                    display: none;
                }
                
                .profile-btn {
                    padding: 4px;
                }
            }
        }
        
        @media (max-width: 480px) {
            .notification-menu {
                width: calc(100vw - 16px);
                right: -8px;
            }
            
            .notification-item {
                padding: 12px 10px;
            }
            
            .notification-item > div:first-child {
                font-size: 13px !important;
            }
            
            .notification-item > div:nth-child(2) {
                font-size: 11px !important;
                line-height: 1.4 !important;
            }
            
            .notification-item > div:last-child {
                font-size: 10px !important;
            }
            
            .college-brand span {
                font-size: 16px;
            }
            
            .college-brand i {
                font-size: 20px;
            }
        }
        
        /* Dashboard Cards - Professional Mobile Design */
        .overview-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .overview-card {
            background: var(--bg-card, #ffffff);
            border: 1px solid var(--border-color, #e5e7eb);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
        }
        
        .overview-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color, #3b82f6);
        }
        
        .card-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            flex-shrink: 0;
        }
        
        .card-icon.students {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .card-icon.departments {
            background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);
        }
        
        .card-icon.courses {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .card-icon.lecturers {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }
        
        .card-content {
            flex: 1;
            min-width: 0;
        }
        
        .card-label {
            font-size: 13px;
            color: var(--text-light, #6b7280);
            margin-bottom: 6px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .card-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-color, #1f2937);
            margin-bottom: 4px;
            line-height: 1.2;
        }
        
        .card-change {
            font-size: 12px;
            color: var(--text-light, #6b7280);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Mobile Responsive - Compact Professional Cards */
        @media (max-width: 768px) {
            .overview-cards {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                margin-bottom: 20px;
            }
            
            .overview-card {
                padding: 16px;
                gap: 12px;
                flex-direction: row;
                align-items: center;
            }
            
            .card-icon {
                width: 48px;
                height: 48px;
                font-size: 20px;
                border-radius: 10px;
            }
            
            .card-label {
                font-size: 11px;
                margin-bottom: 4px;
            }
            
            .card-value {
                font-size: 20px;
                margin-bottom: 2px;
            }
            
            .card-change {
                font-size: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .overview-cards {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .overview-card {
                padding: 14px;
                gap: 14px;
            }
            
            .card-icon {
                width: 44px;
                height: 44px;
                font-size: 18px;
                border-radius: 8px;
            }
            
            .card-label {
                font-size: 10px;
                margin-bottom: 4px;
            }
            
            .card-value {
                font-size: 22px;
            }
            
            .card-change {
                font-size: 11px;
            }
        }
        
        /* Content Cards - Professional Mobile Design */
        .content-card {
            background: var(--bg-card, #ffffff);
            border: 1px solid var(--border-color, #e5e7eb);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            overflow: hidden;
        }
        
        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color, #e5e7eb);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-hover, #f9fafb);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color, #1f2937);
            margin: 0;
        }
        
        .card-body {
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            .content-card {
                margin-bottom: 16px;
                border-radius: 10px;
            }
            
            .card-header {
                padding: 12px 16px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .card-title {
                font-size: 16px;
            }
            
            .card-body {
                padding: 16px;
            }
        }
        
        @media (max-width: 480px) {
            .content-card {
                margin-bottom: 12px;
                border-radius: 8px;
            }
            
            .card-header {
                padding: 10px 12px;
            }
            
            .card-title {
                font-size: 15px;
            }
            
            .card-body {
                padding: 12px;
            }
        }
        
        /* Students Section - Mobile Responsive Design */
        .search-box {
            position: relative;
            flex: 1;
            min-width: 250px;
        }
        
        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light, #6b7280);
            z-index: 1;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 12px 10px 40px;
            border: 2px solid var(--border-color, #e5e7eb);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-secondary, #f9fafb);
            color: var(--text-color, #1f2937);
            transition: all 0.3s ease;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color, #3b82f6);
            background: var(--bg-secondary, #1e293b);
            color: var(--text-color, #f8fafc);
        }
        
        /* Retake row highlighting */
        .retake-row {
            background-color: rgba(239, 68, 68, 0.1) !important;
        }
        
        .retake-row:hover {
            background-color: rgba(239, 68, 68, 0.15) !important;
        }
        
        .retake-row td {
            border-left: 3px solid #ef4444;
        }
        
        /* Unit card styles */
        .unit-card {
            transition: all 0.3s ease;
        }
        
        .unit-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* Marks input styles */
        .marks-input {
            transition: all 0.2s;
        }
        
        .marks-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Card Header with Search */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        /* Table Container - Mobile Responsive */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: -20px;
            padding: 20px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        .data-table thead {
            background: var(--bg-card-hover);
        }
        
        .data-table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
        }
        
        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .data-table tbody tr:hover {
            background: var(--bg-card-hover);
            transition: background-color 0.2s ease;
        }
        
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Action Buttons in Tables */
        .data-table .actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .data-table .btn-icon {
            padding: 6px 8px;
            font-size: 13px;
        }
        
        /* Department Cards - Expandable Structure - Matching Dashboard Theme */
        .department-row {
            border-bottom: none !important;
        }
        
        .department-card {
            background: var(--bg-card, #ffffff);
            border: 1px solid var(--border-color, #e5e7eb);
            border-radius: 12px;
            margin: 8px 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .department-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color, #3b82f6);
        }
        
        .department-header {
            cursor: pointer;
            padding: 20px;
            background: var(--bg-card, #ffffff);
            border-bottom: 1px solid var(--border-color, #e5e7eb);
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background-color 0.3s ease;
        }
        
        .department-header:hover {
            background: var(--bg-hover, #f9fafb);
        }
        
        .department-header i.fa-chevron-right,
        .department-header i.fa-chevron-down {
            color: var(--primary-color, #3b82f6);
            transition: transform 0.2s;
            font-size: 14px;
        }
        
        .department-courses {
            padding: 20px;
            background: var(--bg-hover, #f9fafb);
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 1000px;
            }
        }
        
        .department-courses table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875em;
            background: var(--bg-card, #ffffff);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .department-courses table thead {
            background: var(--bg-hover, #f9fafb);
        }
        
        .department-courses table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-color, #1f2937);
            font-size: 0.875em;
            border-bottom: 2px solid var(--border-color, #e5e7eb);
        }
        
        .department-courses table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color, #e5e7eb);
            color: var(--text-color, #1f2937);
        }
        
        .department-courses table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .department-courses table tbody tr:hover {
            background: var(--bg-hover, #f9fafb);
        }
        
        .department-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        /* Hide table header for departments table since we use cards */
        #departments-table thead {
            display: none;
        }
        
        /* Pagination - Mobile Responsive */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn-pagination {
            padding: 8px 12px;
            background: var(--bg-card, white);
            border: 1px solid var(--border-color, #e5e7eb);
            border-radius: 6px;
            color: var(--text-color, #1f2937);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            min-width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-pagination:hover:not(:disabled) {
            background: var(--primary-color, #3b82f6);
            color: white;
            border-color: var(--primary-color, #3b82f6);
        }
        
        .btn-pagination:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-info {
            color: var(--text-light, #6b7280);
            font-size: 13px;
            padding: 0 8px;
        }
        
        /* Mobile Responsive - Students Section */
        @media (max-width: 768px) {
            /* Card Header - Stack on Mobile */
            .card-header {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .card-header .card-title {
                width: 100%;
            }
            
            .search-box {
                width: 100%;
                min-width: 0;
            }
            
            /* Table - Horizontal Scroll on Mobile */
            .table-container {
                margin: -16px;
                padding: 16px;
            }
            
            .data-table {
                min-width: 700px;
            }
            
            .data-table th,
            .data-table td {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            /* Compact Action Buttons */
            .data-table .actions {
                gap: 4px;
            }
            
            .data-table .btn-icon {
                padding: 5px 6px;
                font-size: 12px;
            }
            
            /* Pagination - Compact */
            .pagination {
                gap: 6px;
                margin-top: 16px;
            }
            
            .btn-pagination {
                padding: 6px 10px;
                font-size: 12px;
                min-width: 32px;
                height: 32px;
            }
            
            .page-info {
                font-size: 12px;
                padding: 0 4px;
            }
        }
        
        @media (max-width: 480px) {
            /* Card Header - Extra Compact */
            .card-header {
                padding: 10px 12px;
                gap: 10px;
            }
            
            .search-box input {
                padding: 8px 10px 8px 36px;
                font-size: 13px;
            }
            
            .search-box i {
                left: 10px;
                font-size: 13px;
            }
            
            /* Table - Smaller Padding */
            .table-container {
                margin: -12px;
                padding: 12px;
            }
            
            .data-table {
                min-width: 650px;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 10px;
                font-size: 12px;
            }
            
            /* Very Compact Actions */
            .data-table .actions {
                gap: 3px;
                flex-wrap: wrap;
            }
            
            .data-table .btn-icon {
                padding: 4px 5px;
                font-size: 11px;
            }
            
            /* Compact Pagination */
            .pagination {
                gap: 4px;
                margin-top: 12px;
            }
            
            .btn-pagination {
                padding: 5px 8px;
                font-size: 11px;
                min-width: 28px;
                height: 28px;
            }
            
            .page-info {
                font-size: 11px;
                padding: 0 2px;
            }
        }
        
        /* Button Styles - Mobile Responsive */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: none;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: var(--primary-color, #3b82f6);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark, #2563eb);
        }
        
        @media (max-width: 768px) {
            .btn {
                padding: 8px 16px;
                font-size: 13px;
                gap: 6px;
            }
        }
        
        @media (max-width: 480px) {
            .btn {
                padding: 7px 12px;
                font-size: 12px;
                gap: 5px;
            }
            
            .btn i {
                font-size: 11px;
            }
        }
    </style>
</head>
<body class="dashboard-page">
    <!-- Top Navigation Bar -->
    <nav class="top-navbar">
        <div class="navbar-content">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="college-brand">
                    <i class="fas fa-graduation-cap"></i>
                    <span>{{ college.name }}</span>
                </div>
            </div>
            <div class="navbar-right">
                <div class="navbar-actions-group">
                <div class="notifications">
                        <button class="notification-btn" id="notification-btn" aria-label="Notifications">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notification-count">0</span>
                    </button>
                    <div class="notification-menu" id="notification-menu">
                        <div class="notification-header">
                            <h3>New Announcements</h3>
                        </div>
                        <div class="notification-list" id="notification-list">
                            <div class="no-notifications">No new announcements</div>
                        </div>
                        <div class="notification-footer">
                            <a href="#" onclick="showSection('announcements-section'); document.getElementById('notification-menu').classList.remove('active'); return false;">View All Announcements</a>
                        </div>
                    </div>
                </div>
                <div class="profile-dropdown">
                        <button class="profile-btn" id="profile-btn" aria-label="Profile Menu">
                        <div class="profile-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="profile-info">
                            <span class="profile-name">{{ user.get_full_name|default:user.username }}</span>
                            <span class="profile-role">{{ user.get_role_display }}</span>
                        </div>
                            <i class="fas fa-chevron-down profile-chevron"></i>
                    </button>
                    <div class="profile-menu" id="profile-menu">
                        <a href="#" class="profile-menu-item">
                            <i class="fas fa-user"></i> Profile
                        </a>
                        <a href="#" class="profile-menu-item">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                        <div class="profile-menu-divider"></div>
                        <a href="{% url 'logout' %}" class="profile-menu-item">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Horizontal Top Navigation Bar -->
    <nav class="top-nav-menu">
        <ul class="top-nav-menu-list">
            <li class="top-nav-menu-item">
                <a href="#" class="top-nav-menu-link" data-section="announcements-section">
                    <i class="fas fa-bullhorn"></i>
                    <span>Announcements</span>
                </a>
            </li>
            {% if user.is_college_admin or user.is_accounts_officer %}
            <li class="top-nav-menu-item">
                <a href="{% url 'accounts:dashboard' %}" class="top-nav-menu-link">
                    <i class="fas fa-wallet"></i>
                    <span>Finance</span>
                </a>
            </li>
            {% endif %}
            <li class="top-nav-menu-item">
                <a href="#" class="top-nav-menu-link" data-section="exams-section">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Exams & Results</span>
                </a>
            </li>
            {% if user.is_college_admin %}
            <li class="top-nav-menu-item">
                <a href="#" class="top-nav-menu-link" data-section="academic-config-section">
                    <i class="fas fa-cog"></i>
                    <span>Academic Configuration</span>
                </a>
            </li>
            <li class="top-nav-menu-item">
                <a href="#" class="top-nav-menu-link" data-section="export-section">
                    <i class="fas fa-file-export"></i>
                    <span>Export & Print</span>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <nav class="sidebar-nav">
            <ul class="nav-menu">
                <li class="nav-item active" data-section="dashboard-section">
                    <a href="#" class="nav-link" data-section="dashboard-section">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item" data-section="students-section">
                    <a href="#" class="nav-link" data-section="students-section">
                        <i class="fas fa-user-graduate"></i>
                        <span>Students</span>
                    </a>
                </li>
                <li class="nav-item" data-section="departments-section">
                    <a href="#" class="nav-link" data-section="departments-section">
                        <i class="fas fa-building"></i>
                        <span>Departments</span>
                    </a>
                </li>
                <li class="nav-item" data-section="courses-section">
                    <a href="#" class="nav-link" data-section="courses-section">
                        <i class="fas fa-book"></i>
                        <span>Courses</span>
                    </a>
                </li>
                <li class="nav-item" data-section="courseunits-section">
                    <a href="#" class="nav-link" data-section="courseunits-section">
                        <i class="fas fa-sitemap"></i>
                        <span>Course Units</span>
                    </a>
                </li>
                <li class="nav-item" data-section="units-section">
                    <a href="#" class="nav-link" data-section="units-section">
                        <i class="fas fa-book-open"></i>
                        <span>Units</span>
                    </a>
                </li>
                <li class="nav-item" data-section="lecturers-section">
                    <a href="#" class="nav-link" data-section="lecturers-section">
                        <i class="fas fa-chalkboard-teacher"></i>
                        <span>Lecturers</span>
                    </a>
                </li>
                <li class="nav-item" data-section="timetable-section">
                    <a href="#" class="nav-link" data-section="timetable-section">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Timetable</span>
                    </a>
                </li>
                <li class="nav-item" data-section="settings-section">
                    <a href="#" class="nav-link" data-section="settings-section">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </li>
                <li class="nav-item logout-item">
                    <a href="{% url 'logout' %}" class="nav-link">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
        <!-- Dashboard Section (Default Visible) -->
        <div class="content-section active" id="dashboard-section">
            <div class="page-header">
                <h1 class="page-title">Dashboard</h1>
                <p class="page-subtitle">Welcome to {{ college.name }} management portal</p>
            </div>
            <div class="overview-cards">
                <div class="overview-card">
                    <div class="card-icon students">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-label">Total Students</div>
                        <div class="card-value" id="dashboard-total-students">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <div class="card-change neutral" id="dashboard-students-status">Loading...</div>
                    </div>
                </div>
                <div class="overview-card">
                    <div class="card-icon departments">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-label">Departments</div>
                        <div class="card-value" id="dashboard-total-departments">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <div class="card-change neutral" id="dashboard-departments-status">Loading...</div>
                    </div>
                </div>
                <div class="overview-card">
                    <div class="card-icon courses">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-label">Courses</div>
                        <div class="card-value" id="dashboard-total-courses">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <div class="card-change neutral" id="dashboard-courses-status">Loading...</div>
                    </div>
                </div>
                <div class="overview-card">
                    <div class="card-icon lecturers">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-label">Lecturers</div>
                        <div class="card-value" id="dashboard-total-lecturers">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <div class="card-change neutral" id="dashboard-lecturers-status">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">Recent Students</h3>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Admission Number</th>
                                    <th>Full Name</th>
                                    <th>Date Added</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-recent-students">
                                <tr>
                                    <td colspan="3" class="loading-row">
                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Students Section -->
        <div class="content-section" id="students-section">
            <div class="page-header">
                <h1 class="page-title">Students</h1>
                {% if user.is_college_admin %}
                <button class="btn btn-primary" onclick="openStudentModal()">
                    <i class="fas fa-plus"></i> Add New Student
                </button>
                {% endif %}
            </div>
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">Student Records</h3>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="students-search" placeholder="Search students..." onkeyup="searchStudents()">
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Admission No.</th>
                                    <th>Name</th>
                                    <th>Course</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="students-tbody">
                                <tr>
                                    <td colspan="5" class="loading-row">
                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="students-pagination"></div>
                </div>
            </div>
        </div>

        <!-- Departments Section -->
        <div class="content-section" id="departments-section">
            <div class="page-header">
                <h1 class="page-title">Departments</h1>
                {% if user.is_college_admin %}
                <button class="btn btn-primary" onclick="openDepartmentModal()">
                    <i class="fas fa-plus"></i> Add New Department
                </button>
                {% endif %}
            </div>
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">College Departments</h3>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="departments-search" placeholder="Search departments..." onkeyup="searchDepartments()">
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="data-table" id="departments-table">
                            <thead style="display: none;">
                                <tr>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="departments-tbody">
                                <tr>
                                    <td colspan="4" class="loading-row">
                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="departments-pagination"></div>
                </div>
            </div>
        </div>

        <!-- Courses Section -->
        <div class="content-section" id="courses-section">
            <div class="page-header">
                <h1 class="page-title">Courses</h1>
                {% if user.is_college_admin %}
                <button class="btn btn-primary" onclick="openCourseModal()">
                    <i class="fas fa-plus"></i> Add New Course
                </button>
                {% endif %}
            </div>
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">College Courses</h3>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="courses-search" placeholder="Search courses..." onkeyup="searchCourses()">
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="courses-tbody">
                                <tr>
                                    <td colspan="5" class="loading-row">
                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="courses-pagination"></div>
                </div>
            </div>
        </div>

        <!-- Course Units Section -->
        <div class="content-section" id="courseunits-section">
            <!-- Courses List View -->
            <div id="courses-list-view">
                <div class="page-header">
                    <h1 class="page-title">Course Units Management</h1>
                </div>
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">All Courses</h3>
                        <div class="search-box" style="flex: 1; max-width: 400px; margin-left: auto;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="courses-search-input" placeholder="Search courses by name..." onkeyup="filterCourses()">
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="courses-list-container">
                            <div class="loading-state" style="text-align: center; padding: 60px 20px;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--primary-color);"></i>
                                <p style="margin-top: 16px; color: var(--text-secondary);">Loading courses...</p>
                            </div>
                        </div>
                        <div class="pagination" id="courses-pagination" style="margin-top: 24px;"></div>
                    </div>
                </div>
            </div>

            <!-- Course Detail View (shown when course is selected) -->
            <div id="course-detail-view" style="display: none;">
                <div class="page-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                        <div>
                            <button class="btn btn-secondary" onclick="showCoursesList()" style="margin-right: 12px;">
                                <i class="fas fa-arrow-left"></i> Back to Courses
                            </button>
                            <h1 class="page-title" id="course-detail-title" style="margin: 0; display: inline-block;">Course Units</h1>
                        </div>
                        {% if user.role == 'registrar' or user.role == 'principal' or user.role == 'director' %}
                        <button class="btn btn-primary" onclick="openAddUnitDialog()">
                            <i class="fas fa-plus"></i> Add Unit
                        </button>
                        {% endif %}
                    </div>
                </div>
                
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title" id="course-detail-name">Course Units</h3>
                        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">Year</label>
                                <select id="course-units-year-filter" class="form-select" style="width: auto; min-width: 120px;" onchange="filterCourseUnits()">
                                    <option value="">All Years</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">Semester</label>
                                <select id="course-units-semester-filter" class="form-select" style="width: auto; min-width: 140px;" onchange="filterCourseUnits()">
                                    <option value="">All Semesters</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="course-units-container">
                            <!-- Will be populated dynamically -->
                        </div>
                        
                        <div id="course-units-loading" style="display: none; text-align: center; padding: 60px 20px;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--primary-color);"></i>
                            <p style="margin-top: 16px; color: var(--text-secondary);">Loading course units...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Units Section -->
        <div class="content-section" id="units-section">
            <!-- My Units Section (For Lecturers) -->
            {% if user.role == 'lecturer' %}
            <div class="content-card" id="my-units-section">
                <div class="card-header">
                    <h3 class="card-title">My Units</h3>
                </div>
                <div class="card-body">
                    <div id="my-units-container" class="units-grid-container">
                        <div class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i> Loading your units...
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Unit Search & Filters (For College Admins) -->
            {% if user.is_college_admin %}
            <div class="page-header">
                <h1 class="page-title">Units</h1>
                <button class="btn btn-primary" onclick="openUnitModal()">
                    <i class="fas fa-plus"></i> Add New Unit
                </button>
            </div>
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">Search Units</h3>
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <div class="search-box" style="flex: 1; min-width: 250px;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="units-search" placeholder="Search by code or name..." onkeyup="searchUnitsWithFilters()">
                        </div>
                        <select id="units-lecturer-filter" class="form-select" style="width: auto; min-width: 180px;" onchange="searchUnitsWithFilters()">
                            <option value="">All Lecturers</option>
                        </select>
                        <select id="units-semester-filter" class="form-select" style="width: auto; min-width: 140px;" onchange="searchUnitsWithFilters()">
                            <option value="">All Semesters</option>
                        </select>
                        <select id="units-course-filter" class="form-select" style="width: auto; min-width: 180px;" onchange="searchUnitsWithFilters()">
                            <option value="">All Courses</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Units List (Default: Semester 1) -->
                    <div id="units-list-container">
                        <div id="units-search-results" class="units-search-results">
                            <div class="loading-state" style="text-align: center; padding: 60px 20px;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--primary-color);"></i>
                                <p style="margin-top: 16px; color: var(--text-secondary);">Loading units...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="units-search-loading" style="display: none; text-align: center; padding: 60px 20px;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--primary-color);"></i>
                        <p style="margin-top: 16px; color: var(--text-secondary);">Searching units...</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Lecturers Section -->
        <div class="content-section" id="lecturers-section">
            <div class="page-header">
                <h1 class="page-title">Lecturers</h1>
                {% if user.is_college_admin %}
                <button class="btn btn-primary" onclick="openLecturerModal()">
                    <i class="fas fa-plus"></i> Add New Lecturer
                </button>
                {% endif %}
            </div>
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">Lecturer Accounts</h3>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="lecturers-search" placeholder="Search lecturers..." onkeyup="searchLecturers()">
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Assigned Units</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="lecturers-tbody">
                                <tr>
                                    <td colspan="6" class="loading-row">
                                        <i class="fas fa-spinner fa-spin"></i> Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="lecturers-pagination"></div>
                </div>
            </div>
        </div>

        <!-- Exams & Results Section -->
        <div class="content-section" id="exams-section">
            <div class="page-header">
                <h1 class="page-title">Exams & Results</h1>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" id="enrollments-tab" onclick="switchTab('enrollments')">
                    <i class="fas fa-user-graduate"></i> Enrollments
                </button>
                <button class="tab-btn" id="results-tab" onclick="switchTab('results')">
                    <i class="fas fa-clipboard-check"></i> Results
                </button>
                {% if user.role == 'registrar' or user.role == 'principal' %}
                <button class="tab-btn" id="my-units-tab" onclick="switchTab('my-units')">
                    <i class="fas fa-book"></i> My Units
                </button>
                {% endif %}
            </div>

            <!-- Enrollments Tab -->
            <div class="tab-content active" id="enrollments-tab-content">
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">Student Enrollments</h3>
                        <button class="btn btn-primary" onclick="openEnrollmentModal()">
                            <i class="fas fa-plus"></i> Enroll Student
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Professional Filters Bar -->
                        <div class="filters-bar" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 24px; padding: 16px; background: var(--bg-card-hover); border-radius: var(--border-radius); border: 1px solid var(--border-color);">
                            <!-- Search Input -->
                            <div class="search-box" style="grid-column: 1 / -1;">
                                <i class="fas fa-search"></i>
                                <input type="text" id="enrollment-search" class="form-input" placeholder="Search by student name or admission number..." onkeyup="debounceEnrollmentSearch()">
                            </div>
                            
                            <!-- Course Filter -->
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">Course</label>
                                <select id="enrollment-course-filter" class="form-select" onchange="onEnrollmentCourseChange()">
                                    <option value="">All Courses</option>
                                </select>
                            </div>
                            
                            <!-- Unit Filter -->
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">Unit</label>
                            <select id="enrollment-unit-filter" class="form-select" onchange="filterEnrollments()">
                                <option value="">All Units</option>
                            </select>
                            </div>
                            
                            <!-- Academic Year Filter -->
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">Academic Year</label>
                            <select id="enrollment-year-filter" class="form-select" onchange="filterEnrollments()">
                                <option value="">All Academic Years</option>
                            </select>
                            </div>
                            
                            <!-- Semester Filter -->
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">Semester</label>
                            <select id="enrollment-semester-filter" class="form-select" onchange="filterEnrollments()">
                                <option value="">All Semesters</option>
                            </select>
                        </div>
                            
                            <!-- Exam Registration Status Filter -->
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">Exam Status</label>
                                <select id="enrollment-exam-status-filter" class="form-select" onchange="filterEnrollments()">
                                    <option value="">All</option>
                                    <option value="registered">Exam Registered</option>
                                    <option value="not_registered">Not Registered</option>
                                </select>
                            </div>
                            
                            <!-- Clear Filters Button -->
                            <div class="form-group" style="margin: 0; display: flex; align-items: flex-end;">
                                <button type="button" class="btn btn-secondary" onclick="clearEnrollmentFilters()" style="width: 100%;">
                                    <i class="fas fa-times"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                        
                        <!-- Results Count -->
                        <div id="enrollments-results-count" style="margin-bottom: 16px; color: var(--text-secondary); font-size: 14px;">
                            <i class="fas fa-info-circle"></i> <span id="enrollments-count-text">Loading...</span>
                        </div>
                        
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Unit</th>
                                        <th>Exam Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="enrollments-tbody">
                                    <tr>
                                        <td colspan="4" class="loading-row">
                                            <i class="fas fa-spinner fa-spin"></i> Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="enrollments-pagination"></div>
                    </div>
                </div>
            </div>

            <!-- Results Tab (formerly My Units) -->
            <div class="tab-content" id="results-tab-content">
                <!-- Units Grid View -->
                <div id="results-units-view" class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">Results</h3>
                        
                            
                        <button class="btn btn-secondary" id="refresh-results-units-btn" onclick="window.loadResultsUnits && window.loadResultsUnits()" title="Refresh">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Professional Filters Bar -->
                        <div class="filters-bar" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 24px; padding: 16px; background: var(--bg-card-hover); border-radius: var(--border-radius); border: 1px solid var(--border-color);">
                            <!-- Academic Year Filter -->
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">Academic Year</label>
                                <select id="results-year-filter" class="form-select" onchange="filterResultsUnits()">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            
                            <!-- Semester Filter -->
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">Semester</label>
                                <select id="results-semester-filter" class="form-select" onchange="filterResultsUnits()">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            
                            {% if user.role == 'registrar' or user.role == 'principal' %}
                            <!-- Unit Search (for Registrar/Principal) -->
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">Search Unit</label>
                                <div class="search-box" style="position: relative;">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="results-unit-search" class="form-input" placeholder="Search by unit code or name..." onkeyup="filterResultsUnitsBySearch()">
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div id="results-units-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary-color); margin-bottom: 12px;"></i>
                                <p style="color: var(--text-light);">Loading Please Wait...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Marks Entry View (after selecting unit) - Kept for backward compatibility but hidden -->
                <div id="marks-entry-view" class="content-card" style="display: none;">
                    <div class="card-header">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; flex-wrap: wrap; gap: 12px;">
                            <div>
                                <button class="btn btn-secondary" onclick="showResultsUnitsView()" style="margin-bottom: 8px;">
                                    <i class="fas fa-arrow-left"></i> Back to Results
                                </button>
                                <h3 class="card-title" id="marks-entry-unit-title" style="margin: 0;">Enter Marks</h3>
                            </div>
                            <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                                <div class="search-box" style="min-width: 250px;">
                                    <i class="fas fa-search"></i>
                                    <input type="text" id="marks-entry-search" class="form-input" 
                                           placeholder="Search by admission number or name..." 
                                           onkeyup="filterMarksTable()">
                                </div>
                                <button class="btn btn-success" id="save-draft-btn" onclick="saveAllDraftMarks()">
                                    <i class="fas fa-save"></i> Save to Draft
                                </button>
                                <button class="btn btn-primary" id="submit-all-marks-btn" onclick="submitAllMarks()" style="display: none;">
                                    <i class="fas fa-check-circle"></i> Submit All
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="marks-entry-stats" style="display: flex; gap: 16px; margin-bottom: 20px; padding: 16px; background: var(--bg-card-hover); border-radius: var(--border-radius); flex-wrap: wrap;">
                            <div>
                                <span style="color: var(--text-light); font-size: 12px;">Total Students:</span>
                                <strong id="stats-total" style="font-size: 18px; margin-left: 8px;">0</strong>
                            </div>
                            <div>
                                <span style="color: var(--text-light); font-size: 12px;">With Marks:</span>
                                <strong id="stats-marked" style="font-size: 18px; margin-left: 8px; color: #10b981;">0</strong>
                            </div>
                            <div>
                                <span style="color: var(--text-light); font-size: 12px;">No Marks:</span>
                                <strong id="stats-no-marks" style="font-size: 18px; margin-left: 8px; color: #ef4444;">0</strong>
                            </div>
                            <div>
                                <span style="color: var(--text-light); font-size: 12px;">Submitted:</span>
                                <strong id="stats-submitted" style="font-size: 18px; margin-left: 8px; color: #10b981;">0</strong>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="data-table" id="marks-entry-table">
                                <thead>
                                    <tr>
                                        <th>Admission No.</th>
                                        <th>Student Name</th>
                                        <th>CAT Marks</th>
                                        <th>Exam Marks</th>
                                        <th>Total</th>
                                        <th>Grade</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="marks-entry-tbody">
                                    <tr>
                                        <td colspan="7" class="loading-row">
                                            <i class="fas fa-spinner fa-spin"></i> Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Units Tab (for Registrar/Principal) -->
            {% if user.role == 'registrar' or user.role == 'principal' %}
            <div class="tab-content" id="my-units-tab-content">
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">My Units</h3>
                        <button class="btn btn-secondary" id="refresh-my-units-results-btn" onclick="window.loadMyUnitsResults && window.loadMyUnitsResults()" title="Refresh">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Professional Filters Bar -->
                        <div class="filters-bar" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 24px; padding: 16px; background: var(--bg-card-hover); border-radius: var(--border-radius); border: 1px solid var(--border-color);">
                            <!-- Academic Year Filter -->
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">Academic Year</label>
                                <select id="my-units-year-filter" class="form-select" onchange="filterMyUnitsResults()">
                                    <option value="">Loading...</option>
                                </select>
                            </div>
                            
                            <!-- Semester Filter -->
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">Semester</label>
                                <select id="my-units-semester-filter" class="form-select" onchange="filterMyUnitsResults()">
                                    <option value="">All Semesters</option>
                                </select>
                            </div>
                            
                            <!-- Clear Filters Button -->
                            <div class="form-group" style="margin: 0; display: flex; align-items: flex-end;">
                                <button type="button" class="btn btn-secondary" onclick="clearMyUnitsFilters()" style="width: 100%;">
                                    <i class="fas fa-times"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                        
                        <div id="my-units-results-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary-color); margin-bottom: 12px;"></i>
                                <p style="color: var(--text-light);">Loading Please Wait...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Fees & Finance Section -->
        <div class="content-section" id="fees-section">
            <div class="page-header">
                <h1 class="page-title">Fees & Finance</h1>
                <p class="page-subtitle">Manage student fees and financial records</p>
            </div>
            <div class="content-card">
                <div class="card-body">
                    <p>Fees & Finance management section - content coming soon.</p>
                </div>
            </div>
        </div>

        <!-- Announcements Section -->
        <div class="content-section" id="announcements-section">
            <div class="page-header">
                <h1 class="page-title"><i class="fas fa-bullhorn"></i> Announcements</h1>
            </div>
            
            <!-- Tabs -->
            <div class="tabs" style="margin-bottom: 20px;">
                <button class="tab-btn active" id="view-announcements-tab" onclick="switchAnnouncementsTab('view')">
                    <i class="fas fa-eye"></i> View Announcements
                </button>
                {% if user.is_college_admin %}
                <button class="tab-btn" id="manage-announcements-tab" onclick="switchAnnouncementsTab('manage')">
                    <i class="fas fa-cog"></i> Manage Announcements
                </button>
                {% endif %}
            </div>

            <!-- View Announcements Tab -->
            <div class="tab-content active" id="view-announcements-tab-content">
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">College Announcements</h3>
                    </div>
                    <div class="card-body">
                        <div id="lecturer-announcements-container">
                            <div class="loading-row">
                                <i class="fas fa-spinner fa-spin"></i> Loading announcements...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manage Announcements Tab (Admin Only) -->
            {% if user.is_college_admin %}
            <div class="tab-content" id="manage-announcements-tab-content">
                <div class="filters-bar" style="margin-bottom: 20px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                    <div class="search-box" style="flex: 1; min-width: 200px;">
                        <i class="fas fa-search"></i>
                        <input type="text" id="announcements-search-input" placeholder="Search announcements..." onkeyup="debounceSearchAnnouncements()">
                    </div>
                    <div class="filter-group" style="display: flex; align-items: center; gap: 8px;">
                        <label style="white-space: nowrap;">Target Type:</label>
                        <select id="announcements-target-type-filter" class="form-input" style="width: auto;" onchange="loadAnnouncementsManagement()">
                            <option value="">All Types</option>
                            <option value="all_students">All Students</option>
                            <option value="all_lecturers">All Lecturers</option>
                            <option value="individual">Individual</option>
                        </select>
                    </div>
                    <div class="filter-group" style="display: flex; align-items: center; gap: 8px;">
                        <label style="white-space: nowrap;">Priority:</label>
                        <select id="announcements-priority-filter" class="form-input" style="width: auto;" onchange="loadAnnouncementsManagement()">
                            <option value="">All Priorities</option>
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="filter-group" style="display: flex; align-items: center; gap: 8px;">
                        <label style="white-space: nowrap;">Status:</label>
                        <select id="announcements-status-filter" class="form-input" style="width: auto;" onchange="loadAnnouncementsManagement()">
                            <option value="">All Status</option>
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>

                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-list"></i> Announcements List</h3>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="card-value" id="announcements-count">0 announcements</span>
                            <button class="btn btn-primary" onclick="openAnnouncementCreateModal()">
                                <i class="fas fa-plus"></i> Create Announcement
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="data-table" id="announcements-table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Target</th>
                                        <th>Priority</th>
                                        <th>Created By</th>
                                        <th>Created At</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="announcements-tbody">
                                    <tr><td colspan="7" class="loading-row"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="announcements-pagination"></div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Timetable Section -->
        <div class="content-section" id="timetable-section">
            <div class="page-header">
                <h1 class="page-title">Timetable</h1>
                {% if user.is_college_admin %}
                <button class="btn btn-primary" onclick="openTimetableModal()">
                    <i class="fas fa-plus"></i> Upload Timetable
                </button>
                {% endif %}
            </div>
            
            <!-- Timetable Tabs -->
            <div class="tabs timetable-tabs">
                <button class="tab-btn active" id="general-timetable-tab" onclick="switchTimetableTab('general')">
                    <i class="fas fa-calendar-alt"></i> General Timetable
                </button>
                <button class="tab-btn" id="course-timetable-tab" onclick="switchTimetableTab('course')">
                    <i class="fas fa-graduation-cap"></i> Course-Specific Timetable
                </button>
                {% if user.is_registrar or user.is_principal or user.is_lecturer %}
                <a href="{% url 'timetable:my_timetable' %}" class="tab-btn" id="my-timetable-tab">
                    <i class="fas fa-user-clock"></i> My Timetable
                </a>
                {% endif %}
                {% if user.is_registrar %}
                <a href="{% url 'timetable:generate_timetable' %}" class="tab-btn" id="generate-timetable-tab">
                    <i class="fas fa-cogs"></i> Generate Timetable
                </a>
                {% endif %}
            </div>
            
            <!-- General Timetable Tab Content -->
            <div class="timetable-tab-content active" id="general-timetable-tab-content">
            <div class="content-card">
                <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-calendar-alt" style="margin-right: 8px;"></i>
                            General Timetables
                        </h3>
                        <div class="timetable-filters">
                            <select id="general-timetable-year-filter" class="form-select timetable-filter" style="width: auto;" onchange="filterTimetables()">
                                <option value="">All Years</option>
                        </select>
                            <select id="general-timetable-semester-filter" class="form-select timetable-filter" style="width: auto;" onchange="filterTimetables()">
                                <option value="">All Semesters</option>
                            </select>
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="general-timetables-search" placeholder="Search..." onkeyup="searchTimetables()">
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="timetable-forms-container" id="general-timetables-container">
                            <div class="loading-state" id="general-timetables-loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading timetables...
                            </div>
                            <div class="timetable-forms-grid" id="general-timetables-tbody" style="display: none;">
                                <!-- Timetable forms will be rendered here -->
                            </div>
                            <div class="empty-state" id="general-timetables-empty" style="display: none;">
                                <i class="fas fa-calendar-times"></i>
                                <p>No timetables found</p>
                            </div>
                        </div>
                        <div class="pagination" id="general-timetables-pagination"></div>
                    </div>
                </div>
            </div>
            
            <!-- Course-Specific Timetable Tab Content -->
            <div class="timetable-tab-content" id="course-timetable-tab-content">
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-graduation-cap" style="margin-right: 8px;"></i>
                            Course-Specific Timetables
                        </h3>
                        <div class="timetable-filters">
                            <select id="course-timetable-course-filter" class="form-select timetable-filter" style="width: auto;" onchange="filterTimetables()">
                            <option value="">All Courses</option>
                        </select>
                            <select id="course-timetable-year-filter" class="form-select timetable-filter" style="width: auto;" onchange="filterTimetables()">
                                <option value="">All Years</option>
                            </select>
                            <select id="course-timetable-semester-filter" class="form-select timetable-filter" style="width: auto;" onchange="filterTimetables()">
                                <option value="">All Semesters</option>
                        </select>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                                <input type="text" id="course-timetables-search" placeholder="Search..." onkeyup="searchTimetables()">
                        </div>
                    </div>
                </div>
                <div class="card-body">
                        <div class="timetable-forms-container" id="course-timetables-container">
                            <div class="loading-state" id="course-timetables-loading">
                                        <i class="fas fa-spinner fa-spin"></i> Loading timetables...
                    </div>
                            <div class="timetable-forms-grid" id="course-timetables-tbody" style="display: none;">
                                <!-- Timetable forms will be rendered here -->
                            </div>
                            <div class="empty-state" id="course-timetables-empty" style="display: none;">
                                <i class="fas fa-calendar-times"></i>
                                <p>No timetables found</p>
                            </div>
                        </div>
                        <div class="pagination" id="course-timetables-pagination"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Section -->
        {% if user.is_college_admin %}
        <div class="content-section" id="export-section">
            <div class="page-header">
                <h1 class="page-title">Export & Print</h1>
                <p class="page-subtitle">Generate and print transcripts and other documents</p>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" id="generate-transcripts-tab" onclick="switchExportTab('transcripts')">
                    <i class="fas fa-file-pdf"></i> Transcripts
                </button>
                <button class="tab-btn" id="student-list-tab" onclick="switchExportTab('student-list')">
                    <i class="fas fa-list"></i> Student List
                </button>
                <button class="tab-btn" id="select-fields-tab" onclick="switchExportTab('fields')">
                    <i class="fas fa-check-square"></i> Select Fields to Export
                </button>
                <button class="tab-btn" id="export-data-tab" onclick="switchExportTab('data')">
                    <i class="fas fa-download"></i> Export Data
                </button>
            </div>
            
            <!-- Generate Transcripts Tab Content -->
            <div class="export-tab-content active" id="generate-transcripts-tab-content">
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-file-pdf" style="color: var(--danger-color); margin-right: 8px;"></i>
                            Generate Transcripts
                        </h3>
                    </div>
                    <div class="card-body">
                    <!-- Compact Filter Bar -->
                    <div style="background: var(--bg-card-hover); padding: 16px; border-radius: var(--border-radius); margin-bottom: 20px; border: 1px solid var(--border-color);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; align-items: end;">
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                    <i class="fas fa-calendar-alt" style="color: var(--text-muted); margin-right: 4px;"></i>Academic Year
                                </label>
                                <select id="transcript-year-filter" class="form-select" style="font-size: 13px; padding: 8px 12px;">
                                    <option value="">All Years</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                    <i class="fas fa-calendar" style="color: var(--text-muted); margin-right: 4px;"></i>Semester
                                </label>
                                <select id="transcript-semester-filter" class="form-select" style="font-size: 13px; padding: 8px 12px;">
                                    <option value="">All Semesters</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                    <i class="fas fa-graduation-cap" style="color: var(--text-muted); margin-right: 4px;"></i>Course
                                </label>
                                <select id="transcript-course-filter" class="form-select" style="font-size: 13px; padding: 8px 12px;">
                                    <option value="">All Courses</option>
                                </select>
                            </div>
                            <button class="btn btn-secondary" onclick="clearTranscriptFilters()" style="font-size: 13px; padding: 8px 16px; white-space: nowrap; height: fit-content;">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                    
                    <!-- Compact Student Selection -->
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; margin-bottom: 20px;">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                                <i class="fas fa-users" style="color: var(--primary-color); margin-right: 6px;"></i>Select Students
                            </label>
                            <select id="transcript-student-select" class="form-select" multiple size="6" style="font-size: 13px; border: 1px solid var(--border-color); border-radius: var(--border-radius);">
                                <option value="">Loading students...</option>
                            </select>
                            <span class="form-help" style="font-size: 11px; color: var(--text-muted); margin-top: 6px; display: block;">
                                <i class="fas fa-info-circle" style="margin-right: 4px;"></i>Hold Ctrl (Cmd on Mac) to select multiple
                            </span>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 8px; justify-content: flex-start; padding-top: 32px;">
                            <button class="btn btn-sm btn-outline-primary" onclick="selectAllStudents()" style="font-size: 12px; padding: 6px 12px; white-space: nowrap;">
                                <i class="fas fa-check-square"></i> Select All
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllStudents()" style="font-size: 12px; padding: 6px 12px; white-space: nowrap;">
                                <i class="fas fa-square"></i> Deselect All
                            </button>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; padding-top: 12px; border-top: 1px solid var(--border-color);">
                        <button class="btn btn-primary" onclick="generateSingleTranscript()" style="font-size: 14px; padding: 10px 20px; font-weight: 600; box-shadow: var(--shadow-md);">
                            <i class="fas fa-file-pdf"></i> Generate Single
                        </button>
                        <button class="btn btn-success" onclick="generateBulkTranscripts()" style="font-size: 14px; padding: 10px 20px; font-weight: 600; box-shadow: var(--shadow-md);">
                            <i class="fas fa-file-archive"></i> Generate Bulk (ZIP)
                        </button>
                        <button class="btn btn-outline-secondary" onclick="previewTranscript()" style="font-size: 14px; padding: 10px 20px; font-weight: 600;">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                    </div>
                    
                    <div id="transcript-generation-status" style="margin-top: 16px; font-size: 13px; color: var(--text-secondary);"></div>
                    </div>
                </div>
            </div>
            
            <!-- Student List Tab Content -->
            <div class="export-tab-content" id="student-list-tab-content">
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-list" style="color: var(--primary-color); margin-right: 8px;"></i>
                            Student List
                        </h3>
                        <p class="card-subtitle" style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">View, search, and export student list with full name and admission number</p>
                    </div>
                    <div class="card-body">
                        <!-- Search and Filters Bar -->
                        <div style="background: var(--bg-card-hover); padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px; border: 1px solid var(--border-color);">
                            <div class="student-list-filters-grid" style="display: grid; grid-template-columns: 2fr 1.5fr 1.2fr auto; gap: 16px; align-items: end;">
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                        <i class="fas fa-search" style="color: var(--primary-color);"></i>Search Students
                                    </label>
                                    <input type="text" id="student-list-search" class="form-input" placeholder="Search by name or admission number..." style="font-size: 14px; padding: 10px 14px; width: 100%;" onkeyup="handleStudentListSearch(event)">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                        <i class="fas fa-graduation-cap" style="color: var(--accent-courses);"></i>Course
                                    </label>
                                    <select id="student-list-course-filter" class="form-select" style="font-size: 14px; padding: 10px 14px; width: 100%;" onchange="loadStudentList()">
                                        <option value="">All Courses</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                        <i class="fas fa-check-circle" style="color: var(--success-color);"></i>Status
                                    </label>
                                    <select id="student-list-status-filter" class="form-select" style="font-size: 14px; padding: 10px 14px; width: 100%;" onchange="loadStudentList()">
                                        <option value="">All</option>
                                        <option value="active">Active</option>
                                        <option value="graduated">Graduated</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                                <button class="btn btn-secondary" onclick="clearStudentListFilters()" style="font-size: 14px; padding: 10px 18px; white-space: nowrap; height: fit-content; align-self: end; margin-bottom: 2px; font-weight: 500;">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                        
                        <!-- Selection and Export Actions -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 12px; background: var(--bg-light); border-radius: var(--border-radius);">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <button class="btn btn-sm btn-outline-primary" onclick="selectAllStudentList()" style="font-size: 12px; padding: 6px 12px;">
                                    <i class="fas fa-check-square"></i> Select All
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllStudentList()" style="font-size: 12px; padding: 6px 12px;">
                                    <i class="fas fa-square"></i> Deselect All
                                </button>
                                <span id="student-list-selection-count" style="font-size: 13px; color: var(--text-secondary); font-weight: 500;">
                                    <span id="selected-count">0</span> selected
                                </span>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-success" onclick="exportStudentListToCSV()" style="font-size: 14px; padding: 10px 20px; font-weight: 600; box-shadow: var(--shadow-md);">
                                    <i class="fas fa-file-csv"></i> Export CSV
                                </button>
                                <button class="btn btn-primary" onclick="exportStudentListToPDF()" style="font-size: 14px; padding: 10px 20px; font-weight: 600; box-shadow: var(--shadow-md);">
                                    <i class="fas fa-file-pdf"></i> Export PDF
                                </button>
                                <button class="btn btn-outline-secondary" onclick="printStudentList()" style="font-size: 14px; padding: 10px 20px; font-weight: 600;">
                                    <i class="fas fa-print"></i> Print
                                </button>
                            </div>
                        </div>
                        
                        <!-- Student List Table -->
                        <div class="table-container" style="overflow-x: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius);">
                            <table class="data-table" id="student-list-table" style="width: 100%; margin: 0;">
                                <thead>
                                    <tr>
                                        <th style="width: 50px; text-align: center;">
                                            <input type="checkbox" id="student-list-select-all" onchange="toggleSelectAllStudents(this)" style="width: 18px; height: 18px; cursor: pointer;">
                                        </th>
                                        <th style="min-width: 150px;">Admission Number</th>
                                        <th style="min-width: 250px;">Full Name</th>
                                    </tr>
                                </thead>
                                <tbody id="student-list-tbody">
                                    <tr>
                                        <td colspan="3" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                            <i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 12px; display: block;"></i>
                                            Loading students...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="student-list-pagination" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                            <div style="font-size: 13px; color: var(--text-secondary);">
                                Showing <span id="student-list-page-info">0-0</span> of <span id="student-list-total">0</span> students
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-outline-secondary" id="student-list-prev-btn" onclick="changeStudentListPage(-1)" disabled style="font-size: 12px; padding: 6px 12px;">
                                    <i class="fas fa-chevron-left"></i> Previous
                                </button>
                                <span id="student-list-page-numbers" style="display: flex; gap: 4px; align-items: center;"></span>
                                <button class="btn btn-sm btn-outline-secondary" id="student-list-next-btn" onclick="changeStudentListPage(1)" disabled style="font-size: 12px; padding: 6px 12px;">
                                    Next <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Select Fields to Export Tab Content -->
            <div class="export-tab-content" id="select-fields-tab-content">
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-file-csv" style="color: var(--success-color); margin-right: 8px;"></i>
                            Export Results to CSV
                        </h3>
                    </div>
                    <div class="card-body">
                        <!-- Filters Section -->
                        <div style="background: var(--bg-card-hover); padding: 16px; border-radius: var(--border-radius); margin-bottom: 20px; border: 1px solid var(--border-color);">
                            <h5 style="font-size: 13px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                <i class="fas fa-filter" style="color: var(--text-secondary); margin-right: 6px;"></i>Filters
                            </h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; align-items: end;">
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                        <i class="fas fa-book" style="color: var(--text-muted); margin-right: 4px;"></i>Unit
                                    </label>
                                    <select id="csv-export-unit-filter" class="form-select" style="font-size: 13px; padding: 8px 12px;">
                                        <option value="">All Units</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                        <i class="fas fa-calendar-alt" style="color: var(--text-muted); margin-right: 4px;"></i>Academic Year
                                    </label>
                                    <select id="csv-export-year-filter" class="form-select" style="font-size: 13px; padding: 8px 12px;">
                                        <option value="">All Years</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                        <i class="fas fa-calendar" style="color: var(--text-muted); margin-right: 4px;"></i>Semester
                                    </label>
                                    <select id="csv-export-semester-filter" class="form-select" style="font-size: 13px; padding: 8px 12px;">
                                        <option value="">All Semesters</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                        <i class="fas fa-search" style="color: var(--text-muted); margin-right: 4px;"></i>Search
                                    </label>
                                    <input type="text" id="csv-export-search" class="form-input" placeholder="Student name or admission..." style="font-size: 13px; padding: 8px 12px;">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                        <i class="fas fa-check-circle" style="color: var(--text-muted); margin-right: 4px;"></i>Status
                                    </label>
                                    <select id="csv-export-status-filter" class="form-select" style="font-size: 13px; padding: 8px 12px;">
                                        <option value="all">All Results</option>
                                        <option value="draft">Draft Only</option>
                                        <option value="submitted">Submitted Only</option>
                                    </select>
                                </div>
                                <button class="btn btn-secondary" onclick="clearCsvExportFilters()" style="font-size: 13px; padding: 8px 16px; white-space: nowrap; height: fit-content;">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                        
                        <!-- Field Selection Section -->
                        <div style="background: var(--bg-card-hover); padding: 20px; border-radius: var(--border-radius); margin-bottom: 20px; border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h5 style="font-size: 13px; font-weight: 700; color: var(--text-primary); margin: 0; text-transform: uppercase; letter-spacing: 0.5px;">
                                    <i class="fas fa-check-square" style="color: var(--success-color); margin-right: 6px;"></i>Select Fields to Export
                                </h5>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-sm btn-outline-primary" onclick="selectAllCsvFields()" style="font-size: 12px; padding: 6px 12px;">
                                        <i class="fas fa-check-square"></i> Select All
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllCsvFields()" style="font-size: 12px; padding: 6px 12px;">
                                        <i class="fas fa-square"></i> Deselect All
                                    </button>
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                            <!-- Student Information -->
                            <div style="padding: 12px; background: var(--bg-card); border-radius: 6px; border-left: 3px solid var(--primary-color);">
                                <h6 style="font-size: 11px; font-weight: 700; color: var(--text-primary); margin-bottom: 10px; text-transform: uppercase;">Student Information</h6>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                                        <input type="checkbox" class="csv-field-checkbox" value="student_name" checked style="margin-right: 8px; width: 16px; height: 16px;">
                                        Student Name
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                                        <input type="checkbox" class="csv-field-checkbox" value="admission_number" checked style="margin-right: 8px; width: 16px; height: 16px;">
                                        Admission Number
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                                        <input type="checkbox" class="csv-field-checkbox" value="student_id" style="margin-right: 8px; width: 16px; height: 16px;">
                                        Student ID
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Unit Information -->
                            <div style="padding: 12px; background: var(--bg-card); border-radius: 6px; border-left: 3px solid var(--success-color);">
                                <h6 style="font-size: 11px; font-weight: 700; color: var(--text-primary); margin-bottom: 10px; text-transform: uppercase;">Unit Information</h6>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                                        <input type="checkbox" class="csv-field-checkbox" value="unit_code" checked style="margin-right: 8px; width: 16px; height: 16px;">
                                        Unit Code
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                                        <input type="checkbox" class="csv-field-checkbox" value="unit_name" checked style="margin-right: 8px; width: 16px; height: 16px;">
                                        Unit Name
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                                        <input type="checkbox" class="csv-field-checkbox" value="unit_id" style="margin-right: 8px; width: 16px; height: 16px;">
                                        Unit ID
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Academic Information -->
                            <div style="padding: 12px; background: var(--bg-card); border-radius: 6px; border-left: 3px solid var(--warning-color);">
                                <h6 style="font-size: 11px; font-weight: 700; color: var(--text-primary); margin-bottom: 10px; text-transform: uppercase;">Academic Information</h6>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                                        <input type="checkbox" class="csv-field-checkbox" value="academic_year" checked style="margin-right: 8px; width: 16px; height: 16px;">
                                        Academic Year
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                                        <input type="checkbox" class="csv-field-checkbox" value="semester" checked style="margin-right: 8px; width: 16px; height: 16px;">
                                        Semester
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Results -->
                            <div style="padding: 12px; background: var(--bg-card); border-radius: 6px; border-left: 3px solid var(--danger-color);">
                                <h6 style="font-size: 11px; font-weight: 700; color: var(--text-primary); margin-bottom: 10px; text-transform: uppercase;">Results</h6>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                                        <input type="checkbox" class="csv-field-checkbox" value="cat_marks" checked style="margin-right: 8px; width: 16px; height: 16px;">
                                        CAT Marks
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                                        <input type="checkbox" class="csv-field-checkbox" value="exam_marks" checked style="margin-right: 8px; width: 16px; height: 16px;">
                                        Exam Marks
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                                        <input type="checkbox" class="csv-field-checkbox" value="total_marks" checked style="margin-right: 8px; width: 16px; height: 16px;">
                                        Total Marks
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                                        <input type="checkbox" class="csv-field-checkbox" value="grade" checked style="margin-right: 8px; width: 16px; height: 16px;">
                                        Grade
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Metadata -->
                            <div style="padding: 12px; background: var(--bg-card); border-radius: 6px; border-left: 3px solid var(--secondary-color);">
                                <h6 style="font-size: 11px; font-weight: 700; color: var(--text-primary); margin-bottom: 10px; text-transform: uppercase;">Metadata</h6>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                                        <input type="checkbox" class="csv-field-checkbox" value="status" style="margin-right: 8px; width: 16px; height: 16px;">
                                        Status
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                                        <input type="checkbox" class="csv-field-checkbox" value="submitted_at" style="margin-right: 8px; width: 16px; height: 16px;">
                                        Submitted At
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: var(--text-primary);">
                                        <input type="checkbox" class="csv-field-checkbox" value="entered_by" style="margin-right: 8px; width: 16px; height: 16px;">
                                        Entered By
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                        <!-- Export Button -->
                        <div style="display: flex; gap: 10px; align-items: center; padding-top: 12px; border-top: 1px solid var(--border-color); margin-top: 20px;">
                            <button class="btn btn-success" onclick="exportResultsToCSV()" style="font-size: 14px; padding: 10px 20px; font-weight: 600; box-shadow: var(--shadow-md);">
                                <i class="fas fa-file-csv"></i> Export to CSV
                            </button>
                            <span id="csv-export-status" style="font-size: 13px; color: var(--text-secondary); margin-left: 12px;"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Export Data Tab Content -->
            <div class="export-tab-content" id="export-data-tab-content">
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-download" style="color: var(--info-color); margin-right: 8px;"></i>
                            Export Data to CSV
                        </h3>
                        <p class="card-subtitle" style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">Export Teachers, Units, Courses, and Students data</p>
                    </div>
                    <div class="card-body">
                        <!-- Teachers Export Section -->
                        <div class="export-entity-section" style="margin-bottom: 32px; padding: 20px; background: var(--bg-card-hover); border-radius: var(--border-radius-lg); border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h4 style="margin: 0; color: var(--text-primary); font-size: 16px; font-weight: 600;">
                                    <i class="fas fa-chalkboard-teacher" style="color: var(--accent-lecturers); margin-right: 8px;"></i>
                                    Teachers
                                </h4>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                        <i class="fas fa-user-tag"></i> Role
                                    </label>
                                    <select id="export-teachers-role-filter" class="form-select" style="font-size: 13px; padding: 8px 12px;">
                                        <option value="">All Roles</option>
                                        <option value="lecturer">Lecturer</option>
                                        <option value="college_admin">College Admin</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                        <i class="fas fa-search"></i> Search
                                    </label>
                                    <input type="text" id="export-teachers-search" class="form-input" placeholder="Name, email, or username..." style="font-size: 13px; padding: 8px 12px;">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                        <i class="fas fa-check-circle"></i> Status
                                    </label>
                                    <select id="export-teachers-status-filter" class="form-select" style="font-size: 13px; padding: 8px 12px;">
                                        <option value="">All</option>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="exportTeachersToCSV()" style="font-size: 14px; padding: 10px 20px; font-weight: 600; box-shadow: var(--shadow-md);">
                                <i class="fas fa-file-csv"></i> Export Teachers
                            </button>
                        </div>
                        
                        <!-- Units Export Section -->
                        <div class="export-entity-section" style="margin-bottom: 32px; padding: 20px; background: var(--bg-card-hover); border-radius: var(--border-radius-lg); border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h4 style="margin: 0; color: var(--text-primary); font-size: 16px; font-weight: 600;">
                                    <i class="fas fa-book" style="color: var(--accent-units); margin-right: 8px;"></i>
                                    Units
                                </h4>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                        <i class="fas fa-graduation-cap"></i> Course
                                    </label>
                                    <select id="export-units-course-filter" class="form-select" style="font-size: 13px; padding: 8px 12px;">
                                        <option value="">All Courses</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                        <i class="fas fa-calendar-alt"></i> Academic Year
                                    </label>
                                    <select id="export-units-year-filter" class="form-select" style="font-size: 13px; padding: 8px 12px;">
                                        <option value="">All Years</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                        <i class="fas fa-calendar"></i> Semester
                                    </label>
                                    <select id="export-units-semester-filter" class="form-select" style="font-size: 13px; padding: 8px 12px;">
                                        <option value="">All Semesters</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                        <i class="fas fa-search"></i> Search
                                    </label>
                                    <input type="text" id="export-units-search" class="form-input" placeholder="Unit code or name..." style="font-size: 13px; padding: 8px 12px;">
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="exportUnitsToCSV()" style="font-size: 14px; padding: 10px 20px; font-weight: 600; box-shadow: var(--shadow-md);">
                                <i class="fas fa-file-csv"></i> Export Units
                            </button>
                        </div>
                        
                        <!-- Courses Export Section -->
                        <div class="export-entity-section" style="margin-bottom: 32px; padding: 20px; background: var(--bg-card-hover); border-radius: var(--border-radius-lg); border: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h4 style="margin: 0; color: var(--text-primary); font-size: 16px; font-weight: 600;">
                                    <i class="fas fa-graduation-cap" style="color: var(--accent-courses); margin-right: 8px;"></i>
                                    Courses
                                </h4>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                        <i class="fas fa-calendar-alt"></i> Academic Year
                                    </label>
                                    <select id="export-courses-year-filter" class="form-select" style="font-size: 13px; padding: 8px 12px;">
                                        <option value="">All Years</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                        <i class="fas fa-search"></i> Search
                                    </label>
                                    <input type="text" id="export-courses-search" class="form-input" placeholder="Course name or code..." style="font-size: 13px; padding: 8px 12px;">
                                </div>
                                <div class="form-group" style="margin: 0;">
                                    <label class="form-label" style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">
                                        <i class="fas fa-check-circle"></i> Status
                                    </label>
                                    <select id="export-courses-status-filter" class="form-select" style="font-size: 13px; padding: 8px 12px;">
                                        <option value="">All</option>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="exportCoursesToCSV()" style="font-size: 14px; padding: 10px 20px; font-weight: 600; box-shadow: var(--shadow-md);">
                                <i class="fas fa-file-csv"></i> Export Courses
                            </button>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Academic Configuration Section -->
        <div class="content-section" id="academic-config-section">
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-cog"></i> Academic Configuration
                </h1>
            </div>
            
            <div class="tabs" style="margin-bottom: 24px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 6px;">
                <button class="tab-btn active {% if not user.is_college_admin %}disabled{% endif %}" id="academic-settings-top-tab" onclick="{% if user.is_college_admin %}switchAcademicConfigTab('academic'){% endif %}" {% if not user.is_college_admin %}disabled{% endif %}>
                    <i class="fas fa-calendar-alt"></i> Academic Settings
                </button>
                <button class="tab-btn {% if not user.is_college_admin %}disabled{% endif %}" id="grading-system-top-tab" onclick="{% if user.is_college_admin %}switchAcademicConfigTab('grading'){% endif %}" {% if not user.is_college_admin %}disabled{% endif %}>
                    <i class="fas fa-graduation-cap"></i> Grading System
                </button>
                <button class="tab-btn {% if not user.is_college_admin %}disabled{% endif %}" id="nominal-roll-top-tab" onclick="{% if user.is_college_admin %}switchAcademicConfigTab('nominal'){% endif %}" {% if not user.is_college_admin %}disabled{% endif %}>
                    <i class="fas fa-clipboard-check"></i> Nominal Roll
                </button>
                <button class="tab-btn {% if not user.is_college_admin %}disabled{% endif %}" id="reports-top-tab" onclick="{% if user.is_college_admin %}switchAcademicConfigTab('reports'){% endif %}" {% if not user.is_college_admin %}disabled{% endif %}>
                    <i class="fas fa-file-alt"></i> Reports
                </button>
            </div>

            <!-- Academic Settings Tab Content -->
            <div class="academic-config-tab-content active" id="academic-settings-top-content">
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-calendar-alt"></i> Academic Settings
                        </h3>
                    </div>
                    <div class="card-body">
                        {% if user.is_college_admin %}
                        <form id="academic-settings-form" onsubmit="handleAcademicSettingsSubmit(event)">
                            <div class="form-group">
                                <label class="form-label">Semesters Per Year <span class="required">*</span></label>
                                <input type="number" id="semesters-per-year" class="form-input" min="1" max="12" value="2">
                                <span class="form-help">Number of semesters per academic year (typically 2, 3, or 4)</span>
                                <span class="error-message" id="error-semesters-per-year"></span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Current Academic Year</label>
                                <input type="text" id="academic-year" class="form-input" placeholder="e.g., 2024/2025" pattern="\d{4}/\d{4}">
                                <span class="form-help">Format: YYYY/YYYY (e.g., 2024/2025)</span>
                                <span class="error-message" id="error-academic-year"></span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Current Semester</label>
                                <select id="academic-semester" class="form-select">
                                    <option value="">Select Semester</option>
                                </select>
                                <span class="form-help">Current active semester</span>
                                <span class="error-message" id="error-academic-semester"></span>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Academic Settings
                                </button>
                            </div>
                        </form>
                        {% else %}
                        <p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 40px;">
                            <i class="fas fa-lock" style="font-size: 48px; color: var(--text-gray); margin-bottom: 16px; display: block;"></i>
                            Only college administrators can access academic settings.
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Grading System Tab Content -->
            {% if user.is_college_admin %}
            <div class="academic-config-tab-content" id="grading-system-top-content">
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-graduation-cap"></i> Grading System Settings
                        </h3>
                    </div>
                    <div class="card-body">
                        <form id="grading-system-form" onsubmit="handleGradingSystemSubmit(event)">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                                <div class="form-group">
                                    <label class="form-label">CAT Marks Weight (%) <span class="required">*</span></label>
                                    <input type="number" id="cat-weight" class="form-input" min="0" max="100" step="0.1" value="30">
                                    <span class="form-help">Percentage weight for CAT marks</span>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Exam Marks Weight (%) <span class="required">*</span></label>
                                    <input type="number" id="exam-weight" class="form-input" min="0" max="100" step="0.1" value="70">
                                    <span class="form-help">Percentage weight for exam marks</span>
                                </div>
                            </div>

                            <div class="form-group" style="margin-bottom: 24px;">
                                <label class="form-label">Pass Mark (%)</label>
                                <input type="number" id="pass-mark" class="form-input" min="0" max="100" step="0.1" value="50">
                                <span class="form-help">Minimum score required to pass (marks below this will be flagged for retake)</span>
                            </div>

                            <div class="form-group">
                                <label class="form-label" style="margin-bottom: 12px; display: block;">Grade Thresholds</label>
                                <div id="grade-thresholds-container" style="display: grid; gap: 12px;">
                                    <!-- Grade thresholds will be populated by JavaScript -->
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Grading System
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Nominal Roll Tab Content -->
            <div class="academic-config-tab-content" id="nominal-roll-top-content">
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-clipboard-check"></i> Nominal Roll Sign-In Settings
                        </h3>
                    </div>
                    <div class="card-body">
                        {% if user.is_college_admin %}
                        <form id="nominal-roll-settings-form" onsubmit="handleNominalRollSettingsSubmit(event)">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="nominal-roll-enabled" class="form-checkbox" onchange="toggleNominalRollFields()">
                                    Enable Nominal Roll Sign-In
                                </label>
                                <p class="form-help">When enabled, students can sign in at the beginning of each semester to update their academic progress.</p>
                            </div>

                            <div id="nominal-roll-fields" style="display: none; margin-top: 24px;">
                                <div class="form-group">
                                    <label class="form-label">Current Academic Year <span class="required">*</span></label>
                                    <input type="text" id="current-academic-year" class="form-input" placeholder="e.g., 2024/2025" pattern="\d{4}/\d{4}">
                                    <span class="form-help">Format: YYYY/YYYY (e.g., 2024/2025)</span>
                                    <span class="error-message" id="error-current-academic-year"></span>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Current Semester <span class="required">*</span></label>
                                    <select id="current-semester" class="form-select">
                                        <option value="">Select Semester</option>
                                    </select>
                                    <span class="error-message" id="error-current-semester"></span>
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Settings
                                    </button>
                                </div>
                            </div>
                        </form>

                        <div id="nominal-roll-stats" style="margin-top: 24px; display: none;">
                            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">
                                <div class="stat-card" style="background: var(--bg-light); padding: 16px; border-radius: 8px;">
                                    <div class="stat-label" style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px;">Total Students</div>
                                    <div class="stat-value" id="stat-total-students" style="font-size: 24px; font-weight: 700; color: var(--text-dark);">-</div>
                                </div>
                                <div class="stat-card" style="background: var(--bg-light); padding: 16px; border-radius: 8px;">
                                    <div class="stat-label" style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px;">Signed In</div>
                                    <div class="stat-value" id="stat-signed-in" style="font-size: 24px; font-weight: 700; color: var(--success);">-</div>
                                </div>
                                <div class="stat-card" style="background: var(--bg-light); padding: 16px; border-radius: 8px;">
                                    <div class="stat-label" style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px;">Not Signed In</div>
                                    <div class="stat-value" id="stat-not-signed-in" style="font-size: 24px; font-weight: 700; color: var(--warning);">-</div>
                                </div>
                                <div class="stat-card" style="background: var(--bg-light); padding: 16px; border-radius: 8px;">
                                    <div class="stat-label" style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px;">Percentage</div>
                                    <div class="stat-value" id="stat-percentage" style="font-size: 24px; font-weight: 700; color: var(--primary-blue);">-</div>
                                </div>
                            </div>
                            <div style="margin-top: 16px;">
                                <button class="btn btn-secondary" onclick="viewNominalRollList()">
                                    <i class="fas fa-list"></i> View Sign-In List
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 40px;">
                            <i class="fas fa-lock" style="font-size: 48px; color: var(--text-gray); margin-bottom: 16px; display: block;"></i>
                            Only college administrators can access nominal roll settings.
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Reports Tab Content -->
            <div class="academic-config-tab-content" id="reports-top-content">
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-file-alt"></i> Report Template Configuration</h3>
                        <p class="card-subtitle" style="color: var(--text-light); font-size: 14px; margin-top: 8px;">Configure which template is used for each report type. Reports are generated dynamically from student data.</p>
                    </div>
                    <div class="card-body">
                        {% if user.is_college_admin %}
                        <!-- Report Template Mapping Form -->
                        <form id="report-template-mapping-form" onsubmit="handleReportTemplateMappingSubmit(event)">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-graduation-cap"></i> Transcript Template
                                </label>
                                <select id="transcript-template-select" class="form-select">
                                    <option value="">-- Select Template --</option>
                                </select>
                                <span class="form-help">Select which template to use for Transcript reports</span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-money-bill-wave"></i> Fee Structure Template
                                </label>
                                <select id="fee-structure-template-select" class="form-select">
                                    <option value="">-- Select Template --</option>
                                </select>
                                <span class="form-help">Select which template to use for Fee Structure reports</span>
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-file-signature"></i> Exam Card Template
                                </label>
                                <select id="exam-card-template-select" class="form-select">
                                    <option value="">-- Select Template --</option>
                                </select>
                                <span class="form-help">Select which template to use for Exam Card reports</span>
                            </div>

                            <div class="form-actions" style="margin-top: 24px;">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Template Mappings
                                </button>
                            </div>
                        </form>
                        
                        <div id="report-template-mapping-status" style="margin-top: 16px;"></div>
                        
                        <!-- Design Templates Button -->
                        <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border-color);">
                            <button class="btn btn-primary" onclick="openReportEditorModal()" style="display: flex; align-items: center; gap: 8px; padding: 12px 24px; font-size: 15px; font-weight: 600;">
                                <i class="fas fa-paint-brush"></i>
                                <span>Design Templates</span>
                            </button>
                            <p style="color: var(--text-light); font-size: 13px; margin-top: 8px;">
                                <i class="fas fa-info-circle"></i> Click to open the Report Editor and customize your report templates
                            </p>
                        </div>
                        {% else %}
                        <p style="color: var(--text-light); font-size: 14px; text-align: center; padding: 40px;">
                            <i class="fas fa-lock" style="font-size: 48px; color: var(--text-gray); margin-bottom: 16px; display: block;"></i>
                            Only college administrators can access transcript template settings.
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Editor Section -->
        <div class="content-section" id="report-section">
            <div class="page-header">
                <div>
                    <h1 class="page-title">Report Editor</h1>
                    <p class="page-subtitle">Design and customize report templates</p>
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <label style="font-size: 14px; font-weight: 500; color: var(--text-dark);">Page Size:</label>
                    <select id="page-size-selector" class="form-input" onchange="handlePageSizeChange()" style="min-width: 150px; padding: 8px 12px;">
                        <option value="A4" selected>A4 (794  1123 px)</option>
                        <option value="A3">A3 (1123  1587 px)</option>
                        <option value="A5">A5 (559  794 px)</option>
                        <option value="Letter">Letter (816  1056 px)</option>
                    </select>
                </div>
            </div>

            <!-- Mobile Message -->
            <div class="report-editor-mobile-message">
                <i class="fas fa-desktop"></i>
                <h2>Use Desktop To Design Reports</h2>
                <p>The report editor is optimized for desktop screens. Please use a desktop or laptop computer to design and customize report templates.</p>
            </div>

            <div class="report-editor-container" style="display: flex; gap: 20px; height: calc(100vh - 200px);">
                <!-- Left Sidebar: Templates List & Tools -->
                <div class="report-editor-sidebar" style="width: 300px; background: var(--bg-white); border-radius: 8px; padding: 20px; overflow-y: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <!-- Templates List -->
                    <div style="margin-bottom: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Templates</h3>
                            {% if user.is_principal or user.is_registrar %}
                            <button class="btn btn-primary" onclick="openNewTemplateModal()" style="padding: 6px 12px; font-size: 12px;">
                                <i class="fas fa-plus"></i> New
                            </button>
                            {% endif %}
                        </div>
                        <div id="report-templates-list" style="display: flex; flex-direction: column; gap: 8px;">
                            <div class="loading-row" style="text-align: center; padding: 20px;">
                                <i class="fas fa-spinner fa-spin"></i> Loading templates...
                            </div>
                        </div>
                    </div>

                    <!-- Editing Tools (only visible when template is selected and user can edit) -->
                    <div id="report-editor-tools" style="display: none;">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">Add Elements</h3>
                        <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 24px;">
                            <button class="btn btn-secondary" onclick="addTextElement()" style="width: 100%; justify-content: flex-start;">
                                <i class="fas fa-font"></i> Add Text Box
                            </button>
                            <button class="btn btn-secondary" onclick="addImageElement()" style="width: 100%; justify-content: flex-start;">
                                <i class="fas fa-image"></i> Add Image
                            </button>
                            <button class="btn btn-secondary" onclick="addLogoElement()" style="width: 100%; justify-content: flex-start;">
                                <i class="fas fa-certificate"></i> Add Logo
                            </button>
                        </div>

                        <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600; margin-top: 24px;">Placeholders & Objects</h3>
                        <div id="placeholders-list" style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px;">
                            <button class="btn btn-secondary placeholder-btn" data-placeholder="student.full_name" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                <i class="fas fa-user"></i> Student Name
                            </button>
                            <button class="btn btn-secondary placeholder-btn" data-placeholder="student.admission_number" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                <i class="fas fa-id-card"></i> Admission No
                            </button>
                            <button class="btn btn-secondary placeholder-btn" data-placeholder="student.course_name" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                <i class="fas fa-graduation-cap"></i> Course
                            </button>
                            <button class="btn btn-secondary placeholder-btn" data-placeholder="student.year_of_study" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                <i class="fas fa-calendar-alt"></i> Year of Study
                            </button>
                            <button class="btn btn-secondary placeholder-btn" data-placeholder="college.name" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                <i class="fas fa-building"></i> College Name
                            </button>
                            <button class="btn btn-secondary placeholder-btn" data-placeholder="generation_date" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                <i class="fas fa-calendar"></i> Date
                            </button>
                            <button class="btn btn-secondary placeholder-btn" data-placeholder="academic_year" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                <i class="fas fa-calendar-check"></i> Academic Year
                            </button>
                            <button class="btn btn-secondary placeholder-btn" data-placeholder="semester" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                <i class="fas fa-calendar-week"></i> Semester
                            </button>
                            <button class="btn btn-secondary placeholder-btn" data-placeholder="table.results" data-type="table" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                <i class="fas fa-table"></i> Results Table
                            </button>
                            <button class="btn btn-secondary placeholder-btn" data-placeholder="table.registered_units" data-type="table" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                <i class="fas fa-list"></i> Units Table
                            </button>
                            <button class="btn btn-secondary placeholder-btn" data-placeholder="table.fee_structure" data-type="table" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                <i class="fas fa-money-bill-wave"></i> Fees Table
                            </button>
                        </div>

                        <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">Element Properties</h3>
                        <div id="element-properties-panel" style="display: none;">
                            <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Element Properties</h3>
                            
                            <!-- Font Controls -->
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label class="form-label" style="font-size: 12px;">Font Family</label>
                                <select id="element-font-family" class="form-input" onchange="updateSelectedElement()" style="font-size: 12px; padding: 6px;">
                                    <option value="Arial">Arial</option>
                                    <option value="Times New Roman">Times New Roman</option>
                                    <option value="Courier New">Courier New</option>
                                    <option value="Helvetica">Helvetica</option>
                                    <option value="Georgia">Georgia</option>
                                    <option value="Verdana">Verdana</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label class="form-label" style="font-size: 12px;">Font Size</label>
                                <input type="number" id="element-font-size" class="form-input" min="8" max="72" value="12" onchange="updateSelectedElement()" style="font-size: 12px; padding: 6px;">
                            </div>
                            
                            <!-- Font Style Controls -->
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label class="form-label" style="font-size: 12px;">Font Style</label>
                                <div style="display: flex; gap: 4px;">
                                    <button id="element-bold-btn" class="btn btn-secondary" onclick="toggleFontStyle('bold')" style="flex: 1; padding: 6px;" title="Bold">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button id="element-italic-btn" class="btn btn-secondary" onclick="toggleFontStyle('italic')" style="flex: 1; padding: 6px;" title="Italic">
                                        <i class="fas fa-italic"></i>
                                    </button>
                                    <button id="element-underline-btn" class="btn btn-secondary" onclick="toggleFontStyle('underline')" style="flex: 1; padding: 6px;" title="Underline">
                                        <i class="fas fa-underline"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Text Alignment -->
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label class="form-label" style="font-size: 12px;">Text Alignment</label>
                                <div style="display: flex; gap: 4px;">
                                    <button class="btn btn-secondary" onclick="setTextAlignment('left')" style="flex: 1; padding: 6px;" title="Align Left">
                                        <i class="fas fa-align-left"></i>
                                    </button>
                                    <button class="btn btn-secondary" onclick="setTextAlignment('center')" style="flex: 1; padding: 6px;" title="Align Center">
                                        <i class="fas fa-align-center"></i>
                                    </button>
                                    <button class="btn btn-secondary" onclick="setTextAlignment('right')" style="flex: 1; padding: 6px;" title="Align Right">
                                        <i class="fas fa-align-right"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Color Controls -->
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label class="form-label" style="font-size: 12px;">Text Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="element-text-color" value="#000000" onchange="updateSelectedElement()" style="width: 50px; height: 32px; border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">
                                    <input type="text" id="element-text-color-hex" value="#000000" onchange="updateColorFromHex('text')" style="flex: 1; padding: 6px; font-size: 12px; font-family: monospace;" placeholder="#000000">
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 12px;" id="element-bg-color-group" style="display: none;">
                                <label class="form-label" style="font-size: 12px;">Background Color</label>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="color" id="element-bg-color" value="#ffffff" onchange="updateSelectedElement()" style="width: 50px; height: 32px; border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">
                                    <input type="text" id="element-bg-color-hex" value="#ffffff" onchange="updateColorFromHex('bg')" style="flex: 1; padding: 6px; font-size: 12px; font-family: monospace;" placeholder="#ffffff">
                                </div>
                            </div>
                            
                            <!-- Position Controls -->
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label class="form-label" style="font-size: 12px;">Position</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <div>
                                        <label style="font-size: 11px; color: var(--text-light);">X</label>
                                        <input type="number" id="element-x" class="form-input" min="0" value="0" onchange="updateSelectedElement()" style="font-size: 12px; padding: 6px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 11px; color: var(--text-light);">Y</label>
                                        <input type="number" id="element-y" class="form-input" min="0" value="0" onchange="updateSelectedElement()" style="font-size: 12px; padding: 6px;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Size Controls (for resizable elements) -->
                            <div class="form-group" style="margin-bottom: 12px; display: none;" id="element-size-group">
                                <label class="form-label" style="font-size: 12px;">Size</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                    <div>
                                        <label style="font-size: 11px; color: var(--text-light);">Width</label>
                                        <input type="number" id="element-width" class="form-input" min="20" value="200" onchange="updateSelectedElement()" style="font-size: 12px; padding: 6px;">
                                    </div>
                                    <div>
                                        <label style="font-size: 11px; color: var(--text-light);">Height</label>
                                        <input type="number" id="element-height" class="form-input" min="20" value="200" onchange="updateSelectedElement()" style="font-size: 12px; padding: 6px;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Content -->
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label class="form-label" style="font-size: 12px;">Content</label>
                                <textarea id="element-content" class="form-input" rows="3" onchange="updateSelectedElement()" style="font-size: 12px; padding: 6px; resize: vertical;"></textarea>
                            </div>
                            <button class="btn btn-danger" onclick="deleteSelectedElement()" style="width: 100%;">
                                <i class="fas fa-trash"></i> Delete Element
                            </button>
                            <button class="btn btn-primary" onclick="saveTemplateElements()" style="width: 100%; margin-top: 8px;">
                                <i class="fas fa-save"></i> Save Elements
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Center: Canvas Area with Top Toolbar -->
                <div style="flex: 1; display: flex; flex-direction: column; gap: 12px;">
                    <!-- Top Toolbar (Fixed) -->
                    <div id="canvas-toolbar" style="background: var(--bg-white); border-radius: 8px; padding: 12px 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                        <!-- Canvas Settings Group -->
                        <div style="display: flex; align-items: center; gap: 12px; padding-right: 16px; border-right: 1px solid var(--border-color);">
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); white-space: nowrap;">Page Size:</label>
                            <select id="page-size-selector-toolbar" class="form-input" onchange="handlePageSizeChange()" style="font-size: 12px; padding: 6px 10px; min-width: 140px;">
                                <option value="A4" selected>A4 (794  1123 px)</option>
                                <option value="A3">A3 (1123  1587 px)</option>
                                <option value="A5">A5 (559  794 px)</option>
                                <option value="Letter">Letter (816  1056 px)</option>
                            </select>
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); white-space: nowrap;">Width:</label>
                            <input type="number" id="canvas-width-toolbar" class="form-input" min="200" max="2000" value="794" onchange="updateCanvasSize()" style="font-size: 12px; padding: 6px; width: 80px;">
                            <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary); white-space: nowrap;">Height:</label>
                            <input type="number" id="canvas-height-toolbar" class="form-input" min="200" max="3000" value="1123" onchange="updateCanvasSize()" style="font-size: 12px; padding: 6px; width: 80px;">
                        </div>
                        
                        <!-- Zoom Controls -->
                        <div style="display: flex; align-items: center; gap: 8px; padding-right: 16px; border-right: 1px solid var(--border-color);">
                            <button class="btn btn-secondary" onclick="zoomCanvas(-10)" style="padding: 6px 10px; font-size: 12px;" title="Zoom Out">
                                <i class="fas fa-search-minus"></i>
                            </button>
                            <span id="canvas-zoom-level" style="font-size: 12px; font-weight: 600; min-width: 50px; text-align: center;">100%</span>
                            <button class="btn btn-secondary" onclick="zoomCanvas(10)" style="padding: 6px 10px; font-size: 12px;" title="Zoom In">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="btn btn-secondary" onclick="resetZoom()" style="padding: 6px 10px; font-size: 12px;" title="Reset Zoom">
                                <i class="fas fa-expand-arrows-alt"></i>
                            </button>
                        </div>
                        
                        <!-- View Controls -->
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label class="form-label" style="font-size: 12px; display: flex; align-items: center; gap: 6px; margin: 0; cursor: pointer;">
                                <input type="checkbox" id="toggle-grid" checked onchange="toggleGrid()" style="margin: 0;">
                                <span>Grid</span>
                            </label>
                            <label class="form-label" style="font-size: 12px; display: flex; align-items: center; gap: 6px; margin: 0; cursor: pointer;">
                                <input type="checkbox" id="toggle-margins" checked onchange="toggleMargins()" style="margin: 0;">
                                <span>Margins</span>
                            </label>
                            <label class="form-label" style="font-size: 12px; display: flex; align-items: center; gap: 6px; margin: 0; cursor: pointer;">
                                <input type="checkbox" id="snap-to-guides-toolbar" checked onchange="updateSnapToGuides()" style="margin: 0;">
                                <span>Snap</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Canvas Area (Scrollable) -->
                    <div class="report-editor-canvas-container" style="flex: 1; background: var(--bg-light); border-radius: 8px; padding: 20px; overflow: auto; position: relative;">
                        <div id="report-canvas-wrapper" style="background: white; margin: 0 auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15); position: relative; min-height: 400px; transform-origin: top center;">
                            <div id="report-canvas" style="position: relative; background: white; width: 794px; height: 1123px; margin: 0 auto;">
                                <!-- Alignment Guides Overlay -->
                                <div id="canvas-guides" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                                    <!-- Center lines and margin guides will be drawn here -->
                                </div>
                                <div style="text-align: center; padding: 40px; color: var(--text-light);">
                                    <i class="fas fa-file-alt" style="font-size: 48px; margin-bottom: 16px;"></i>
                                    <p>Select or create a template to start editing</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Sidebar: Template Settings & Save -->
                <div class="report-editor-settings" style="width: 250px; background: var(--bg-white); border-radius: 8px; padding: 20px; overflow-y: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Template Settings</h3>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label" style="font-size: 12px;">Template Name</label>
                        <input type="text" id="template-name" class="form-input" placeholder="Enter template name" style="font-size: 12px; padding: 6px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label" style="font-size: 12px;">Description</label>
                        <textarea id="template-description" class="form-input" rows="3" placeholder="Template description" style="font-size: 12px; padding: 6px; resize: vertical;"></textarea>
                    </div>
                    <div class="form-group" style="margin-bottom: 12px;">
                        <label class="form-label" style="font-size: 12px;">Report Type</label>
                        <select id="template-report-type" class="form-input" style="font-size: 12px; padding: 6px;">
                            <option value="custom">Custom Report</option>
                            <option value="transcript">Transcript</option>
                            <option value="certificate">Certificate</option>
                            <option value="result_slip">Result Slip</option>
                        </select>
                    </div>
                    {% if user.is_principal or user.is_registrar %}
                    <div style="display: flex; gap: 8px; margin-top: 16px;">
                        <button class="btn btn-primary" onclick="saveReportTemplate()" style="flex: 1;">
                        <i class="fas fa-save"></i> Save Template
                    </button>
                        <button class="btn btn-secondary" onclick="openMoreDataDialog()" style="flex: 1;" title="Add More Data Objects">
                            <i class="fas fa-database"></i> More Data
                        </button>
                    </div>
                    <button class="btn btn-secondary" onclick="loadReportTemplate()" style="width: 100%; margin-top: 8px;">
                        <i class="fas fa-sync"></i> Reload
                    </button>
                    {% else %}
                    <div style="padding: 12px; background: var(--bg-hover); border-radius: 6px; font-size: 12px; color: var(--text-light); text-align: center;">
                        <i class="fas fa-lock"></i> View Only Mode
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Report Editor Modal -->
        <div class="modal" id="report-editor-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Report Editor</h2>
                    <button class="modal-close" onclick="closeReportEditorModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="page-header" style="margin-bottom: 24px; padding: 20px 24px 0; border-bottom: 1px solid var(--border-color);">
                        <div>
                            <p class="page-subtitle" style="margin-top: 4px;">Design and customize report templates</p>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <label style="font-size: 14px; font-weight: 500; color: var(--text-dark);">Page Size:</label>
                            <select id="modal-page-size-selector" class="form-input" onchange="handlePageSizeChange()" style="min-width: 150px; padding: 8px 12px;">
                                <option value="A4" selected>A4 (794  1123 px)</option>
                                <option value="A3">A3 (1123  1587 px)</option>
                                <option value="A5">A5 (559  794 px)</option>
                                <option value="Letter">Letter (816  1056 px)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Mobile Message for Modal -->
                    <div class="report-editor-mobile-message" style="margin: 20px;">
                        <i class="fas fa-desktop"></i>
                        <h2>Use Desktop To Design Reports</h2>
                        <p>The report editor is optimized for desktop screens. Please use a desktop or laptop computer to design and customize report templates.</p>
                    </div>

                    <div class="report-editor-container" style="display: flex; gap: 20px; height: 100%; padding: 20px;">
                        <!-- Left Sidebar: Templates List & Tools -->
                        <div class="report-editor-sidebar" style="width: 300px; background: var(--bg-white); border-radius: 8px; padding: 20px; overflow-y: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <!-- Templates List -->
                            <div style="margin-bottom: 24px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Templates</h3>
                                    {% if user.is_principal or user.is_registrar %}
                                    <button class="btn btn-primary" onclick="openNewTemplateModal()" style="padding: 6px 12px; font-size: 12px;">
                                        <i class="fas fa-plus"></i> New
                                    </button>
                                    {% endif %}
                                </div>
                                <div id="modal-report-templates-list" style="display: flex; flex-direction: column; gap: 8px;">
                                    <div class="loading-row" style="text-align: center; padding: 20px;">
                                        <i class="fas fa-spinner fa-spin"></i> Loading templates...
                                    </div>
                                </div>
                            </div>

                            <!-- Editing Tools (only visible when template is selected and user can edit) -->
                            <div id="modal-report-editor-tools" style="display: none;">
                                <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">Add Elements</h3>
                                <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 24px;">
                                    <button class="btn btn-secondary" onclick="addTextElement()" style="width: 100%; justify-content: flex-start;">
                                        <i class="fas fa-font"></i> Add Text Box
                                    </button>
                                    <button class="btn btn-secondary" onclick="addImageElement()" style="width: 100%; justify-content: flex-start;">
                                        <i class="fas fa-image"></i> Add Image
                                    </button>
                                    <button class="btn btn-secondary" onclick="addLogoElement()" style="width: 100%; justify-content: flex-start;">
                                        <i class="fas fa-certificate"></i> Add Logo
                                    </button>
                                </div>

                                <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600; margin-top: 24px;">Placeholders & Objects</h3>
                                <div id="modal-placeholders-list" style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px;">
                                    <button class="btn btn-secondary placeholder-btn" data-placeholder="student.full_name" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                        <i class="fas fa-user"></i> Student Name
                                    </button>
                                    <button class="btn btn-secondary placeholder-btn" data-placeholder="student.admission_number" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                        <i class="fas fa-id-card"></i> Admission No
                                    </button>
                                    <button class="btn btn-secondary placeholder-btn" data-placeholder="student.course_name" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                        <i class="fas fa-graduation-cap"></i> Course
                                    </button>
                                    <button class="btn btn-secondary placeholder-btn" data-placeholder="student.year_of_study" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                        <i class="fas fa-calendar-alt"></i> Year of Study
                                    </button>
                                    <button class="btn btn-secondary placeholder-btn" data-placeholder="college.name" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                        <i class="fas fa-building"></i> College Name
                                    </button>
                                    <button class="btn btn-secondary placeholder-btn" data-placeholder="generation_date" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                        <i class="fas fa-calendar"></i> Date
                                    </button>
                                    <button class="btn btn-secondary placeholder-btn" data-placeholder="academic_year" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                        <i class="fas fa-calendar-check"></i> Academic Year
                                    </button>
                                    <button class="btn btn-secondary placeholder-btn" data-placeholder="semester" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                        <i class="fas fa-calendar-week"></i> Semester
                                    </button>
                                    <button class="btn btn-secondary placeholder-btn" data-placeholder="table.results" data-type="table" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                        <i class="fas fa-table"></i> Results Table
                                    </button>
                                    <button class="btn btn-secondary placeholder-btn" data-placeholder="table.registered_units" data-type="table" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                        <i class="fas fa-list"></i> Units Table
                                    </button>
                                    <button class="btn btn-secondary placeholder-btn" data-placeholder="table.fee_structure" data-type="table" style="width: 100%; justify-content: flex-start; font-size: 12px; padding: 8px;">
                                        <i class="fas fa-money-bill-wave"></i> Fees Table
                                    </button>
                                </div>

                                <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">Element Properties</h3>
                                <div id="modal-element-properties-panel" style="display: none;">
                                    <div class="form-group" style="margin-bottom: 12px;">
                                        <label class="form-label" style="font-size: 12px;">Font Family</label>
                                        <select id="modal-element-font-family" class="form-input" onchange="updateSelectedElement()" style="font-size: 12px; padding: 6px;">
                                            <option value="Arial">Arial</option>
                                            <option value="Times New Roman">Times New Roman</option>
                                            <option value="Courier New">Courier New</option>
                                            <option value="Helvetica">Helvetica</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="Verdana">Verdana</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="margin-bottom: 12px;">
                                        <label class="form-label" style="font-size: 12px;">Font Size</label>
                                        <input type="number" id="modal-element-font-size" class="form-input" min="8" max="72" value="12" onchange="updateSelectedElement()" style="font-size: 12px; padding: 6px;">
                                    </div>
                                    <div class="form-group" style="margin-bottom: 12px;">
                                        <label class="form-label" style="font-size: 12px;">Text Alignment</label>
                                        <div style="display: flex; gap: 4px;">
                                            <button class="btn btn-secondary" onclick="setTextAlignment('left')" style="flex: 1; padding: 6px;">
                                                <i class="fas fa-align-left"></i>
                                            </button>
                                            <button class="btn btn-secondary" onclick="setTextAlignment('center')" style="flex: 1; padding: 6px;">
                                                <i class="fas fa-align-center"></i>
                                            </button>
                                            <button class="btn btn-secondary" onclick="setTextAlignment('right')" style="flex: 1; padding: 6px;">
                                                <i class="fas fa-align-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin-bottom: 12px;">
                                        <label class="form-label" style="font-size: 12px;">X Position</label>
                                        <input type="number" id="modal-element-x" class="form-input" min="0" value="0" onchange="updateSelectedElement()" style="font-size: 12px; padding: 6px;">
                                    </div>
                                    <div class="form-group" style="margin-bottom: 12px;">
                                        <label class="form-label" style="font-size: 12px;">Y Position</label>
                                        <input type="number" id="modal-element-y" class="form-input" min="0" value="0" onchange="updateSelectedElement()" style="font-size: 12px; padding: 6px;">
                                    </div>
                                    <div class="form-group" style="margin-bottom: 12px;">
                                        <label class="form-label" style="font-size: 12px;">Content</label>
                                        <textarea id="modal-element-content" class="form-input" rows="3" onchange="updateSelectedElement()" style="font-size: 12px; padding: 6px; resize: vertical;"></textarea>
                                    </div>
                                    <button class="btn btn-danger" onclick="deleteSelectedElement()" style="width: 100%;">
                                        <i class="fas fa-trash"></i> Delete Element
                                    </button>
                                    <!-- Table Column Management (only for table elements) -->
                                    <div id="modal-table-columns-section" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                                        <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600;">Table Columns</h4>
                                        <div id="modal-table-columns-list" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; max-height: 300px; overflow-y: auto;">
                                            <!-- Columns will be listed here -->
                                </div>
                                        <button class="btn btn-secondary" onclick="addTableColumn()" style="width: 100%; font-size: 12px; padding: 6px;">
                                            <i class="fas fa-plus"></i> Add Column
                                        </button>
                                    </div>
                                    <button class="btn btn-primary" onclick="saveTemplateElements()" style="width: 100%; margin-top: 8px;">
                                        <i class="fas fa-save"></i> Save Elements
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Center: Canvas Area -->
                        <div class="report-editor-canvas-container" style="flex: 1; background: var(--bg-light); border-radius: 8px; padding: 20px; overflow: auto; position: relative;">
                            <div id="modal-report-canvas-wrapper" style="background: white; margin: 0 auto; box-shadow: 0 4px 12px rgba(0,0,0,0.15); position: relative; min-height: 400px;">
                                <div id="modal-report-canvas" style="position: relative; background: white; width: 794px; height: 1123px; margin: 0 auto;">
                                    <!-- Alignment Guides Overlay -->
                                    <div id="modal-canvas-guides" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                                        <!-- Center lines and margin guides will be drawn here -->
                                    </div>
                                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                                        <i class="fas fa-file-alt" style="font-size: 48px; margin-bottom: 16px;"></i>
                                        <p>Select or create a template to start editing</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Sidebar: Canvas Settings & Save -->
                        <div class="report-editor-settings" style="width: 250px; background: var(--bg-white); border-radius: 8px; padding: 20px; overflow-y: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">Canvas Settings</h3>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label class="form-label" style="font-size: 12px;">Page Size</label>
                                <select id="modal-page-size-selector-sidebar" class="form-input" onchange="handlePageSizeChange()" style="font-size: 12px; padding: 6px;">
                                    <option value="A4" selected>A4 (794  1123 px)</option>
                                    <option value="A3">A3 (1123  1587 px)</option>
                                    <option value="A5">A5 (559  794 px)</option>
                                    <option value="Letter">Letter (816  1056 px)</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label class="form-label" style="font-size: 12px;">Width (px)</label>
                                <input type="number" id="modal-canvas-width" class="form-input" min="200" max="2000" value="794" onchange="updateCanvasSize()" style="font-size: 12px; padding: 6px;">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label class="form-label" style="font-size: 12px;">Height (px)</label>
                                <input type="number" id="modal-canvas-height" class="form-input" min="200" max="3000" value="1123" onchange="updateCanvasSize()" style="font-size: 12px; padding: 6px;">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label class="form-label" style="font-size: 12px; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="modal-toggle-grid" checked onchange="toggleGrid()" style="margin: 0;">
                                    <span>Grid</span>
                                </label>
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label class="form-label" style="font-size: 12px; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="modal-toggle-margins" checked onchange="toggleMargins()" style="margin: 0;">
                                    <span>Margins</span>
                                </label>
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label class="form-label" style="font-size: 12px; display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="modal-snap-to-guides" checked style="margin: 0;">
                                    <span>Snap to Guides</span>
                                </label>
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label class="form-label" style="font-size: 12px;">Template Name</label>
                                <input type="text" id="modal-template-name" class="form-input" placeholder="Enter template name" style="font-size: 12px; padding: 6px;">
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label class="form-label" style="font-size: 12px;">Description</label>
                                <textarea id="modal-template-description" class="form-input" rows="3" placeholder="Template description" style="font-size: 12px; padding: 6px; resize: vertical;"></textarea>
                            </div>
                            <div class="form-group" style="margin-bottom: 12px;">
                                <label class="form-label" style="font-size: 12px;">Report Type</label>
                                <select id="modal-template-report-type" class="form-input" style="font-size: 12px; padding: 6px;">
                                    <option value="custom">Custom Report</option>
                                    <option value="transcript">Transcript</option>
                                    <option value="certificate">Certificate</option>
                                    <option value="result_slip">Result Slip</option>
                                </select>
                            </div>
                            {% if user.is_principal or user.is_registrar %}
                            <div style="display: flex; gap: 8px; margin-top: 16px;">
                                <button class="btn btn-primary" onclick="saveReportTemplate()" style="flex: 1;">
                                <i class="fas fa-save"></i> Save Template
                            </button>
                                <button class="btn btn-secondary" onclick="openMoreDataDialog()" style="flex: 1;" title="Add More Data Objects">
                                    <i class="fas fa-database"></i> More Data
                                </button>
                            </div>
                            <button class="btn btn-secondary" onclick="loadReportTemplate()" style="width: 100%; margin-top: 8px;">
                                <i class="fas fa-sync"></i> Reload
                            </button>
                            {% else %}
                            <div style="padding: 12px; background: var(--bg-hover); border-radius: 6px; font-size: 12px; color: var(--text-light); text-align: center;">
                                <i class="fas fa-lock"></i> View Only Mode
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- More Data Dialog -->
        <div class="modal" id="more-data-dialog" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">Add Data Objects</h2>
                    <button class="modal-close" onclick="closeMoreDataDialog()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 16px; color: var(--text-light); font-size: 14px;">
                        Select data objects to add as placeholders to your report. These will be replaced with actual data during export.
                    </p>
                    <div id="data-objects-list" style="max-height: 400px; overflow-y: auto;">
                        <!-- Data objects will be populated here -->
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 8px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeMoreDataDialog()">Cancel</button>
                        <button class="btn btn-primary" onclick="addSelectedDataObjects()">Add Selected</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="content-section" id="settings-section">
            <div class="page-header">
                <h1 class="page-title">Settings</h1>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" id="profile-settings-tab" onclick="switchSettingsTab('profile')">
                    <i class="fas fa-user"></i> Profile Settings
                </button>
                {% if user.is_college_admin %}
                <button class="tab-btn" id="user-management-tab" onclick="switchSettingsTab('user-management')">
                    <i class="fas fa-users-cog"></i> User Management
                </button>
                {% endif %}
                <button class="tab-btn" id="college-settings-tab" onclick="switchSettingsTab('college')">
                    <i class="fas fa-school"></i> College Settings
                </button>
            </div>

            <!-- Profile Settings Tab -->
            <div class="tab-content active" id="profile-settings-tab-content">
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">Profile Settings</h3>
                    </div>
                    <div class="card-body">
                        <form id="profile-settings-form" onsubmit="handleProfileSubmit(event)">
                            <div class="form-group">
                                <label class="form-label">Username</label>
                                <input type="text" id="profile-username" class="form-input" value="{{ user.username }}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" id="profile-email" class="form-input" value="{{ user.email }}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <input type="tel" id="profile-phone" class="form-input" value="{{ user.phone|default:'' }}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Change Password</label>
                                <input type="password" id="profile-password" class="form-input" placeholder="Leave blank to keep current password">
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- User Management Tab (only for college admins) -->
            {% if user.is_college_admin %}
            <div class="tab-content" id="user-management-tab-content">
                <div class="content-card">
                    <div class="card-header">
                        <div>
                            <h3 class="card-title">User Management</h3>
                            <p class="card-subtitle" style="color: var(--text-light); font-size: 14px; margin-top: 8px;">Manage users and their roles</p>
                        </div>
                        <button class="btn btn-primary" onclick="openAddUserModal()">
                            <i class="fas fa-user-plus"></i> Add User
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Search -->
                        <div class="search-box" style="margin-bottom: 20px;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="user-management-search" placeholder="Search users..." onkeyup="searchUserManagement()">
                        </div>
                        
                        <!-- Users Table -->
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Current Role</th>
                                        <th>Assigned Units</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="user-management-tbody">
                                    <tr>
                                        <td colspan="7" class="loading-row">
                                            <i class="fas fa-spinner fa-spin"></i> Loading users...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination" id="user-management-pagination"></div>
                        
                        <div style="margin-top: 20px; padding: 16px; background: var(--bg-hover); border-radius: 8px;">
                            <p style="margin: 0; color: var(--text-light); font-size: 14px;">
                                <i class="fas fa-info-circle"></i> 
                                <strong>College Admins</strong> can edit all sections. 
                                <strong>Lecturers</strong> have read-only access (except for results of their assigned units).
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- College Settings Tab -->
            <div class="tab-content" id="college-settings-tab-content">
                <!-- Inner Tabs for College Settings -->
                <div class="tabs" style="margin-bottom: 24px;">
                    <button class="tab-btn active" id="college-info-inner-tab" onclick="switchCollegeSettingsTab('info')">
                        <i class="fas fa-school"></i> College Information
                    </button>
                    {% if user.is_college_admin %}
                    <button class="tab-btn" id="academic-settings-inner-tab" onclick="switchCollegeSettingsTab('academic')">
                        <i class="fas fa-calendar-alt"></i> Academic Settings
                    </button>
                    <button class="tab-btn" id="grading-system-inner-tab" onclick="switchCollegeSettingsTab('grading')">
                        <i class="fas fa-graduation-cap"></i> Grading System
                    </button>
                    <button class="tab-btn" id="nominal-roll-inner-tab" onclick="switchCollegeSettingsTab('nominal')">
                        <i class="fas fa-clipboard-check"></i> Nominal Roll
                    </button>
                    <button class="tab-btn" id="transcript-template-inner-tab" onclick="switchCollegeSettingsTab('transcript')">
                        <i class="fas fa-file-pdf"></i> Transcript Template
                    </button>
                    {% endif %}
                </div>

                <!-- College Information Tab Content -->
                <div class="college-settings-tab-content active" id="college-info-tab-content">
                <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">College Information</h3>
                        {% if user.is_college_admin %}
                        <button class="btn btn-secondary" id="edit-college-btn" onclick="toggleCollegeEditMode()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-primary" id="save-college-btn" onclick="saveCollegeInfo()" style="display: none;">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button class="btn btn-secondary" id="cancel-college-btn" onclick="cancelCollegeEdit()" style="display: none;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        <!-- Display Mode -->
                        <div id="college-info-display" class="settings-display">
                            <div class="setting-item">
                                <label>College Name:</label>
                                <span id="display-college-name">{{ college.name }}</span>
                            </div>
                            <div class="setting-item">
                                <label>Address:</label>
                                <span id="display-college-address">{{ college.address }}</span>
                            </div>
                            <div class="setting-item">
                                <label>County:</label>
                                <span id="display-college-county">{{ college.county }}</span>
                            </div>
                            <div class="setting-item">
                                <label>Email:</label>
                                <span id="display-college-email">{{ college.email }}</span>
                            </div>
                            <div class="setting-item">
                                <label>Phone:</label>
                                <span id="display-college-phone">{{ college.phone }}</span>
                            </div>
                            <div class="setting-item">
                                <label>Principal Name:</label>
                                <span id="display-college-principal">{{ college.principal_name }}</span>
                            </div>
                            <div class="setting-item">
                                <label>Status:</label>
                                <span class="badge badge-{{ college.registration_status }}" id="display-college-status">{{ college.get_registration_status_display }}</span>
                            </div>
                        </div>
                        
                        <!-- Edit Mode -->
                        <form id="college-info-form" style="display: none;" onsubmit="saveCollegeInfo(event)">
                            <div class="form-group">
                                <label class="form-label">College Name <span class="required">*</span></label>
                                <input type="text" id="edit-college-name" class="form-input" value="{{ college.name }}" required>
                                <span class="error-message" id="error-college-name"></span>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Address <span class="required">*</span></label>
                                <textarea id="edit-college-address" class="form-input" rows="3" required>{{ college.address }}</textarea>
                                <span class="error-message" id="error-college-address"></span>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">County <span class="required">*</span></label>
                                <input type="text" id="edit-college-county" class="form-input" value="{{ college.county }}" required>
                                <span class="error-message" id="error-college-county"></span>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Email <span class="required">*</span></label>
                                <input type="email" id="edit-college-email" class="form-input" value="{{ college.email }}" required>
                                <span class="error-message" id="error-college-email"></span>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Phone <span class="required">*</span></label>
                                <input type="tel" id="edit-college-phone" class="form-input" value="{{ college.phone }}" required>
                                <span class="error-message" id="error-college-phone"></span>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Principal Name <span class="required">*</span></label>
                                <input type="text" id="edit-college-principal" class="form-input" value="{{ college.principal_name }}" required>
                                <span class="error-message" id="error-college-principal"></span>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <input type="text" class="form-input" value="{{ college.get_registration_status_display }}" readonly style="background: var(--bg-light);">
                                <span class="form-help">Status can only be changed by super administrator</span>
                            </div>
                        </form>
                        
                        {% if not user.is_college_admin %}
                        <p style="color: var(--text-light); font-size: 14px; margin-top: 20px;">
                            <i class="fas fa-info-circle"></i> Only college administrators can edit college settings.
                        </p>
                        {% endif %}
                    </div>
                </div>

                <!-- Academic Settings Tab Content -->
                {% if user.is_college_admin %}
                <div class="college-settings-tab-content" id="academic-settings-tab-content">
                    <div class="content-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-calendar-alt"></i> Academic Settings
                            </h3>
                        </div>
                        <div class="card-body">
                            <form id="academic-settings-form" onsubmit="handleAcademicSettingsSubmit(event)">
                                <div class="form-group">
                                    <label class="form-label">Semesters Per Year <span class="required">*</span></label>
                                    <input type="number" id="semesters-per-year" class="form-input" min="1" max="12" value="2">
                                    <span class="form-help">Number of semesters per academic year (typically 2, 3, or 4)</span>
                                    <span class="error-message" id="error-semesters-per-year"></span>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Current Academic Year</label>
                                    <input type="text" id="academic-year" class="form-input" placeholder="e.g., 2024/2025" pattern="\d{4}/\d{4}">
                                    <span class="form-help">Format: YYYY/YYYY (e.g., 2024/2025)</span>
                                    <span class="error-message" id="error-academic-year"></span>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Current Semester</label>
                                    <select id="academic-semester" class="form-select">
                                        <option value="">Select Semester</option>
                                    </select>
                                    <span class="form-help">Current active semester</span>
                                    <span class="error-message" id="error-academic-semester"></span>
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Academic Settings
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Grading System Tab Content -->
                {% if user.is_college_admin %}
                <div class="college-settings-tab-content" id="grading-system-tab-content">
                    <div class="content-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-graduation-cap"></i> Grading System Settings
                            </h3>
                        </div>
                        <div class="card-body">
                            <form id="grading-system-form" onsubmit="handleGradingSystemSubmit(event)">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;">
                                    <div class="form-group">
                                        <label class="form-label">CAT Marks Weight (%) <span class="required">*</span></label>
                                        <input type="number" id="cat-weight" class="form-input" min="0" max="100" step="0.1" value="30">
                                        <span class="form-help">Percentage weight for CAT marks</span>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Exam Marks Weight (%) <span class="required">*</span></label>
                                        <input type="number" id="exam-weight" class="form-input" min="0" max="100" step="0.1" value="70">
                                        <span class="form-help">Percentage weight for exam marks</span>
                                    </div>
                                </div>

                                <div class="form-group" style="margin-bottom: 24px;">
                                    <label class="form-label">Pass Mark (%)</label>
                                    <input type="number" id="pass-mark" class="form-input" min="0" max="100" step="0.1" value="50">
                                    <span class="form-help">Minimum score required to pass (marks below this will be flagged for retake)</span>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" style="margin-bottom: 12px; display: block;">Grade Thresholds</label>
                                    <div id="grade-thresholds-container" style="display: grid; gap: 12px;">
                                        <!-- Grade thresholds will be populated by JavaScript -->
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Grading System
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Nominal Roll Tab Content -->
                {% if user.is_college_admin %}
                <div class="college-settings-tab-content" id="nominal-roll-tab-content">
                    <div class="content-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-clipboard-check"></i> Nominal Roll Sign-In Settings
                        </h3>
                    </div>
                    <div class="card-body">
                        <form id="nominal-roll-settings-form" onsubmit="handleNominalRollSettingsSubmit(event)">
                            <div class="form-group">
                                <label class="form-label">
                                    <input type="checkbox" id="nominal-roll-enabled" class="form-checkbox" onchange="toggleNominalRollFields()">
                                    Enable Nominal Roll Sign-In
                                </label>
                                <p class="form-help">When enabled, students can sign in at the beginning of each semester to update their academic progress.</p>
                            </div>

                            <div id="nominal-roll-fields" style="display: none; margin-top: 24px;">
                                <div class="form-group">
                                    <label class="form-label">Current Academic Year <span class="required">*</span></label>
                                    <input type="text" id="current-academic-year" class="form-input" placeholder="e.g., 2024/2025" pattern="\d{4}/\d{4}">
                                    <span class="form-help">Format: YYYY/YYYY (e.g., 2024/2025)</span>
                                    <span class="error-message" id="error-current-academic-year"></span>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Current Semester <span class="required">*</span></label>
                                    <select id="current-semester" class="form-select">
                                        <option value="">Select Semester</option>
                                    </select>
                                    <span class="error-message" id="error-current-semester"></span>
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Settings
                                    </button>
                                </div>
                            </div>
                        </form>

                        <div id="nominal-roll-stats" style="margin-top: 24px; display: none;">
                            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">
                                <div class="stat-card" style="background: var(--bg-light); padding: 16px; border-radius: 8px;">
                                    <div class="stat-label" style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px;">Total Students</div>
                                    <div class="stat-value" id="stat-total-students" style="font-size: 24px; font-weight: 700; color: var(--text-dark);">-</div>
                                </div>
                                <div class="stat-card" style="background: var(--bg-light); padding: 16px; border-radius: 8px;">
                                    <div class="stat-label" style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px;">Signed In</div>
                                    <div class="stat-value" id="stat-signed-in" style="font-size: 24px; font-weight: 700; color: var(--success);">-</div>
                                </div>
                                <div class="stat-card" style="background: var(--bg-light); padding: 16px; border-radius: 8px;">
                                    <div class="stat-label" style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px;">Not Signed In</div>
                                    <div class="stat-value" id="stat-not-signed-in" style="font-size: 24px; font-weight: 700; color: var(--warning);">-</div>
                                </div>
                                <div class="stat-card" style="background: var(--bg-light); padding: 16px; border-radius: 8px;">
                                    <div class="stat-label" style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px;">Percentage</div>
                                    <div class="stat-value" id="stat-percentage" style="font-size: 24px; font-weight: 700; color: var(--primary-blue);">-</div>
                                </div>
                            </div>
                            <div style="margin-top: 16px;">
                                <button class="btn btn-secondary" onclick="viewNominalRollList()">
                                    <i class="fas fa-list"></i> View Sign-In List
                                </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Transcript Template Tab Content -->
                {% if user.is_college_admin %}
                <div class="college-settings-tab-content" id="transcript-template-tab-content">
                    <div class="content-card">
                        <div class="card-header">
                            <h3 class="card-title">Transcript Template</h3>
                            <p class="card-subtitle" style="color: var(--text-light); font-size: 14px; margin-top: 8px;">Upload and configure transcript template with coordinate-based field positions</p>
                        </div>
                        <div class="card-body">
                            <!-- Template Upload Section -->
                            <div id="transcript-template-upload-section">
                                <h4 style="margin-bottom: 16px;">Upload Template</h4>
                                <form id="transcript-template-upload-form" enctype="multipart/form-data">
                                    <div class="form-group">
                                        <label class="form-label">Template Name</label>
                                        <input type="text" id="transcript-template-name" class="form-input" placeholder="Default Transcript Template" value="Default Transcript Template">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Template File (PDF or Image)</label>
                                        <input type="file" id="transcript-template-file" class="form-input" accept=".pdf,.png,.jpg,.jpeg" required>
                                        <span class="form-help">Upload a PDF or image (PNG/JPG) template. You'll mark field positions after upload.</span>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-upload"></i> Upload Template
                                    </button>
                                </form>
                            </div>
                            
                            <!-- Template Preview and Position Mapping -->
                            <div id="transcript-template-mapping-section" style="display: none; margin-top: 24px;">
                                <div style="display: grid; grid-template-columns: 420px 1fr; gap: 24px; align-items: start; width: 100%;">
                                    <!-- Left: Field Configuration Form -->
                                    <div style="background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); border: 1px solid #cbd5e1; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto;">
                                        <h4 style="margin: 0 0 20px 0; font-size: 16px; font-weight: 700; color: #1e293b; display: flex; align-items: center;">
                                            <i class="fas fa-cog" style="color: #007bff; margin-right: 8px;"></i>
                                            Field Configuration
                                        </h4>
                                        
                                        <!-- Field Selector -->
                                        <div class="form-group" style="margin-bottom: 20px;">
                                            <label class="form-label" style="font-size: 12px; font-weight: 600; color: #495057; margin-bottom: 8px;">
                                                <i class="fas fa-tag" style="color: #6c757d; margin-right: 4px;"></i>Select Field
                                            </label>
                                            <select id="transcript-field-selector" class="form-select" onchange="selectTranscriptField()" style="font-size: 13px; padding: 10px 12px; border: 2px solid #dee2e6; border-radius: 6px;">
                                                <option value="">-- Select Field --</option>
                                                <option value="student_name">Student Name</option>
                                                <option value="admission_number">Admission Number</option>
                                                <option value="course_name">Course Name</option>
                                                <option value="college_name">College Name</option>
                                                <option value="generation_date">Generation Date</option>
                                                <option value="average_score">Average Score</option>
                                                <option value="results_table">Results Table (Start Position)</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Position Configuration -->
                                        <div id="transcript-field-config" style="display: none; border-top: 2px solid #e9ecef; padding-top: 20px; margin-top: 20px;">
                                            <h5 style="font-size: 13px; font-weight: 700; color: #495057; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px;">
                                                <i class="fas fa-crosshairs" style="color: #28a745; margin-right: 6px;"></i>Position
                                            </h5>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                                                <div class="form-group" style="margin: 0;">
                                                    <label class="form-label" style="font-size: 11px; font-weight: 600; color: #6c757d; margin-bottom: 6px;">X Coordinate</label>
                                                    <input type="number" id="transcript-field-x" class="form-input" placeholder="0" style="font-size: 13px; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px;">
                                                    <span class="form-help" style="font-size: 10px; color: #868e96; margin-top: 4px; display: block;">Points (0-595)</span>
                                                </div>
                                                <div class="form-group" style="margin: 0;">
                                                    <label class="form-label" style="font-size: 11px; font-weight: 600; color: #6c757d; margin-bottom: 6px;">Y Coordinate</label>
                                                    <input type="number" id="transcript-field-y" class="form-input" placeholder="0" style="font-size: 13px; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px;">
                                                    <span class="form-help" style="font-size: 10px; color: #868e96; margin-top: 4px; display: block;">Points (0-842)</span>
                                                </div>
                                            </div>
                                            
                                            <!-- Font Configuration -->
                                            <h5 style="font-size: 13px; font-weight: 700; color: #495057; margin: 24px 0 16px 0; text-transform: uppercase; letter-spacing: 0.5px;">
                                                <i class="fas fa-font" style="color: #dc3545; margin-right: 6px;"></i>Font Settings
                                            </h5>
                                            
                                            <div class="form-group" style="margin-bottom: 12px;">
                                                <label class="form-label" style="font-size: 11px; font-weight: 600; color: #6c757d; margin-bottom: 6px;">Font Family</label>
                                                <select id="transcript-field-font-family" class="form-select" style="font-size: 13px; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px;">
                                                    <optgroup label="Sans-Serif Fonts">
                                                        <option value="Helvetica">Helvetica (Default)</option>
                                                        <option value="Helvetica-Bold">Helvetica Bold</option>
                                                        <option value="Helvetica-Oblique">Helvetica Italic</option>
                                                        <option value="Helvetica-BoldOblique">Helvetica Bold Italic</option>
                                                    </optgroup>
                                                    <optgroup label="Serif Fonts">
                                                        <option value="Times-Roman">Times Roman</option>
                                                        <option value="Times-Bold">Times Bold</option>
                                                        <option value="Times-Italic">Times Italic</option>
                                                        <option value="Times-BoldItalic">Times Bold Italic</option>
                                                    </optgroup>
                                                    <optgroup label="Monospace Fonts">
                                                        <option value="Courier">Courier</option>
                                                        <option value="Courier-Bold">Courier Bold</option>
                                                        <option value="Courier-Oblique">Courier Italic</option>
                                                        <option value="Courier-BoldOblique">Courier Bold Italic</option>
                                                    </optgroup>
                                                </select>
                                            </div>
                                            
                                            <div class="form-group" style="margin-bottom: 12px;">
                                                <label class="form-label" style="font-size: 11px; font-weight: 600; color: #6c757d; margin-bottom: 6px;">Font Size</label>
                                                <input type="number" id="transcript-field-font-size" class="form-input" value="12" min="6" max="120" step="0.5" style="font-size: 13px; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px;">
                                            </div>
                                            
                                            <div class="form-group" style="margin-bottom: 12px;">
                                                <label class="form-label" style="font-size: 11px; font-weight: 600; color: #6c757d; margin-bottom: 6px;">Font Color</label>
                                                <div style="display: flex; gap: 8px; align-items: center;">
                                                    <input type="color" id="transcript-field-color" value="#000000" style="width: 50px; height: 38px; border: 1px solid #ced4da; border-radius: 4px; cursor: pointer;">
                                                    <input type="text" id="transcript-field-color-hex" value="#000000" class="form-input" placeholder="#000000" style="flex: 1; font-size: 13px; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px; font-family: monospace;">
                                                </div>
                                            </div>
                                            
                                            <div class="form-group" style="margin-bottom: 12px;">
                                                <label class="form-label" style="font-size: 11px; font-weight: 600; color: #6c757d; margin-bottom: 8px;">Font Style</label>
                                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: #495057; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                                        <input type="checkbox" id="transcript-field-bold" style="margin-right: 6px; width: 16px; height: 16px;">
                                                        <strong>Bold</strong>
                                                    </label>
                                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: #495057; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                                        <input type="checkbox" id="transcript-field-italic" style="margin-right: 6px; width: 16px; height: 16px;">
                                                        <em>Italic</em>
                                                    </label>
                                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: #495057; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                                        <input type="checkbox" id="transcript-field-underline" style="margin-right: 6px; width: 16px; height: 16px;">
                                                        <u>Underline</u>
                                                    </label>
                                                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 12px; color: #495057; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                                        <input type="checkbox" id="transcript-field-strikethrough" style="margin-right: 6px; width: 16px; height: 16px;">
                                                        <span style="text-decoration: line-through;">Strikethrough</span>
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="form-group" style="margin-bottom: 12px;">
                                                <label class="form-label" style="font-size: 11px; font-weight: 600; color: #6c757d; margin-bottom: 6px;">Text Transformation</label>
                                                <select id="transcript-field-text-transform" class="form-select" style="font-size: 13px; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px;">
                                                    <option value="none">None (As Is)</option>
                                                    <option value="uppercase">UPPERCASE</option>
                                                    <option value="lowercase">lowercase</option>
                                                    <option value="capitalize">Capitalize Each Word</option>
                                                </select>
                                            </div>
                                            
                                            <div class="form-group" style="margin-bottom: 20px;">
                                                <label class="form-label" style="font-size: 11px; font-weight: 600; color: #6c757d; margin-bottom: 6px;">Text Alignment</label>
                                                <select id="transcript-field-alignment" class="form-select" style="font-size: 13px; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px;">
                                                    <option value="left">Left</option>
                                                    <option value="center">Center</option>
                                                    <option value="right">Right</option>
                                                </select>
                                            </div>
                                            
                                            <button class="btn btn-primary" onclick="updateTranscriptFieldConfig()" style="width: 100%; font-size: 13px; padding: 10px; font-weight: 600; margin-top: 8px;">
                                                <i class="fas fa-check"></i> Apply Settings
                                            </button>
                                        </div>
                                        
                                        <!-- Results Table Configuration -->
                                        <div id="transcript-results-table-config" style="display: none; border-top: 2px solid #e9ecef; padding-top: 20px; margin-top: 20px;">
                                            <h5 style="font-size: 13px; font-weight: 700; color: #495057; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.5px;">
                                                <i class="fas fa-table" style="color: #17a2b8; margin-right: 6px;"></i>Table Settings
                                            </h5>
                                            <div class="form-group" style="margin-bottom: 16px;">
                                                <label class="form-label" style="font-size: 11px; font-weight: 600; color: #6c757d; margin-bottom: 6px;">Row Height</label>
                                                <input type="number" id="transcript-row-height" class="form-input" value="20" min="10" max="50" style="font-size: 13px; padding: 8px 10px;">
                                            </div>
                                            <div class="form-group" style="margin-bottom: 16px;">
                                                <label class="form-label" style="font-size: 11px; font-weight: 600; color: #6c757d; margin-bottom: 8px;">Column Offsets (from start X)</label>
                                                <div style="display: grid; grid-template-columns: 1fr; gap: 10px; max-height: 300px; overflow-y: auto; padding-right: 8px;">
                                                    <div style="display: grid; grid-template-columns: 1fr 80px; gap: 8px; align-items: center; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                                        <span style="font-size: 11px; color: #495057; font-weight: 500;">Unit Code</span>
                                                        <input type="number" id="transcript-col-unit-code" class="form-input" value="0" style="font-size: 12px; padding: 6px 8px;">
                                                    </div>
                                                    <div style="display: grid; grid-template-columns: 1fr 80px; gap: 8px; align-items: center; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                                        <span style="font-size: 11px; color: #495057; font-weight: 500;">Unit Name</span>
                                                        <input type="number" id="transcript-col-unit-name" class="form-input" value="80" style="font-size: 12px; padding: 6px 8px;">
                                                    </div>
                                                    <div style="display: grid; grid-template-columns: 1fr 80px; gap: 8px; align-items: center; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                                        <span style="font-size: 11px; color: #495057; font-weight: 500;">Academic Year</span>
                                                        <input type="number" id="transcript-col-academic-year" class="form-input" value="280" style="font-size: 12px; padding: 6px 8px;">
                                                    </div>
                                                    <div style="display: grid; grid-template-columns: 1fr 80px; gap: 8px; align-items: center; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                                        <span style="font-size: 11px; color: #495057; font-weight: 500;">Semester</span>
                                                        <input type="number" id="transcript-col-semester" class="form-input" value="380" style="font-size: 12px; padding: 6px 8px;">
                                                    </div>
                                                    <div style="display: grid; grid-template-columns: 1fr 80px; gap: 8px; align-items: center; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                                        <span style="font-size: 11px; color: #495057; font-weight: 500;">CAT Marks</span>
                                                        <input type="number" id="transcript-col-cat-marks" class="form-input" value="440" style="font-size: 12px; padding: 6px 8px;">
                                                    </div>
                                                    <div style="display: grid; grid-template-columns: 1fr 80px; gap: 8px; align-items: center; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                                        <span style="font-size: 11px; color: #495057; font-weight: 500;">Exam Marks</span>
                                                        <input type="number" id="transcript-col-exam-marks" class="form-input" value="500" style="font-size: 12px; padding: 6px 8px;">
                                                    </div>
                                                    <div style="display: grid; grid-template-columns: 1fr 80px; gap: 8px; align-items: center; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                                        <span style="font-size: 11px; color: #495057; font-weight: 500;">Total Marks</span>
                                                        <input type="number" id="transcript-col-total-marks" class="form-input" value="560" style="font-size: 12px; padding: 6px 8px;">
                                                    </div>
                                                    <div style="display: grid; grid-template-columns: 1fr 80px; gap: 8px; align-items: center; padding: 6px; background: #f8f9fa; border-radius: 4px;">
                                                        <span style="font-size: 11px; color: #495057; font-weight: 500;">Grade</span>
                                                        <input type="number" id="transcript-col-grade" class="form-input" value="620" style="font-size: 12px; padding: 6px 8px;">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Preview with Real Data -->
                                        <div style="border-top: 2px solid #e9ecef; padding-top: 20px; margin-top: 20px; margin-bottom: 20px;">
                                            <h5 style="font-size: 13px; font-weight: 700; color: #495057; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                                <i class="fas fa-eye" style="color: #17a2b8; margin-right: 6px;"></i>Preview with Real Data
                                            </h5>
                                            <div class="form-group" style="margin-bottom: 12px;">
                                                <label class="form-label" style="font-size: 11px; font-weight: 600; color: #6c757d; margin-bottom: 6px;">Select Student</label>
                                                <select id="transcript-preview-student" class="form-select" style="font-size: 13px; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px;">
                                                    <option value="">-- Loading Students --</option>
                                                </select>
                                                <span class="form-help" style="font-size: 10px; color: #868e96; margin-top: 4px; display: block;">Select a student to preview transcript with real data</span>
                                            </div>
                                            <button class="btn btn-primary" onclick="previewTranscriptWithRealData()" style="width: 100%; font-size: 13px; padding: 10px; font-weight: 600;">
                                                <i class="fas fa-eye"></i> Preview with Selected Student
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="previewTranscriptWithSampleData()" style="width: 100%; font-size: 13px; padding: 10px; margin-top: 8px;">
                                                <i class="fas fa-file-alt"></i> Preview with Sample Data
                                            </button>
                                        </div>
                                        
                                        <!-- Action Buttons -->
                                        <div style="border-top: 2px solid #e9ecef; padding-top: 20px; margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
                                            <button class="btn btn-primary" onclick="saveTranscriptFieldPositions()" style="width: 100%; font-size: 13px; padding: 10px; font-weight: 600;">
                                                <i class="fas fa-save"></i> Save All Positions
                                            </button>
                                            <button class="btn btn-outline-secondary" onclick="clearTranscriptFieldPositions()" style="width: 100%; font-size: 13px; padding: 10px;">
                                                <i class="fas fa-undo"></i> Clear All
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="deleteTranscriptTemplate()" style="width: 100%; font-size: 13px; padding: 10px;">
                                                <i class="fas fa-trash"></i> Delete Template
                                            </button>
                                        </div>
                                        
                                        <div id="transcript-template-status" style="margin-top: 16px; font-size: 12px;"></div>
                                    </div>
                                    
                                    <!-- Right: Canvas Preview -->
                                    <div style="background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); border: 1px solid #cbd5e1; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                            <h4 style="margin: 0; font-size: 16px; font-weight: 700; color: #1e293b;">
                                                <i class="fas fa-eye" style="color: #28a745; margin-right: 8px;"></i>
                                                Template Preview
                                            </h4>
                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                <span id="transcript-canvas-info" style="font-size: 11px; color: #64748b; font-weight: 500;">A4: 210mm  297mm</span>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="resetTranscriptCanvasZoom()" style="font-size: 11px; padding: 4px 10px;">
                                                    <i class="fas fa-expand"></i> Reset
                                                </button>
                                            </div>
                                        </div>
                                        <div style="position: relative; border: 2px solid #cbd5e1; border-radius: 6px; padding: 16px; background: #f1f5f9; overflow: auto; max-height: calc(100vh - 200px); display: flex; justify-content: center; align-items: flex-start;">
                                            <canvas id="transcript-template-canvas" style="cursor: crosshair; box-shadow: 0 4px 12px rgba(0,0,0,0.15); background: #e2e8f0; border-radius: 4px; display: none;"></canvas>
                                            <iframe id="transcript-template-pdf-viewer" style="width: 100%; min-height: 800px; border: none; border-radius: 4px; display: none; background: white;"></iframe>
                                        </div>
                                        <p style="margin-top: 12px; font-size: 11px; color: #6c757d; text-align: center;">
                                            <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
                                            Click on canvas to set position (optional) or use X/Y inputs
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Student Modal -->
    <div class="modal" id="student-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="student-modal-title">Add New Student</h2>
                <button class="modal-close" onclick="closeModal('student-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="student-form" onsubmit="handleStudentSubmit(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Admission Number <span class="required">*</span></label>
                        <input type="text" id="student-admission-number" class="form-input" required>
                        <span class="error-message" id="error-student-admission-number"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Full Name <span class="required">*</span></label>
                        <input type="text" id="student-full-name" class="form-input" required>
                        <span class="error-message" id="error-student-full-name"></span>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" id="student-email" class="form-input">
                            <span class="error-message" id="error-student-email"></span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" id="student-phone" class="form-input">
                            <span class="error-message" id="error-student-phone"></span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Gender <span class="required">*</span></label>
                            <select id="student-gender" class="form-select" required>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                                <option value="O">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date of Birth <span class="required">*</span></label>
                            <input type="date" id="student-date-of-birth" class="form-input" required>
                            <span class="error-message" id="error-student-date-of-birth"></span>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Year of Study <span class="required">*</span></label>
                            <input type="number" id="student-year" class="form-input" min="1" max="5" value="1" required>
                            <span class="error-message" id="error-student-year"></span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Current Semester</label>
                            <input type="number" id="student-current-semester" class="form-input" min="1" value="1">
                            <span class="form-help" id="student-semester-help">Must be between 1 and college semesters per year</span>
                            <span class="error-message" id="error-student-current-semester"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Course</label>
                        <select id="student-course" class="form-select">
                            <option value="">Select Course</option>
                            <!-- Courses will be loaded dynamically -->
                        </select>
                        <span class="form-help" id="student-course-help">Selecting a course will validate year of study against course duration</span>
                    </div>
                    
                    <!-- Ream Paper Field -->
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" id="student-has-ream-paper" class="form-check-input">
                            <label class="form-check-label" for="student-has-ream-paper">
                                Has Ream Paper
                            </label>
                        </div>
                        <span class="error-message" id="error-student-has-ream-paper"></span>
                    </div>
                    
                    <!-- Scholarship/Sponsorship Fields -->
                    <div class="form-group">
                        <div class="form-check">
                            <input type="checkbox" id="student-is-sponsored" class="form-check-input">
                            <label class="form-check-label" for="student-is-sponsored">
                                Is Sponsored/Scholarship
                            </label>
                        </div>
                        <span class="error-message" id="error-student-is-sponsored"></span>
                    </div>
                    
                    <div id="sponsorship-fields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Discount Type</label>
                            <select id="student-sponsorship-discount-type" class="form-select">
                                <option value="">Select Discount Type</option>
                                <option value="percentage">Percentage</option>
                                <option value="fixed_amount">Fixed Amount</option>
                            </select>
                            <span class="error-message" id="error-student-sponsorship-discount-type"></span>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Discount Value</label>
                            <input type="number" id="student-sponsorship-discount-value" class="form-input" step="0.01" min="0" placeholder="Enter percentage (0-100) or fixed amount in KES">
                            <small class="form-text text-muted">Enter percentage (0-100) or fixed amount in KES</small>
                            <span class="error-message" id="error-student-sponsorship-discount-value"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('student-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text">Save Student</span>
                        <span class="btn-loader" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Saving...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Course Modal -->
    <div class="modal" id="course-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="course-modal-title">Add New Course</h2>
                <button class="modal-close" onclick="closeModal('course-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="course-form" onsubmit="handleCourseSubmit(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Adapt from Global Course (Optional)</label>
                        <div class="global-course-select-wrapper">
                            <div class="searchable-select">
                                <input type="text" 
                                       id="course-global-course-search" 
                                       class="form-input" 
                                       placeholder="Search global courses..."
                                       autocomplete="off">
                                <div class="searchable-select-dropdown" id="course-global-course-dropdown" style="display: none;">
                                    <div class="search-results" id="course-global-course-results"></div>
                                    <div class="no-results" id="course-global-course-no-results" style="display: none;">
                                        <p>No global course found</p>
                                        <button type="button" class="btn btn-sm btn-primary" id="create-new-course-from-search">
                                            <i class="fas fa-plus"></i> Create New Course
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="course-global-course-id" value="">
                            <div id="selected-global-course" style="display: none; margin-top: 8px; padding: 8px; background: #f0f0f0; border-radius: 4px;">
                                <span id="selected-global-course-text"></span>
                                <button type="button" class="btn-icon btn-sm" onclick="clearGlobalCourseSelection()" style="float: right;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department <span class="required">*</span></label>
                        <select id="course-department" class="form-input" required>
                            <option value="">Select Department</option>
                        </select>
                        <span class="error-message" id="error-course-department"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Course Code <span class="required">*</span></label>
                        <input type="text" id="course-code" class="form-input" required style="text-transform: uppercase;">
                        <span class="error-message" id="error-course-code"></span>
                        <small class="form-hint">Enter course code (e.g., CS101)</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Course Name <span class="required">*</span></label>
                        <input type="text" id="course-name" class="form-input" required>
                        <span class="error-message" id="error-course-name"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Duration (Years) <span class="required">*</span></label>
                        <input type="number" id="course-duration" class="form-input" min="1" max="5" value="1" required>
                        <span class="error-message" id="error-course-duration"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Admission Requirements (Optional)</label>
                        <textarea id="course-admission-requirements" class="form-input" rows="4" placeholder="Enter admission requirements..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('course-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text">Save Course</span>
                        <span class="btn-loader" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Saving...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Unit Modal -->
    <div class="modal" id="unit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="unit-modal-title">Add New Unit</h2>
                <button class="modal-close" onclick="closeModal('unit-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="unit-form" onsubmit="handleUnitSubmit(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Adapt from Global Unit (Optional)</label>
                        <div class="global-unit-select-wrapper">
                            <div class="searchable-select">
                                <input type="text" 
                                       id="unit-global-unit-search" 
                                       class="form-input" 
                                       placeholder="Search global units..."
                                       autocomplete="off">
                                <div class="searchable-select-dropdown" id="unit-global-unit-dropdown" style="display: none;">
                                    <div class="search-results" id="unit-global-unit-results"></div>
                                    <div class="no-results" id="unit-global-unit-no-results" style="display: none;">
                                        <p>No global unit found</p>
                                        <button type="button" class="btn btn-sm btn-primary" id="create-new-unit-from-search">
                                            <i class="fas fa-plus"></i> Create New Unit
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="unit-global-unit-id" value="">
                            <div id="selected-global-unit" style="display: none; margin-top: 8px; padding: 8px; background: #f0f0f0; border-radius: 4px;">
                                <span id="selected-global-unit-text"></span>
                                <button type="button" class="btn-icon btn-sm" onclick="clearGlobalUnitSelection()" style="float: right;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unit Code <span class="required">*</span></label>
                        <input type="text" id="unit-code" class="form-input" required>
                        <span class="error-message" id="error-unit-code"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unit Name <span class="required">*</span></label>
                        <input type="text" id="unit-name" class="form-input" required>
                        <span class="error-message" id="error-unit-name"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Semester <span class="required">*</span></label>
                        <select id="unit-semester" class="form-select" required>
                            <option value="">Select Semester</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assigned Lecturer (Optional)</label>
                        <select id="unit-lecturer" class="form-select">
                            <option value="">-- No Lecturer Assigned --</option>
                            <!-- Populated via JavaScript -->
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('unit-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text">Save Unit</span>
                        <span class="btn-loader" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Saving...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Course Unit Assignment Modal -->
    <div class="modal" id="courseunit-modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 class="modal-title" id="courseunit-modal-title">Assign Units to Course</h2>
                <button class="modal-close" onclick="closeModal('courseunit-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="courseunit-form" onsubmit="handleCourseUnitSubmit(event)">
                <div class="modal-body">
                    <!-- Course Selection -->
                    <div class="form-group">
                        <label class="form-label">Course <span class="required">*</span></label>
                        <select id="courseunit-course" class="form-select" required onchange="handleCourseSelection()">
                            <option value="">Select Course</option>
                        </select>
                    </div>
                    
                    <!-- Year and Semester Selection (shown when course is selected) -->
                    <div id="year-semester-section" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Year of Study <span class="required">*</span></label>
                                <select id="courseunit-year" class="form-select" required onchange="handleYearSemesterChange()">
                                    <option value="">Select Year</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Semester <span class="required">*</span></label>
                                <select id="courseunit-semester" class="form-select" required onchange="handleYearSemesterChange()">
                                    <option value="">Select Semester</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Units Selection (shown when course, year, and semester are selected) -->
                    <div id="units-selection-section" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Select Units to Assign</label>
                            <p class="step-description" style="margin-bottom: 16px; color: var(--text-secondary); font-size: 14px;">
                                Select units for <span id="selected-course-name"></span> - Year <span id="selected-year"></span>, Semester <span id="selected-semester"></span>
                            </p>
                            
                            <!-- Loading state -->
                            <div id="units-loading" class="loading-state" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> Loading units...
                            </div>
                            
                            <!-- Units list container -->
                            <div id="units-selection-container" class="units-selection-container">
                                <!-- Units will be displayed here as cards/list items -->
                            </div>
                            
                            <!-- Info message if no units available -->
                            <div id="units-empty" class="empty-state" style="display: none;">
                                <i class="fas fa-info-circle"></i>
                                <p>No units available. Please create units first.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('courseunit-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="courseunit-submit-btn">
                        <span class="btn-text">Assign Selected Units</span>
                        <span class="btn-loader" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Assigning...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Unit Detail Dialog Modal -->
    <div class="modal" id="unit-detail-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Unit Details</h2>
                <button class="modal-close" onclick="closeUnitDetailModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="unit-detail-content">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Add Unit to Course Dialog -->
    <div class="modal" id="add-unit-dialog">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">Add Units to Course</h2>
                <button class="modal-close" onclick="closeModal('add-unit-dialog')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Year and Semester Selection -->
                <div class="form-row" style="margin-bottom: 24px;">
                    <div class="form-group">
                        <label class="form-label">Year of Study <span class="required">*</span></label>
                        <select id="add-unit-year" class="form-select" required>
                            <option value="">Select Year</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Semester <span class="required">*</span></label>
                        <select id="add-unit-semester" class="form-select" required>
                            <option value="">Select Semester</option>
                        </select>
                    </div>
                </div>

                <!-- Search Box -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="add-unit-search" placeholder="Search units by code or name..." onkeyup="filterUnitsInDialog()">
                    </div>
                </div>

                <!-- Units List with Multi-Selection -->
                <div class="form-group">
                    <label class="form-label">Select Units</label>
                    <div id="add-unit-units-container" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; background: var(--bg-card);">
                        <div class="loading-state" style="text-align: center; padding: 40px;">
                            <i class="fas fa-spinner fa-spin"></i> Loading units...
                        </div>
                    </div>
                    <div style="margin-top: 12px; padding: 12px; background: var(--bg-card-hover); border-radius: 6px; font-size: 14px; color: var(--text-secondary);">
                        <i class="fas fa-info-circle"></i> 
                        <span id="selected-units-count">0</span> unit(s) selected
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('add-unit-dialog')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveUnitsToCourse()" id="save-units-btn">
                    <span class="btn-text">Save</span>
                    <span class="btn-loader" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> Saving...
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- Department Modal -->
    <div class="modal" id="department-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="department-modal-title">Add New Department</h2>
                <button class="modal-close" onclick="closeModal('department-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="department-form" onsubmit="handleDepartmentSubmit(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Code <span class="required">*</span></label>
                        <input type="text" id="department-code" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Name <span class="required">*</span></label>
                        <input type="text" id="department-name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="department-description" class="form-input" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('department-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Department</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lecturer Modal -->
    <div class="modal" id="lecturer-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="lecturer-modal-title">Add New Lecturer</h2>
                <button class="modal-close" onclick="closeModal('lecturer-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="lecturer-form" onsubmit="handleLecturerSubmit(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Username <span class="required">*</span></label>
                        <input type="text" id="lecturer-username" class="form-input" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">First Name <span class="required">*</span></label>
                            <input type="text" id="lecturer-first-name" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name <span class="required">*</span></label>
                            <input type="text" id="lecturer-last-name" class="form-input" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email <span class="required">*</span></label>
                        <input type="email" id="lecturer-email" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" id="lecturer-phone" class="form-input">
                    </div>
                    <div class="form-group" id="lecturer-role-group" style="display: none;">
                        <label class="form-label">Role</label>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <select id="lecturer-role" class="form-select" style="flex: 1;">
                                <option value="lecturer">Lecturer</option>
                                <option value="college_admin">College Admin</option>
                            </select>
                            <span id="lecturer-role-badge" class="badge" style="margin: 0;"></span>
                        </div>
                        <small class="form-text" style="color: var(--text-muted); margin-top: 4px;">
                            <i class="fas fa-info-circle"></i> Changing role will grant/revoke admin privileges
                        </small>
                    </div>
                    <div id="lecturer-role-confirmation" style="display: none; padding: 16px; background: rgba(217, 119, 6, 0.1); border: 2px solid var(--warning-color); border-radius: 8px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                            <i class="fas fa-exclamation-triangle" style="color: var(--warning-color); margin-top: 4px;"></i>
                            <div style="flex: 1;">
                                <p style="margin: 0 0 12px 0; color: var(--text-color); font-weight: 500;">
                                    <strong>Role Change Warning</strong>
                                </p>
                                <p style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 14px;">
                                    You are changing this user's role. This will grant or revoke administrative privileges. Please confirm this change.
                                </p>
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="lecturer-role-confirm-checkbox" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="color: var(--text-color); font-size: 14px;">
                                        I confirm this role change and understand the implications
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" id="lecturer-password-group">
                        <label class="form-label">Password <span class="required">*</span></label>
                        <input type="password" id="lecturer-password" class="form-input" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('lecturer-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="lecturer-submit-btn">
                        <span class="btn-text">Save Lecturer</span>
                        <span class="btn-loader" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Saving...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal" id="add-user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New User</h2>
                <button class="modal-close" onclick="closeModal('add-user-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="add-user-form" onsubmit="handleAddUserSubmit(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Username <span class="required">*</span></label>
                        <input type="text" id="add-user-username" class="form-input" required>
                        <span class="error-message" id="error-add-user-username"></span>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">First Name <span class="required">*</span></label>
                            <input type="text" id="add-user-first-name" class="form-input" required>
                            <span class="error-message" id="error-add-user-first-name"></span>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name <span class="required">*</span></label>
                            <input type="text" id="add-user-last-name" class="form-input" required>
                            <span class="error-message" id="error-add-user-last-name"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email <span class="required">*</span></label>
                        <input type="email" id="add-user-email" class="form-input" required>
                        <span class="error-message" id="error-add-user-email"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" id="add-user-phone" class="form-input">
                        <span class="error-message" id="error-add-user-phone"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role <span class="required">*</span></label>
                        <select id="add-user-role" class="form-select" required>
                            <option value="">-- Select Role --</option>
                            <option value="lecturer">Lecturer</option>
                            <option value="reception">Reception</option>
                        </select>
                        <small class="form-text" style="color: var(--text-muted); margin-top: 4px;">
                            <i class="fas fa-info-circle"></i> Select the role for this user
                        </small>
                        <span class="error-message" id="error-add-user-role"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password <span class="required">*</span></label>
                        <input type="password" id="add-user-password" class="form-input" required>
                        <span class="error-message" id="error-add-user-password"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-user-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="add-user-submit-btn">
                        <span class="btn-text">Create User</span>
                        <span class="btn-loader" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Creating...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Enrollment Modal -->
    <div class="modal" id="enrollment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="enrollment-modal-title">Enroll Student</h2>
                <button class="modal-close" onclick="closeModal('enrollment-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="enrollment-form" onsubmit="handleEnrollmentSubmit(event)">
                <div class="modal-body">
                    <!-- Student Selection -->
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-user-graduate"></i> Student <span class="required">*</span>
                        </label>
                        <select id="enrollment-student" class="form-select" required>
                            <option value="">Select Student</option>
                        </select>
                        <small class="form-text" style="color: #6c757d; margin-top: 4px;">
                            Select the student to enroll in a unit
                        </small>
                    </div>
                    
                    <!-- Unit Selection -->
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-book"></i> Unit <span class="required">*</span>
                        </label>
                        <select id="enrollment-unit" class="form-select" required>
                            <option value="">Select Unit</option>
                        </select>
                        <small class="form-text" style="color: #6c757d; margin-top: 4px;">
                            Select the unit to enroll the student in
                        </small>
                    </div>
                    
                    <!-- Academic Period -->
                    <div style="background: #1e1e1e; padding: 16px; border-radius: 8px; margin: 20px 0;">
                        <h4 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600; color: #ffffff;">
                            <i class="fas fa-calendar-alt"></i> Academic Period
                        </h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Academic Year <span class="required">*</span></label>
                            <select id="enrollment-academic-year" class="form-select" required>
                                    <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Semester <span class="required">*</span></label>
                            <select id="enrollment-semester" class="form-select" required>
                                    <option value="">Select Semester</option>
                            </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('enrollment-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text" id="enrollment-submit-text">Enroll Student</span>
                        <span class="btn-loader" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Saving...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal" id="result-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Enter/Edit Results</h2>
                <button class="modal-close" onclick="closeModal('result-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="result-form" onsubmit="handleResultSubmit(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label" id="result-cat-label">CAT Marks (out of 30)</label>
                        <input type="number" id="result-cat-marks" class="form-input" min="0" max="30" step="0.1" onchange="calculateTotal()">
                    </div>
                    <div class="form-group">
                        <label class="form-label" id="result-exam-label">Exam Marks (out of 70)</label>
                        <input type="number" id="result-exam-marks" class="form-input" min="0" max="70" step="0.1" onchange="calculateTotal()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Total (Auto-calculated)</label>
                        <input type="number" id="result-total" class="form-input" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Grade (Auto-calculated)</label>
                        <input type="text" id="result-grade" class="form-input" readonly>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('result-modal')">Cancel</button>
                    <button type="button" id="result-submit-btn" class="btn btn-success" onclick="submitResult()" style="display: none;">
                        <i class="fas fa-check"></i> Submit Results
                    </button>
                    <button type="submit" class="btn btn-primary" id="save-result-btn">
                        <span class="btn-text">
                            <i class="fas fa-save"></i> Save Results
                        </span>
                        <span class="btn-loader" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Saving...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Nominal Roll List Modal -->
    <div class="modal" id="nominal-roll-list-modal">
        <div class="modal-content" style="max-width: 1400px;">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="modal-icon-wrapper" style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);">
                        <i class="fas fa-clipboard-check" style="font-size: 20px; color: white;"></i>
                    </div>
                    <div>
                        <h2 class="modal-title" style="margin: 0; color: #000000;">Nominal Roll Sign-In List</h2>
                        <p style="margin: 4px 0 0 0; color: #000000; font-size: 14px;">View and manage student sign-in records</p>
                    </div>
                </div>
                <button class="modal-close" onclick="closeModal('nominal-roll-list-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Search and Action Bar -->
                <div class="nominal-roll-header-bar">
                    <div class="nominal-roll-search-wrapper">
                        <i class="fas fa-search nominal-roll-search-icon"></i>
                        <input type="text" id="nominal-roll-search" class="nominal-roll-search-input" placeholder="Search by admission number, name, or course..." onkeyup="filterNominalRollList()">
                        <button type="button" class="nominal-roll-search-clear" id="nominal-roll-search-clear" onclick="clearNominalRollSearch()" style="display: none;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="nominal-roll-actions">
                        <button class="btn btn-secondary btn-icon-only" onclick="exportNominalRollList()" title="Export to CSV">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-secondary btn-icon-only" onclick="printNominalRollList()" title="Print List">
                            <i class="fas fa-print"></i>
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="nominal-roll-filters">
                    <div class="nominal-roll-filters-header">
                        <i class="fas fa-filter"></i>
                        <span>Filters</span>
                        <button class="nominal-roll-filters-toggle" onclick="toggleNominalRollFilters()">
                            <i class="fas fa-chevron-down" id="nominal-roll-filters-icon"></i>
                        </button>
                    </div>
                    <div class="nominal-roll-filters-content" id="nominal-roll-filters-content">
                        <div class="nominal-roll-filters-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-calendar-alt"></i> Academic Year
                                </label>
                                <select id="nominal-roll-year-filter" class="form-select" onchange="filterNominalRollList()">
                                    <option value="">All Years</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-calendar"></i> Semester
                                </label>
                                <select id="nominal-roll-semester-filter" class="form-select" onchange="filterNominalRollList()">
                                    <option value="">All Semesters</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-graduation-cap"></i> Course
                                </label>
                                <select id="nominal-roll-course-filter" class="form-select" onchange="filterNominalRollList()">
                                    <option value="">All Courses</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-layer-group"></i> Year of Study
                                </label>
                                <select id="nominal-roll-year-study-filter" class="form-select" onchange="filterNominalRollList()">
                                    <option value="">All Years</option>
                                    <option value="1">Year 1</option>
                                    <option value="2">Year 2</option>
                                    <option value="3">Year 3</option>
                                    <option value="4">Year 4</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-info-circle"></i> Status
                                </label>
                                <select id="nominal-roll-status-filter" class="form-select" onchange="filterNominalRollList()">
                                    <option value="">All Status</option>
                                    <option value="signed_in">Signed In</option>
                                    <option value="not_signed_in">Not Signed In</option>
                                </select>
                            </div>
                        </div>
                        <div class="nominal-roll-filters-actions">
                            <button class="btn btn-secondary" onclick="clearNominalRollFilters()">
                                <i class="fas fa-times"></i> Clear All Filters
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Results Summary -->
                <div class="nominal-roll-summary">
                    <div class="nominal-roll-summary-item">
                        <div class="nominal-roll-summary-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="nominal-roll-summary-content">
                            <div class="nominal-roll-summary-label">Total Students</div>
                            <div class="nominal-roll-summary-value" id="nominal-roll-total-count">0</div>
                        </div>
                    </div>
                    <div class="nominal-roll-summary-item">
                        <div class="nominal-roll-summary-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="nominal-roll-summary-content">
                            <div class="nominal-roll-summary-label">Signed In</div>
                            <div class="nominal-roll-summary-value" id="nominal-roll-signed-in-count">0</div>
                        </div>
                    </div>
                    <div class="nominal-roll-summary-item">
                        <div class="nominal-roll-summary-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="nominal-roll-summary-content">
                            <div class="nominal-roll-summary-label">Not Signed In</div>
                            <div class="nominal-roll-summary-value" id="nominal-roll-not-signed-in-count">0</div>
                        </div>
                    </div>
                </div>
                
                <!-- Table -->
                <div class="table-container nominal-roll-table-container" id="nominal-roll-table-container">
                    <div class="nominal-roll-loading-overlay" id="nominal-roll-loading-overlay">
                        <div class="nominal-roll-spinner-wrapper">
                            <div class="nominal-roll-spinner">
                                <div class="spinner-ring"></div>
                                <div class="spinner-ring"></div>
                                <div class="spinner-ring"></div>
                                <div class="spinner-ring"></div>
                            </div>
                            <p class="spinner-text">Loading sign-in records...</p>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table nominal-roll-table">
                            <thead>
                                <tr>
                                    <th>
                                        <div class="table-header-content">
                                            <i class="fas fa-id-card"></i>
                                            <span>Admission No.</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="table-header-content">
                                            <i class="fas fa-user"></i>
                                            <span>Full Name</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="table-header-content">
                                            <i class="fas fa-graduation-cap"></i>
                                            <span>Course</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="table-header-content">
                                            <i class="fas fa-calendar-alt"></i>
                                            <span>Academic Year</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="table-header-content">
                                            <i class="fas fa-calendar"></i>
                                            <span>Semester</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="table-header-content">
                                            <i class="fas fa-layer-group"></i>
                                            <span>Year of Study</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="table-header-content">
                                            <i class="fas fa-clock"></i>
                                            <span>Signed In At</span>
                                        </div>
                                    </th>
                                    <th>
                                        <div class="table-header-content">
                                            <i class="fas fa-info-circle"></i>
                                            <span>Status</span>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="nominal-roll-list-tbody">
                                <tr>
                                    <td colspan="8" class="loading-row">
                                        <div class="loading-state-content">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            <span>Loading sign-in records...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div class="nominal-roll-empty-state" id="nominal-roll-empty-state" style="display: none;">
                    <div class="empty-state-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <h3 class="empty-state-title">No Records Found</h3>
                    <p class="empty-state-message">No sign-in records match your current filters. Try adjusting your search criteria.</p>
                    <button class="btn btn-secondary" onclick="clearNominalRollFilters(); clearNominalRollSearch();">
                        <i class="fas fa-redo"></i> Reset Filters
                    </button>
                </div>
                
                <!-- Pagination -->
                <div class="pagination nominal-roll-pagination" id="nominal-roll-list-pagination"></div>
            </div>
        </div>
    </div>

    <!-- Timetable Modal -->
    <div class="modal" id="timetable-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title" id="timetable-modal-title">Upload Timetable</h2>
                <button class="modal-close" onclick="closeModal('timetable-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="timetable-form" onsubmit="handleTimetableSubmit(event)" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Timetable Type <span class="required">*</span></label>
                        <div style="display: flex; gap: 16px; margin-top: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="timetable-type" value="general" checked onchange="toggleTimetableCourseField()">
                                <span>General Timetable (All Courses)</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="timetable-type" value="course_specific" onchange="toggleTimetableCourseField()">
                                <span>Course-Specific Timetable</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group" id="timetable-course-group" style="display: none;">
                        <label class="form-label">Course <span class="required">*</span></label>
                        <select id="timetable-course" class="form-select">
                            <option value="">Select Course</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Timetable File <span class="required">*</span></label>
                        <div class="file-upload-container">
                            <input type="file" id="timetable-image" class="file-input-hidden" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp,application/pdf,.pdf" required onchange="previewTimetableFile(event)">
                            <div class="file-upload-area" id="timetable-upload-area" onclick="if(!event.target.closest('.file-upload-preview')) document.getElementById('timetable-image').click()">
                                <div class="file-upload-content" id="timetable-upload-content">
                                    <div class="file-upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="file-upload-text">
                                        <p class="file-upload-title">Drag & drop your file here</p>
                                        <p class="file-upload-subtitle">or click to browse</p>
                                    </div>
                                    <div class="file-upload-formats">
                                        <span class="format-badge">JPG</span>
                                        <span class="format-badge">PNG</span>
                                        <span class="format-badge">GIF</span>
                                        <span class="format-badge">WebP</span>
                                        <span class="format-badge">PDF</span>
                                    </div>
                                    <p class="file-upload-size">Max file size: 10MB</p>
                                </div>
                                <div class="file-upload-preview" id="timetable-upload-preview" style="display: none;">
                                    <div class="preview-image-wrapper" id="timetable-preview-wrapper">
                                        <img id="timetable-preview-img" src="" alt="Preview" style="display: none;">
                                        <div id="timetable-pdf-preview" style="display: none; padding: 20px; text-align: center;">
                                            <i class="fas fa-file-pdf" style="font-size: 48px; color: #dc3545; margin-bottom: 10px;"></i>
                                            <p id="timetable-pdf-name" style="font-weight: 600; margin: 0; word-break: break-word;"></p>
                                        </div>
                                        <button type="button" class="preview-remove-btn" onclick="event.stopPropagation(); removeTimetablePreview()" title="Remove file">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div class="preview-info">
                                        <p class="preview-filename" id="timetable-filename"></p>
                                        <p class="preview-filesize" id="timetable-filesize"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="file-upload-error" id="timetable-upload-error" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Academic Year</label>
                            <input type="text" id="timetable-academic-year" class="form-input" placeholder="e.g., 2024/2025">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Semester</label>
                            <select id="timetable-semester" class="form-select">
                                <option value="">Select Semester</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="timetable-description" class="form-input" rows="3" placeholder="Optional description or notes"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('timetable-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="timetable-submit-btn">
                        <span class="btn-text">Upload Timetable</span>
                        <span class="btn-loader" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Uploading...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Timetable View Modal -->
    <div class="modal" id="timetable-view-modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh;">
            <div class="modal-header">
                <h2 class="modal-title" id="timetable-view-title">Timetable</h2>
                <button class="modal-close" onclick="closeModal('timetable-view-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 20px;">
                <div id="timetable-view-content">
                    <img id="timetable-view-img" src="" alt="Timetable" style="max-width: 100%; max-height: 80vh; border-radius: 8px;">
                </div>
            </div>
        </div>
    </div>

    <!-- Announcement Management Modal -->
    <div class="modal" id="announcement-management-modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 class="modal-title" id="announcement-modal-title">Create New Announcement</h2>
                <button class="modal-close" onclick="closeModal('announcement-management-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="announcement-management-form" onsubmit="handleAnnouncementFormSubmit(event)">
                <div class="modal-body">
                    <input type="hidden" id="announcement-id">
                    
                    <div class="form-group">
                        <label class="form-label">Title <span class="required">*</span></label>
                        <input type="text" id="announcement-title" class="form-input" placeholder="Enter announcement title" required>
                        <span class="field-error" id="announcement-title-error"></span>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Content <span class="required">*</span></label>
                        <textarea id="announcement-content" class="form-input" rows="6" placeholder="Enter announcement content" required></textarea>
                        <span class="field-error" id="announcement-content-error"></span>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Target Type <span class="required">*</span></label>
                            <select id="announcement-target-type" class="form-input" required onchange="handleAnnouncementTargetTypeChange()">
                                <option value="">Select target type</option>
                                <option value="all_students">All Students</option>
                                <option value="all_lecturers">All Lecturers</option>
                                <option value="individual">Individual Users</option>
                            </select>
                            <span class="field-error" id="announcement-target-type-error"></span>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Priority</label>
                            <select id="announcement-priority" class="form-input">
                                <option value="normal">Normal</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                    </div>

                    <!-- Individual Targeting Section -->
                    <div id="individual-targeting-section" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Individual Targeting</label>
                            <div class="tabs">
                                <button type="button" class="tab-btn active" onclick="switchAnnouncementTargetTab('students')">Students</button>
                                <button type="button" class="tab-btn" onclick="switchAnnouncementTargetTab('lecturers')">Lecturers</button>
                            </div>
                            
                            <div class="tab-content active" id="students-target-tab">
                                <div class="form-group">
                                    <label class="form-label">Select Students</label>
                                    <select id="announcement-targeted-students" class="form-input" multiple size="8">
                                        <!-- Populated via JS -->
                                    </select>
                                    <small class="form-help">Hold Ctrl/Cmd to select multiple students</small>
                                </div>
                            </div>
                            
                            <div class="tab-content" id="lecturers-target-tab">
                                <div class="form-group">
                                    <label class="form-label">Select Lecturers</label>
                                    <select id="announcement-targeted-users" class="form-input" multiple size="8">
                                        <!-- Populated via JS -->
                                    </select>
                                    <small class="form-help">Hold Ctrl/Cmd to select multiple lecturers</small>
                                </div>
                            </div>
                            
                            <div class="selected-count" id="announcement-selected-count" style="margin-top: 12px; padding: 8px; background: var(--bg-hover); border-radius: 4px;">
                                <span id="selected-students-count">0 students</span>, <span id="selected-lecturers-count">0 lecturers</span> selected
                            </div>
                            <span class="field-error" id="announcement-individual-targeting-error"></span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Expiration Date (Optional)</label>
                        <input type="datetime-local" id="announcement-expires-at" class="form-input">
                        <small class="form-help">Leave empty for no expiration</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('announcement-management-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="announcement-submit-btn">
                        <span class="btn-text">Create Announcement</span>
                        <span class="btn-loader" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Saving...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Announcement View Modal -->
    <div class="modal" id="announcement-view-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="announcement-view-title">Announcement Details</h2>
                <button class="modal-close" onclick="closeModal('announcement-view-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="announcement-view-content">
                <!-- Content populated via JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('announcement-view-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Marks Entry Modal (after selecting unit) -->
    <div class="modal" id="marks-entry-modal">
        <div class="modal-content modal-large" style="max-width: 95%; width: 95%;">
            <div class="modal-header">
                <h2 class="modal-title" id="marks-entry-unit-title">Enter Marks</h2>
                <button class="modal-close" onclick="closeMarksEntryModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; flex-wrap: wrap; gap: 12px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <div class="search-box" style="min-width: 250px;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="marks-entry-search" class="form-input" 
                                   placeholder="Search by admission number or name..." 
                                   onkeyup="filterMarksTable()">
                        </div>
                        <button class="btn btn-success" id="save-draft-btn" onclick="saveAllDraftMarks()">
                            <i class="fas fa-save"></i> Save to Draft
                        </button>
                        <button class="btn btn-primary" id="submit-all-marks-btn" onclick="submitAllMarks()" style="display: none;">
                            <i class="fas fa-check-circle"></i> Submit All
                        </button>
                    </div>
                </div>
                <div id="marks-entry-stats" style="display: flex; gap: 16px; margin-bottom: 20px; padding: 16px; background: var(--bg-card-hover); border-radius: var(--border-radius); flex-wrap: wrap;">
                    <div>
                        <span style="color: var(--text-light); font-size: 12px;">Total Students:</span>
                        <strong id="stats-total" style="font-size: 18px; margin-left: 8px;">0</strong>
                    </div>
                    <div>
                        <span style="color: var(--text-light); font-size: 12px;">With Marks:</span>
                        <strong id="stats-marked" style="font-size: 18px; margin-left: 8px; color: #10b981;">0</strong>
                    </div>
                    <div>
                        <span style="color: var(--text-light); font-size: 12px;">No Marks:</span>
                        <strong id="stats-no-marks" style="font-size: 18px; margin-left: 8px; color: #ef4444;">0</strong>
                    </div>
                    <div>
                        <span style="color: var(--text-light); font-size: 12px;">Submitted:</span>
                        <strong id="stats-submitted" style="font-size: 18px; margin-left: 8px; color: #10b981;">0</strong>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table" id="marks-entry-table">
                        <thead>
                            <tr>
                                <th>Admission No.</th>
                                <th>Student Name</th>
                                <th>CAT Marks</th>
                                <th>Exam Marks</th>
                                <th>Total</th>
                                <th>Grade</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="marks-entry-tbody-modal">
                            <tr>
                                <td colspan="7" class="loading-row">
                                    <i class="fas fa-spinner fa-spin"></i> Loading...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Set college slug for API calls
        window.COLLEGE_SLUG = '{{ college.get_slug }}';
        window.csrftoken = getCookie('csrftoken');
        window.USER_ROLE = '{{ user.role }}';
        window.IS_COLLEGE_ADMIN = window.USER_ROLE === 'college_admin' || window.USER_ROLE === 'principal' || window.USER_ROLE === 'registrar';
        window.CURRENT_USER_ID = '{{ user.id }}';
        
        // Toast notification function
        function showToast(type, message) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle'
            }[type] || 'fa-info-circle';
            
            toast.innerHTML = `
                <i class="fas ${icon}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Modal functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeMarksEntryModal() {
            const modal = document.getElementById('marks-entry-modal');
            if (modal) {
                modal.classList.remove('active');
            }
            // Show the results units view again
            const resultsUnitsView = document.getElementById('results-units-view');
            if (resultsUnitsView) {
                resultsUnitsView.style.display = 'block';
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                // Remove display: none to prevent flicker - CSS should handle visibility
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                    form.dataset.editId = '';
                    form.dataset.originalRole = '';
                    form.dataset.timetableId = '';
                    
                    const title = modal.querySelector('.modal-title');
                    if (title) {
                        if (modalId === 'student-modal') title.textContent = 'Add New Student';
                        else if (modalId === 'course-modal') title.textContent = 'Add New Course';
                        else if (modalId === 'unit-modal') title.textContent = 'Add New Unit';
                        else if (modalId === 'timetable-modal') title.textContent = 'Upload Timetable';
                        else if (modalId === 'announcement-management-modal') title.textContent = 'Create New Announcement';
                    }
                }
                
                // Reset timetable-specific fields
                if (modalId === 'timetable-modal') {
                    removeTimetablePreview();
                    const courseGroup = document.getElementById('timetable-course-group');
                    const generalRadio = document.querySelector('input[name="timetable-type"][value="general"]');
                    if (courseGroup) courseGroup.style.display = 'none';
                    if (generalRadio) generalRadio.checked = true;
                    const errorDiv = document.getElementById('timetable-upload-error');
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                        errorDiv.textContent = '';
                    }
                }
                
                // Reset announcement-specific fields
                if (modalId === 'announcement-management-modal') {
                    document.getElementById('announcement-id').value = '';
                    document.getElementById('individual-targeting-section').style.display = 'none';
                    document.getElementById('announcement-target-type').value = '';
                    document.getElementById('announcement-priority').value = 'normal';
                    document.getElementById('announcement-expires-at').value = '';
                    const studentsSelect = document.getElementById('announcement-targeted-students');
                    const usersSelect = document.getElementById('announcement-targeted-users');
                    if (studentsSelect) studentsSelect.selectedIndex = -1;
                    if (usersSelect) usersSelect.selectedIndex = -1;
                    updateAnnouncementSelectedCount();
                    editingAnnouncementId = null;
                }
                
                // Reset role confirmation UI for lecturer modal
                if (modalId === 'lecturer-modal') {
                    const confirmationDiv = document.getElementById('lecturer-role-confirmation');
                    const roleSelect = document.getElementById('lecturer-role');
                    const confirmCheckbox = document.getElementById('lecturer-role-confirm-checkbox');
                    const submitBtn = document.getElementById('lecturer-submit-btn');
                    const btnText = submitBtn ? submitBtn.querySelector('.btn-text') : null;
                    
                    if (confirmationDiv) confirmationDiv.style.display = 'none';
                    if (roleSelect) {
                        roleSelect.style.borderColor = '';
                        roleSelect.dataset.originalRole = '';
                    }
                    if (confirmCheckbox) confirmCheckbox.checked = false;
                    if (btnText) btnText.textContent = 'Save Lecturer';
                }
            }
        }

        // Professional File Upload Functions for Timetable
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function validateImageFile(file) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
            
            if (!allowedTypes.includes(file.type)) {
                return { valid: false, error: 'Invalid file type. Please upload JPG, PNG, GIF, or WebP images only.' };
            }
            
            if (file.size > maxSize) {
                return { valid: false, error: 'File size exceeds 10MB limit. Please choose a smaller file.' };
            }
            
            return { valid: true };
        }

        function showTimetableError(message) {
            const errorDiv = document.getElementById('timetable-upload-error');
            if (errorDiv) {
                errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                errorDiv.style.display = 'block';
            }
        }

        function hideTimetableError() {
            const errorDiv = document.getElementById('timetable-upload-error');
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
        }

        function previewTimetableFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            hideTimetableError();
            
            // Validate file type and size
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'application/pdf'];
            const maxSize = 10 * 1024 * 1024; // 10MB
            
            if (!allowedTypes.includes(file.type) && !file.name.toLowerCase().endsWith('.pdf')) {
                showTimetableError('Invalid file type. Please upload an image (JPG, PNG, GIF, WebP) or PDF file.');
                event.target.value = '';
                return;
            }
            
            if (file.size > maxSize) {
                showTimetableError('File size exceeds 10MB limit.');
                event.target.value = '';
                return;
            }
            
            const uploadArea = document.getElementById('timetable-upload-area');
            const uploadContent = document.getElementById('timetable-upload-content');
            const uploadPreview = document.getElementById('timetable-upload-preview');
            const previewImg = document.getElementById('timetable-preview-img');
            const pdfPreview = document.getElementById('timetable-pdf-preview');
            const pdfName = document.getElementById('timetable-pdf-name');
            const filename = document.getElementById('timetable-filename');
            const filesize = document.getElementById('timetable-filesize');
            
            if (!uploadArea || !uploadContent || !uploadPreview || !filename || !filesize) return;
            
            const isPDF = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
            
            if (isPDF) {
                // Show PDF preview
                if (previewImg) previewImg.style.display = 'none';
                if (pdfPreview) {
                    pdfPreview.style.display = 'block';
                    if (pdfName) pdfName.textContent = file.name;
                }
            } else {
                // Show image preview
                if (pdfPreview) pdfPreview.style.display = 'none';
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (previewImg) {
                        previewImg.src = e.target.result;
                        previewImg.style.display = 'block';
                    }
                };
                reader.readAsDataURL(file);
            }
            
            filename.textContent = file.name;
            filesize.textContent = formatFileSize(file.size);
            
            uploadContent.style.display = 'none';
            uploadPreview.style.display = 'flex';
            uploadArea.classList.add('has-preview');
        }

        function removeTimetablePreview() {
            const fileInput = document.getElementById('timetable-image');
            const uploadArea = document.getElementById('timetable-upload-area');
            const uploadContent = document.getElementById('timetable-upload-content');
            const uploadPreview = document.getElementById('timetable-upload-preview');
            
            if (fileInput) fileInput.value = '';
            if (uploadArea) uploadArea.classList.remove('has-preview', 'drag-over');
            if (uploadContent) uploadContent.style.display = 'flex';
            if (uploadPreview) uploadPreview.style.display = 'none';
            
            const previewImg = document.getElementById('timetable-preview-img');
            if (previewImg) {
                previewImg.src = '';
                previewImg.style.display = 'none';
            }
            
            const pdfPreview = document.getElementById('timetable-pdf-preview');
            if (pdfPreview) {
                pdfPreview.style.display = 'none';
            }
            
            hideTimetableError();
        }

        // Initialize drag and drop for timetable upload
        // Initialize marks entry system on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load academic year options for unit selection
            if (document.getElementById('unit-selection-year-filter')) {
                loadAcademicYearOptions();
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('timetable-upload-area');
            const fileInput = document.getElementById('timetable-image');
            
            if (!uploadArea || !fileInput) return;
            
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // Highlight drop area when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, function() {
                    uploadArea.classList.add('drag-over');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, function() {
                    uploadArea.classList.remove('drag-over');
                }, false);
            });
            
            // Handle dropped files
            uploadArea.addEventListener('drop', function(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    const file = files[0];
                    const validation = validateImageFile(file);
                    
                    if (!validation.valid) {
                        showTimetableError(validation.error);
                        return;
                    }
                    
                    // Create a FileList-like object and assign to input
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    
                    // Trigger change event
                    const changeEvent = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(changeEvent);
                }
            }, false);
        });

        // Store courses data for validation
        let studentCoursesData = [];
        
        async function loadStudentCourseOptions() {
            const courseSelect = document.getElementById('student-course');
            if (!courseSelect) return;
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/courses/`);
                const data = await response.json();
                
                // Store courses data for validation
                studentCoursesData = data.results || [];
                
                // Clear existing options except the first one
                courseSelect.innerHTML = '<option value="">Select Course</option>';
                
                // Add courses
                if (studentCoursesData.length > 0) {
                    studentCoursesData.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.name;
                        option.setAttribute('data-duration', course.duration || course.duration_years || 5);
                        courseSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading courses for student:', error);
            }
        }

        async function openStudentModal() {
            document.getElementById('student-modal-title').textContent = 'Add New Student';
            document.getElementById('student-form').dataset.editId = '';
            document.getElementById('student-form').dataset.viewMode = '';
            
            // Load courses into dropdown
            await loadStudentCourseOptions();
            
            // Get and set max semester based on college settings
            const maxSemesters = await getSemestersPerYear();
            const semesterInput = document.getElementById('student-current-semester');
            if (semesterInput) {
                semesterInput.setAttribute('max', maxSemesters);
                document.getElementById('student-semester-help').textContent = `Must be between 1 and ${maxSemesters} (based on college settings)`;
            }
            
            // Reset form
            document.getElementById('student-form').reset();
            
            // Set default current semester to 1
            document.getElementById('student-current-semester').value = '1';
            
            // Enable all fields
            document.getElementById('student-admission-number').disabled = false;
            document.getElementById('student-full-name').disabled = false;
            document.getElementById('student-email').disabled = false;
            document.getElementById('student-phone').disabled = false;
            document.getElementById('student-gender').disabled = false;
            document.getElementById('student-year').disabled = false;
            document.getElementById('student-date-of-birth').disabled = false;
            document.getElementById('student-current-semester').disabled = false;
            document.getElementById('student-course').disabled = false;
            document.getElementById('student-has-ream-paper').disabled = false;
            document.getElementById('student-is-sponsored').disabled = false;
            document.getElementById('student-sponsorship-discount-type').disabled = false;
            document.getElementById('student-sponsorship-discount-value').disabled = false;
            
            // Hide sponsorship fields initially
            document.getElementById('sponsorship-fields').style.display = 'none';
            
            // Reset new fields
            document.getElementById('student-has-ream-paper').checked = false;
            document.getElementById('student-is-sponsored').checked = false;
            document.getElementById('student-sponsorship-discount-type').value = '';
            document.getElementById('student-sponsorship-discount-value').value = '';
            
            // Add event listener for sponsorship checkbox
            const sponsoredCheckbox = document.getElementById('student-is-sponsored');
            const sponsorshipFields = document.getElementById('sponsorship-fields');
            if (sponsoredCheckbox && sponsorshipFields) {
                // Remove existing listeners by cloning
                const newCheckbox = sponsoredCheckbox.cloneNode(true);
                sponsoredCheckbox.parentNode.replaceChild(newCheckbox, sponsoredCheckbox);
                
                newCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        sponsorshipFields.style.display = 'block';
                    } else {
                        sponsorshipFields.style.display = 'none';
                    }
                });
            }
            
            // Clear error messages
            document.querySelectorAll('#student-form .error-message').forEach(el => {
                el.textContent = '';
            });
            
            // Add event listener for course selection to validate year_of_study
            const courseSelect = document.getElementById('student-course');
            const yearInput = document.getElementById('student-year');
            if (courseSelect && yearInput) {
                // Remove existing listeners by cloning
                const newCourseSelect = courseSelect.cloneNode(true);
                courseSelect.parentNode.replaceChild(newCourseSelect, courseSelect);
                
                newCourseSelect.addEventListener('change', function() {
                    const selectedCourseId = this.value;
                    if (selectedCourseId) {
                        const selectedCourse = studentCoursesData.find(c => c.id === parseInt(selectedCourseId));
                        if (selectedCourse) {
                            const maxYear = selectedCourse.duration || selectedCourse.duration_years || 5;
                            yearInput.setAttribute('max', maxYear);
                            document.getElementById('student-course-help').textContent = 
                                `Course duration: ${maxYear} years. Year of study must be between 1 and ${maxYear}`;
                            
                            // Validate current year value
                            const currentYear = parseInt(yearInput.value) || 1;
                            if (currentYear > maxYear) {
                                yearInput.value = maxYear;
                                document.getElementById('error-student-year').textContent = 
                                    `Year adjusted to ${maxYear} (course duration)`;
                            } else {
                                document.getElementById('error-student-year').textContent = '';
                            }
                        }
                    } else {
                        yearInput.setAttribute('max', 5);
                        document.getElementById('student-course-help').textContent = 
                            'Selecting a course will validate year of study against course duration';
                        document.getElementById('error-student-year').textContent = '';
                    }
                });
            }
            
            // Show submit button
            const submitButton = document.querySelector('#student-form button[type="submit"]');
            if (submitButton) {
                submitButton.style.display = '';
            }
            
            openModal('student-modal');
        }

        // Make function globally accessible
        window.loadStudentCourseOptions = loadStudentCourseOptions;

        async function openCourseModal() {
            document.getElementById('course-modal-title').textContent = 'Add New Course';
            document.getElementById('course-form').dataset.editId = '';
            
            // Reset form fields
            document.getElementById('course-code').value = '';
            document.getElementById('course-name').value = '';
            document.getElementById('course-duration').value = '1';
            document.getElementById('course-global-course-id').value = '';
            document.getElementById('course-global-course-search').value = '';
            document.getElementById('selected-global-course').style.display = 'none';
            document.getElementById('course-admission-requirements').value = '';
            document.getElementById('course-global-course-dropdown').style.display = 'none';
            document.getElementById('course-department').value = '';
            
            // Load departments into dropdown
            await loadCourseDepartments();
            
            openModal('course-modal');
        }
        
        async function loadCourseDepartments() {
            try {
                // Pass skipSectionCheck=true to fetch even if departments section is not visible
                const data = await window.LandingData.fetchDepartments(1, '', true);
                const deptSelect = document.getElementById('course-department');
                if (deptSelect && data && data.results && data.results.length > 0) {
                    // Clear existing options except the first one
                    deptSelect.innerHTML = '<option value="">Select Department</option>';
                    
                    // Add departments
                    data.results.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.name;
                        option.textContent = `${dept.code} - ${dept.name}`;
                        deptSelect.appendChild(option);
                    });
                    console.log('Loaded', data.results.length, 'departments into dropdown');
                } else {
                    console.warn('No departments found or invalid data:', data);
                    const deptSelect = document.getElementById('course-department');
                    if (deptSelect) {
                        deptSelect.innerHTML = '<option value="">No departments available</option>';
                    }
                }
            } catch (error) {
                console.error('Error loading departments:', error);
                const deptSelect = document.getElementById('course-department');
                if (deptSelect) {
                    deptSelect.innerHTML = '<option value="">Error loading departments</option>';
                }
            }
        }

        function openUnitModal() {
            document.getElementById('unit-modal-title').textContent = 'Add New Unit';
            document.getElementById('unit-form').dataset.editId = '';
            
            // Reset form fields
            document.getElementById('unit-code').value = '';
            document.getElementById('unit-name').value = '';
            document.getElementById('unit-semester').value = '1';
            document.getElementById('unit-global-unit-id').value = '';
            document.getElementById('unit-global-unit-search').value = '';
            document.getElementById('selected-global-unit').style.display = 'none';
            document.getElementById('unit-lecturer').value = '';
            document.getElementById('unit-global-unit-dropdown').style.display = 'none';
            
            // Load lecturers
            loadLecturersForUnit();
            
            openModal('unit-modal');
        }

        // Form handlers
        async function handleStudentSubmit(e) {
            e.preventDefault();
            const form = e.target;
            
            // Prevent submission if in view mode
            if (form.dataset.viewMode === 'true') {
                return;
            }
            
            const editId = form.dataset.editId;
            const submitBtn = form.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoader = submitBtn.querySelector('.btn-loader');
            
            // Clear previous error messages
            document.querySelectorAll('#student-form .error-message').forEach(el => {
                el.textContent = '';
            });
            
            // Get form values
            const admissionNumber = document.getElementById('student-admission-number').value.trim();
            const fullName = document.getElementById('student-full-name').value.trim();
            const email = document.getElementById('student-email').value.trim();
            const phone = document.getElementById('student-phone').value.trim();
            const gender = document.getElementById('student-gender').value;
            const yearOfStudy = parseInt(document.getElementById('student-year').value);
            const dateOfBirth = document.getElementById('student-date-of-birth').value;
            const currentSemester = document.getElementById('student-current-semester').value;
            const courseId = document.getElementById('student-course').value;
            const hasReamPaper = document.getElementById('student-has-ream-paper').checked;
            const isSponsored = document.getElementById('student-is-sponsored').checked;
            const sponsorshipDiscountType = document.getElementById('student-sponsorship-discount-type').value;
            const sponsorshipDiscountValue = document.getElementById('student-sponsorship-discount-value').value;
            
            // Client-side validation
            let hasErrors = false;
            
            if (!admissionNumber) {
                document.getElementById('error-student-admission-number').textContent = 'Admission number is required';
                hasErrors = true;
            }
            
            if (!fullName) {
                document.getElementById('error-student-full-name').textContent = 'Full name is required';
                hasErrors = true;
            }
            
            if (!dateOfBirth) {
                document.getElementById('error-student-date-of-birth').textContent = 'Date of birth is required';
                hasErrors = true;
            }
            
            // Validate year_of_study against course duration
            if (courseId) {
                const selectedCourse = studentCoursesData.find(c => c.id === parseInt(courseId));
                if (selectedCourse) {
                    const maxYear = selectedCourse.duration || selectedCourse.duration_years || 5;
                    if (yearOfStudy > maxYear) {
                        document.getElementById('error-student-year').textContent = 
                            `Year of study (${yearOfStudy}) cannot exceed course duration (${maxYear} years)`;
                        hasErrors = true;
                    }
                }
            }
            
            // Validate current_semester against college semesters_per_year
            if (currentSemester) {
                const semesterValue = parseInt(currentSemester);
                const maxSemesters = await getSemestersPerYear();
                if (semesterValue < 1 || semesterValue > maxSemesters) {
                    document.getElementById('error-student-current-semester').textContent = 
                        `Semester (${semesterValue}) must be between 1 and ${maxSemesters}`;
                    hasErrors = true;
                }
            }
            
            // Validate sponsorship fields
            if (isSponsored) {
                if (!sponsorshipDiscountType) {
                    document.getElementById('error-student-sponsorship-discount-type').textContent = 
                        'Discount type is required when student is sponsored';
                    hasErrors = true;
                }
                if (!sponsorshipDiscountValue) {
                    document.getElementById('error-student-sponsorship-discount-value').textContent = 
                        'Discount value is required when student is sponsored';
                    hasErrors = true;
                } else if (sponsorshipDiscountType === 'percentage') {
                    const discountValue = parseFloat(sponsorshipDiscountValue);
                    if (discountValue < 0 || discountValue > 100) {
                        document.getElementById('error-student-sponsorship-discount-value').textContent = 
                            'Percentage discount must be between 0 and 100';
                        hasErrors = true;
                    }
                }
            }
            
            if (hasErrors) {
                return;
            }
            
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline-block';
            submitBtn.disabled = true;

            const formData = {
                admission_number: admissionNumber,
                full_name: fullName,
                email: email,
                phone: phone,
                gender: gender,
                year: yearOfStudy,
                date_of_birth: dateOfBirth,
                current_semester: currentSemester || null,
                course: courseId || null,
                has_ream_paper: hasReamPaper,
                is_sponsored: isSponsored,
                sponsorship_discount_type: sponsorshipDiscountType || null,
                sponsorship_discount_value: sponsorshipDiscountValue || null
            };

            try {
                if (editId) {
                    await window.LandingData.updateStudent(parseInt(editId), formData);
                } else {
                    await window.LandingData.createStudent(formData);
                }
            } catch (error) {
                console.error('Error saving student:', error);
                // Show error message to user
                if (error.message) {
                    showToast('error', error.message);
                } else {
                    showToast('error', 'An error occurred while saving the student');
                }
            } finally {
                btnText.style.display = 'inline-block';
                btnLoader.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        async function handleCourseSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const editId = form.dataset.editId;
            const submitBtn = form.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoader = submitBtn.querySelector('.btn-loader');
            
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline-block';
            submitBtn.disabled = true;

            const departmentName = document.getElementById('course-department').value;
            const courseName = document.getElementById('course-name').value.trim();
            const courseCode = document.getElementById('course-code').value.trim().toUpperCase();
            
            // Validate department selection for new courses
            if (!editId && !departmentName) {
                showToast('error', 'Please select a department');
                btnText.style.display = 'inline-block';
                btnLoader.style.display = 'none';
                submitBtn.disabled = false;
                return;
            }

            // Validate course code
            if (!courseCode) {
                showToast('error', 'Course code is required');
                btnText.style.display = 'inline-block';
                btnLoader.style.display = 'none';
                submitBtn.disabled = false;
                return;
            }

            const formData = {
                code: courseCode,
                name: courseName,
                duration: parseInt(document.getElementById('course-duration').value),
                global_course_id: document.getElementById('course-global-course-id').value || null,
                admission_requirements: document.getElementById('course-admission-requirements').value || '',
                department_name: departmentName || null
            };

            try {
                if (editId) {
                    await window.LandingData.updateCourse(parseInt(editId), formData);
                } else {
                    await window.LandingData.createCourse(formData);
                }
            } catch (error) {
                console.error('Error saving course:', error);
            } finally {
                btnText.style.display = 'inline-block';
                btnLoader.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        async function handleUnitSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const editId = form.dataset.editId;
            const submitBtn = form.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoader = submitBtn.querySelector('.btn-loader');
            
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline-block';
            submitBtn.disabled = true;

            const formData = {
                code: document.getElementById('unit-code').value,
                name: document.getElementById('unit-name').value,
                semester: parseInt(document.getElementById('unit-semester').value),
                global_unit_id: document.getElementById('unit-global-unit-id').value || null,
                assigned_lecturer_id: document.getElementById('unit-lecturer').value || null
            };

            try {
                if (editId) {
                    await window.LandingData.updateUnit(parseInt(editId), formData);
                } else {
                    await window.LandingData.createUnit(formData);
                }
            } catch (error) {
                console.error('Error saving unit:', error);
            } finally {
                btnText.style.display = 'inline-block';
                btnLoader.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        // Global unit search functions
        let globalUnitsCache = [];
        let globalUnitSearchTimeout;

        async function loadGlobalUnits(search = '') {
            try {
                const params = new URLSearchParams();
                if (search) params.append('search', search);
                
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/global-units/?${params.toString()}`);
                const data = await response.json();
                
                if (data.results) {
                    globalUnitsCache = data.results;
                    return data.results;
                }
                return [];
            } catch (error) {
                console.error('Error loading global units:', error);
                return [];
            }
        }

        function handleGlobalUnitSearch() {
            clearTimeout(globalUnitSearchTimeout);
            const searchInput = document.getElementById('unit-global-unit-search');
            const dropdown = document.getElementById('unit-global-unit-dropdown');
            const results = document.getElementById('unit-global-unit-results');
            const noResults = document.getElementById('unit-global-unit-no-results');
            
            const searchTerm = searchInput.value.trim();
            
            if (searchTerm.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            globalUnitSearchTimeout = setTimeout(async () => {
                const units = await loadGlobalUnits(searchTerm);
                
                if (units.length > 0) {
                    results.innerHTML = units.map(unit => `
                        <div class="search-result-item" onclick="selectGlobalUnit(${unit.id}, '${unit.code}', '${unit.name.replace(/'/g, "\\'")}')">
                            <strong>${unit.code}</strong> - ${unit.name}
                        </div>
                    `).join('');
                    results.style.display = 'block';
                    noResults.style.display = 'none';
                } else {
                    results.style.display = 'none';
                    noResults.style.display = 'block';
                }
                
                dropdown.style.display = 'block';
            }, 300);
        }

        function selectGlobalUnit(id, code, name) {
            document.getElementById('unit-global-unit-id').value = id;
            document.getElementById('unit-global-unit-search').value = `${code} - ${name}`;
            document.getElementById('selected-global-unit-text').textContent = `${code} - ${name}`;
            document.getElementById('selected-global-unit').style.display = 'block';
            document.getElementById('unit-global-unit-dropdown').style.display = 'none';
            
            // Pre-fill unit code and name from global unit (only when creating, not editing)
            if (!document.getElementById('unit-form').dataset.editId) {
                document.getElementById('unit-code').value = code;
                document.getElementById('unit-name').value = name;
            }
        }
        window.selectGlobalUnit = selectGlobalUnit;

        function clearGlobalUnitSelection() {
            document.getElementById('unit-global-unit-id').value = '';
            document.getElementById('unit-global-unit-search').value = '';
            document.getElementById('selected-global-unit').style.display = 'none';
        }
        window.clearGlobalUnitSelection = clearGlobalUnitSelection;

        async function loadLecturersForUnit() {
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/lecturers/`);
                const data = await response.json();
                const select = document.getElementById('unit-lecturer');
                
                if (select && data.results) {
                    // Clear existing options except the first one
                    select.innerHTML = '<option value="">-- No Lecturer Assigned --</option>';
                    
                    data.results.forEach(lecturer => {
                        const option = document.createElement('option');
                        option.value = lecturer.id;
                        option.textContent = `${lecturer.first_name} ${lecturer.last_name}`.trim() || lecturer.email;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading lecturers:', error);
            }
        }
        window.loadLecturersForUnit = loadLecturersForUnit;

        // Global course search functions
        let globalCoursesCache = [];
        let globalCourseSearchTimeout;

        async function loadGlobalCourses(search = '') {
            try {
                const params = new URLSearchParams();
                if (search) params.append('search', search);
                
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/global-courses/?${params.toString()}`);
                const data = await response.json();
                
                if (data.results) {
                    globalCoursesCache = data.results;
                    return data.results;
                }
                return [];
            } catch (error) {
                console.error('Error loading global courses:', error);
                return [];
            }
        }

        function handleGlobalCourseSearch() {
            clearTimeout(globalCourseSearchTimeout);
            const searchInput = document.getElementById('course-global-course-search');
            const dropdown = document.getElementById('course-global-course-dropdown');
            const results = document.getElementById('course-global-course-results');
            const noResults = document.getElementById('course-global-course-no-results');
            
            const searchTerm = searchInput.value.trim();
            
            if (searchTerm.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            globalCourseSearchTimeout = setTimeout(async () => {
                const courses = await loadGlobalCourses(searchTerm);
                
                if (courses.length > 0) {
                    results.innerHTML = courses.map(course => `
                        <div class="search-result-item" onclick="selectGlobalCourse(${course.id}, '${course.name.replace(/'/g, "\\'")}', '${course.level_display || course.level}')">
                            <strong>${course.name}</strong> - ${course.level_display || course.level}
                            ${course.category ? `<span style="color: #666; font-size: 0.9em;"> (${course.category})</span>` : ''}
                        </div>
                    `).join('');
                    results.style.display = 'block';
                    noResults.style.display = 'none';
                } else {
                    results.style.display = 'none';
                    noResults.style.display = 'block';
                }
                
                dropdown.style.display = 'block';
            }, 300);
        }

        function selectGlobalCourse(id, name, level) {
            document.getElementById('course-global-course-id').value = id;
            document.getElementById('course-global-course-search').value = `${name} (${level})`;
            document.getElementById('selected-global-course-text').textContent = `${name} (${level})`;
            document.getElementById('selected-global-course').style.display = 'block';
            document.getElementById('course-global-course-dropdown').style.display = 'none';
            
            // Pre-fill course name from global course (only when creating, not editing)
            if (!document.getElementById('course-form').dataset.editId) {
                document.getElementById('course-name').value = name;
            }
        }
        window.selectGlobalCourse = selectGlobalCourse;

        function clearGlobalCourseSelection() {
            document.getElementById('course-global-course-id').value = '';
            document.getElementById('course-global-course-search').value = '';
            document.getElementById('selected-global-course').style.display = 'none';
        }
        window.clearGlobalCourseSelection = clearGlobalCourseSelection;

        // Search functions - each with its own timeout
        let studentsSearchTimeout;
        function searchStudents() {
            clearTimeout(studentsSearchTimeout);
            studentsSearchTimeout = setTimeout(() => {
                const searchInput = document.getElementById('students-search');
                if (!searchInput) {
                    console.error('Students search input not found');
                    return;
                }
                const search = searchInput.value.trim();
                console.log('Searching students:', search);
                
                // Wait for LandingData to be available (with retry)
                function trySearch(retries = 20) {
                    if (window.LandingData && typeof window.LandingData.fetchStudents === 'function') {
                        console.log('Calling fetchStudents with search:', search);
                        window.LandingData.fetchStudents(1, search);
                    } else if (retries > 0) {
                        // Retry after a short delay if LandingData not ready yet
                        console.log('Waiting for LandingData... retries left:', retries);
                        setTimeout(() => trySearch(retries - 1), 200);
                    } else {
                        console.error('LandingData.fetchStudents is not available after retries', {
                            LandingData: window.LandingData,
                            typeof: typeof window.LandingData,
                            fetchStudents: window.LandingData ? typeof window.LandingData.fetchStudents : 'N/A'
                        });
                        // Try to load the script manually if it failed
                        if (!window.LandingData) {
                            console.error('LandingData is completely missing. Check if landing-data.js loaded correctly.');
                        }
                    }
                }
                trySearch();
            }, 500);
        }
        // Make function globally accessible immediately
        window.searchStudents = searchStudents;
        
        // Set up search input event listeners when DOM is ready
        // Initialize marks entry system on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load academic year options for unit selection
            if (document.getElementById('unit-selection-year-filter')) {
                loadAcademicYearOptions();
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            // Function to attach search listeners
            function attachSearchListeners() {
                const searchInput = document.getElementById('students-search');
                if (searchInput && !searchInput.dataset.listenerAttached) {
                    // Mark as attached to prevent duplicate listeners
                    searchInput.dataset.listenerAttached = 'true';
                    // Add both input and keyup listeners for better compatibility
                    searchInput.addEventListener('input', searchStudents);
                    searchInput.addEventListener('keyup', searchStudents);
                }
            }
            
            // Attach immediately if element exists
            attachSearchListeners();
            
            // Also attach when students section becomes active (using MutationObserver)
            const studentsSection = document.getElementById('students-section');
            if (studentsSection) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            if (studentsSection.classList.contains('active')) {
                                attachSearchListeners();
                            }
                        }
                    });
                });
                observer.observe(studentsSection, { attributes: true });
            }
        });

        let coursesSearchTimeout;
        function searchCourses() {
            clearTimeout(coursesSearchTimeout);
            coursesSearchTimeout = setTimeout(() => {
                const searchInput = document.getElementById('courses-search');
                if (!searchInput) {
                    console.error('Courses search input not found');
                    return;
                }
                const search = searchInput.value.trim();
                console.log('Searching courses:', search);
                
                // Wait for LandingData to be available (with retry)
                function trySearch(retries = 20) {
                    if (window.LandingData && typeof window.LandingData.fetchCourses === 'function') {
                        console.log('Calling fetchCourses with search:', search);
                window.LandingData.fetchCourses(1, search);
                    } else if (retries > 0) {
                        // Retry after a short delay if LandingData not ready yet
                        setTimeout(() => trySearch(retries - 1), 200);
                    } else {
                        console.error('LandingData.fetchCourses is not available after retries', window.LandingData);
                    }
                }
                trySearch();
            }, 500);
        }
        // Export to window
        window.searchCourses = searchCourses;

        function searchUnits() {
            // Redirect to new search function
            if (typeof window.searchUnitsWithFilters === 'function') {
                window.searchUnitsWithFilters();
            }
        }
        
        // Legacy function - kept for compatibility
        function searchUnitsOld() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const search = document.getElementById('units-search').value;
                window.LandingData.fetchUnits(1, search);
            }, 500);
        }

        let departmentsSearchTimeout;
        function searchDepartments() {
            clearTimeout(departmentsSearchTimeout);
            departmentsSearchTimeout = setTimeout(() => {
                const searchInput = document.getElementById('departments-search');
                if (!searchInput) {
                    console.error('Departments search input not found');
                    return;
                }
                const search = searchInput.value.trim();
                console.log('Searching departments:', search);
                
                // Wait for LandingData to be available (with retry)
                function trySearch(retries = 20) {
                    if (window.LandingData && typeof window.LandingData.fetchDepartments === 'function') {
                        console.log('Calling fetchDepartments with search:', search);
                window.LandingData.fetchDepartments(1, search);
                    } else if (retries > 0) {
                        // Retry after a short delay if LandingData not ready yet
                        setTimeout(() => trySearch(retries - 1), 200);
                    } else {
                        console.error('LandingData.fetchDepartments is not available after retries', window.LandingData);
                    }
                }
                trySearch();
            }, 500);
        }
        // Export to window
        window.searchDepartments = searchDepartments;

        let lecturersSearchTimeout;
        function searchLecturers() {
            clearTimeout(lecturersSearchTimeout);
            lecturersSearchTimeout = setTimeout(() => {
                const searchInput = document.getElementById('lecturers-search');
                if (!searchInput) {
                    console.error('Lecturers search input not found');
                    return;
                }
                const search = searchInput.value.trim();
                console.log('Searching lecturers:', search);
                
                // Wait for LandingData to be available (with retry)
                function trySearch(retries = 10) {
                    if (window.LandingData && typeof window.LandingData.fetchLecturers === 'function') {
                        console.log('Calling fetchLecturers with search:', search);
                window.LandingData.fetchLecturers(1, search);
                    } else if (retries > 0) {
                        // Retry after a short delay if LandingData not ready yet
                        setTimeout(() => trySearch(retries - 1), 100);
                    } else {
                        console.error('LandingData.fetchLecturers is not available after retries', window.LandingData);
                    }
                }
                trySearch();
            }, 500);
        }
        // Export to window
        window.searchLecturers = searchLecturers;

        let resultsSearchTimeout;
        function searchResults() {
            clearTimeout(resultsSearchTimeout);
            resultsSearchTimeout = setTimeout(() => {
                const searchInput = document.getElementById('results-search');
                if (!searchInput) {
                    console.error('Results search input not found');
                    return;
                }
                const search = searchInput.value.trim();
                console.log('Searching results:', search);
                
                // Wait for LandingData to be available (with retry)
                function trySearch(retries = 10) {
                    if (window.LandingData && typeof window.LandingData.fetchResults === 'function') {
                        console.log('Calling fetchResults with search:', search);
                window.LandingData.fetchResults(1, search);
                    } else if (retries > 0) {
                        // Retry after a short delay if LandingData not ready yet
                        setTimeout(() => trySearch(retries - 1), 100);
                    } else {
                        console.error('LandingData.fetchResults is not available after retries', window.LandingData);
                    }
                }
                trySearch();
            }, 500);
        }
        // Export to window
        window.searchResults = searchResults;

        // Debug: Verify all search functions are available
        // Initialize marks entry system on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load academic year options for unit selection
            if (document.getElementById('unit-selection-year-filter')) {
                loadAcademicYearOptions();
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Search functions loaded:', {
                searchStudents: typeof window.searchStudents,
                searchCourses: typeof window.searchCourses,
                searchDepartments: typeof window.searchDepartments,
                searchLecturers: typeof window.searchLecturers,
                searchResults: typeof window.searchResults,
                LandingData: typeof window.LandingData
            });
        });

        // Modal open functions
        function openDepartmentModal() {
            document.getElementById('department-modal-title').textContent = 'Add New Department';
            const form = document.getElementById('department-form');
            delete form.dataset.editId;
            delete form.dataset.oldName;
            // Clear form fields
            document.getElementById('department-code').value = '';
            document.getElementById('department-name').value = '';
            document.getElementById('department-description').value = '';
            openModal('department-modal');
        }

        function openLecturerModal() {
            document.getElementById('lecturer-modal-title').textContent = 'Add New Lecturer';
            document.getElementById('lecturer-form').dataset.editId = '';
            document.getElementById('lecturer-form').dataset.originalRole = '';
            document.getElementById('lecturer-password-group').style.display = 'block';
            document.getElementById('lecturer-password').required = true;
            
            // Update submit button text
            const submitBtn = document.getElementById('lecturer-submit-btn');
            const btnText = submitBtn ? submitBtn.querySelector('.btn-text') : null;
            if (btnText) {
                btnText.textContent = 'Create Lecturer';
            }
            
            // Hide role field for new lecturers (only admins can set role on creation)
            const roleGroup = document.getElementById('lecturer-role-group');
            const roleSelect = document.getElementById('lecturer-role');
            const confirmationDiv = document.getElementById('lecturer-role-confirmation');
            const isAdmin = window.IS_COLLEGE_ADMIN || false;
            
            if (roleGroup && roleSelect) {
                if (isAdmin) {
                    roleGroup.style.display = 'block';
                    roleSelect.value = 'lecturer'; // Default to lecturer
                    roleSelect.disabled = false;
                    roleSelect.dataset.originalRole = 'lecturer';
                    if (typeof updateLecturerRoleBadge === 'function') {
                        updateLecturerRoleBadge('lecturer');
                    }
                } else {
                    roleGroup.style.display = 'none';
                }
            }
            
            if (confirmationDiv) {
                confirmationDiv.style.display = 'none';
            }
            
            // Reset form
            document.getElementById('lecturer-form').reset();
            
            openModal('lecturer-modal');
        }

        async function openEnrollmentModal() {
            document.getElementById('enrollment-modal-title').textContent = 'Enroll Student';
            document.getElementById('enrollment-form').dataset.editId = '';
            document.getElementById('enrollment-submit-text').textContent = 'Enroll Student';
            
            // Reset form
            document.getElementById('enrollment-form').reset();
            
            // Load students, units, and academic year dropdown
            await loadEnrollmentFormStudents();
            await loadEnrollmentFormUnits();
            await populateEnrollmentAcademicYearDropdown();
            
            openModal('enrollment-modal');
        }
        
        async function populateEnrollmentAcademicYearDropdown() {
            const yearSelect = document.getElementById('enrollment-academic-year');
            if (!yearSelect) return;
            
            try {
                // Get academic settings to get current_academic_year
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/academic-settings/`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error loading academic settings:', data.error);
                    return;
                }
                
                const currentAcademicYear = data.current_academic_year;
                if (!currentAcademicYear) {
                    // Fallback: calculate from current date
                    const currentYear = new Date().getFullYear();
                    const fallbackYear = `${currentYear}/${currentYear + 1}`;
                    yearSelect.innerHTML = `<option value="${fallbackYear}">${fallbackYear}</option>`;
                    yearSelect.value = fallbackYear;
                    return;
                }
                
                // Generate range: past 2 years, current, future 3 years
                const baseYear = parseInt(currentAcademicYear.split('/')[0]);
                yearSelect.innerHTML = '<option value="">Select Academic Year</option>';
                
                for (let i = -2; i <= 3; i++) {
                    const year = baseYear + i;
                    const yearStr = `${year}/${year + 1}`;
                    const option = document.createElement('option');
                    option.value = yearStr;
                    option.textContent = yearStr;
                    if (yearStr === currentAcademicYear) {
                        option.selected = true;
                    }
                    yearSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error populating enrollment academic year dropdown:', error);
                // Fallback: calculate from current date
                const currentYear = new Date().getFullYear();
                const fallbackYear = `${currentYear}/${currentYear + 1}`;
                yearSelect.innerHTML = `<option value="${fallbackYear}">${fallbackYear}</option>`;
                yearSelect.value = fallbackYear;
            }
        }
        
        async function loadEnrollmentFormStudents() {
            try {
                const params = new URLSearchParams({
                    page: 1,
                    page_size: 1000
                });
                
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/students/?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken || ''
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const studentsData = await response.json();
                const studentSelect = document.getElementById('enrollment-student');
                if (studentSelect && studentsData && studentsData.results) {
                    studentSelect.innerHTML = '<option value="">Select Student</option>';
                    studentsData.results.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = `${student.full_name} (${student.admission_number})`;
                        studentSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading students for enrollment form:', error);
            }
        }
        window.loadEnrollmentFormStudents = loadEnrollmentFormStudents;
        
        async function loadEnrollmentFormUnits() {
            try {
                const params = new URLSearchParams({
                    page: 1,
                    page_size: 1000
                });
                
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/units/?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken || ''
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const unitsData = await response.json();
                const unitSelect = document.getElementById('enrollment-unit');
                if (unitSelect && unitsData && unitsData.results) {
                    unitSelect.innerHTML = '<option value="">Select Unit</option>';
                    unitsData.results.forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit.id;
                        option.textContent = `${unit.code} - ${unit.name}`;
                        unitSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading units for enrollment form:', error);
            }
        }
        window.loadEnrollmentFormUnits = loadEnrollmentFormUnits;

        // Form handlers
        async function handleDepartmentSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const editId = form.dataset.editId;
            const oldName = form.dataset.oldName;  // Get original name
            const formData = {
                code: document.getElementById('department-code').value.trim(),
                name: document.getElementById('department-name').value.trim(),
                description: document.getElementById('department-description').value.trim()
            };
            
            // Validate required fields
            if (!formData.code || !formData.name) {
                showToast('error', 'Please fill in all required fields (Code and Name)');
                return;
            }
            
            try {
                if (editId) {
                    // Include old_name for identification
                    await window.LandingData.updateDepartment(parseInt(editId), {
                        ...formData,
                        old_name: oldName || ''
                    });
                } else {
                    await window.LandingData.createDepartment(formData);
                }
                // Reset form data attributes
                delete form.dataset.editId;
                delete form.dataset.oldName;
            } catch (error) {
                console.error('Error saving department:', error);
                // Error toast is already shown by createDepartment/updateDepartment
            }
        }

        async function handleLecturerSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const editId = form.dataset.editId;
            const submitBtn = document.getElementById('lecturer-submit-btn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoader = submitBtn.querySelector('.btn-loader');
            
            // Disable submit button and show loading
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline-block';
            
            try {
                const formData = {
                    username: document.getElementById('lecturer-username').value,
                    first_name: document.getElementById('lecturer-first-name').value,
                    last_name: document.getElementById('lecturer-last-name').value,
                    email: document.getElementById('lecturer-email').value,
                    phone: document.getElementById('lecturer-phone').value
                };
                
                if (!editId) {
                    formData.password = document.getElementById('lecturer-password').value;
                } else if (document.getElementById('lecturer-password').value) {
                    formData.password = document.getElementById('lecturer-password').value;
                }
                
                // Check for role change (only when editing)
                if (editId) {
                    const roleSelect = document.getElementById('lecturer-role');
                    const originalRole = form.dataset.originalRole;
                    const newRole = roleSelect ? roleSelect.value : null;
                    const confirmCheckbox = document.getElementById('lecturer-role-confirm-checkbox');
                    
                    // If role changed, validate confirmation
                    if (newRole && newRole !== originalRole) {
                        if (!confirmCheckbox || !confirmCheckbox.checked) {
                            showToast('error', 'Please confirm the role change before submitting');
                            confirmCheckbox.focus();
                            submitBtn.disabled = false;
                            btnText.style.display = 'inline';
                            btnLoader.style.display = 'none';
                            return;
                        }
                        
                        // Update role first via role API endpoint
                        try {
                            const roleResponse = await fetch(`/api/${window.COLLEGE_SLUG}/lecturers/${editId}/role/`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': window.csrftoken
                                },
                                credentials: 'same-origin',
                                body: JSON.stringify({ role: newRole })
                            });
                            
                            if (!roleResponse.ok) {
                                const error = await roleResponse.json();
                                throw new Error(error.error || 'Failed to update role');
                            }
                            
                            const roleData = await roleResponse.json();
                            console.log('Role updated:', roleData);
                        } catch (roleError) {
                            console.error('Error updating role:', roleError);
                            showToast('error', roleError.message || 'Failed to update role. Other changes were not saved.');
                            submitBtn.disabled = false;
                            btnText.style.display = 'inline';
                            btnLoader.style.display = 'none';
                            return;
                        }
                    }
                }
                
                // Add role to formData if creating new lecturer (only for admins)
                if (!editId) {
                    const roleSelect = document.getElementById('lecturer-role');
                    if (roleSelect && window.IS_COLLEGE_ADMIN) {
                        formData.role = roleSelect.value || 'lecturer';
                    }
                }
                
                // Update lecturer data
                if (editId) {
                    await window.LandingData.updateLecturer(parseInt(editId), formData);
                    if (form.dataset.originalRole && document.getElementById('lecturer-role') && 
                        document.getElementById('lecturer-role').value !== form.dataset.originalRole) {
                        showToast('success', 'Lecturer updated and role changed successfully');
                    } else {
                        showToast('success', 'Lecturer updated successfully');
                    }
                } else {
                    await window.LandingData.createLecturer(formData);
                    showToast('success', 'Lecturer created successfully');
                }
                
                // Close modal and refresh
                closeModal('lecturer-modal');
                if (window.LandingData && window.LandingData.fetchLecturers) {
                    // Fetch lecturers - use page 1 as default since state is not exposed
                    await window.LandingData.fetchLecturers(1);
                }
            } catch (error) {
                console.error('Error saving lecturer:', error);
                showToast('error', error.message || 'Failed to save lecturer');
            } finally {
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
            }
        }

        function openAddUserModal() {
            // Reset form
            document.getElementById('add-user-form').reset();
            
            // Clear error messages
            document.querySelectorAll('#add-user-modal .error-message').forEach(el => {
                el.textContent = '';
            });
            
            // Reset submit button
            const submitBtn = document.getElementById('add-user-submit-btn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoader = submitBtn.querySelector('.btn-loader');
            submitBtn.disabled = false;
            btnText.style.display = 'inline';
            btnLoader.style.display = 'none';
            
            openModal('add-user-modal');
        }
        // Export to window immediately
        window.openAddUserModal = openAddUserModal;

        async function handleAddUserSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = document.getElementById('add-user-submit-btn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoader = submitBtn.querySelector('.btn-loader');
            
            // Clear previous error messages
            document.querySelectorAll('#add-user-modal .error-message').forEach(el => {
                el.textContent = '';
            });
            
            // Disable submit button and show loading
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline-block';
            
            try {
                const formData = {
                    username: document.getElementById('add-user-username').value.trim(),
                    first_name: document.getElementById('add-user-first-name').value.trim(),
                    last_name: document.getElementById('add-user-last-name').value.trim(),
                    email: document.getElementById('add-user-email').value.trim(),
                    phone: document.getElementById('add-user-phone').value.trim(),
                    password: document.getElementById('add-user-password').value,
                    role: document.getElementById('add-user-role').value
                };
                
                // Validate required fields
                if (!formData.username) {
                    document.getElementById('error-add-user-username').textContent = 'Username is required';
                    throw new Error('Username is required');
                }
                if (!formData.first_name) {
                    document.getElementById('error-add-user-first-name').textContent = 'First name is required';
                    throw new Error('First name is required');
                }
                if (!formData.last_name) {
                    document.getElementById('error-add-user-last-name').textContent = 'Last name is required';
                    throw new Error('Last name is required');
                }
                if (!formData.email) {
                    document.getElementById('error-add-user-email').textContent = 'Email is required';
                    throw new Error('Email is required');
                }
                if (!formData.password) {
                    document.getElementById('error-add-user-password').textContent = 'Password is required';
                    throw new Error('Password is required');
                }
                if (!formData.role) {
                    document.getElementById('error-add-user-role').textContent = 'Role is required';
                    throw new Error('Role is required');
                }
                
                // Create user via API
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/lecturers/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    // Handle validation errors
                    if (data.error) {
                        if (data.error.includes('username')) {
                            document.getElementById('error-add-user-username').textContent = data.error;
                        } else if (data.error.includes('email')) {
                            document.getElementById('error-add-user-email').textContent = data.error;
                        } else {
                            showToast('error', data.error);
                        }
                    } else {
                        showToast('error', 'Failed to create user');
                    }
                    throw new Error(data.error || 'Failed to create user');
                }
                
                showToast('success', 'User created successfully');
                
                // Close modal and refresh user list
                closeModal('add-user-modal');
                loadUserManagement();
                
            } catch (error) {
                console.error('Error creating user:', error);
                if (!error.message.includes('required') && !error.message.includes('already')) {
                    showToast('error', error.message || 'Failed to create user');
                }
            } finally {
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                btnLoader.style.display = 'none';
            }
        }
        // Export to window immediately
        window.handleAddUserSubmit = handleAddUserSubmit;

        async function handleEnrollmentSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const editId = form.dataset.editId;
            const submitBtn = form.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoader = submitBtn.querySelector('.btn-loader');
            
            // Show loading state
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline-block';
            submitBtn.disabled = true;
            
            const formData = {
                student: parseInt(document.getElementById('enrollment-student').value),
                unit: parseInt(document.getElementById('enrollment-unit').value),
                academic_year: document.getElementById('enrollment-academic-year').value,
                semester: parseInt(document.getElementById('enrollment-semester').value)
            };
            
            try {
                if (editId) {
                    await window.LandingData.updateEnrollment(parseInt(editId), formData);
                } else {
                    await window.LandingData.createEnrollment(formData);
                }
            } catch (error) {
                console.error('Error saving enrollment:', error);
                showToast('error', error.message || 'Failed to save enrollment');
            } finally {
                // Hide loading state
                btnText.style.display = 'inline-block';
                btnLoader.style.display = 'none';
                submitBtn.disabled = false;
            }
        }

        async function handleResultSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const enrollmentId = parseInt(form.dataset.enrollmentId);
            const submitBtn = document.getElementById('save-result-btn') || form.querySelector('button[type="submit"]');
            const btnText = submitBtn ? submitBtn.querySelector('.btn-text') : null;
            const btnLoader = submitBtn ? submitBtn.querySelector('.btn-loader') : null;
            
            if (!enrollmentId) {
                showToast('error', 'Enrollment ID is required');
                return;
            }
            
            // Show loading state
            if (submitBtn) {
                submitBtn.disabled = true;
                if (btnText) btnText.style.display = 'none';
                if (btnLoader) btnLoader.style.display = 'inline-block';
            }
            
            const formData = {
                cat_marks: parseFloat(document.getElementById('result-cat-marks').value) || null,
                exam_marks: parseFloat(document.getElementById('result-exam-marks').value) || null
            };
            
            // Validate that at least one mark is entered
            if (formData.cat_marks === null && formData.exam_marks === null) {
                showToast('error', 'Please enter at least one mark (CAT or Exam)');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    if (btnText) btnText.style.display = 'inline-block';
                    if (btnLoader) btnLoader.style.display = 'none';
                }
                return;
            }
            
            try {
                await window.LandingData.saveResult(enrollmentId, formData);
                showToast('success', 'Results saved successfully');
                closeModal('result-modal');
                // Refresh results list
                if (window.LandingData && window.LandingData.fetchResults) {
                    await window.LandingData.fetchResults();
                }
            } catch (error) {
                console.error('Error saving result:', error);
                const errorMsg = error.message || 'Failed to save results. Please try again.';
                showToast('error', errorMsg);
            } finally {
                // Reset button state
                if (submitBtn) {
                    submitBtn.disabled = false;
                    if (btnText) btnText.style.display = 'inline-block';
                    if (btnLoader) btnLoader.style.display = 'none';
                }
            }
        }

        async function calculateTotal() {
            const catMarks = parseFloat(document.getElementById('result-cat-marks').value) || 0;
            const examMarks = parseFloat(document.getElementById('result-exam-marks').value) || 0;
            
            // Get grading criteria from API (optional - may fail for non-admins)
            let criteria = null;
            try {
                if (window.COLLEGE_SLUG) {
                    const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/grading-system/`, {
                        headers: { 'X-CSRFToken': window.csrftoken }
                    });
                    // Handle 403 gracefully (lecturers don't have admin access)
                    if (response.ok) {
                        const data = await response.json();
                        if (!data.error && data.grading_criteria) {
                            criteria = data.grading_criteria;
                        }
                    }
                    // Silently ignore 403 errors
                }
            } catch (error) {
                // Silently handle errors - use default grading
            }
            
            // Formula: Total = CAT + Exam (direct addition)
            // cat_weight and exam_weight represent maximum marks, not percentages
            const total = catMarks + examMarks;
            document.getElementById('result-total').value = total.toFixed(2);
            
            // Calculate grade using configured criteria or defaults
            let grade = 'N/A';
            if (criteria && criteria.grades) {
                // Sort grades by min value descending
                const sortedGrades = Object.entries(criteria.grades).sort((a, b) => b[1].min - a[1].min);
                for (const [gradeName, range] of sortedGrades) {
                    if (total >= range.min && total <= range.max) {
                        grade = gradeName;
                        break;
                    }
                }
            } else {
                // Default grading
            if (total >= 70) grade = 'A';
            else if (total >= 60) grade = 'B';
            else if (total >= 50) grade = 'C';
            else if (total >= 40) grade = 'D';
            else if (total > 0) grade = 'F';
            }
            document.getElementById('result-grade').value = grade;
        }
        
        // Update result input fields when page loads
        // Initialize marks entry system on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load academic year options for unit selection
            if (document.getElementById('unit-selection-year-filter')) {
                loadAcademicYearOptions();
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof window.LandingData !== 'undefined' && typeof window.LandingData.updateResultInputFields === 'function') {
                window.LandingData.updateResultInputFields();
            }
        });

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'enrollments') {
                document.getElementById('enrollments-tab').classList.add('active');
                document.getElementById('enrollments-tab-content').classList.add('active');
                // Load filters when tab is opened
                if (typeof loadEnrollmentFilters === 'function') {
                    loadEnrollmentFilters().then(() => {
                window.LandingData.fetchEnrollments();
                    });
                } else {
                    window.LandingData.fetchEnrollments();
                }
            } else if (tabName === 'results') {
                document.getElementById('results-tab').classList.add('active');
                document.getElementById('results-tab-content').classList.add('active');
                
                // Close marks entry modal if open
                const marksEntryModal = document.getElementById('marks-entry-modal');
                if (marksEntryModal) {
                    marksEntryModal.classList.remove('active');
                }
                
                // Show units grid view
                showResultsUnitsView();
                
                // Load filters when tab is opened (same as My Units tab)
                if (typeof loadResultsFilters === 'function') {
                    loadResultsFilters().then(() => {
                        // Load units after filters are loaded
                        if (typeof window.loadResultsUnits === 'function') {
                            window.loadResultsUnits();
                        }
                    });
                } else {
                    // Initialize if not loaded yet
                    setTimeout(() => {
                        if (typeof loadResultsFilters === 'function') {
                            loadResultsFilters().then(() => {
                                if (typeof window.loadResultsUnits === 'function') {
                                    window.loadResultsUnits();
                                }
                            });
                        }
                    }, 100);
                }
            } else if (tabName === 'my-units') {
                document.getElementById('my-units-tab').classList.add('active');
                document.getElementById('my-units-tab-content').classList.add('active');
                
                // Close marks entry modal if open
                const marksEntryModal = document.getElementById('marks-entry-modal');
                if (marksEntryModal) {
                    marksEntryModal.classList.remove('active');
                }
                
                // Load filters when tab is opened
                if (typeof loadMyUnitsFilters === 'function') {
                    loadMyUnitsFilters().then(() => {
                        // Load units after filters are loaded
                        if (typeof loadMyUnitsResults === 'function') {
                            loadMyUnitsResults();
                        }
                    });
                } else {
                    // Initialize if not loaded yet
                    setTimeout(() => {
                        if (typeof loadMyUnitsFilters === 'function') {
                            loadMyUnitsFilters().then(() => {
                                if (typeof loadMyUnitsResults === 'function') {
                                    loadMyUnitsResults();
                                }
                            });
                        }
                    }, 100);
                }
            }
        }

        function switchExportTab(tabName) {
            document.querySelectorAll('#export-section .tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#export-section .export-tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'transcripts') {
                document.getElementById('generate-transcripts-tab').classList.add('active');
                document.getElementById('generate-transcripts-tab-content').classList.add('active');
            } else if (tabName === 'student-list') {
                document.getElementById('student-list-tab').classList.add('active');
                document.getElementById('student-list-tab-content').classList.add('active');
                // Load student list when tab is opened
                loadStudentList();
                loadStudentListFilters();
            } else if (tabName === 'fields') {
                document.getElementById('select-fields-tab').classList.add('active');
                document.getElementById('select-fields-tab-content').classList.add('active');
            } else if (tabName === 'data') {
                document.getElementById('export-data-tab').classList.add('active');
                document.getElementById('export-data-tab-content').classList.add('active');
                // Load filter options when tab is opened
                loadExportDataFilters();
            }
        }
        
        // Load filter options for export data tab
        async function loadExportDataFilters() {
            if (!window.COLLEGE_SLUG) return;
            
            try {
                // Load courses for units and students filters
                const coursesResponse = await fetch(`/api/${window.COLLEGE_SLUG}/courses/?page_size=100`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                const coursesData = await coursesResponse.json();
                
                if (coursesData.results) {
                    // Populate units course filter
                    const unitsCourseSelect = document.getElementById('export-units-course-filter');
                    if (unitsCourseSelect) {
                        unitsCourseSelect.innerHTML = '<option value="">All Courses</option>';
                        coursesData.results.forEach(course => {
                            const option = document.createElement('option');
                            option.value = course.id;
                            option.textContent = course.name;
                            unitsCourseSelect.appendChild(option);
                        });
                    }
                }
                
                // Load academic years
                const yearsResponse = await fetch(`/api/${window.COLLEGE_SLUG}/enrollments/academic-years/`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                const yearsData = await yearsResponse.json();
                
                if (yearsData.academic_years) {
                    const yearSelects = [
                        'export-units-year-filter',
                        'export-courses-year-filter'
                    ];
                    
                    yearSelects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        if (select) {
                            select.innerHTML = '<option value="">All Years</option>';
                            yearsData.academic_years.forEach(year => {
                                const option = document.createElement('option');
                                option.value = year;
                                option.textContent = year;
                                select.appendChild(option);
                            });
                        }
                    });
                }
                
                // Load semesters for units filter
                await populateSemesterDropdown('export-units-semester-filter', true);
                
            } catch (error) {
                console.error('Error loading export data filters:', error);
            }
        }
        
        // Export functions
        async function exportTeachersToCSV() {
            if (!window.COLLEGE_SLUG) {
                showToast('error', 'College information not available');
                return;
            }
            
            try {
                const params = new URLSearchParams();
                const role = document.getElementById('export-teachers-role-filter').value;
                const search = document.getElementById('export-teachers-search').value;
                const status = document.getElementById('export-teachers-status-filter').value;
                
                if (role) params.append('role', role);
                if (search) params.append('search', search);
                if (status) params.append('status', status);
                
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/export/teachers/?${params.toString()}`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `teachers-export-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showToast('success', 'Teachers exported successfully');
                } else {
                    showToast('error', 'Failed to export teachers');
                }
            } catch (error) {
                console.error('Error exporting teachers:', error);
                showToast('error', 'Error exporting teachers');
            }
        }
        
        async function exportUnitsToCSV() {
            if (!window.COLLEGE_SLUG) {
                showToast('error', 'College information not available');
                return;
            }
            
            try {
                const params = new URLSearchParams();
                const course = document.getElementById('export-units-course-filter').value;
                const year = document.getElementById('export-units-year-filter').value;
                const semester = document.getElementById('export-units-semester-filter').value;
                const search = document.getElementById('export-units-search').value;
                
                if (course) params.append('course_id', course);
                if (year) params.append('academic_year', year);
                if (semester) params.append('semester', semester);
                if (search) params.append('search', search);
                
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/export/units/?${params.toString()}`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `units-export-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showToast('success', 'Units exported successfully');
                } else {
                    showToast('error', 'Failed to export units');
                }
            } catch (error) {
                console.error('Error exporting units:', error);
                showToast('error', 'Error exporting units');
            }
        }
        
        async function exportCoursesToCSV() {
            if (!window.COLLEGE_SLUG) {
                showToast('error', 'College information not available');
                return;
            }
            
            try {
                const params = new URLSearchParams();
                const year = document.getElementById('export-courses-year-filter').value;
                const search = document.getElementById('export-courses-search').value;
                const status = document.getElementById('export-courses-status-filter').value;
                
                if (year) params.append('academic_year', year);
                if (search) params.append('search', search);
                if (status) params.append('status', status);
                
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/export/courses/?${params.toString()}`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `courses-export-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showToast('success', 'Courses exported successfully');
                } else {
                    showToast('error', 'Failed to export courses');
                }
            } catch (error) {
                console.error('Error exporting courses:', error);
                showToast('error', 'Error exporting courses');
            }
        }
        
        // Student List Management
        let studentListState = {
            currentPage: 1,
            pageSize: 20,
            totalPages: 1,
            total: 0,
            selectedIds: new Set(),
            allStudents: []
        };

        async function loadStudentListFilters() {
            if (!window.COLLEGE_SLUG) return;
            
            try {
                // Load courses
                const coursesResponse = await fetch(`/api/${window.COLLEGE_SLUG}/courses/?page_size=100`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                const coursesData = await coursesResponse.json();
                
                const courseSelect = document.getElementById('student-list-course-filter');
                if (courseSelect && coursesData.results) {
                    courseSelect.innerHTML = '<option value="">All Courses</option>';
                    coursesData.results.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.name;
                        courseSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading student list filters:', error);
            }
        }

        async function loadStudentList(page = 1) {
            if (!window.COLLEGE_SLUG) return;
            
            const tbody = document.getElementById('student-list-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 24px; margin-bottom: 12px; display: block;"></i>Loading students...</td></tr>';
            
            try {
                const params = new URLSearchParams({
                    page: page,
                    page_size: studentListState.pageSize
                });
                
                const search = document.getElementById('student-list-search')?.value;
                const course = document.getElementById('student-list-course-filter')?.value;
                const status = document.getElementById('student-list-status-filter')?.value;
                
                if (search) params.append('search', search);
                if (course) params.append('course', course);
                if (status) params.append('status', status);
                
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/students/?${params.toString()}`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                
                const data = await response.json();
                
                if (data.results) {
                    studentListState.currentPage = data.page || page;
                    studentListState.totalPages = data.total_pages || 1;
                    studentListState.total = data.count || 0;
                    studentListState.allStudents = data.results;
                    
                    renderStudentListTable(data.results);
                    updateStudentListPagination();
                    updateSelectionCount();
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 40px; color: var(--text-secondary);">No students found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading student list:', error);
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 40px; color: var(--error);">Error loading students</td></tr>';
                showToast('error', 'Failed to load student list');
            }
        }

        function renderStudentListTable(students) {
            const tbody = document.getElementById('student-list-tbody');
            if (!tbody) return;
            
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 40px; color: var(--text-secondary);">No students found</td></tr>';
                return;
            }
            
            tbody.innerHTML = students.map(student => `
                <tr>
                    <td style="text-align: center;">
                        <input type="checkbox" class="student-list-checkbox" value="${student.id}" 
                               onchange="handleStudentSelection(${student.id}, this.checked)"
                               ${studentListState.selectedIds.has(student.id) ? 'checked' : ''}
                               style="width: 18px; height: 18px; cursor: pointer;">
                    </td>
                    <td><strong>${student.admission_number || '-'}</strong></td>
                    <td>${student.full_name || '-'}</td>
                </tr>
            `).join('');
        }

        function updateStudentListPagination() {
            const pageInfo = document.getElementById('student-list-page-info');
            const total = document.getElementById('student-list-total');
            const prevBtn = document.getElementById('student-list-prev-btn');
            const nextBtn = document.getElementById('student-list-next-btn');
            const pageNumbers = document.getElementById('student-list-page-numbers');
            
            if (pageInfo) {
                const start = ((studentListState.currentPage - 1) * studentListState.pageSize) + 1;
                const end = Math.min(start + studentListState.pageSize - 1, studentListState.total);
                pageInfo.textContent = `${start}-${end}`;
            }
            
            if (total) {
                total.textContent = studentListState.total;
            }
            
            if (prevBtn) {
                prevBtn.disabled = studentListState.currentPage <= 1;
            }
            
            if (nextBtn) {
                nextBtn.disabled = studentListState.currentPage >= studentListState.totalPages;
            }
            
            if (pageNumbers) {
                let html = '';
                const maxPages = 5;
                let startPage = Math.max(1, studentListState.currentPage - Math.floor(maxPages / 2));
                let endPage = Math.min(studentListState.totalPages, startPage + maxPages - 1);
                
                if (endPage - startPage < maxPages - 1) {
                    startPage = Math.max(1, endPage - maxPages + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    html += `<button class="btn btn-sm ${i === studentListState.currentPage ? 'btn-primary' : 'btn-outline-secondary'}" 
                             onclick="goToStudentListPage(${i})" style="font-size: 12px; padding: 6px 12px; min-width: 36px;">${i}</button>`;
                }
                pageNumbers.innerHTML = html;
            }
        }

        function changeStudentListPage(direction) {
            const newPage = studentListState.currentPage + direction;
            if (newPage >= 1 && newPage <= studentListState.totalPages) {
                loadStudentList(newPage);
            }
        }

        function goToStudentListPage(page) {
            if (page >= 1 && page <= studentListState.totalPages) {
                loadStudentList(page);
            }
        }

        function handleStudentListSearch(event) {
            if (event.key === 'Enter' || event.type === 'input') {
                clearTimeout(window.studentListSearchTimeout);
                window.studentListSearchTimeout = setTimeout(() => {
                    loadStudentList(1);
                }, 500);
            }
        }

        function clearStudentListFilters() {
            document.getElementById('student-list-search').value = '';
            document.getElementById('student-list-course-filter').value = '';
            document.getElementById('student-list-status-filter').value = '';
            loadStudentList(1);
        }

        function handleStudentSelection(id, checked) {
            if (checked) {
                studentListState.selectedIds.add(id);
            } else {
                studentListState.selectedIds.delete(id);
            }
            updateSelectionCount();
            const selectAllCheckbox = document.getElementById('student-list-select-all');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = studentListState.selectedIds.size === studentListState.allStudents.length && studentListState.allStudents.length > 0;
            }
        }

        function toggleSelectAllStudents(checkbox) {
            const checkboxes = document.querySelectorAll('.student-list-checkbox');
            checkboxes.forEach(cb => {
                const id = parseInt(cb.value);
                cb.checked = checkbox.checked;
                if (checkbox.checked) {
                    studentListState.selectedIds.add(id);
                } else {
                    studentListState.selectedIds.delete(id);
                }
            });
            updateSelectionCount();
        }

        function selectAllStudentList() {
            studentListState.allStudents.forEach(student => {
                studentListState.selectedIds.add(student.id);
            });
            document.querySelectorAll('.student-list-checkbox').forEach(cb => cb.checked = true);
            const selectAllCheckbox = document.getElementById('student-list-select-all');
            if (selectAllCheckbox) selectAllCheckbox.checked = true;
            updateSelectionCount();
        }

        function deselectAllStudentList() {
            studentListState.selectedIds.clear();
            document.querySelectorAll('.student-list-checkbox').forEach(cb => cb.checked = false);
            const selectAllCheckbox = document.getElementById('student-list-select-all');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            updateSelectionCount();
        }

        function updateSelectionCount() {
            const countEl = document.getElementById('selected-count');
            if (countEl) {
                countEl.textContent = studentListState.selectedIds.size;
            }
        }

        async function exportStudentListToCSV() {
            if (!window.COLLEGE_SLUG) {
                showToast('error', 'College information not available');
                return;
            }
            
            const selectedIds = Array.from(studentListState.selectedIds);
            if (selectedIds.length === 0) {
                showToast('error', 'Please select at least one student');
                return;
            }
            
            try {
                const params = new URLSearchParams();
                params.append('student_ids', selectedIds.join(','));
                params.append('format', 'simple'); // Simple format: only name and admission number
                
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/export/students/?${params.toString()}`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `student-list-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showToast('success', 'Student list exported successfully');
                } else {
                    const error = await response.json();
                    showToast('error', error.error || 'Failed to export student list');
                }
            } catch (error) {
                console.error('Error exporting student list:', error);
                showToast('error', 'Error exporting student list');
            }
        }

        async function exportStudentListToPDF() {
            if (!window.COLLEGE_SLUG) {
                showToast('error', 'College information not available');
                return;
            }
            
            const selectedIds = Array.from(studentListState.selectedIds);
            if (selectedIds.length === 0) {
                showToast('error', 'Please select at least one student');
                return;
            }
            
            try {
                showToast('info', 'Generating PDF... This may take a moment.');
                
                const params = new URLSearchParams();
                params.append('student_ids', selectedIds.join(','));
                params.append('report_type', 'transcript'); // Use transcript template from reports section
                
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/export/students/pdf/?${params.toString()}`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `student-list-${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showToast('success', 'Student list PDF generated successfully');
                } else {
                    const error = await response.json();
                    showToast('error', error.error || 'Failed to generate PDF');
                }
            } catch (error) {
                console.error('Error generating PDF:', error);
                showToast('error', 'Error generating PDF');
            }
        }

        function printStudentList() {
            const selectedIds = Array.from(studentListState.selectedIds);
            if (selectedIds.length === 0) {
                showToast('error', 'Please select at least one student');
                return;
            }
            
            const selectedStudents = studentListState.allStudents.filter(s => selectedIds.includes(s.id));
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Student List</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { text-align: center; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                    </style>
                </head>
                <body>
                    <h1>Student List</h1>
                    <table>
                        <thead>
                            <tr>
                                <th>Admission Number</th>
                                <th>Full Name</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${selectedStudents.map(s => `
                                <tr>
                                    <td><strong>${s.admission_number || '-'}</strong></td>
                                    <td>${s.full_name || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Export student list functions to window
        window.loadStudentList = loadStudentList;
        window.loadStudentListFilters = loadStudentListFilters;
        window.handleStudentListSearch = handleStudentListSearch;
        window.clearStudentListFilters = clearStudentListFilters;
        window.selectAllStudentList = selectAllStudentList;
        window.deselectAllStudentList = deselectAllStudentList;
        window.toggleSelectAllStudents = toggleSelectAllStudents;
        window.handleStudentSelection = handleStudentSelection;
        window.changeStudentListPage = changeStudentListPage;
        window.goToStudentListPage = goToStudentListPage;
        window.exportStudentListToCSV = exportStudentListToCSV;
        window.exportStudentListToPDF = exportStudentListToPDF;
        window.printStudentList = printStudentList;

        function switchSettingsTab(tabName) {
            document.querySelectorAll('#settings-section .tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#settings-section .tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'profile') {
                document.getElementById('profile-settings-tab').classList.add('active');
                document.getElementById('profile-settings-tab-content').classList.add('active');
            } else if (tabName === 'user-management') {
                const tab = document.getElementById('user-management-tab');
                const content = document.getElementById('user-management-tab-content');
                if (tab && content) {
                    tab.classList.add('active');
                    content.classList.add('active');
                    loadUserManagement(); // Load users when tab is opened
                }
            } else if (tabName === 'college') {
                document.getElementById('college-settings-tab').classList.add('active');
                document.getElementById('college-settings-tab-content').classList.add('active');
                // Load settings when college tab is opened
                setTimeout(() => {
                    loadAcademicSettings();
                    loadGradingSystem();
                    loadNominalRollSettings();
                }, 100);
            }
        }

        // Switch inner tabs within College Settings
        function switchCollegeSettingsTab(tabName) {
            console.log('switchCollegeSettingsTab called with:', tabName);
            
            // Remove active class from all inner tab buttons
            document.querySelectorAll('#college-settings-tab-content .tab-btn').forEach(btn => btn.classList.remove('active'));
            // Remove active class from all inner tab contents
            document.querySelectorAll('#college-settings-tab-content .college-settings-tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'info') {
                const infoTab = document.getElementById('college-info-inner-tab');
                const infoContent = document.getElementById('college-info-tab-content');
                console.log('Info tab elements:', { infoTab, infoContent });
                if (infoTab) infoTab.classList.add('active');
                if (infoContent) infoContent.classList.add('active');
            } else if (tabName === 'academic') {
                const academicTab = document.getElementById('academic-settings-inner-tab');
                const academicContent = document.getElementById('academic-settings-tab-content');
                console.log('Academic tab elements:', { academicTab, academicContent });
                if (!academicTab) console.error('Academic settings tab button not found!');
                if (!academicContent) console.error('Academic settings content not found!');
                if (academicTab) academicTab.classList.add('active');
                if (academicContent) {
                    academicContent.classList.add('active');
                    console.log('Academic content activated, display:', window.getComputedStyle(academicContent).display);
                }
                if (typeof loadAcademicSettings === 'function') {
                    loadAcademicSettings();
                } else {
                    console.error('loadAcademicSettings function not found!');
                }
            } else if (tabName === 'grading') {
                const gradingTab = document.getElementById('grading-system-inner-tab');
                const gradingContent = document.getElementById('grading-system-tab-content');
                console.log('Grading tab elements:', { gradingTab, gradingContent });
                if (!gradingTab) console.error('Grading system tab button not found!');
                if (!gradingContent) console.error('Grading system content not found!');
                if (gradingTab) gradingTab.classList.add('active');
                if (gradingContent) {
                    gradingContent.classList.add('active');
                    console.log('Grading content activated, display:', window.getComputedStyle(gradingContent).display);
                }
                if (typeof loadGradingSystem === 'function') {
                    loadGradingSystem();
                } else {
                    console.error('loadGradingSystem function not found!');
                }
            } else if (tabName === 'nominal') {
                const nominalTab = document.getElementById('nominal-roll-inner-tab');
                const nominalContent = document.getElementById('nominal-roll-tab-content');
                console.log('Nominal roll tab elements:', { nominalTab, nominalContent });
                if (!nominalTab) console.error('Nominal roll tab button not found!');
                if (!nominalContent) console.error('Nominal roll content not found!');
                if (nominalTab) nominalTab.classList.add('active');
                if (nominalContent) {
                    nominalContent.classList.add('active');
                    console.log('Nominal roll content activated, display:', window.getComputedStyle(nominalContent).display);
                }
                if (typeof loadNominalRollSettings === 'function') {
                    loadNominalRollSettings();
                } else {
                    console.error('loadNominalRollSettings function not found!');
                }
            } else if (tabName === 'transcript') {
                const transcriptTab = document.getElementById('transcript-template-inner-tab');
                const transcriptContent = document.getElementById('transcript-template-tab-content');
                console.log('Transcript tab elements:', { transcriptTab, transcriptContent });
                if (!transcriptTab) console.error('Transcript template tab button not found!');
                if (!transcriptContent) console.error('Transcript template content not found!');
                if (transcriptTab) transcriptTab.classList.add('active');
                if (transcriptContent) {
                    transcriptContent.classList.add('active');
                    console.log('Transcript content activated, display:', window.getComputedStyle(transcriptContent).display);
                }
                if (typeof loadTranscriptTemplate === 'function') {
                    loadTranscriptTemplate();
                } else {
                    console.error('loadTranscriptTemplate function not found!');
                }
            }
        }

        // Switch tabs within Academic Configuration Section
        function switchAcademicConfigTab(tabName) {
            // Remove active class from all tab buttons in academic config section
            document.querySelectorAll('#academic-config-section .tab-btn').forEach(btn => btn.classList.remove('active'));
            // Remove active class from all tab contents
            document.querySelectorAll('#academic-config-section .academic-config-tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'academic') {
                const academicTab = document.getElementById('academic-settings-top-tab');
                const academicContent = document.getElementById('academic-settings-top-content');
                if (academicTab) academicTab.classList.add('active');
                if (academicContent) {
                    academicContent.classList.add('active');
                    if (typeof loadAcademicSettings === 'function') {
                        loadAcademicSettings();
                    }
                }
            } else if (tabName === 'grading') {
                const gradingTab = document.getElementById('grading-system-top-tab');
                const gradingContent = document.getElementById('grading-system-top-content');
                if (gradingTab) gradingTab.classList.add('active');
                if (gradingContent) {
                    gradingContent.classList.add('active');
                    if (typeof loadGradingSystem === 'function') {
                        loadGradingSystem();
                    }
                }
            } else if (tabName === 'nominal') {
                const nominalTab = document.getElementById('nominal-roll-top-tab');
                const nominalContent = document.getElementById('nominal-roll-top-content');
                if (nominalTab) nominalTab.classList.add('active');
                if (nominalContent) {
                    nominalContent.classList.add('active');
                    if (typeof loadNominalRollSettings === 'function') {
                        loadNominalRollSettings();
                    }
                }
            } else if (tabName === 'reports') {
                const reportsTab = document.getElementById('reports-top-tab');
                const reportsContent = document.getElementById('reports-top-content');
                if (reportsTab) reportsTab.classList.add('active');
                if (reportsContent) {
                    reportsContent.classList.add('active');
                    if (typeof loadReportTemplateMapping === 'function') {
                        loadReportTemplateMapping();
                    }
                }
            }
        }
        
        // ==================== TRANSCRIPT TEMPLATE MANAGEMENT ====================
        
        let transcriptTemplateCanvas = null;
        let transcriptTemplateCtx = null;
        let transcriptTemplateImage = null;
        let transcriptFieldPositions = {};
        let currentTranscriptField = null;
        
        async function loadTranscriptTemplate() {
            if (!window.COLLEGE_SLUG) return;
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/transcript-template/`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                const data = await response.json();
                
                // Find the currently visible transcript template section
                const topContent = document.getElementById('transcript-template-top-content');
                const tabContent = document.getElementById('transcript-template-tab-content');
                const activeSection = topContent && topContent.offsetParent !== null ? topContent : 
                                     tabContent && tabContent.offsetParent !== null ? tabContent : null;
                
                if (!activeSection) {
                    console.warn('No active transcript template section found');
                    return;
                }
                
                // Find elements within the active section
                const uploadSection = activeSection.querySelector('#transcript-template-upload-section');
                const mappingSection = activeSection.querySelector('#transcript-template-mapping-section');
                
                if (data.template && data.template.id) {
                    // Template exists - show mapping section, hide upload section
                    transcriptFieldPositions = data.template.field_positions || {};
                    transcriptFieldPositions.template_id = data.template_id || data.template.id;
                    if (uploadSection) uploadSection.style.display = 'none';
                    if (mappingSection) {
                        mappingSection.style.display = 'block';
                        // Always use template_url - it contains the actual uploaded file
                        // For PDFs, it will be displayed in iframe; for images, in canvas
                        const templateUrl = data.template.template_url;
                        await loadTranscriptTemplatePreview(templateUrl, data.template.template_type);
                        // Load students for preview dropdown
                        await loadStudentsForPreview();
                    }
                } else {
                    // No template - show upload section, hide mapping section
                    transcriptFieldPositions = {};
                    transcriptTemplateImage = null;
                    if (uploadSection) uploadSection.style.display = 'block';
                    if (mappingSection) mappingSection.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading transcript template:', error);
                // On error, show upload section, hide mapping section
                transcriptFieldPositions = {};
                transcriptTemplateImage = null;
                
                // Find the currently visible transcript template section
                const topContent = document.getElementById('transcript-template-top-content');
                const tabContent = document.getElementById('transcript-template-tab-content');
                const activeSection = topContent && topContent.offsetParent !== null ? topContent : 
                                     tabContent && tabContent.offsetParent !== null ? tabContent : null;
                
                if (activeSection) {
                    const uploadSection = activeSection.querySelector('#transcript-template-upload-section');
                    const mappingSection = activeSection.querySelector('#transcript-template-mapping-section');
                    if (uploadSection) uploadSection.style.display = 'block';
                    if (mappingSection) mappingSection.style.display = 'none';
                }
            }
        }
        
        let transcriptCanvasScale = 1;
        let transcriptOriginalWidth = 0;
        let transcriptOriginalHeight = 0;
        
        async function loadTranscriptTemplatePreview(templateUrl, templateType) {
            const canvas = document.getElementById('transcript-template-canvas');
            if (!canvas) {
                console.error('Canvas element not found');
                return;
            }
            
            transcriptTemplateCanvas = canvas;
            transcriptTemplateCtx = canvas.getContext('2d');
            
            // A4 dimensions in pixels at 72 DPI
            const A4_WIDTH_MM = 210;
            const A4_HEIGHT_MM = 297;
            const DPI = 72;
            const A4_WIDTH_PX = (A4_WIDTH_MM / 25.4) * DPI; // 595.28px
            const A4_HEIGHT_PX = (A4_HEIGHT_MM / 25.4) * DPI; // 841.89px
            
            // Calculate scale to fit viewport while maintaining aspect ratio
            const viewportWidth = window.innerWidth * 0.85; // 85% of viewport
            const viewportHeight = window.innerHeight * 0.7; // 70% of viewport
            
            // Use A4 aspect ratio for scaling
            let scaleX = viewportWidth / A4_WIDTH_PX;
            let scaleY = viewportHeight / A4_HEIGHT_PX;
            transcriptCanvasScale = Math.min(scaleX, scaleY, 1); // Don't scale up beyond 100%
            
            // Set canvas size to A4 dimensions scaled
            canvas.width = A4_WIDTH_PX * transcriptCanvasScale;
            canvas.height = A4_HEIGHT_PX * transcriptCanvasScale;
            
            // Draw grey A4 background
            transcriptTemplateCtx.fillStyle = '#e2e8f0';
            transcriptTemplateCtx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw border to show page edges
            transcriptTemplateCtx.strokeStyle = '#CCCCCC';
            transcriptTemplateCtx.lineWidth = 1;
            transcriptTemplateCtx.strokeRect(0, 0, canvas.width, canvas.height);
            
            console.log('Loading template preview:', { templateUrl, templateType, canvasSize: `${canvas.width}x${canvas.height}` });
            
            // Check if template is PDF - PDFs need to be displayed in iframe
            if (templateType === 'pdf' || (templateUrl && templateUrl.toLowerCase().endsWith('.pdf'))) {
                // For PDF templates, load in iframe instead of canvas
                transcriptTemplateImage = null;
                
                // Hide canvas, show PDF viewer
                canvas.style.display = 'none';
                const pdfViewer = document.getElementById('transcript-template-pdf-viewer');
                if (pdfViewer) {
                    // Validate templateUrl
                    if (!templateUrl) {
                        console.error('Template URL is empty or undefined');
                        showToast('error', 'Template URL not found. Please re-upload the template.');
                        return;
                    }
                    
                    // Construct absolute URL if relative
                    let pdfUrl = templateUrl;
                    if (templateUrl.startsWith('/')) {
                        pdfUrl = window.location.origin + templateUrl;
                    } else if (!templateUrl.startsWith('http://') && !templateUrl.startsWith('https://')) {
                        pdfUrl = window.location.origin + '/' + templateUrl;
                    }
                    
                    console.log('Loading PDF template in iframe:', {
                        originalUrl: templateUrl,
                        constructedUrl: pdfUrl,
                        origin: window.location.origin
                    });
                    
                    pdfViewer.src = pdfUrl;
                    pdfViewer.style.display = 'block';
                    pdfViewer.style.width = '100%';
                    pdfViewer.style.minHeight = '800px';
                    
                    // Handle iframe load errors
                    pdfViewer.onerror = function() {
                        console.error('Failed to load PDF in iframe:', pdfUrl);
                        showToast('error', 'Failed to load PDF. Please check the file exists.');
                    };
                    
                    // Update help text
                    const helpTexts = document.querySelectorAll('#transcript-help-text');
                    helpTexts.forEach(el => {
                        if (el) el.textContent = 'Use X/Y inputs to set field positions (PDF displayed above)';
                    });
                    
                    showToast('success', 'PDF template loaded successfully');
                } else {
                    console.error('PDF viewer iframe not found');
                    showToast('error', 'Failed to load PDF viewer');
                }
                
                // Draw existing markers on canvas (even though it's hidden, for coordinate reference)
                drawTranscriptFieldMarkers();
                return;
            }
            
            // For non-PDF templates, update help text
            const helpTexts = document.querySelectorAll('#transcript-help-text');
            helpTexts.forEach(el => {
                if (el) el.textContent = 'Click on canvas to set position (optional) or use X/Y inputs';
            });
            
            // For non-PDF templates, show canvas and hide PDF viewer
            canvas.style.display = 'block';
            const pdfViewer = document.getElementById('transcript-template-pdf-viewer');
            if (pdfViewer) {
                pdfViewer.style.display = 'none';
                pdfViewer.src = '';
            }
            
            if (templateUrl) {
                const img = new Image();
                
                // Handle CORS - only set if URL is from different origin
                try {
                    const urlObj = new URL(templateUrl, window.location.origin);
                    if (urlObj.origin !== window.location.origin) {
                        img.crossOrigin = 'anonymous';
                    }
                } catch (e) {
                    // Relative URL - no CORS needed
                    console.log('Using relative URL, no CORS needed');
                }
                
                img.onload = function() {
                    console.log('Template image loaded successfully:', templateUrl, 'Size:', img.width, 'x', img.height);
                    // Store original dimensions
                    transcriptOriginalWidth = img.width;
                    transcriptOriginalHeight = img.height;
                    
                    // Clear canvas first
                    transcriptTemplateCtx.fillStyle = '#e2e8f0';
                    transcriptTemplateCtx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw image scaled to A4 size (on top of white background)
                    transcriptTemplateCtx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    transcriptTemplateImage = img;
                    
                    // Draw existing markers
                    drawTranscriptFieldMarkers();
                    
                    showToast('success', 'Template loaded successfully');
                };
                
                img.onerror = function(error) {
                    console.error('Error loading template image:', templateUrl, error);
                    console.error('Image load failed. Check:', {
                        url: templateUrl,
                        absoluteUrl: new URL(templateUrl, window.location.origin).href,
                        templateType: templateType
                    });
                    
                    // If image fails to load, show error message
                    transcriptTemplateImage = null;
                    drawTranscriptFieldMarkers();
                    
                    // Show error message on canvas
                    transcriptTemplateCtx.fillStyle = '#ff0000';
                    transcriptTemplateCtx.font = '16px Arial';
                    transcriptTemplateCtx.textAlign = 'center';
                    transcriptTemplateCtx.fillText('Failed to load template image', canvas.width / 2, canvas.height / 2 - 20);
                    transcriptTemplateCtx.fillText('Check console for details', canvas.width / 2, canvas.height / 2 + 10);
                    
                    showToast('error', `Failed to load template image. URL: ${templateUrl}`);
                };
                
                // Construct absolute URL if relative
                let imageUrl = templateUrl;
                if (templateUrl && templateUrl.startsWith('/')) {
                    // Relative URL - make it absolute
                    imageUrl = window.location.origin + templateUrl;
                } else if (templateUrl && !templateUrl.startsWith('http://') && !templateUrl.startsWith('https://')) {
                    // Relative path without leading slash
                    imageUrl = window.location.origin + '/' + templateUrl;
                }
                
                console.log('Loading template image:', {
                    originalUrl: templateUrl,
                    absoluteUrl: imageUrl,
                    templateType: templateType,
                    windowOrigin: window.location.origin
                });
                
                // For PDF templates, use preview_image_url if available (converted to PNG)
                // If preview_image_url is not available, show message
                if (templateType === 'pdf' && !templateUrl.includes('preview')) {
                    // Check if we have a preview image URL (should be set by API)
                    // If not, show message
                    if (!templateUrl || templateUrl.includes('.pdf')) {
                        console.warn('PDF template detected - attempting to load preview image...');
                        // The API should have provided preview_image_url, but if not, show message
                        transcriptTemplateCtx.fillStyle = '#ffa500';
                        transcriptTemplateCtx.font = '14px Arial';
                        transcriptTemplateCtx.textAlign = 'center';
                        transcriptTemplateCtx.fillText('PDF template - loading preview...', canvas.width / 2, canvas.height / 2 - 20);
                        transcriptTemplateCtx.fillText('If preview fails, convert PDF to PNG/JPG', canvas.width / 2, canvas.height / 2 + 10);
                        showToast('info', 'PDF template - loading preview image...');
                    }
                }
                
                img.src = imageUrl;
            } else {
                // No template URL - just show white A4 page
                console.warn('No template URL provided');
                transcriptTemplateImage = null;
                drawTranscriptFieldMarkers();
            }
            
            // Update info
            const infoEl = document.getElementById('transcript-canvas-info');
            if (infoEl) {
                infoEl.textContent = `A4 Page Size (${Math.round(canvas.width)}px  ${Math.round(canvas.height)}px) - Scale: ${Math.round(transcriptCanvasScale * 100)}%`;
            }
            
            // Add click listener for positioning
            canvas.addEventListener('click', handleTranscriptCanvasClick);
            
            // Add zoom controls
            canvas.addEventListener('wheel', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? 0.9 : 1.1;
                    transcriptCanvasScale = Math.max(0.5, Math.min(2, transcriptCanvasScale * delta));
                    redrawTranscriptCanvas();
                }
            });
        }
        
        function redrawTranscriptCanvas() {
            if (!transcriptTemplateCanvas) return;
            
            const A4_WIDTH_MM = 210;
            const A4_HEIGHT_MM = 297;
            const DPI = 72;
            const A4_WIDTH_PX = (A4_WIDTH_MM / 25.4) * DPI;
            const A4_HEIGHT_PX = (A4_HEIGHT_MM / 25.4) * DPI;
            
            transcriptTemplateCanvas.width = A4_WIDTH_PX * transcriptCanvasScale;
            transcriptTemplateCanvas.height = A4_HEIGHT_PX * transcriptCanvasScale;
            
            // Draw grey A4 background
            transcriptTemplateCtx.fillStyle = '#e2e8f0';
            transcriptTemplateCtx.fillRect(0, 0, transcriptTemplateCanvas.width, transcriptTemplateCanvas.height);
            
            // Draw border
            transcriptTemplateCtx.strokeStyle = '#CCCCCC';
            transcriptTemplateCtx.lineWidth = 1;
            transcriptTemplateCtx.strokeRect(0, 0, transcriptTemplateCanvas.width, transcriptTemplateCanvas.height);
            
            // Draw template image if available
            if (transcriptTemplateImage) {
                transcriptTemplateCtx.drawImage(transcriptTemplateImage, 0, 0, transcriptTemplateCanvas.width, transcriptTemplateCanvas.height);
            }
            
            const infoEl = document.getElementById('transcript-canvas-info');
            if (infoEl) {
                infoEl.textContent = `A4 Page Size (${Math.round(transcriptTemplateCanvas.width)}px  ${Math.round(transcriptTemplateCanvas.height)}px) - Scale: ${Math.round(transcriptCanvasScale * 100)}%`;
            }
            
            drawTranscriptFieldMarkers();
        }
        
        function resetTranscriptCanvasZoom() {
            transcriptCanvasScale = 1;
            redrawTranscriptCanvas();
        }
        
        function handleTranscriptCanvasClick(event) {
            if (!currentTranscriptField) return;
            
            const rect = transcriptTemplateCanvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // A4 dimensions in pixels at 72 DPI
            const A4_WIDTH_MM = 210;
            const A4_HEIGHT_MM = 297;
            const DPI = 72;
            const A4_WIDTH_PX = (A4_WIDTH_MM / 25.4) * DPI; // 595.28px
            const A4_HEIGHT_PX = (A4_HEIGHT_MM / 25.4) * DPI; // 841.89px
            
            // Scale coordinates back to A4 size (not image size, since we're working with A4 coordinates)
            const scaleX = A4_WIDTH_PX / transcriptTemplateCanvas.width;
            const scaleY = A4_HEIGHT_PX / transcriptTemplateCanvas.height;
            const actualX = x * scaleX;
            const actualY = y * scaleY;
            
            if (currentTranscriptField === 'results_table') {
                transcriptFieldPositions.results_table = transcriptFieldPositions.results_table || {};
                transcriptFieldPositions.results_table.start_x = actualX;
                transcriptFieldPositions.results_table.start_y = actualY;
                transcriptFieldPositions.results_table.row_height = parseInt(document.getElementById('transcript-row-height').value) || 20;
                transcriptFieldPositions.results_table.columns = {
                    unit_code: { x_offset: parseInt(document.getElementById('transcript-col-unit-code').value) || 0 },
                    unit_name: { x_offset: parseInt(document.getElementById('transcript-col-unit-name').value) || 80 },
                    academic_year: { x_offset: parseInt(document.getElementById('transcript-col-academic-year').value) || 280 },
                    semester: { x_offset: parseInt(document.getElementById('transcript-col-semester').value) || 380 },
                    cat_marks: { x_offset: parseInt(document.getElementById('transcript-col-cat-marks').value) || 440 },
                    exam_marks: { x_offset: parseInt(document.getElementById('transcript-col-exam-marks').value) || 500 },
                    total_marks: { x_offset: parseInt(document.getElementById('transcript-col-total-marks').value) || 560 },
                    grade: { x_offset: parseInt(document.getElementById('transcript-col-grade').value) || 620 }
                };
            } else {
                // Update form fields with clicked coordinates
                document.getElementById('transcript-field-x').value = Math.round(actualX);
                document.getElementById('transcript-field-y').value = Math.round(actualY);
                
                // Update field positions (preserve existing font settings if any)
                const existing = transcriptFieldPositions[currentTranscriptField] || {};
                transcriptFieldPositions[currentTranscriptField] = {
                    x: actualX,
                    y: actualY,
                    font_family: existing.font_family || 'Helvetica',
                    font_size: existing.font_size || 12,
                    color: existing.color || '#000000',
                    bold: existing.bold || false,
                    italic: existing.italic || false,
                    underline: existing.underline || false,
                    strikethrough: existing.strikethrough || false,
                    text_transform: existing.text_transform || 'none',
                    alignment: existing.alignment || 'left'
                };
            }
            
            drawTranscriptFieldMarkers();
            showToast('success', `Position set for ${currentTranscriptField.replace('_', ' ')}`);
        }
        
        function drawTranscriptFieldMarkers() {
            if (!transcriptTemplateCtx || !transcriptTemplateCanvas) return;
            
            // A4 dimensions in pixels at 72 DPI
            const A4_WIDTH_MM = 210;
            const A4_HEIGHT_MM = 297;
            const DPI = 72;
            const A4_WIDTH_PX = (A4_WIDTH_MM / 25.4) * DPI;
            const A4_HEIGHT_PX = (A4_HEIGHT_MM / 25.4) * DPI;
            
            // Redraw grey background
            transcriptTemplateCtx.fillStyle = '#e2e8f0';
            transcriptTemplateCtx.fillRect(0, 0, transcriptTemplateCanvas.width, transcriptTemplateCanvas.height);
            
            // Draw border
            transcriptTemplateCtx.strokeStyle = '#CCCCCC';
            transcriptTemplateCtx.lineWidth = 1;
            transcriptTemplateCtx.strokeRect(0, 0, transcriptTemplateCanvas.width, transcriptTemplateCanvas.height);
            
            // Redraw template image if available
            if (transcriptTemplateImage) {
                transcriptTemplateCtx.drawImage(transcriptTemplateImage, 0, 0, transcriptTemplateCanvas.width, transcriptTemplateCanvas.height);
            }
            
            // Draw markers - scale from A4 coordinates to canvas coordinates
            const scaleX = transcriptTemplateCanvas.width / A4_WIDTH_PX;
            const scaleY = transcriptTemplateCanvas.height / A4_HEIGHT_PX;
            
            Object.keys(transcriptFieldPositions).forEach(field => {
                const pos = transcriptFieldPositions[field];
                if (field === 'results_table' && pos.start_x !== undefined) {
                    const x = pos.start_x * scaleX;
                    const y = pos.start_y * scaleY;
                    transcriptTemplateCtx.fillStyle = 'rgba(255, 0, 0, 0.5)';
                    transcriptTemplateCtx.fillRect(x - 5, y - 5, 10, 10);
                    transcriptTemplateCtx.strokeStyle = 'red';
                    transcriptTemplateCtx.strokeRect(x - 5, y - 5, 10, 10);
                } else if (pos.x !== undefined && pos.y !== undefined) {
                    const x = pos.x * scaleX;
                    const y = pos.y * scaleY;
                    transcriptTemplateCtx.fillStyle = 'rgba(0, 255, 0, 0.5)';
                    transcriptTemplateCtx.fillRect(x - 5, y - 5, 10, 10);
                    transcriptTemplateCtx.strokeStyle = 'green';
                    transcriptTemplateCtx.strokeRect(x - 5, y - 5, 10, 10);
                }
            });
        }
        
        function selectTranscriptField() {
            const selector = document.getElementById('transcript-field-selector');
            currentTranscriptField = selector.value;
            const fieldConfig = document.getElementById('transcript-field-config');
            const tableConfig = document.getElementById('transcript-results-table-config');
            
            if (!currentTranscriptField) {
                fieldConfig.style.display = 'none';
                tableConfig.style.display = 'none';
                return;
            }
            
            if (currentTranscriptField === 'results_table') {
                fieldConfig.style.display = 'none';
                tableConfig.style.display = 'block';
                // Load existing table config if available
                if (transcriptFieldPositions.results_table) {
                    const table = transcriptFieldPositions.results_table;
                    document.getElementById('transcript-row-height').value = table.row_height || 20;
                    if (table.columns) {
                        document.getElementById('transcript-col-unit-code').value = table.columns.unit_code?.x_offset || 0;
                        document.getElementById('transcript-col-unit-name').value = table.columns.unit_name?.x_offset || 80;
                        document.getElementById('transcript-col-academic-year').value = table.columns.academic_year?.x_offset || 280;
                        document.getElementById('transcript-col-semester').value = table.columns.semester?.x_offset || 380;
                        document.getElementById('transcript-col-cat-marks').value = table.columns.cat_marks?.x_offset || 440;
                        document.getElementById('transcript-col-exam-marks').value = table.columns.exam_marks?.x_offset || 500;
                        document.getElementById('transcript-col-total-marks').value = table.columns.total_marks?.x_offset || 560;
                        document.getElementById('transcript-col-grade').value = table.columns.grade?.x_offset || 620;
                    }
                }
            } else {
                tableConfig.style.display = 'none';
                fieldConfig.style.display = 'block';
                
                // Load existing field config if available
                const field = transcriptFieldPositions[currentTranscriptField];
                if (field) {
                    document.getElementById('transcript-field-x').value = field.x || 0;
                    document.getElementById('transcript-field-y').value = field.y || 0;
                    document.getElementById('transcript-field-font-family').value = field.font_family || 'Helvetica';
                    document.getElementById('transcript-field-font-size').value = field.font_size || 12;
                    const color = field.color || '#000000';
                    document.getElementById('transcript-field-color').value = color;
                    document.getElementById('transcript-field-color-hex').value = color;
                    document.getElementById('transcript-field-bold').checked = field.bold || false;
                    document.getElementById('transcript-field-italic').checked = field.italic || false;
                    document.getElementById('transcript-field-alignment').value = field.alignment || 'left';
                } else {
                    // Reset to defaults
                    document.getElementById('transcript-field-x').value = '';
                    document.getElementById('transcript-field-y').value = '';
                    document.getElementById('transcript-field-font-family').value = 'Helvetica';
                    document.getElementById('transcript-field-font-size').value = 12;
                    document.getElementById('transcript-field-color').value = '#000000';
                    document.getElementById('transcript-field-color-hex').value = '#000000';
                    document.getElementById('transcript-field-bold').checked = false;
                    document.getElementById('transcript-field-italic').checked = false;
                    document.getElementById('transcript-field-alignment').value = 'left';
                }
            }
        }
        
        function updateTranscriptFieldConfig() {
            if (!currentTranscriptField || currentTranscriptField === 'results_table') return;
            
            const x = parseInt(document.getElementById('transcript-field-x').value) || 0;
            const y = parseInt(document.getElementById('transcript-field-y').value) || 0;
            const fontFamily = document.getElementById('transcript-field-font-family').value;
            const fontSize = parseFloat(document.getElementById('transcript-field-font-size').value) || 12;
            const color = document.getElementById('transcript-field-color').value;
            const bold = document.getElementById('transcript-field-bold').checked;
            const italic = document.getElementById('transcript-field-italic').checked;
            const underline = document.getElementById('transcript-field-underline').checked;
            const strikethrough = document.getElementById('transcript-field-strikethrough').checked;
            const textTransform = document.getElementById('transcript-field-text-transform').value;
            const alignment = document.getElementById('transcript-field-alignment').value;
            
            // Update field positions
            transcriptFieldPositions[currentTranscriptField] = {
                x: x,
                y: y,
                font_family: fontFamily,
                font_size: fontSize,
                color: color,
                bold: bold,
                italic: italic,
                underline: underline,
                strikethrough: strikethrough,
                text_transform: textTransform,
                alignment: alignment
            };
            
            // Redraw markers
            drawTranscriptFieldMarkers();
            
            showToast('success', `Settings applied for ${currentTranscriptField.replace('_', ' ')}`);
        }
        
        // Sync color picker with hex input
        // Initialize marks entry system on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load academic year options for unit selection
            if (document.getElementById('unit-selection-year-filter')) {
                loadAcademicYearOptions();
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            const colorPicker = document.getElementById('transcript-field-color');
            const colorHex = document.getElementById('transcript-field-color-hex');
            
            if (colorPicker && colorHex) {
                colorPicker.addEventListener('input', function() {
                    colorHex.value = this.value;
                });
                
                colorHex.addEventListener('input', function() {
                    if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                        colorPicker.value = this.value;
                    }
                });
            }
        });
        
        async function saveTranscriptFieldPositions() {
            if (!window.COLLEGE_SLUG) return;
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/transcript-template/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken
                    },
                    body: JSON.stringify({
                        template_id: transcriptFieldPositions.template_id,
                        field_positions: transcriptFieldPositions
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('success', 'Field positions saved successfully');
                } else {
                    showToast('error', data.error || 'Failed to save positions');
                }
            } catch (error) {
                console.error('Error saving field positions:', error);
                showToast('error', 'Error saving field positions');
            }
        }
        
        function clearTranscriptFieldPositions() {
            transcriptFieldPositions = {};
            drawTranscriptFieldMarkers();
            showToast('info', 'All field positions cleared');
        }
        
        async function deleteTranscriptTemplate() {
            if (!confirm('Are you sure you want to delete this template? This action cannot be undone.')) return;
            
            if (!window.COLLEGE_SLUG) {
                showToast('error', 'College slug not found');
                return;
            }
            
            // Try to get template ID from transcriptFieldPositions first
            let templateId = transcriptFieldPositions.template_id;
            
            // If not found, try to get it from the API
            if (!templateId) {
                try {
                    const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/transcript-template/`, {
                        headers: { 'X-CSRFToken': window.csrftoken }
                    });
                    const data = await response.json();
                    if (data.template && data.template.id) {
                        templateId = data.template.id;
                        transcriptFieldPositions.template_id = templateId;
                    }
                } catch (e) {
                    console.error('Error fetching template ID:', e);
                }
            }
            
            if (!templateId) {
                showToast('error', 'Template ID not found. Please refresh the page and try again.');
                console.error('Template ID not found. transcriptFieldPositions:', transcriptFieldPositions);
                return;
            }
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/transcript-template/`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken
                    },
                    body: JSON.stringify({
                        template_id: templateId
                    })
                });
                
                console.log('Delete template response:', response.status, response.statusText);
                
                // Handle response - API returns JSON with status 200
                if (response.ok) {
                    try {
                        const data = await response.json();
                        console.log('Delete template success:', data);
                        showToast('success', data.message || 'Template deleted successfully');
                    } catch (e) {
                        // If no JSON body (204 No Content), still show success
                        console.log('No JSON response body, assuming success');
                        showToast('success', 'Template deleted successfully');
                    }
                    
                    // Reset state
                    transcriptFieldPositions = {};
                    transcriptTemplateImage = null;
                    
                    // Hide PDF viewer if visible
                    const pdfViewer = document.getElementById('transcript-template-pdf-viewer');
                    if (pdfViewer) {
                        pdfViewer.style.display = 'none';
                        pdfViewer.src = '';
                    }
                    
                    // Reload template section (will show upload form)
                    await loadTranscriptTemplate();
                } else {
                    // Try to parse error response
                    let errorMessage = `Failed to delete template (Status: ${response.status})`;
                    try {
                        const data = await response.json();
                        errorMessage = data.error || errorMessage;
                        console.error('Delete template error:', data);
                    } catch (e) {
                        const text = await response.text();
                        console.error('Delete template error (text):', text);
                        if (text) {
                            try {
                                const errorData = JSON.parse(text);
                                errorMessage = errorData.error || errorMessage;
                            } catch (parseError) {
                                errorMessage = text || errorMessage;
                            }
                        }
                    }
                    showToast('error', errorMessage);
                }
            } catch (error) {
                console.error('Error deleting template:', error);
                showToast('error', 'Error deleting template: ' + (error.message || 'Unknown error'));
            }
        }
        
        // Handle template upload form
        document.getElementById('transcript-template-upload-form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!window.COLLEGE_SLUG) return;
            
            const formData = new FormData();
            formData.append('template_file', document.getElementById('transcript-template-file').files[0]);
            formData.append('name', document.getElementById('transcript-template-name').value);
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/transcript-template/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': window.csrftoken },
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    showToast('success', 'Template uploaded successfully');
                    transcriptFieldPositions.template_id = data.template.id;
                    await loadTranscriptTemplate();
                } else {
                    showToast('error', data.error || 'Failed to upload template');
                }
            } catch (error) {
                console.error('Error uploading template:', error);
                showToast('error', 'Error uploading template');
            }
        });
        
        // ==================== TRANSCRIPT GENERATION ====================
        
        async function loadTranscriptFilters() {
            if (!window.COLLEGE_SLUG) return;
            
            // Load academic years
            try {
                const yearsResponse = await fetch(`/api/${window.COLLEGE_SLUG}/results/academic-years/`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                const yearsData = await yearsResponse.json();
                const yearSelect = document.getElementById('transcript-year-filter');
                if (yearSelect && yearsData.academic_years) {
                    yearSelect.innerHTML = '<option value="">All Years</option>';
                    yearsData.academic_years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        yearSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading academic years:', error);
            }
            
            // Load semester dropdown
            await populateSemesterDropdown('transcript-semester-filter', true);
            
            // Load courses
            try {
                const coursesResponse = await fetch(`/api/${window.COLLEGE_SLUG}/courses/?page_size=100`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                const coursesData = await coursesResponse.json();
                const courseSelect = document.getElementById('transcript-course-filter');
                if (courseSelect && coursesData.results) {
                    courseSelect.innerHTML = '<option value="">All Courses</option>';
                    coursesData.results.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.name;
                        courseSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading courses:', error);
            }
            
            // Load students
            await loadTranscriptStudents();
        }
        
        async function loadTranscriptStudents() {
            if (!window.COLLEGE_SLUG) return;
            
            const yearFilter = document.getElementById('transcript-year-filter')?.value;
            const semesterFilter = document.getElementById('transcript-semester-filter')?.value;
            const courseFilter = document.getElementById('transcript-course-filter')?.value;
            
            try {
                const params = new URLSearchParams({ page_size: 1000 });
                if (yearFilter) params.append('academic_year', yearFilter);
                if (semesterFilter) params.append('semester', semesterFilter);
                if (courseFilter) params.append('course', courseFilter);
                
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/students/?${params.toString()}`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                const data = await response.json();
                
                const studentSelect = document.getElementById('transcript-student-select');
                if (studentSelect && data.results) {
                    studentSelect.innerHTML = '';
                    data.results.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = `${student.admission_number} - ${student.full_name}`;
                        studentSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }
        
        function selectAllStudents() {
            const select = document.getElementById('transcript-student-select');
            Array.from(select.options).forEach(option => option.selected = true);
        }
        
        function deselectAllStudents() {
            const select = document.getElementById('transcript-student-select');
            Array.from(select.options).forEach(option => option.selected = false);
        }
        
        function clearTranscriptFilters() {
            document.getElementById('transcript-year-filter').value = '';
            document.getElementById('transcript-semester-filter').value = '';
            document.getElementById('transcript-course-filter').value = '';
            loadTranscriptStudents();
        }
        
        // CSV Export Functions
        async function loadCsvExportFilters() {
            if (!window.COLLEGE_SLUG) return;
            
            // Load units
            try {
                const unitsResponse = await fetch(`/api/${window.COLLEGE_SLUG}/units/`);
                const unitsData = await unitsResponse.json();
                
                const unitSelect = document.getElementById('csv-export-unit-filter');
                if (unitSelect && unitsData && unitsData.results) {
                    const currentValue = unitSelect.value;
                    unitSelect.innerHTML = '<option value="">All Units</option>';
                    
                    unitsData.results.forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit.id;
                        option.textContent = `${unit.code} - ${unit.name}`;
                        unitSelect.appendChild(option);
                    });
                    
                    if (currentValue) {
                        unitSelect.value = currentValue;
                    }
                }
            } catch (error) {
                console.error('Error loading units for CSV export:', error);
            }
            
            // Load academic years
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/results/academic-years/`);
                const data = await response.json();
                
                const yearSelect = document.getElementById('csv-export-year-filter');
                if (yearSelect && data.academic_years) {
                    const currentValue = yearSelect.value;
                    yearSelect.innerHTML = '<option value="">All Years</option>';
                    
                    data.academic_years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        yearSelect.appendChild(option);
                    });
                    
                    if (currentValue) {
                        yearSelect.value = currentValue;
                    }
                }
            } catch (error) {
                console.error('Error loading academic years for CSV export:', error);
            }
            
            // Load semesters
            try {
                await populateSemesterDropdown('csv-export-semester-filter', true);
            } catch (error) {
                console.error('Error loading semesters for CSV export:', error);
            }
        }
        
        function clearCsvExportFilters() {
            document.getElementById('csv-export-unit-filter').value = '';
            document.getElementById('csv-export-year-filter').value = '';
            document.getElementById('csv-export-semester-filter').value = '';
            document.getElementById('csv-export-search').value = '';
            document.getElementById('csv-export-status-filter').value = 'all';
        }
        
        function selectAllCsvFields() {
            document.querySelectorAll('.csv-field-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
        }
        
        function deselectAllCsvFields() {
            document.querySelectorAll('.csv-field-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        async function exportResultsToCSV() {
            if (!window.COLLEGE_SLUG) {
                showToast('error', 'College information not available');
                return;
            }
            
            // Get selected fields
            const selectedFields = Array.from(document.querySelectorAll('.csv-field-checkbox:checked'))
                .map(checkbox => checkbox.value);
            
            if (selectedFields.length === 0) {
                showToast('error', 'Please select at least one field to export');
                return;
            }
            
            // Get filter values
            const unit = document.getElementById('csv-export-unit-filter').value;
            const academicYear = document.getElementById('csv-export-year-filter').value;
            const semester = document.getElementById('csv-export-semester-filter').value;
            const search = document.getElementById('csv-export-search').value;
            const status = document.getElementById('csv-export-status-filter').value;
            
            // Determine show_submitted based on status filter
            let showSubmitted = true;
            if (status === 'draft') {
                showSubmitted = false;
            } else if (status === 'submitted') {
                showSubmitted = true;
            }
            
            // Build query parameters
            const params = new URLSearchParams();
            params.append('fields', selectedFields.join(','));
            if (unit) params.append('unit', unit);
            if (academicYear) params.append('academic_year', academicYear);
            if (semester) params.append('semester', semester);
            if (search) params.append('search', search);
            params.append('show_submitted', showSubmitted);
            params.append('status', status);
            
            // Show loading status
            const statusEl = document.getElementById('csv-export-status');
            const root = getComputedStyle(document.documentElement);
            const primaryColor = root.getPropertyValue('--primary-color').trim() || '#3b82f6';
            const successColor = root.getPropertyValue('--success-color').trim() || '#10b981';
            const dangerColor = root.getPropertyValue('--danger-color').trim() || '#ef4444';
            const textSecondary = root.getPropertyValue('--text-secondary').trim() || '#cbd5e1';
            
            if (statusEl) {
                statusEl.textContent = 'Exporting...';
                statusEl.style.color = primaryColor;
            }
            
            try {
                // Trigger download
                const url = `/api/${window.COLLEGE_SLUG}/results/export-csv/?${params.toString()}`;
                window.location.href = url;
                
                // Show success message after a short delay
                setTimeout(() => {
                    if (statusEl) {
                        statusEl.textContent = 'Export started successfully';
                        statusEl.style.color = successColor;
                    }
                    showToast('success', 'CSV export started. File will download shortly.');
                }, 500);
                
                // Clear status after 3 seconds
                setTimeout(() => {
                    if (statusEl) {
                        statusEl.textContent = '';
                        statusEl.style.color = textSecondary;
                    }
                }, 3000);
            } catch (error) {
                console.error('Error exporting CSV:', error);
                if (statusEl) {
                    statusEl.textContent = 'Export failed';
                    statusEl.style.color = dangerColor;
                }
                showToast('error', 'Failed to export CSV. Please try again.');
            }
        }
        
        async function generateSingleTranscript() {
            const select = document.getElementById('transcript-student-select');
            const selected = Array.from(select.selectedOptions).map(opt => parseInt(opt.value));
            
            if (selected.length !== 1) {
                showToast('error', 'Please select exactly one student');
                return;
            }
            
            await generateTranscripts(selected);
        }
        
        async function generateBulkTranscripts() {
            const select = document.getElementById('transcript-student-select');
            const selected = Array.from(select.selectedOptions).map(opt => parseInt(opt.value));
            
            if (selected.length === 0) {
                showToast('error', 'Please select at least one student');
                return;
            }
            
            await generateTranscripts(selected);
        }
        
        async function generateTranscripts(studentIds) {
            if (!window.COLLEGE_SLUG) return;
            
            const statusEl = document.getElementById('transcript-generation-status');
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating transcript(s)...';
            
            const yearFilter = document.getElementById('transcript-year-filter')?.value;
            const semesterFilter = document.getElementById('transcript-semester-filter')?.value;
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/generate-transcript/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken
                    },
                    body: JSON.stringify({
                        student_ids: studentIds,
                        academic_year: yearFilter || '',
                        semester: semesterFilter || ''
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    statusEl.innerHTML = `<div style="color: var(--success);"><i class="fas fa-check-circle"></i> ${data.message}</div>`;
                    // Trigger download
                    window.open(data.download_url, '_blank');
                    showToast('success', data.message);
                } else {
                    statusEl.innerHTML = `<div style="color: var(--error);"><i class="fas fa-times-circle"></i> ${data.error}</div>`;
                    showToast('error', data.error);
                }
            } catch (error) {
                console.error('Error generating transcript:', error);
                statusEl.innerHTML = `<div style="color: var(--error);"><i class="fas fa-times-circle"></i> Error generating transcript</div>`;
                showToast('error', 'Error generating transcript');
            }
        }
        
        // Load students for preview dropdown (only students with results)
        async function loadStudentsForPreview() {
            if (!window.COLLEGE_SLUG) return;
            
            // Find the active section and get the student select from it
            const topContent = document.getElementById('transcript-template-top-content');
            const tabContent = document.getElementById('transcript-template-tab-content');
            const activeSection = topContent && topContent.offsetParent !== null ? topContent : 
                                 tabContent && tabContent.offsetParent !== null ? tabContent : null;
            
            if (!activeSection) return;
            
            const studentSelect = activeSection.querySelector('#transcript-preview-student');
            if (!studentSelect) return;
            
            studentSelect.innerHTML = '<option value="">-- Loading students with results --</option>';
            
            try {
                // Get students with results by fetching results and extracting unique students
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/results/?page_size=1000&status=submitted`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                const data = await response.json();
                
                // Extract unique students from results
                const studentsMap = new Map();
                
                if (data.results && data.results.length > 0) {
                    data.results.forEach(result => {
                        // Only include students with actual marks entered
                        if (result.student_id && 
                            (result.cat_marks !== null || result.exam_marks !== null || result.total !== null)) {
                            const studentId = result.student_id;
                            if (!studentsMap.has(studentId)) {
                                studentsMap.set(studentId, {
                                    id: result.student_id,
                                    admission_number: result.student_admission,
                                    full_name: result.student_name
                                });
                            }
                        }
                    });
                }
                
                // If no submitted results found, try getting all results (including drafts)
                if (studentsMap.size === 0) {
                    const allResultsResponse = await fetch(`/api/${window.COLLEGE_SLUG}/results/?page_size=1000&show_submitted=true`, {
                        headers: { 'X-CSRFToken': window.csrftoken }
                    });
                    const allResultsData = await allResultsResponse.json();
                    
                    if (allResultsData.results && allResultsData.results.length > 0) {
                        allResultsData.results.forEach(result => {
                            // Only include students with actual marks entered
                            if (result.student_id && 
                                (result.cat_marks !== null || result.exam_marks !== null || result.total !== null)) {
                                const studentId = result.student_id;
                                if (!studentsMap.has(studentId)) {
                                    studentsMap.set(studentId, {
                                        id: result.student_id,
                                        admission_number: result.student_admission,
                                        full_name: result.student_name
                                    });
                                }
                            }
                        });
                    }
                }
                
                studentSelect.innerHTML = '<option value="">-- Select Student --</option>';
                
                if (studentsMap.size > 0) {
                    // Sort students by admission number
                    const studentsArray = Array.from(studentsMap.values()).sort((a, b) => {
                        return a.admission_number.localeCompare(b.admission_number);
                    });
                    
                    studentsArray.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = `${student.admission_number} - ${student.full_name}`;
                        studentSelect.appendChild(option);
                    });
                } else {
                    studentSelect.innerHTML = '<option value="">-- No students with results found --</option>';
                }
            } catch (error) {
                console.error('Error loading students with results:', error);
                studentSelect.innerHTML = '<option value="">-- Error loading students --</option>';
            }
        }
        
        // Preview transcript with real student data
        async function previewTranscriptWithRealData() {
            if (!window.COLLEGE_SLUG) {
                showToast('error', 'College slug not found');
                return;
            }
            
            // Find the active section and get the student select and PDF viewer from it
            const topContent = document.getElementById('transcript-template-top-content');
            const tabContent = document.getElementById('transcript-template-tab-content');
            const activeSection = topContent && topContent.offsetParent !== null ? topContent : 
                                 tabContent && tabContent.offsetParent !== null ? tabContent : null;
            
            if (!activeSection) {
                showToast('error', 'Template section not found');
                return;
            }
            
            const studentSelect = activeSection.querySelector('#transcript-preview-student');
            const studentId = studentSelect ? studentSelect.value : null;
            
            if (!studentId) {
                showToast('error', 'Please select a student first');
                return;
            }
            
            const pdfViewer = activeSection.querySelector('#transcript-template-pdf-viewer');
            if (!pdfViewer) {
                showToast('error', 'PDF viewer not found');
                return;
            }
            
            // Show loading state
            pdfViewer.style.display = 'block';
            pdfViewer.src = 'about:blank';
            pdfViewer.style.background = 'linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%)';
            pdfViewer.style.backgroundSize = '200% 100%';
            
            showToast('info', 'Generating preview with real student data...');
            
            try {
                const generateResponse = await fetch(`/api/${window.COLLEGE_SLUG}/admin/generate-transcript/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken
                    },
                    body: JSON.stringify({
                        student_ids: [parseInt(studentId)],
                        preview: false
                    })
                });
                
                const generateData = await generateResponse.json();
                
                if (generateData.success && generateData.download_url) {
                    // Build full URL
                    const fullUrl = generateData.download_url.startsWith('http') 
                        ? generateData.download_url 
                        : `${window.location.origin}${generateData.download_url}`;
                    
                    pdfViewer.src = fullUrl;
                    pdfViewer.style.background = 'white';
                    showToast('success', 'Preview generated successfully with real student data');
                } else {
                    pdfViewer.style.display = 'none';
                    showToast('error', generateData.error || 'Failed to generate preview');
                }
            } catch (error) {
                console.error('Error generating preview:', error);
                pdfViewer.style.display = 'none';
                showToast('error', 'Error generating preview: ' + error.message);
            }
        }
        
        // Preview transcript with sample data
        async function previewTranscriptWithSampleData() {
            if (!window.COLLEGE_SLUG) {
                showToast('error', 'College slug not found');
                return;
            }
            
            // Find the active section and get the PDF viewer from it
            const topContent = document.getElementById('transcript-template-top-content');
            const tabContent = document.getElementById('transcript-template-tab-content');
            const activeSection = topContent && topContent.offsetParent !== null ? topContent : 
                                 tabContent && tabContent.offsetParent !== null ? tabContent : null;
            
            if (!activeSection) {
                showToast('error', 'Template section not found');
                return;
            }
            
            const pdfViewer = activeSection.querySelector('#transcript-template-pdf-viewer');
            if (!pdfViewer) {
                showToast('error', 'PDF viewer not found');
                return;
            }
            
            // Show loading state
            pdfViewer.style.display = 'block';
            pdfViewer.src = 'about:blank';
            pdfViewer.style.background = 'linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%)';
            pdfViewer.style.backgroundSize = '200% 100%';
            
            showToast('info', 'Generating preview with sample data...');
            
            try {
                const generateResponse = await fetch(`/api/${window.COLLEGE_SLUG}/admin/generate-transcript/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken
                    },
                    body: JSON.stringify({
                        student_ids: [0], // Use 0 for sample data
                        preview: true
                    })
                });
                
                const generateData = await generateResponse.json();
                
                if (generateData.success && generateData.download_url) {
                    // Build full URL
                    const fullUrl = generateData.download_url.startsWith('http') 
                        ? generateData.download_url 
                        : `${window.location.origin}${generateData.download_url}`;
                    
                    pdfViewer.src = fullUrl;
                    pdfViewer.style.background = 'white';
                    showToast('success', 'Preview generated successfully with sample data');
                } else {
                    pdfViewer.style.display = 'none';
                    showToast('error', generateData.error || 'Failed to generate preview');
                }
            } catch (error) {
                console.error('Error generating preview:', error);
                pdfViewer.style.display = 'none';
                showToast('error', 'Error generating preview: ' + error.message);
            }
        }
        
        async function previewTranscript() {
            if (!window.COLLEGE_SLUG) {
                showToast('error', 'College slug not found');
                return;
            }
            
            const statusEl = document.getElementById('transcript-generation-status');
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating preview...';
            
            // Check if template exists and generate preview
            try {
                const templateResponse = await fetch(`/api/${window.COLLEGE_SLUG}/admin/transcript-template/`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                const templateData = await templateResponse.json();
                
                if (!templateData.template) {
                    statusEl.innerHTML = `<div style="color: var(--error);"><i class="fas fa-times-circle"></i> Please upload a transcript template first in Settings  Transcript Template</div>`;
                    showToast('error', 'Please upload a transcript template first');
                    return;
                }
                
                // Generate preview transcript with sample data
                const generateResponse = await fetch(`/api/${window.COLLEGE_SLUG}/admin/generate-transcript/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken
                    },
                    body: JSON.stringify({
                        student_ids: [0], // Always use 0 for preview (sample data)
                        preview: true  // Flag for preview mode
                    })
                });
                
                const generateData = await generateResponse.json();
                
                if (generateData.success && generateData.download_url) {
                    // Build full URL
                    const fullUrl = generateData.download_url.startsWith('http') 
                        ? generateData.download_url 
                        : `${window.location.origin}${generateData.download_url}`;
                    
                    // Open preview immediately - try multiple methods
                    let previewWindow = null;
                    
                    // Method 1: Direct window.open
                    previewWindow = window.open(fullUrl, '_blank');
                    
                    // Method 2: If blocked, create a link and click it
                    if (!previewWindow || previewWindow.closed || typeof previewWindow.closed == 'undefined') {
                        const link = document.createElement('a');
                        link.href = fullUrl;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        statusEl.innerHTML = `
                            <div style="color: var(--success);">
                                <i class="fas fa-check-circle"></i> Preview generated and opened
                                <br>
                                <a href="${fullUrl}" target="_blank" style="color: var(--primary-blue); text-decoration: underline; margin-top: 8px; display: inline-block; font-weight: 600;">
                                    <i class="fas fa-external-link-alt"></i> Open preview again
                                </a>
                            </div>
                        `;
                        showToast('success', 'Preview opened');
                    } else {
                        statusEl.innerHTML = `<div style="color: var(--success);"><i class="fas fa-check-circle"></i> Preview opened in new window</div>`;
                        showToast('success', 'Preview opened in new window');
                    }
                    
                    // Clear status after a moment
                    setTimeout(() => {
                        statusEl.innerHTML = '';
                    }, 3000);
                } else {
                    statusEl.innerHTML = `<div style="color: var(--error);"><i class="fas fa-times-circle"></i> ${generateData.error || 'Failed to generate preview'}</div>`;
                    showToast('error', generateData.error || 'Failed to generate preview');
                }
            } catch (error) {
                console.error('Error generating preview:', error);
                statusEl.innerHTML = `<div style="color: var(--error);"><i class="fas fa-times-circle"></i> Error: ${error.message}</div>`;
                showToast('error', 'Error generating preview: ' + error.message);
            }
        }
        
        // Load filters when export section is opened
        // Initialize marks entry system on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load academic year options for unit selection
            if (document.getElementById('unit-selection-year-filter')) {
                loadAcademicYearOptions();
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for export section (loads both transcript and CSV export filters)
            const exportSectionLinks = document.querySelectorAll('.nav-link[data-section="export-section"], .top-nav-menu-link[data-section="export-section"]');
            exportSectionLinks.forEach(link => {
                link.addEventListener('click', function() {
                    setTimeout(() => {
                        loadTranscriptFilters();
                        loadCsvExportFilters();
                    }, 100);
                });
            });
            
            // Add filter change listeners
            document.getElementById('transcript-year-filter')?.addEventListener('change', loadTranscriptStudents);
            document.getElementById('transcript-semester-filter')?.addEventListener('change', loadTranscriptStudents);
            document.getElementById('transcript-course-filter')?.addEventListener('change', loadTranscriptStudents);
        });

        // User Management Functions
        let userManagementData = [];
        let userManagementCurrentPage = 1;
        let userManagementSearchTimeout = null;

        async function loadUserManagement(page = 1, search = '') {
            userManagementCurrentPage = page;
            const tbody = document.getElementById('user-management-tbody');
            
            if (!tbody) return;
            
            tbody.innerHTML = '<tr><td colspan="7" class="loading-row"><i class="fas fa-spinner fa-spin"></i> Loading users...</td></tr>';
            
            try {
                // Fetch all lecturers and admins (excluding super admin)
                const params = new URLSearchParams({
                    page: page,
                    page_size: 10,
                    search: search
                });
                
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/lecturers/?${params}`, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': window.csrftoken,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load users');
                }
                
                const data = await response.json();
                userManagementData = data.results || [];
                
                renderUserManagementTable(userManagementData);
                renderUserManagementPagination(data.total_pages || 1);
            } catch (error) {
                console.error('Error loading users:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="error-row">Failed to load users</td></tr>';
            }
        }

        function renderUserManagementTable(users) {
            const tbody = document.getElementById('user-management-tbody');
            if (!tbody) return;
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No users found</td></tr>';
                return;
            }
            
            // Helper function to get role badge
            function getRoleBadge(role) {
                const roleMap = {
                    'principal': '<span class="badge badge-success">Principal</span>',
                    'registrar': '<span class="badge badge-primary">Registrar</span>',
                    'accounts_officer': '<span class="badge badge-warning">Accounts</span>',
                    'reception': '<span class="badge badge-info">Reception</span>',
                    'lecturer': '<span class="badge badge-secondary">Lecturer</span>',
                    'college_admin': '<span class="badge badge-success">College Admin</span>',
                    'director': '<span class="badge badge-dark">Director</span>'
                };
                return roleMap[role] || '<span class="badge badge-secondary">' + (role || 'Unknown') + '</span>';
            }
            
            tbody.innerHTML = users.map(user => {
                // Skip director - should not be visible to other users
                if (user.role === 'director') {
                    return '';
                }
                
                const roleBadge = getRoleBadge(user.role);
                const isAdmin = user.role === 'college_admin';
                const isPrincipal = user.role === 'principal';
                const isRegistrar = user.role === 'registrar';
                const isAccounts = user.role === 'accounts_officer';
                const isReception = user.role === 'reception';
                
                // Only show promote/demote for lecturer and college_admin roles
                // Director role cannot be changed
                let actionButtons = '';
                if (user.role === 'lecturer') {
                    actionButtons = `<button class="btn-icon btn-success" onclick="promoteToAdmin(${user.id})" title="Promote to Admin">
                        <i class="fas fa-user-shield"></i> Make Admin
                    </button>`;
                } else if (user.role === 'college_admin') {
                    actionButtons = `<button class="btn-icon btn-warning" onclick="demoteToLecturer(${user.id})" title="Demote to Lecturer">
                        <i class="fas fa-user"></i> Make Lecturer
                    </button>`;
                }
                
                return `
                    <tr>
                        <td>${user.full_name || user.username}</td>
                        <td>${user.username}</td>
                        <td>${user.email || '-'}</td>
                        <td>${roleBadge}</td>
                        <td>${user.assigned_units_count || 0}</td>
                        <td><span class="badge badge-${user.status || 'active'}">${user.status || 'Active'}</span></td>
                        <td>
                            <div class="actions">
                                ${actionButtons}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderUserManagementPagination(totalPages) {
            const pagination = document.getElementById('user-management-pagination');
            if (!pagination) return;
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            if (userManagementCurrentPage > 1) {
                html += `<button class="btn-pagination" onclick="loadUserManagement(${userManagementCurrentPage - 1})">Previous</button>`;
            }
            
            for (let i = 1; i <= totalPages; i++) {
                html += `<button class="btn-pagination ${i === userManagementCurrentPage ? 'active' : ''}" onclick="loadUserManagement(${i})">${i}</button>`;
            }
            
            if (userManagementCurrentPage < totalPages) {
                html += `<button class="btn-pagination" onclick="loadUserManagement(${userManagementCurrentPage + 1})">Next</button>`;
            }
            
            pagination.innerHTML = html;
        }

        async function promoteToAdmin(userId) {
            if (!confirm('Are you sure you want to promote this lecturer to College Admin? They will be able to edit all sections.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/lecturers/${userId}/role/`, {
                    method: 'PUT',
                    headers: {
                        'X-CSRFToken': window.csrftoken,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ role: 'college_admin' })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to promote user');
                }
                
                const data = await response.json();
                showToast('success', data.message || 'User promoted to College Admin successfully');
                loadUserManagement(userManagementCurrentPage);
            } catch (error) {
                console.error('Error promoting user:', error);
                showToast('error', error.message || 'Failed to promote user');
            }
        }

        async function demoteToLecturer(userId) {
            if (!confirm('Are you sure you want to demote this admin to Lecturer? They will lose edit access to all sections.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/lecturers/${userId}/role/`, {
                    method: 'PUT',
                    headers: {
                        'X-CSRFToken': window.csrftoken,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ role: 'lecturer' })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to demote user');
                }
                
                const data = await response.json();
                showToast('success', data.message || 'User demoted to Lecturer successfully');
                loadUserManagement(userManagementCurrentPage);
            } catch (error) {
                console.error('Error demoting user:', error);
                showToast('error', error.message || 'Failed to demote user');
            }
        }

        function searchUserManagement() {
            if (userManagementSearchTimeout) {
                clearTimeout(userManagementSearchTimeout);
            }
            userManagementSearchTimeout = setTimeout(() => {
                const search = document.getElementById('user-management-search').value;
                loadUserManagement(1, search);
            }, 500);
        }

        // Enrollment filter management
        let enrollmentSearchTimeout;
        function debounceEnrollmentSearch() {
            clearTimeout(enrollmentSearchTimeout);
            enrollmentSearchTimeout = setTimeout(() => {
                filterEnrollments();
            }, 500);
        }

        function filterEnrollments() {
            const search = document.getElementById('enrollment-search')?.value.trim() || '';
            const filters = {
                unit: document.getElementById('enrollment-unit-filter')?.value || '',
                course: document.getElementById('enrollment-course-filter')?.value || '',
                academic_year: document.getElementById('enrollment-year-filter')?.value || '',
                semester: document.getElementById('enrollment-semester-filter')?.value || '',
                exam_registered: document.getElementById('enrollment-exam-status-filter')?.value || ''
            };
            window.LandingData.fetchEnrollments(1, search, filters);
        }
        
        function clearEnrollmentFilters() {
            document.getElementById('enrollment-search').value = '';
            document.getElementById('enrollment-course-filter').value = '';
            document.getElementById('enrollment-unit-filter').value = '';
            document.getElementById('enrollment-year-filter').value = '';
            document.getElementById('enrollment-semester-filter').value = '';
            document.getElementById('enrollment-exam-status-filter').value = '';
            // Reload units dropdown when course is cleared
            loadEnrollmentUnits();
            filterEnrollments();
        }
        
        async function loadEnrollmentFilters() {
            // Load courses
            try {
                const coursesData = await window.LandingData.fetchCourses(1, '');
                const courseSelect = document.getElementById('enrollment-course-filter');
                if (courseSelect && coursesData && coursesData.results) {
                    // Keep the "All Courses" option
                    courseSelect.innerHTML = '<option value="">All Courses</option>';
                    coursesData.results.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.name;
                        courseSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading courses for enrollment filters:', error);
            }
            
            // Load units
            await loadEnrollmentUnits();
            
            // Load academic years (current year + next 3 years)
            const yearSelect = document.getElementById('enrollment-year-filter');
            if (yearSelect) {
                const currentYear = new Date().getFullYear();
                yearSelect.innerHTML = '<option value="">All Academic Years</option>';
                for (let i = 0; i < 4; i++) {
                    const year = currentYear + i;
                    const option = document.createElement('option');
                    option.value = `${year}/${year + 1}`;
                    option.textContent = `${year}/${year + 1}`;
                    yearSelect.appendChild(option);
                }
            }
        }
        
        async function loadEnrollmentUnits(courseId = null) {
            try {
                const params = new URLSearchParams({
                    page: 1,
                    page_size: 1000  // Get all units
                });
                if (courseId) {
                    params.append('course', courseId);
                }
                
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/units/?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken || ''
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const unitsData = await response.json();
                const unitSelect = document.getElementById('enrollment-unit-filter');
                if (unitSelect && unitsData && unitsData.results) {
                    // Keep the "All Units" option
                    unitSelect.innerHTML = '<option value="">All Units</option>';
                    
                    unitsData.results.forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit.id;
                        option.textContent = `${unit.code} - ${unit.name}`;
                        unitSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading units for enrollment filters:', error);
            }
        }
        
        function onEnrollmentCourseChange() {
            const courseId = document.getElementById('enrollment-course-filter')?.value;
            // Reset unit filter when course changes
            document.getElementById('enrollment-unit-filter').value = '';
            // Reload units (filtered by course if needed)
            loadEnrollmentUnits(courseId);
            // Apply filters
            filterEnrollments();
        }

        function filterResults() {
            // Prevent filtering while populating dropdowns
            if (isPopulatingFilters) {
                return;
            }
            
            const filters = {
                unit: document.getElementById('result-unit-filter').value,
                academic_year: document.getElementById('result-year-filter').value,
                semester: document.getElementById('result-semester-filter').value
            };
            // Get current tab state
            const draftTab = document.getElementById('results-draft-tab');
            if (draftTab && draftTab.classList.contains('active')) {
                filters.show_submitted = false;
            } else {
                filters.show_submitted = true;
            }
            window.LandingData.fetchResults(1, '', filters);
        }
        
        async function clearResultFilters() {
            document.getElementById('result-unit-filter').value = '';
            document.getElementById('result-year-filter').value = '';
            document.getElementById('result-semester-filter').value = '';
            // Reload academic year dropdown and set default
            await populateResultYearDropdown();
            filterResults();
        }
        
        function switchResultsTab(tab) {
            const draftTab = document.getElementById('results-draft-tab');
            const submittedTab = document.getElementById('results-submitted-tab');
            
            if (tab === 'draft') {
                draftTab.classList.add('active');
                submittedTab.classList.remove('active');
            } else {
                submittedTab.classList.add('active');
                draftTab.classList.remove('active');
            }
            
            const filters = {
                unit: document.getElementById('result-unit-filter').value,
                academic_year: document.getElementById('result-year-filter').value,
                semester: document.getElementById('result-semester-filter').value,
                show_submitted: tab === 'submitted'
            };
            window.LandingData.fetchResults(1, '', filters);
        }
        
        // ==================== NEW MARKS ENTRY SYSTEM ====================
        
        let currentUnitId = null;
        let currentAcademicYear = null;
        let currentSemester = null;
        let marksData = [];
        let filteredMarksData = [];
        let passMark = 50;
        let maxCatMarks = 30;
        let maxExamMarks = 70;
        
        // Show unit selection view
        function showUnitSelection() {
            const unitSelectionView = document.getElementById('unit-selection-view');
            const marksEntryView = document.getElementById('marks-entry-view');
            const adminResultsView = document.getElementById('admin-results-view');
            
            if (!unitSelectionView) {
                console.error('Unit selection view element not found');
                return;
            }
            
            // Show unit selection view
            unitSelectionView.style.display = 'block';
            
            // Hide other views
            if (marksEntryView) marksEntryView.style.display = 'none';
            if (adminResultsView) adminResultsView.style.display = 'none';
            
            console.log('Showing unit selection view');
            
            // Load units
            loadLecturerUnits();
        }
        
        // Load lecturer units with stats
        let loadUnitsTimeout = null;
        let loadUnitsAbortController = null;
        let isLoadingUnits = false;
        
        // Make function globally accessible
        window.loadLecturerUnits = async function loadLecturerUnits() {
            const grid = document.getElementById('units-grid');
            if (!grid) {
                console.error('Units grid element not found');
                return;
            }
            
            // Clear any existing timeout
            if (loadUnitsTimeout) {
                clearTimeout(loadUnitsTimeout);
                loadUnitsTimeout = null;
            }
            
            // Abort any existing request
            if (loadUnitsAbortController) {
                loadUnitsAbortController.abort();
                loadUnitsAbortController = null;
            }
            
            // Create new AbortController for this request
            loadUnitsAbortController = new AbortController();
            isLoadingUnits = true;
            
            // Disable refresh button and show loading state
            const refreshBtn = document.getElementById('refresh-units-btn');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            }
            
            // Show loading state
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary-color); margin-bottom: 12px;"></i><p style="color: var(--text-light);">Loading units...</p></div>';
            
            // Helper function to stop loading and show timeout
            const stopLoading = () => {
                isLoadingUnits = false;
                if (loadUnitsAbortController) {
                    loadUnitsAbortController.abort();
                    loadUnitsAbortController = null;
                }
                
                const currentGrid = document.getElementById('units-grid');
                if (currentGrid) {
                    currentGrid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                            <i class="fas fa-clock" style="font-size: 32px; color: #f59e0b; margin-bottom: 12px;"></i>
                            <p style="color: var(--text-light); margin-bottom: 8px;">Request timed out</p>
                            <p style="color: var(--text-light); font-size: 12px;">The request took too long. Please check your connection and try again.</p>
                            <button class="btn btn-secondary" onclick="loadLecturerUnits()" style="margin-top: 16px;">
                                <i class="fas fa-redo"></i> Retry
                            </button>
                        </div>
                    `;
                }
                
                // Re-enable refresh button
                const currentRefreshBtn = document.getElementById('refresh-units-btn');
                if (currentRefreshBtn) {
                    currentRefreshBtn.disabled = false;
                    currentRefreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                }
                
                if (typeof showToast === 'function') {
                    showToast('warning', 'Request timed out. Please try again.');
                }
            };
            
            // Set timeout (10 seconds - shorter timeout)
            loadUnitsTimeout = setTimeout(() => {
                console.log('Request timeout triggered');
                stopLoading();
                loadUnitsTimeout = null;
            }, 10000); // 10 seconds timeout
            
            const yearFilter = document.getElementById('unit-selection-year-filter')?.value || '';
            const semesterFilter = document.getElementById('unit-selection-semester-filter')?.value || '';
            
            const params = new URLSearchParams();
            if (yearFilter) params.append('academic_year', yearFilter);
            if (semesterFilter) params.append('semester', semesterFilter);
            
            try {
                console.log('Starting fetch request...');
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/lecturer/units/stats/?${params.toString()}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken || ''
                    },
                    credentials: 'same-origin',
                    signal: loadUnitsAbortController.signal
                });
                
                // Clear timeout on success
                if (loadUnitsTimeout) {
                    clearTimeout(loadUnitsTimeout);
                    loadUnitsTimeout = null;
                }
                
                isLoadingUnits = false;
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Units data received:', data);
                
                // Load academic year options if not loaded
                const yearSelect = document.getElementById('unit-selection-year-filter');
                if (yearSelect && yearSelect.options.length <= 1) {
                    loadAcademicYearOptions();
                }
                
                renderUnitsGrid(data.units || []);
                
                // Re-enable refresh button
                const currentRefreshBtn = document.getElementById('refresh-units-btn');
                if (currentRefreshBtn) {
                    currentRefreshBtn.disabled = false;
                    currentRefreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                }
            } catch (error) {
                // Clear timeout on error
                if (loadUnitsTimeout) {
                    clearTimeout(loadUnitsTimeout);
                    loadUnitsTimeout = null;
                }
                
                isLoadingUnits = false;
                
                // Don't show error if request was aborted (timeout or manual abort)
                if (error.name === 'AbortError') {
                    console.log('Request was aborted');
                    return;
                }
                
                console.error('Error loading lecturer units:', error);
                
                const currentGrid = document.getElementById('units-grid');
                if (currentGrid) {
                    currentGrid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px; color: #ef4444; margin-bottom: 12px;"></i>
                            <p style="color: var(--text-light); margin-bottom: 8px;">Failed to load units</p>
                            <p style="color: var(--text-light); font-size: 12px;">${error.message || 'Please try again'}</p>
                            <button class="btn btn-secondary" onclick="loadLecturerUnits()" style="margin-top: 16px;">
                                <i class="fas fa-redo"></i> Retry
                            </button>
                        </div>
                    `;
                }
                
                // Re-enable refresh button
                const currentRefreshBtn = document.getElementById('refresh-units-btn');
                if (currentRefreshBtn) {
                    currentRefreshBtn.disabled = false;
                    currentRefreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                }
                
                if (typeof showToast === 'function') {
                    showToast('error', 'Failed to load units: ' + (error.message || 'Unknown error'));
                }
            }
        }
        
        // Render units grid with enhanced stats
        function renderUnitsGrid(units) {
            const grid = document.getElementById('units-grid');
            if (!grid) {
                console.error('Units grid element not found');
                return;
            }
            
            if (!units || units.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; background: var(--bg-card-hover); border-radius: 12px; border: 2px dashed var(--border-color);">
                        <i class="fas fa-book-open" style="font-size: 48px; color: var(--text-light); margin-bottom: 16px; opacity: 0.5;"></i>
                        <h3 style="color: var(--text-color); margin-bottom: 8px; font-size: 20px;">No Units Assigned</h3>
                        <p style="color: var(--text-light); font-size: 14px; margin-bottom: 0;">You don't have any units assigned to you yet.</p>
                        <p style="color: var(--text-light); font-size: 12px; margin-top: 8px; opacity: 0.7;">Please contact your administrator to get units assigned.</p>
                    </div>
                `;
                return;
            }
            
            console.log(`Rendering ${units.length} units`);
            
            grid.innerHTML = units.map(unit => {
                const statusColor = unit.status === 'submitted' ? '#10b981' : 
                                   unit.status === 'draft' ? '#f59e0b' : '#6b7280';
                const statusIcon = unit.status === 'submitted' ? 'fa-check-circle' : 
                                  unit.status === 'draft' ? 'fa-edit' : 'fa-file';
                
                // Calculate students without marks
                const withoutMarks = (unit.total_enrolled || 0) - (unit.marked_count || 0);
                
                // Show submit button only if all students have marks and not all submitted
                const canSubmit = (unit.total_enrolled || 0) > 0 && 
                                 (unit.marked_count || 0) === (unit.total_enrolled || 0) && 
                                 (unit.submitted_count || 0) < (unit.total_enrolled || 0);
                
                // Escape special characters for JavaScript
                const unitCode = (unit.code || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const unitName = (unit.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const academicYear = (unit.academic_year || '').replace(/'/g, "\\'");
                const semester = unit.semester || '';
                
                return `
                    <div class="unit-card" 
                         onclick="selectUnit(${unit.id}, '${unitCode}', '${unitName}', '${academicYear}', '${semester}')" 
                         style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; position: relative;"
                         onmouseover="this.style.borderColor='var(--primary-color)'; this.style.transform='translateY(-2px)'"
                         onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <h4 style="margin: 0 0 4px 0; color: var(--text-color);">${unit.code}</h4>
                                <p style="margin: 0; color: var(--text-light); font-size: 14px;">${unit.name}</p>
                            </div>
                            <span style="color: ${statusColor}; font-size: 24px;">
                                <i class="fas ${statusIcon}"></i>
                            </span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">Total Enrolled</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--primary-color);">${unit.total_enrolled || 0}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">With Marks</div>
                                <div style="font-size: 20px; font-weight: 700; color: #10b981;">${unit.marked_count || 0}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">No Marks</div>
                                <div style="font-size: 20px; font-weight: 700; color: ${withoutMarks > 0 ? '#ef4444' : '#6b7280'};">${withoutMarks}</div>
                            </div>
                        </div>
                        
                        ${canSubmit ? `
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                                <button class="btn btn-primary" 
                                        onclick="event.stopPropagation(); submitAllMarksForUnit(${unit.id}, '${unitCode}', '${unitName}')"
                                        style="width: 100%; padding: 10px; font-weight: 600;">
                                    <i class="fas fa-check-circle"></i> Submit All Results
                                </button>
                            </div>
                        ` : (unit.submitted_count || 0) === (unit.total_enrolled || 0) && (unit.total_enrolled || 0) > 0 ? `
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color); text-align: center;">
                                <span style="color: #10b981; font-size: 14px; font-weight: 600;">
                                    <i class="fas fa-check-circle"></i> All Submitted
                                </span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Load My Units (for My Units tab)
        let loadMyUnitsTimeout = null;
        let loadMyUnitsAbortController = null;
        
        window.loadMyUnits = async function loadMyUnits() {
            const grid = document.getElementById('my-units-grid');
            if (!grid) {
                console.error('My units grid element not found');
                return;
            }
            
            // Clear any existing timeout
            if (loadMyUnitsTimeout) {
                clearTimeout(loadMyUnitsTimeout);
                loadMyUnitsTimeout = null;
            }
            
            // Abort any existing request
            if (loadMyUnitsAbortController) {
                loadMyUnitsAbortController.abort();
                loadMyUnitsAbortController = null;
            }
            
            // Create new AbortController for this request
            loadMyUnitsAbortController = new AbortController();
            
            // Disable refresh button and show loading state
            const refreshBtn = document.getElementById('refresh-my-units-btn');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            }
            
            // Show loading state
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary-color); margin-bottom: 12px;"></i><p style="color: var(--text-light);">Loading units...</p></div>';
            
            // Helper function to stop loading and show timeout
            const stopLoading = () => {
                if (loadMyUnitsAbortController) {
                    loadMyUnitsAbortController.abort();
                    loadMyUnitsAbortController = null;
                }
                
                const currentGrid = document.getElementById('my-units-grid');
                if (currentGrid) {
                    currentGrid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                            <i class="fas fa-clock" style="font-size: 32px; color: #f59e0b; margin-bottom: 12px;"></i>
                            <p style="color: var(--text-light); margin-bottom: 8px;">Request timed out</p>
                            <p style="color: var(--text-light); font-size: 12px;">The request took too long. Please check your connection and try again.</p>
                            <button class="btn btn-secondary" onclick="window.loadMyUnits && window.loadMyUnits()" style="margin-top: 16px;">
                                <i class="fas fa-redo"></i> Retry
                            </button>
                        </div>
                    `;
                }
                
                // Re-enable refresh button
                const currentRefreshBtn = document.getElementById('refresh-my-units-btn');
                if (currentRefreshBtn) {
                    currentRefreshBtn.disabled = false;
                    currentRefreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                }
                
                if (typeof showToast === 'function') {
                    showToast('warning', 'Request timed out. Please try again.');
                }
            };
            
            // Set timeout (10 seconds)
            loadMyUnitsTimeout = setTimeout(() => {
                console.log('My Units request timeout triggered');
                stopLoading();
                loadMyUnitsTimeout = null;
            }, 10000);
            
            try {
                console.log('Starting fetch request for My Units...');
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/lecturer/units/stats/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken || ''
                    },
                    credentials: 'same-origin',
                    signal: loadMyUnitsAbortController.signal
                });
                
                // Clear timeout on success
                if (loadMyUnitsTimeout) {
                    clearTimeout(loadMyUnitsTimeout);
                    loadMyUnitsTimeout = null;
                }
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('My Units data received:', data);
                
                renderMyUnitsGrid(data.units || []);
                
                // Re-enable refresh button
                const currentRefreshBtn = document.getElementById('refresh-my-units-btn');
                if (currentRefreshBtn) {
                    currentRefreshBtn.disabled = false;
                    currentRefreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                }
            } catch (error) {
                // Clear timeout on error
                if (loadMyUnitsTimeout) {
                    clearTimeout(loadMyUnitsTimeout);
                    loadMyUnitsTimeout = null;
                }
                
                // Don't show error if request was aborted
                if (error.name === 'AbortError') {
                    console.log('My Units request was aborted');
                    return;
                }
                
                console.error('Error loading my units:', error);
                
                const currentGrid = document.getElementById('my-units-grid');
                if (currentGrid) {
                    currentGrid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px; color: #ef4444; margin-bottom: 12px;"></i>
                            <p style="color: var(--text-light); margin-bottom: 8px;">Failed to load units</p>
                            <p style="color: var(--text-light); font-size: 12px;">${error.message || 'Please try again'}</p>
                            <button class="btn btn-secondary" onclick="window.loadMyUnits && window.loadMyUnits()" style="margin-top: 16px;">
                                <i class="fas fa-redo"></i> Retry
                            </button>
                        </div>
                    `;
                }
                
                // Re-enable refresh button
                const currentRefreshBtn = document.getElementById('refresh-my-units-btn');
                if (currentRefreshBtn) {
                    currentRefreshBtn.disabled = false;
                    currentRefreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                }
                
                if (typeof showToast === 'function') {
                    showToast('error', 'Failed to load units: ' + (error.message || 'Unknown error'));
                }
            }
        };
        
        // Render My Units grid
        function renderMyUnitsGrid(units) {
            const grid = document.getElementById('my-units-grid');
            if (!grid) {
                console.error('My units grid element not found');
                return;
            }
            
            if (!units || units.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; background: var(--bg-card-hover); border-radius: 12px; border: 2px dashed var(--border-color);">
                        <i class="fas fa-book-open" style="font-size: 48px; color: var(--text-light); margin-bottom: 16px; opacity: 0.5;"></i>
                        <h3 style="color: var(--text-color); margin-bottom: 8px; font-size: 20px;">No Units Assigned</h3>
                        <p style="color: var(--text-light); font-size: 14px; margin-bottom: 0;">You don't have any units assigned to you yet.</p>
                        <p style="color: var(--text-light); font-size: 12px; margin-top: 8px; opacity: 0.7;">Please contact your administrator to get units assigned.</p>
                    </div>
                `;
                return;
            }
            
            console.log(`Rendering ${units.length} units in My Units tab`);
            
            grid.innerHTML = units.map(unit => {
                const statusColor = unit.status === 'submitted' ? '#10b981' : 
                                   unit.status === 'draft' ? '#f59e0b' : '#6b7280';
                const statusIcon = unit.status === 'submitted' ? 'fa-check-circle' : 
                                  unit.status === 'draft' ? 'fa-edit' : 'fa-file';
                
                // Calculate students without marks
                const withoutMarks = (unit.total_enrolled || 0) - (unit.marked_count || 0);
                
                // Show submit button only if all students have marks and not all submitted
                const canSubmit = (unit.total_enrolled || 0) > 0 && 
                                 (unit.marked_count || 0) === (unit.total_enrolled || 0) && 
                                 (unit.submitted_count || 0) < (unit.total_enrolled || 0);
                
                // Escape special characters for JavaScript
                const unitCode = (unit.code || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const unitName = (unit.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const academicYear = (unit.academic_year || '').replace(/'/g, "\\'");
                const semester = unit.semester || '';
                
                return `
                    <div class="unit-card" 
                         onclick="selectUnitFromMyUnits(${unit.id}, '${unitCode}', '${unitName}', '${academicYear}', '${semester}')"
                         style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s; position: relative;"
                         onmouseover="this.style.borderColor='var(--primary-color)'; this.style.transform='translateY(-2px)'"
                         onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <h4 style="margin: 0 0 4px 0; color: var(--text-color);">${unit.code}</h4>
                                <p style="margin: 0; color: var(--text-light); font-size: 14px;">${unit.name}</p>
                            </div>
                            <span style="color: ${statusColor}; font-size: 24px;">
                                <i class="fas ${statusIcon}"></i>
                            </span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">Total Enrolled</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--primary-color);">${unit.total_enrolled || 0}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">With Marks</div>
                                <div style="font-size: 20px; font-weight: 700; color: #10b981;">${unit.marked_count || 0}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">No Marks</div>
                                <div style="font-size: 20px; font-weight: 700; color: ${withoutMarks > 0 ? '#ef4444' : '#6b7280'};">${withoutMarks}</div>
                            </div>
                        </div>
                        
                        ${canSubmit ? `
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                                <button class="btn btn-primary" 
                                        onclick="event.stopPropagation(); submitAllMarksForUnit(${unit.id}, '${unitCode}', '${unitName}')"
                                        style="width: 100%; padding: 10px; font-weight: 600;">
                                    <i class="fas fa-check-circle"></i> Submit Results
                                </button>
                            </div>
                        ` : (unit.submitted_count || 0) === (unit.total_enrolled || 0) && (unit.total_enrolled || 0) > 0 ? `
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color); text-align: center;">
                                <span style="color: #10b981; font-size: 14px; font-weight: 600;">
                                    <i class="fas fa-check-circle"></i> All Submitted
                                </span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Show Results Units View
        window.showResultsUnitsView = function showResultsUnitsView() {
            const resultsUnitsView = document.getElementById('results-units-view');
            const marksEntryModal = document.getElementById('marks-entry-modal');
            
            if (resultsUnitsView) resultsUnitsView.style.display = 'block';
            if (marksEntryModal) marksEntryModal.classList.remove('active');
            
            // Reload units when going back to the view
            if (typeof window.loadResultsUnits === 'function') {
                window.loadResultsUnits();
            }
        }
        
        // Load Results Units - Simple version to display lecturer units
        window.loadResultsUnits = async function loadResultsUnits() {
            const grid = document.getElementById('results-units-grid');
            if (!grid) {
                console.error('Results units grid element not found');
                return;
            }
            
            // Show loading state
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary-color); margin-bottom: 12px;"></i><p style="color: var(--text-light);">Loading units...</p></div>';
            
            // Disable refresh button
            const refreshBtn = document.getElementById('refresh-results-units-btn');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            }
            
            try {
                // Get filter values - always use current year and semester as defaults
                let yearFilter = document.getElementById('results-year-filter')?.value || '';
                let semesterFilter = document.getElementById('results-semester-filter')?.value || '';
                const unitFilter = document.getElementById('results-unit-filter')?.value || '';
                const unitSearch = document.getElementById('results-unit-search')?.value || '';
                
                // If no academic year selected, fetch current academic year as default
                if (!yearFilter) {
                    try {
                        const settingsResponse = await fetch(`/api/${window.COLLEGE_SLUG}/admin/academic-settings/`, {
                            headers: { 'X-CSRFToken': window.csrftoken }
                        });
                        const settingsData = await settingsResponse.json();
                        if (settingsData.current_academic_year) {
                            yearFilter = settingsData.current_academic_year;
                            // Update the dropdown to show the selected value
                            const yearSelect = document.getElementById('results-year-filter');
                            if (yearSelect) {
                                yearSelect.value = yearFilter;
                            }
                        }
                    } catch (err) {
                        console.warn('Could not fetch current academic year:', err);
                    }
                }
                
                // If no semester selected, fetch current semester as default
                if (!semesterFilter) {
                    try {
                        const settingsResponse = await fetch(`/api/${window.COLLEGE_SLUG}/admin/academic-settings/`, {
                            headers: { 'X-CSRFToken': window.csrftoken }
                        });
                        const settingsData = await settingsResponse.json();
                        if (settingsData.current_semester) {
                            semesterFilter = String(settingsData.current_semester);
                            // Update the dropdown to show the selected value
                            const semesterSelect = document.getElementById('results-semester-filter');
                            if (semesterSelect) {
                                semesterSelect.value = semesterFilter;
                            }
                        }
                    } catch (err) {
                        console.warn('Could not fetch current semester:', err);
                    }
                }
                
                // Build API URL with filters (academic year is now always set)
                // For lecturers: show all assigned units so they can add marks and submit
                // For registrars/principals: only show units with submitted results
                let apiUrl = `/api/${window.COLLEGE_SLUG}/lecturer/units/stats/`;
                const params = new URLSearchParams();
                if (yearFilter) params.append('academic_year', yearFilter);
                if (semesterFilter) params.append('semester', semesterFilter);
                if (unitSearch) params.append('search', unitSearch);
                // Only filter by submitted status for registrars/principals, not for lecturers
                const isRegistrarOrPrincipal = (window.USER_ROLE === 'registrar' || window.USER_ROLE === 'principal');
                if (isRegistrarOrPrincipal) {
                    params.append('only_submitted', 'true'); // Only show submitted results for Results tab
                }
                if (params.toString()) {
                    apiUrl += '?' + params.toString();
                }
                
                // Fetch lecturer units
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken || ''
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Results Units data received:', data);
                
                // Log detailed unit information for debugging
                if (data.units && data.units.length > 0) {
                    console.log(`=== UNIT ENROLLMENT STATS ===`);
                    data.units.forEach((unit, index) => {
                        console.log(`Unit ${index + 1}: ${unit.code} - ${unit.name}`);
                        console.log(`  - Unit ID: ${unit.id}`);
                        console.log(`  - Total Enrolled: ${unit.total_enrolled || 0}`);
                        console.log(`  - Marked Count: ${unit.marked_count || 0}`);
                        console.log(`  - Submitted Count: ${unit.submitted_count || 0}`);
                        console.log(`  - Status: ${unit.status || 'N/A'}`);
                        console.log(`  - Academic Year: ${unit.academic_year || 'N/A'}`);
                        console.log(`  - Semester: ${unit.semester || 'N/A'}`);
                        console.log(`  - Full Unit Object:`, unit);
                        console.log('---');
                    });
                    console.log(`Total units: ${data.units.length}`);
                } else {
                    console.warn('No units found in response or units array is empty');
                    console.log('Full response data:', data);
                }
                
                // Render the units
                renderResultsUnitsGrid(data.units || []);
                
                // Re-enable refresh button
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                }
            } catch (error) {
                console.error('Error loading results units:', error);
                
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 32px; color: #ef4444; margin-bottom: 12px;"></i>
                        <p style="color: var(--text-light); margin-bottom: 8px;">Failed to load units</p>
                        <p style="color: var(--text-light); font-size: 12px;">${error.message || 'Please try again'}</p>
                        <button class="btn btn-secondary" onclick="window.loadResultsUnits && window.loadResultsUnits()" style="margin-top: 16px;">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                `;
                
                // Re-enable refresh button
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                }
                
                if (typeof showToast === 'function') {
                    showToast('error', 'Failed to load units: ' + (error.message || 'Unknown error'));
                }
            }
        };
        
        // Load Results filters (Academic Year, Semester, and Unit) - Same as My Units
        async function loadResultsFilters() {
            const yearSelect = document.getElementById('results-year-filter');
            if (yearSelect) {
                try {
                    const yearsResponse = await fetch(`/api/${window.COLLEGE_SLUG}/results/academic-years/`, {
                        headers: { 'X-CSRFToken': window.csrftoken }
                    });
                    const yearsData = await yearsResponse.json();
                    if (yearsData.academic_years && yearsData.academic_years.length > 0) {
                        yearSelect.innerHTML = '';
                        yearsData.academic_years.forEach(year => {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year;
                            yearSelect.appendChild(option);
                        });
                        // Set default to current academic year from settings
                        try {
                            const settingsResponse = await fetch(`/api/${window.COLLEGE_SLUG}/admin/academic-settings/`, {
                                headers: { 'X-CSRFToken': window.csrftoken }
                            });
                            const settingsData = await settingsResponse.json();
                            if (settingsData.current_academic_year) {
                                yearSelect.value = settingsData.current_academic_year;
                            }
                        } catch (err) {
                            if (yearsData.academic_years.length > 0) {
                                yearSelect.value = yearsData.academic_years[0];
                            }
                        }
                    }
                } catch (err) {
                    console.warn('Could not load academic years:', err);
                }
            }
            
            // Load semester dropdown with default to current semester
            const semesterSelect = document.getElementById('results-semester-filter');
            if (semesterSelect) {
                try {
                    const settingsResponse = await fetch(`/api/${window.COLLEGE_SLUG}/admin/academic-settings/`, {
                        headers: { 'X-CSRFToken': window.csrftoken }
                    });
                    const settingsData = await settingsResponse.json();
                    const semestersPerYear = settingsData.semesters_per_year || 2;
                    const currentSemester = settingsData.current_semester || 1;
                    
                    semesterSelect.innerHTML = '';
                    for (let i = 1; i <= semestersPerYear; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `Semester ${i}`;
                        semesterSelect.appendChild(option);
                    }
                    
                    // Set default to current semester from settings
                    semesterSelect.value = String(currentSemester);
                } catch (err) {
                    console.warn('Could not load semester options:', err);
                    // Fallback: populate with default 2 semesters
                    semesterSelect.innerHTML = '';
                    for (let i = 1; i <= 2; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `Semester ${i}`;
                        semesterSelect.appendChild(option);
                    }
                    semesterSelect.value = '1';
                }
            }
        }
        
        // Filter Results Units
        function filterResultsUnits() {
            if (typeof window.loadResultsUnits === 'function') {
                window.loadResultsUnits();
            }
        }
        
        // Clear Results Filters (reset to current year and semester)
        async function clearResultsFilters() {
            // Get current academic year and semester
            let currentAcademicYear = null;
            let currentSemester = null;
            
            try {
                const settingsResponse = await fetch(`/api/${window.COLLEGE_SLUG}/admin/academic-settings/`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                const settingsData = await settingsResponse.json();
                if (settingsData.current_academic_year) {
                    currentAcademicYear = settingsData.current_academic_year;
                }
                if (settingsData.current_semester) {
                    currentSemester = settingsData.current_semester;
                }
            } catch (err) {
                console.warn('Could not fetch academic settings:', err);
                // Fallback to COLLEGE_DATA if available
                if (window.COLLEGE_DATA) {
                    if (window.COLLEGE_DATA.current_academic_year) {
                        currentAcademicYear = window.COLLEGE_DATA.current_academic_year;
                    }
                    if (window.COLLEGE_DATA.current_semester) {
                        currentSemester = window.COLLEGE_DATA.current_semester;
                    }
                }
            }
            
            const yearSelect = document.getElementById('results-year-filter');
            const semesterSelect = document.getElementById('results-semester-filter');
            
            // Reset to current year (required, not empty)
            if (yearSelect && currentAcademicYear) {
                yearSelect.value = currentAcademicYear;
            }
            
            // Reset semester to current semester from settings
            if (semesterSelect && currentSemester) {
                semesterSelect.value = String(currentSemester);
            } else if (semesterSelect) {
                // Fallback to first semester if current not available
                semesterSelect.value = '1';
            }
            
            // Reset unit search if it exists
            const unitSearch = document.getElementById('results-unit-search');
            if (unitSearch) {
                unitSearch.value = '';
            }
            
            filterResultsUnits();
        }
        
        // Load My Units Results (for Registrar/Principal)
        window.loadMyUnitsResults = async function loadMyUnitsResults() {
            const grid = document.getElementById('my-units-results-grid');
            if (!grid) return;
            
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 24px; color: var(--primary-color); margin-bottom: 12px;"></i><p style="color: var(--text-light);">Loading units...</p></div>';
            
            const refreshBtn = document.getElementById('refresh-my-units-results-btn');
            if (refreshBtn) {
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            }
            
            try {
                let yearFilter = document.getElementById('my-units-year-filter')?.value || '';
                const semesterFilter = document.getElementById('my-units-semester-filter')?.value || '';
                
                if (!yearFilter) {
                    try {
                        const settingsResponse = await fetch(`/api/${window.COLLEGE_SLUG}/admin/academic-settings/`, {
                            headers: { 'X-CSRFToken': window.csrftoken }
                        });
                        const settingsData = await settingsResponse.json();
                        if (settingsData.current_academic_year) {
                            yearFilter = settingsData.current_academic_year;
                            const yearSelect = document.getElementById('my-units-year-filter');
                            if (yearSelect) yearSelect.value = yearFilter;
                        }
                    } catch (err) {
                        console.warn('Could not fetch current academic year:', err);
                    }
                }
                
                // For My Units tab: only show units assigned to the registrar
                let apiUrl = `/api/${window.COLLEGE_SLUG}/lecturer/units/stats/`;
                const params = new URLSearchParams();
                if (yearFilter) params.append('academic_year', yearFilter);
                if (semesterFilter) params.append('semester', semesterFilter);
                params.append('for_my_units', 'true'); // Only show assigned units for My Units tab
                if (params.toString()) apiUrl += '?' + params.toString();
                
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken || ''
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                renderResultsUnitsGrid(data.units || [], 'my-units-results-grid');
                
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                }
            } catch (error) {
                console.error('Error loading my units results:', error);
                grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; background: var(--bg-card-hover); border-radius: 12px; border: 2px dashed var(--border-color);"><i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #ef4444; margin-bottom: 16px;"></i><h3 style="color: var(--text-color); margin-bottom: 8px; font-size: 20px;">Error Loading Units</h3><p style="color: var(--text-light); font-size: 14px; margin-bottom: 16px;">${error.message || 'An error occurred while loading units.'}</p><button class="btn btn-secondary" onclick="window.loadMyUnitsResults && window.loadMyUnitsResults()" style="margin-top: 16px;"><i class="fas fa-redo"></i> Retry</button></div>`;
                if (refreshBtn) {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                }
            }
        };
        
        async function loadMyUnitsFilters() {
            const yearSelect = document.getElementById('my-units-year-filter');
            if (yearSelect) {
                try {
                    const yearsResponse = await fetch(`/api/${window.COLLEGE_SLUG}/results/academic-years/`, {
                        headers: { 'X-CSRFToken': window.csrftoken }
                    });
                    const yearsData = await yearsResponse.json();
                    if (yearsData.academic_years && yearsData.academic_years.length > 0) {
                        yearSelect.innerHTML = '';
                        yearsData.academic_years.forEach(year => {
                            const option = document.createElement('option');
                            option.value = year;
                            option.textContent = year;
                            yearSelect.appendChild(option);
                        });
                        try {
                            const settingsResponse = await fetch(`/api/${window.COLLEGE_SLUG}/admin/academic-settings/`, {
                                headers: { 'X-CSRFToken': window.csrftoken }
                            });
                            const settingsData = await settingsResponse.json();
                            if (settingsData.current_academic_year) {
                                yearSelect.value = settingsData.current_academic_year;
                            }
                        } catch (err) {
                            if (yearsData.academic_years.length > 0) {
                                yearSelect.value = yearsData.academic_years[0];
                            }
                        }
                    }
                } catch (err) {
                    console.warn('Could not load academic years:', err);
                }
            }
            
            // Load semester dropdown with default to first semester (1)
            const semesterSelect = document.getElementById('my-units-semester-filter');
            if (semesterSelect) {
                try {
                    const settingsResponse = await fetch(`/api/${window.COLLEGE_SLUG}/admin/academic-settings/`, {
                        headers: { 'X-CSRFToken': window.csrftoken }
                    });
                    const settingsData = await settingsResponse.json();
                    const semestersPerYear = settingsData.semesters_per_year || 2;
                    
                    semesterSelect.innerHTML = '<option value="">All Semesters</option>';
                    for (let i = 1; i <= semestersPerYear; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `Semester ${i}`;
                        semesterSelect.appendChild(option);
                    }
                    
                    // Set default to first semester (1)
                    semesterSelect.value = '1';
                } catch (err) {
                    console.warn('Could not load semester options:', err);
                    await populateSemesterDropdown('my-units-semester-filter', true);
                    const defaultSelect = document.getElementById('my-units-semester-filter');
                    if (defaultSelect) defaultSelect.value = '1';
                }
            }
        }
        
        async function filterMyUnitsResults() {
            if (typeof window.loadMyUnitsResults === 'function') {
                await window.loadMyUnitsResults();
            }
        }
        
        async function clearMyUnitsFilters() {
            const yearSelect = document.getElementById('my-units-year-filter');
            const semesterSelect = document.getElementById('my-units-semester-filter');
            try {
                const settingsResponse = await fetch(`/api/${window.COLLEGE_SLUG}/admin/academic-settings/`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                const settingsData = await settingsResponse.json();
                if (yearSelect && settingsData.current_academic_year) {
                    yearSelect.value = settingsData.current_academic_year;
                }
            } catch (err) {
                console.warn('Could not fetch current academic year:', err);
            }
            // Reset semester to first semester (1) instead of empty
            if (semesterSelect) {
                semesterSelect.value = '1';
            }
            if (typeof window.loadMyUnitsResults === 'function') {
                await window.loadMyUnitsResults();
            }
        }
        
        // Render Results Units grid
        function renderResultsUnitsGrid(units, gridId = 'results-units-grid') {
            const grid = document.getElementById(gridId);
            if (!grid) {
                console.error(`Results units grid element not found: ${gridId}`);
                return;
            }
            
            if (!units || units.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; background: var(--bg-card-hover); border-radius: 12px; border: 2px dashed var(--border-color);">
                        <i class="fas fa-book-open" style="font-size: 48px; color: var(--text-light); margin-bottom: 16px; opacity: 0.5;"></i>
                        <h3 style="color: var(--text-color); margin-bottom: 8px; font-size: 20px;">No Units Assigned</h3>
                        <p style="color: var(--text-light); font-size: 14px; margin-bottom: 0;">You don't have any units assigned to you yet.</p>
                        <p style="color: var(--text-light); font-size: 12px; margin-top: 8px; opacity: 0.7;">Please contact your administrator to get units assigned.</p>
                    </div>
                `;
                return;
            }
            
            console.log(`Rendering ${units.length} units in Results tab`);
            
            grid.innerHTML = units.map(unit => {
                // Log each unit's enrollment data before rendering
                console.log(`[RENDER] Unit: ${unit.code} - ${unit.name} (ID: ${unit.id})`);
                console.log(`[RENDER]   total_enrolled: ${unit.total_enrolled} (type: ${typeof unit.total_enrolled})`);
                console.log(`[RENDER]   marked_count: ${unit.marked_count} (type: ${typeof unit.marked_count})`);
                console.log(`[RENDER]   submitted_count: ${unit.submitted_count} (type: ${typeof unit.submitted_count})`);
                console.log(`[RENDER]   Raw unit object:`, JSON.stringify(unit, null, 2));
                
                const statusColor = unit.status === 'submitted' ? '#10b981' : 
                                   unit.status === 'draft' ? '#f59e0b' : '#6b7280';
                const statusIcon = unit.status === 'submitted' ? 'fa-check-circle' : 
                                  unit.status === 'draft' ? 'fa-edit' : 'fa-file';
                
                // Calculate students without marks
                const totalEnrolled = unit.total_enrolled || 0;
                const markedCount = unit.marked_count || 0;
                const withoutMarks = totalEnrolled - markedCount;
                
                console.log(`[RENDER]   Calculated values - Total: ${totalEnrolled}, Marked: ${markedCount}, Without: ${withoutMarks}`);
                
                // Escape special characters for JavaScript
                const unitCode = (unit.code || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const unitName = (unit.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const academicYear = (unit.academic_year || '').replace(/'/g, "\\'");
                const semester = unit.semester || '';
                
                // Determine if unit is fully submitted
                const isFullySubmitted = (unit.submitted_count || 0) === totalEnrolled && totalEnrolled > 0;
                const isSubmitted = unit.status === 'submitted' || isFullySubmitted;
                
                // Registrars and principals can always click to review/edit submitted results
                // Lecturers can only click if not fully submitted (they can't edit submitted results)
                const isRegistrarOrPrincipal = (window.USER_ROLE === 'registrar' || window.USER_ROLE === 'principal');
                const canClick = isRegistrarOrPrincipal || !isSubmitted;
                
                const cardOpacity = canClick ? '1' : '0.6';
                const cardCursor = canClick ? 'pointer' : 'not-allowed';
                const cardBackground = canClick ? 'var(--bg-card)' : 'var(--bg-card-hover)';
                
                return `
                    <div class="unit-card" 
                         ${canClick ? `onclick="selectUnitFromResults(${unit.id}, '${unitCode}', '${unitName}', '${academicYear}', '${semester}')"` : ''}
                         style="background: ${cardBackground}; border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; cursor: ${cardCursor}; transition: all 0.3s; position: relative; opacity: ${cardOpacity};"
                         ${canClick ? `onmouseover="this.style.borderColor='var(--primary-color)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.transform='translateY(0)'"` : ''}>
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <h4 style="margin: 0 0 4px 0; color: var(--text-color);">${unit.code}</h4>
                                <p style="margin: 0; color: var(--text-light); font-size: 14px;">${unit.name}</p>
                            </div>
                            <span style="color: ${statusColor}; font-size: 24px;">
                                <i class="fas ${statusIcon}"></i>
                            </span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">Total Enrolled</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--primary-color);">${totalEnrolled}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">With Marks</div>
                                <div style="font-size: 20px; font-weight: 700; color: #10b981;">${markedCount}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-light); margin-bottom: 4px;">No Marks</div>
                                <div style="font-size: 20px; font-weight: 700; color: ${withoutMarks > 0 ? '#ef4444' : '#6b7280'};">${withoutMarks}</div>
                            </div>
                        </div>
                        
                        ${(() => {
                            const isRegistrar = (window.USER_ROLE === 'registrar' || window.USER_ROLE === 'principal');
                            if (isRegistrar) {
                                if (unit.lecturer_name) {
                                    const lecturerNameEscaped = (unit.lecturer_name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                    return `<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                                        <div style="display: flex; align-items: center; gap: 8px; color: var(--text-secondary); font-size: 13px;">
                                            <i class="fas fa-user-tie"></i>
                                            <span style="font-weight: 600;">Submitted by:</span>
                                            <span style="color: var(--text-color);">${lecturerNameEscaped}</span>
                                        </div>
                                    </div>`;
                                } else if ((unit.submitted_count || 0) === totalEnrolled && totalEnrolled > 0) {
                                    return `<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color); text-align: center;">
                                        <span style="color: #10b981; font-size: 14px; font-weight: 600;">
                                            <i class="fas fa-check-circle"></i> All Submitted
                                        </span>
                                    </div>`;
                                }
                                return '';
                            } else {
                                // For lecturers: show submit button or submitted status
                                if (isFullySubmitted) {
                                    return `<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color); text-align: center;">
                                        <span style="color: #10b981; font-size: 14px; font-weight: 600;">
                                            <i class="fas fa-check-circle"></i> Submitted
                                        </span>
                                    </div>`;
                                } else if (markedCount > 0 && (unit.submitted_count || 0) < totalEnrolled) {
                                    return `<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                                        <button class="btn btn-primary" 
                                                onclick="event.stopPropagation(); submitAllMarksForUnit(${unit.id}, '${unitCode}', '${unitName}')"
                                                style="width: 100%; padding: 10px; font-weight: 600;">
                                            <i class="fas fa-check-circle"></i> Submit Results
                                        </button>
                                    </div>`;
                                }
                                return '';
                            }
                        })()}
                    </div>
                `;
            }).join('');
        }
        
        // Select unit from Results tab
        async function selectUnitFromResults(unitId, unitCode, unitName, academicYear, semester) {
            // Set current unit info
            currentUnitId = unitId;
            currentAcademicYear = academicYear;
            currentSemester = semester;
            
            // Update modal title
            const titleElement = document.getElementById('marks-entry-unit-title');
            if (titleElement) {
                titleElement.textContent = `${unitCode} - ${unitName}`;
            }
            
            // Open the modal
            const marksEntryModal = document.getElementById('marks-entry-modal');
            if (marksEntryModal) {
                marksEntryModal.classList.add('active');
            }
            
            // Load marks for this unit
            if (typeof loadUnitStudentsMarks === 'function') {
                await loadUnitStudentsMarks(unitId, academicYear, semester);
            } else {
                console.error('loadUnitStudentsMarks function not found');
            }
        }
        
        // Load academic year options
        function loadAcademicYearOptions() {
            const yearSelect = document.getElementById('unit-selection-year-filter');
            if (!yearSelect) return;
            
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '<option value="">All Years</option>';
            for (let i = -2; i <= 3; i++) {
                const year = currentYear + i;
                const option = document.createElement('option');
                option.value = `${year}/${year + 1}`;
                option.textContent = `${year}/${year + 1}`;
                yearSelect.appendChild(option);
            }
            
            // Set default to current academic year if available
            if (window.COLLEGE_CURRENT_YEAR) {
                yearSelect.value = window.COLLEGE_CURRENT_YEAR;
            }
        }
        
        // Select unit and show marks entry view
        async function selectUnit(unitId, unitCode, unitName, academicYear, semester) {
            currentUnitId = unitId;
            currentAcademicYear = academicYear;
            currentSemester = semester;
            
            document.getElementById('unit-selection-view').style.display = 'none';
            document.getElementById('marks-entry-view').style.display = 'block';
            document.getElementById('marks-entry-unit-title').textContent = `${unitCode} - ${unitName}`;
            
            await loadUnitStudentsMarks(unitId, academicYear, semester);
        }
        
        // Select unit from My Units tab - switches to Results tab and opens marks entry
        async function selectUnitFromMyUnits(unitId, unitCode, unitName, academicYear, semester) {
            // Set a flag to prevent showUnitSelection from being called
            window.skipUnitSelection = true;
            
            // Switch to Results tab first
            switchTab('results');
            
            // Wait a bit for the tab to switch, then select the unit
            setTimeout(async () => {
                // Make sure we're showing the marks entry view (not unit selection)
                const unitSelectionView = document.getElementById('unit-selection-view');
                const marksEntryView = document.getElementById('marks-entry-view');
                const adminResultsView = document.getElementById('admin-results-view');
                
                if (unitSelectionView) unitSelectionView.style.display = 'none';
                if (marksEntryView) marksEntryView.style.display = 'block';
                if (adminResultsView) adminResultsView.style.display = 'none';
                
                await selectUnit(unitId, unitCode, unitName, academicYear, semester);
                
                // Clear the flag
                window.skipUnitSelection = false;
            }, 200);
        }
        
        // Make function globally accessible
        window.selectUnitFromMyUnits = selectUnitFromMyUnits;
        
        // Load students and marks for a unit (enhanced)
        async function loadUnitStudentsMarks(unitId, academicYear, semester) {
            // Target the modal table body (the visible one)
            const tbody = document.getElementById('marks-entry-tbody-modal');
            if (!tbody) {
                console.error('Marks entry table body not found in modal');
                return;
            }
            
            tbody.innerHTML = '<tr><td colspan="7" class="loading-row"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
            
            // Only add parameters if they have valid values (not empty strings)
            const params = new URLSearchParams();
            if (academicYear && academicYear.trim() !== '') {
                params.append('academic_year', academicYear.trim());
            }
            if (semester && semester !== '' && semester !== null && semester !== undefined) {
                params.append('semester', semester);
            }
            
            const apiUrl = `/api/${window.COLLEGE_SLUG}/units/${unitId}/students-marks/${params.toString() ? '?' + params.toString() : ''}`;
            console.log('Loading students for unit:', { unitId, academicYear, semester, apiUrl });
            
            try {
                // Load students marks (this API now includes grading criteria)
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken || ''
                    },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Students marks data received:', { 
                    studentsCount: data.students?.length || 0, 
                    totalCount: data.count || 0,
                    students: data.students 
                });
                
                marksData = data.students || [];
                filteredMarksData = marksData;
                passMark = data.pass_mark || 50;
                
                // Get grading criteria from the students-marks response (available to lecturers)
                if (data.grading_criteria) {
                    maxCatMarks = data.grading_criteria.cat_weight || 30;
                    maxExamMarks = data.grading_criteria.exam_weight || 70;
                }
                
                if (marksData.length === 0) {
                    console.warn('No students returned from API. Check if enrollments exist for this unit.');
                }
                
                renderMarksTable(filteredMarksData);
                updateStats(filteredMarksData);
                
                // Clear search
                const searchInput = document.getElementById('marks-entry-search');
                if (searchInput) {
                    searchInput.value = '';
                }
            } catch (error) {
                console.error('Error loading unit students marks:', error);
                tbody.innerHTML = `<tr><td colspan="7" class="error-row">Failed to load students: ${error.message || 'Unknown error'}</td></tr>`;
                if (typeof showToast === 'function') {
                    showToast('error', 'Failed to load students: ' + (error.message || 'Unknown error'));
                }
            }
        }
        
        // Filter marks table by search
        function filterMarksTable() {
            const searchTerm = document.getElementById('marks-entry-search').value.toLowerCase().trim();
            const tbody = document.getElementById('marks-entry-tbody');
            
            if (!searchTerm) {
                filteredMarksData = marksData;
            } else {
                filteredMarksData = marksData.filter(student => 
                    student.admission_number.toLowerCase().includes(searchTerm) ||
                    student.student_name.toLowerCase().includes(searchTerm)
                );
            }
            
            renderMarksTable(filteredMarksData);
            updateStats(filteredMarksData);
        }
        
        // Render marks entry table with editable fields
        function renderMarksTable(students) {
            // Target the modal table body (the visible one)
            const tbody = document.getElementById('marks-entry-tbody-modal');
            if (!tbody) {
                console.error('Marks entry table body not found in modal');
                return;
            }
            
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No students found</td></tr>';
                return;
            }
            
            tbody.innerHTML = students.map((student, index) => {
                const retakeClass = student.retake ? 'retake-row' : '';
                const statusBadge = student.status === 'submitted' 
                    ? '<span class="badge badge-success">Submitted</span>'
                    : student.cat_marks !== null || student.exam_marks !== null
                    ? '<span class="badge badge-warning">Draft</span>'
                    : '<span class="badge badge-secondary">Pending</span>';
                
                const isReadOnly = student.status === 'submitted' && !student.can_edit;
                const readOnlyAttr = isReadOnly ? 'readonly' : '';
                const readOnlyStyle = isReadOnly ? 'background: #f3f4f6; cursor: not-allowed;' : '';
                
                return `
                    <tr class="${retakeClass}" data-enrollment-id="${student.enrollment_id}" data-index="${index}">
                        <td><strong>${student.admission_number}</strong></td>
                        <td>${student.student_name}</td>
                        <td>
                            <input type="number" 
                                   class="marks-input cat-marks" 
                                   data-enrollment-id="${student.enrollment_id}"
                                   value="${student.cat_marks !== null ? student.cat_marks : ''}" 
                                   min="0" 
                                   max="${maxCatMarks}" 
                                   step="0.1"
                                   ${readOnlyAttr}
                                   onchange="updateTotalMarks(${student.enrollment_id})"
                                   oninput="autoSaveMarks(${student.enrollment_id}, 'cat', this.value)"
                                   onblur="autoSaveMarks(${student.enrollment_id}, 'cat', this.value)"
                                   style="width: 100px; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; ${readOnlyStyle}">
                        </td>
                        <td>
                            <input type="number" 
                                   class="marks-input exam-marks" 
                                   data-enrollment-id="${student.enrollment_id}"
                                   value="${student.exam_marks !== null ? student.exam_marks : ''}" 
                                   min="0" 
                                   max="${maxExamMarks}" 
                                   step="0.1"
                                   ${readOnlyAttr}
                                   onchange="updateTotalMarks(${student.enrollment_id})"
                                   oninput="autoSaveMarks(${student.enrollment_id}, 'exam', this.value)"
                                   onblur="autoSaveMarks(${student.enrollment_id}, 'exam', this.value)"
                                   style="width: 100px; padding: 6px; border: 1px solid var(--border-color); border-radius: 4px; ${readOnlyStyle}">
                        </td>
                        <td class="total-cell" data-enrollment-id="${student.enrollment_id}">
                            ${student.total !== null ? student.total.toFixed(1) : '-'}
                        </td>
                        <td>
                            <span class="badge badge-grade-${student.grade || 'N/A'}">${student.grade || 'N/A'}</span>
                        </td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Update total marks calculation
        function updateTotalMarks(enrollmentId) {
            const row = document.querySelector(`tr[data-enrollment-id="${enrollmentId}"]`);
            if (!row) return;
            
            const catInput = row.querySelector('.cat-marks');
            const examInput = row.querySelector('.exam-marks');
            const totalCell = row.querySelector('.total-cell');
            const gradeBadge = row.querySelector('.badge');
            
            if (!catInput || !examInput || !totalCell) return;
            
            const catMarks = parseFloat(catInput.value) || 0;
            const examMarks = parseFloat(examInput.value) || 0;
            const total = catMarks + examMarks;
            
            totalCell.textContent = total > 0 ? total.toFixed(1) : '-';
            
            // Update grade
            if (gradeBadge && total > 0) {
                let grade = 'N/A';
                if (total >= 70) grade = 'A';
                else if (total >= 60) grade = 'B';
                else if (total >= 50) grade = 'C';
                else if (total >= 40) grade = 'D';
                else if (total > 0) grade = 'F';
                
                gradeBadge.className = `badge badge-grade-${grade}`;
                gradeBadge.textContent = grade;
            }
        }
        
        // Auto-save marks
        let saveTimeout = null;
        async function autoSaveMarks(enrollmentId, markType, value) {
            // Clear previous timeout
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            
            // Debounce save
            saveTimeout = setTimeout(async () => {
                try {
                    const formData = {
                        enrollment_id: enrollmentId,
                        [markType === 'cat' ? 'cat_marks' : 'exam_marks']: value ? parseFloat(value) : null
                    };
                    
                    const response = await fetch(`/api/${window.COLLEGE_SLUG}/results/bulk-save/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': window.csrftoken || ''
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify(formData)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || 'Failed to save marks');
                    }
                    
                    const data = await response.json();
                    
                    // Update total and grade in the table
                    const row = document.querySelector(`tr[data-enrollment-id="${enrollmentId}"]`);
                    if (row) {
                        const totalCell = row.querySelector('.total-cell');
                        const gradeBadge = row.querySelector('.badge');
                        
                        if (totalCell && data.result.total !== null) {
                            totalCell.textContent = data.result.total.toFixed(1);
                        }
                        if (gradeBadge && data.result.grade) {
                            gradeBadge.className = `badge badge-grade-${data.result.grade}`;
                            gradeBadge.textContent = data.result.grade;
                        }
                        
                        // Update status badge
                        const statusCell = row.querySelector('td:last-child');
                        if (statusCell && data.result.status) {
                            const statusBadge = data.result.status === 'submitted' 
                                ? '<span class="badge badge-success">Submitted</span>'
                                : '<span class="badge badge-warning">Draft</span>';
                            statusCell.innerHTML = statusBadge;
                        }
                        
                        // Update retake status
                        if (data.result.retake) {
                            row.classList.add('retake-row');
                        } else {
                            row.classList.remove('retake-row');
                        }
                    }
                    
                    // Update marksData
                    const studentIndex = marksData.findIndex(s => s.enrollment_id === enrollmentId);
                    if (studentIndex !== -1) {
                        marksData[studentIndex].cat_marks = data.result.cat_marks;
                        marksData[studentIndex].exam_marks = data.result.exam_marks;
                        marksData[studentIndex].total = data.result.total;
                        marksData[studentIndex].grade = data.result.grade;
                        marksData[studentIndex].status = data.result.status;
                        marksData[studentIndex].retake = data.result.retake;
                    }
                    
                    // Update filtered data if it exists
                    const filteredIndex = filteredMarksData.findIndex(s => s.enrollment_id === enrollmentId);
                    if (filteredIndex !== -1) {
                        filteredMarksData[filteredIndex] = {...marksData[studentIndex]};
                    }
                    
                    updateStats(filteredMarksData.length > 0 ? filteredMarksData : marksData);
                    
                    // Show subtle save indicator
                    showSaveIndicator(row);
                } catch (error) {
                    console.error('Error auto-saving marks:', error);
                    // Don't show error toast on every failed save to avoid spam
                    // Only log to console for debugging
                }
            }, 800); // 800ms debounce - saves to draft as user types
        }
        
        // Show save indicator
        function showSaveIndicator(row) {
            if (!row) return;
            const originalBg = row.style.backgroundColor;
            row.style.backgroundColor = '#d1fae5';
            setTimeout(() => {
                row.style.backgroundColor = originalBg;
            }, 300);
        }
        
        // Update statistics
        function updateStats(students) {
            const total = students.length;
            const marked = students.filter(s => s.cat_marks !== null || s.exam_marks !== null).length;
            const noMarks = total - marked;
            const submitted = students.filter(s => s.status === 'submitted').length;
            
            const totalEl = document.getElementById('stats-total');
            const markedEl = document.getElementById('stats-marked');
            const noMarksEl = document.getElementById('stats-no-marks');
            const submittedEl = document.getElementById('stats-submitted');
            
            if (totalEl) totalEl.textContent = total;
            if (markedEl) markedEl.textContent = marked;
            if (noMarksEl) noMarksEl.textContent = noMarks;
            if (submittedEl) submittedEl.textContent = submitted;
            
            // Show/hide submit button
            const submitBtn = document.getElementById('submit-all-marks-btn');
            if (submitBtn) {
                submitBtn.style.display = (marked === total && total > 0 && submitted < total) ? 'inline-block' : 'none';
            }
        }
        
        // Save all marks to draft
        async function saveAllDraftMarks() {
            const rows = document.querySelectorAll('#marks-entry-tbody tr[data-enrollment-id]');
            const savePromises = [];
            
            for (const row of rows) {
                const enrollmentId = parseInt(row.dataset.enrollmentId);
                const catInput = row.querySelector('.cat-marks');
                const examInput = row.querySelector('.exam-marks');
                
                const catMarks = catInput && catInput.value ? parseFloat(catInput.value) : null;
                const examMarks = examInput && examInput.value ? parseFloat(examInput.value) : null;
                
                // Only save if at least one mark is entered
                if (catMarks !== null || examMarks !== null) {
                    const formData = {
                        enrollment_id: enrollmentId,
                        cat_marks: catMarks,
                        exam_marks: examMarks
                    };
                    
                    savePromises.push(
                        fetch(`/api/${window.COLLEGE_SLUG}/results/bulk-save/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': window.csrftoken || ''
                            },
                            body: JSON.stringify(formData),
                            credentials: 'same-origin'
                        })
                    );
                }
            }
            
            if (savePromises.length === 0) {
                showToast('warning', 'No marks to save');
                return;
            }
            
            try {
                showToast('info', 'Saving all marks to draft...');
                await Promise.all(savePromises);
                
                // Reload data
                await loadUnitStudentsMarks(currentUnitId, currentAcademicYear, currentSemester);
                showToast('success', 'All marks saved to draft successfully');
            } catch (error) {
                console.error('Error saving all marks:', error);
                showToast('error', 'Failed to save some marks. Please try again.');
            }
        }
        
        // Submit all marks for a unit (from unit card)
        async function submitAllMarksForUnit(unitId, unitCode, unitName) {
            if (!confirm(`Are you sure you want to submit all results for ${unitCode} - ${unitName}? This action cannot be undone.`)) {
                return;
            }
            
            try {
                // Get current academic year and semester if available from various sources
                let academicYear = window.currentAcademicYear || null;
                let semester = window.currentSemester || null;
                
                // Try to get from DOM elements if not in window
                if (!academicYear) {
                    const academicYearSelect = document.getElementById('academic-year-filter') || 
                                               document.getElementById('results-academic-year') ||
                                               document.querySelector('select[name="academic_year"]');
                    if (academicYearSelect && academicYearSelect.value) {
                        academicYear = academicYearSelect.value;
                    }
                }
                
                if (!semester) {
                    const semesterSelect = document.getElementById('semester-filter') || 
                                          document.getElementById('results-semester') ||
                                          document.querySelector('select[name="semester"]');
                    if (semesterSelect && semesterSelect.value) {
                        semester = semesterSelect.value;
                    }
                }
                
                const formData = {};
                if (academicYear) {
                    formData.academic_year = academicYear;
                }
                if (semester) {
                    formData.semester = semester;
                }
                
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/units/${unitId}/bulk-submit/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken || ''
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to submit results');
                }
                
                const data = await response.json();
                showToast('success', data.message || 'All results submitted successfully');
                
                // Reload units - check which view is active
                const myUnitsTab = document.getElementById('my-units-tab');
                const resultsTab = document.getElementById('results-tab');
                
                if (myUnitsTab && myUnitsTab.classList.contains('active')) {
                    // Refresh My Units grid if we're in My Units tab
                    if (window.loadMyUnitsResults) {
                        await window.loadMyUnitsResults();
                    }
                } else if (resultsTab && resultsTab.classList.contains('active')) {
                    // Refresh Results units grid if we're in Results tab
                    if (window.loadResultsUnits) {
                        await window.loadResultsUnits();
                    }
                } else {
                    // Otherwise refresh lecturer units (marks entry view)
                    if (typeof loadLecturerUnits === 'function') {
                        loadLecturerUnits();
                    }
                }
                
                // Close marks entry modal if open
                const marksEntryModal = document.getElementById('marks-entry-modal');
                if (marksEntryModal) {
                    marksEntryModal.classList.remove('active');
                }
            } catch (error) {
                console.error('Error submitting results:', error);
                showToast('error', 'Failed to submit results. Please try again.');
            }
        }
        
        // Submit all marks for the unit
        async function submitAllMarks() {
            if (!currentUnitId) {
                showToast('error', 'No unit selected');
                return;
            }
            
            if (!confirm('Are you sure you want to submit all marks for this unit? This action cannot be undone.')) {
                return;
            }
            
            const submitBtn = document.getElementById('submit-all-marks-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            
            try {
                const formData = {
                    academic_year: currentAcademicYear,
                    semester: currentSemester
                };
                
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/units/${currentUnitId}/bulk-submit/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken || ''
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to submit marks');
                }
                
                const data = await response.json();
                showToast('success', data.message || 'Marks submitted successfully');
                
                // Reload the marks table
                await loadUnitStudentsMarks(currentUnitId, currentAcademicYear, currentSemester);
                
            } catch (error) {
                console.error('Error submitting marks:', error);
                showToast('error', error.message || 'Failed to submit marks');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }
        
        // Load result filters when Results section is activated
        async function loadResultFilters() {
            // Set flag to prevent triggering filterResults while populating
            isPopulatingFilters = true;
            
            // Load units (filtered by lecturer if applicable)
            try {
                let unitsData = null;
                
                // Debug: Check user role
                console.log('Loading result filters. USER_ROLE:', window.USER_ROLE, 'Type:', typeof window.USER_ROLE);
                console.log('IS_COLLEGE_ADMIN:', window.IS_COLLEGE_ADMIN);
                
                // For lecturers, use my-units endpoint; for admins, use regular units endpoint
                // Strictly check if user is a lecturer (not a college admin)
                const isLecturer = window.USER_ROLE === 'lecturer' && !window.IS_COLLEGE_ADMIN;
                
                console.log('Is Lecturer?', isLecturer);
                
                if (isLecturer) {
                    console.log('Lecturer detected, fetching my-units...');
                    const response = await fetch(`/api/${window.COLLEGE_SLUG}/units/my-units/`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': window.csrftoken || ''
                        },
                        credentials: 'same-origin'
                    });
                    if (response.ok) {
                        unitsData = await response.json();
                        console.log('Lecturer units fetched:', unitsData.results?.length || 0, 'units');
                        if (unitsData.results && unitsData.results.length > 0) {
                            console.log('Sample unit:', unitsData.results[0]);
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('Failed to fetch lecturer units:', response.status, response.statusText, errorData);
                        // Don't fall back to all units - show empty or error
                        unitsData = { results: [] };
                    }
                } else if (window.IS_COLLEGE_ADMIN || window.USER_ROLE === 'college_admin') {
                    console.log('College admin detected, fetching all units...');
                    // For college admins, fetch all units
                    const params = new URLSearchParams({
                        page: 1,
                        page_size: 1000
                    });
                    const response = await fetch(`/api/${window.COLLEGE_SLUG}/units/?${params.toString()}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': window.csrftoken || ''
                        },
                        credentials: 'same-origin'
                    });
                    if (response.ok) {
                        unitsData = await response.json();
                        console.log('All units fetched:', unitsData.results?.length || 0, 'units');
                    } else {
                        console.error('Failed to fetch units:', response.status, response.statusText);
                    }
                } else {
                    // Unknown role or lecturer check failed - try my-units as fallback
                    console.warn('Unknown role or lecturer check failed. Attempting to fetch my-units as fallback...');
                    try {
                        const response = await fetch(`/api/${window.COLLEGE_SLUG}/units/my-units/`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': window.csrftoken || ''
                            },
                            credentials: 'same-origin'
                        });
                        if (response.ok) {
                            unitsData = await response.json();
                            console.log('Fallback: Lecturer units fetched:', unitsData.results?.length || 0, 'units');
                        } else {
                            console.error('Fallback: Failed to fetch lecturer units:', response.status, response.statusText);
                            unitsData = { results: [] };
                        }
                    } catch (error) {
                        console.error('Fallback: Error fetching lecturer units:', error);
                        unitsData = { results: [] };
                    }
                }
                
                const unitSelect = document.getElementById('result-unit-filter');
                if (unitSelect && unitsData) {
                    const currentValue = unitSelect.value;
                    unitSelect.innerHTML = '<option value="">All Units</option>';
                    
                    // Handle response format: my-units returns {count, results}, regular units returns {count, results, page, etc.}
                    const units = unitsData.results || [];
                    
                    console.log('Populating unit dropdown with', units.length, 'units');
                    
                    if (units.length > 0) {
                        units.forEach(unit => {
                            const option = document.createElement('option');
                            option.value = unit.id;
                            option.textContent = `${unit.code} - ${unit.name}`;
                            unitSelect.appendChild(option);
                        });
                    } else {
                        console.warn('No units found for result filters');
                    }
                    
                    if (currentValue) {
                        unitSelect.value = currentValue;
                    }
                } else if (unitSelect && !unitsData) {
                    console.error('No units data received');
                }
            } catch (error) {
                console.error('Error loading units for result filters:', error);
            }
            
            // Populate academic year dropdown
            await populateResultYearDropdown();
            
            // Populate semester dropdown
            await populateSemesterDropdown('result-semester-filter', true);
            
            // Reset flag after a short delay to allow all values to be set
            setTimeout(() => {
                isPopulatingFilters = false;
            }, 200);
        }
        
        // Flag to prevent recursive calls when populating dropdowns
        let isPopulatingFilters = false;
        
        async function populateResultYearDropdown() {
            const yearSelect = document.getElementById('result-year-filter');
            if (!yearSelect) return;
            
            const currentValue = yearSelect.value;
            
            try {
                // Fetch distinct academic years from database
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/results/academic-years/`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                const data = await response.json();
                
                yearSelect.innerHTML = '<option value="">All Years</option>';
                
                if (data.academic_years && data.academic_years.length > 0) {
                    data.academic_years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        yearSelect.appendChild(option);
                    });
                    
                    // Set most recent year as default if no value selected
                    if (!currentValue && data.academic_years.length > 0) {
                        yearSelect.value = data.academic_years[0]; // Most recent year (already sorted DESC)
                    } else if (currentValue) {
                        yearSelect.value = currentValue;
                    }
                } else {
                    // Fallback: if no data, try to get current_academic_year from settings
                    try {
                        const settingsResponse = await fetch(`/api/${window.COLLEGE_SLUG}/admin/academic-settings/`, {
                            headers: { 'X-CSRFToken': window.csrftoken }
                        });
                        const settingsData = await settingsResponse.json();
                        if (settingsData.current_academic_year) {
                            const option = document.createElement('option');
                            option.value = settingsData.current_academic_year;
                            option.textContent = settingsData.current_academic_year;
                            yearSelect.appendChild(option);
                            if (!currentValue) {
                                yearSelect.value = settingsData.current_academic_year;
                            }
                        }
                    } catch (error) {
                        console.error('Error loading academic settings:', error);
                    }
                }
            } catch (error) {
                console.error('Error loading academic years for results:', error);
                yearSelect.innerHTML = '<option value="">All Years</option>';
            }
        }

        let collegeInfoOriginalData = null;

        function toggleCollegeEditMode() {
            const displayDiv = document.getElementById('college-info-display');
            const formDiv = document.getElementById('college-info-form');
            const editBtn = document.getElementById('edit-college-btn');
            const saveBtn = document.getElementById('save-college-btn');
            const cancelBtn = document.getElementById('cancel-college-btn');
            
            if (displayDiv.style.display === 'none') {
                // Switch to display mode
                displayDiv.style.display = 'block';
                formDiv.style.display = 'none';
                editBtn.style.display = 'inline-flex';
                saveBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
            } else {
                // Switch to edit mode
                // Save original data
                collegeInfoOriginalData = {
                    name: document.getElementById('edit-college-name').value,
                    address: document.getElementById('edit-college-address').value,
                    county: document.getElementById('edit-college-county').value,
                    email: document.getElementById('edit-college-email').value,
                    phone: document.getElementById('edit-college-phone').value,
                    principal_name: document.getElementById('edit-college-principal').value
                };
                
                displayDiv.style.display = 'none';
                formDiv.style.display = 'block';
                editBtn.style.display = 'none';
                saveBtn.style.display = 'inline-flex';
                cancelBtn.style.display = 'inline-flex';
                
                // Clear any previous errors
                clearCollegeFormErrors();
            }
        }

        function cancelCollegeEdit() {
            if (collegeInfoOriginalData) {
                // Restore original values
                document.getElementById('edit-college-name').value = collegeInfoOriginalData.name;
                document.getElementById('edit-college-address').value = collegeInfoOriginalData.address;
                document.getElementById('edit-college-county').value = collegeInfoOriginalData.county;
                document.getElementById('edit-college-email').value = collegeInfoOriginalData.email;
                document.getElementById('edit-college-phone').value = collegeInfoOriginalData.phone;
                document.getElementById('edit-college-principal').value = collegeInfoOriginalData.principal_name;
            }
            toggleCollegeEditMode();
        }

        function clearCollegeFormErrors() {
            const errorElements = document.querySelectorAll('[id^="error-college-"]');
            errorElements.forEach(el => {
                el.textContent = '';
                el.style.display = 'none';
            });
        }

        async function saveCollegeInfo(e) {
            if (e) {
                e.preventDefault();
            }
            
            if (!window.COLLEGE_SLUG) {
                showToast('error', 'College slug not found');
                return;
            }
            
            clearCollegeFormErrors();
            
            const data = {
                name: document.getElementById('edit-college-name').value.trim(),
                address: document.getElementById('edit-college-address').value.trim(),
                county: document.getElementById('edit-college-county').value.trim(),
                email: document.getElementById('edit-college-email').value.trim(),
                phone: document.getElementById('edit-college-phone').value.trim(),
                principal_name: document.getElementById('edit-college-principal').value.trim()
            };
            
            // Basic validation
            if (!data.name || !data.address || !data.county || !data.email || !data.phone || !data.principal_name) {
                showToast('error', 'All fields are required');
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(data.email)) {
                document.getElementById('error-college-email').textContent = 'Please enter a valid email address';
                document.getElementById('error-college-email').style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/college-info/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // Update display values
                    document.getElementById('display-college-name').textContent = result.name;
                    document.getElementById('display-college-address').textContent = result.address;
                    document.getElementById('display-college-county').textContent = result.county;
                    document.getElementById('display-college-email').textContent = result.email;
                    document.getElementById('display-college-phone').textContent = result.phone;
                    document.getElementById('display-college-principal').textContent = result.principal_name;
                    
                    showToast('success', result.message || 'College information updated successfully');
                    toggleCollegeEditMode();
                } else {
                    // Handle validation errors
                    if (result.error) {
                        showToast('error', result.error);
                        
                        // Try to show field-specific errors
                        if (result.error.includes('Email')) {
                            document.getElementById('error-college-email').textContent = result.error;
                            document.getElementById('error-college-email').style.display = 'block';
                        }
                    } else {
                        showToast('error', 'Failed to update college information');
                    }
                }
            } catch (error) {
                console.error('Error updating college info:', error);
                showToast('error', 'An error occurred while updating college information');
            }
        }

        // Cache for semesters_per_year to avoid repeated API calls
        let cachedSemestersPerYear = null;

        // Get semesters per year from settings
        async function getSemestersPerYear() {
            if (cachedSemestersPerYear) {
                return cachedSemestersPerYear;
            }
            
            if (!window.COLLEGE_SLUG) return 2;
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/academic-settings/`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error fetching academic settings:', data.error);
                    return 2; // Default fallback
                }
                
                cachedSemestersPerYear = data.semesters_per_year || 2;
                return cachedSemestersPerYear;
            } catch (error) {
                console.error('Error fetching semesters per year:', error);
                return 2; // Default fallback
            }
        }

        // Helper function to populate a single semester dropdown
        async function populateSemesterDropdown(selectId, includeAll = false, selectedValue = null) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const maxSemesters = await getSemestersPerYear();
            const currentValue = selectedValue !== null ? selectedValue : select.value;
            
            // Determine the first option text based on context
            const firstOptionText = includeAll ? 'All Semesters' : 
                                   (select.hasAttribute('required') && !includeAll ? 'Select Semester' : 'Select Semester');
            
            select.innerHTML = `<option value="">${firstOptionText}</option>`;
            
            for (let i = 1; i <= maxSemesters; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Semester ${i}`;
                select.appendChild(option);
            }
            
            if (currentValue) {
                select.value = currentValue;
            }
        }

        // Populate all semester dropdowns on the page
        async function populateAllSemesterDropdowns() {
            // Clear cache to get fresh data
            cachedSemestersPerYear = null;
            
            // List of all semester dropdown IDs and whether they should include "All" option
            const semesterDropdowns = [
                { id: 'units-semester-filter', includeAll: true },
                { id: 'enrollment-semester-filter', includeAll: true },
                { id: 'result-semester-filter', includeAll: true },
                { id: 'unit-semester', includeAll: false },
                { id: 'courseunit-semester', includeAll: false },
                { id: 'enrollment-semester', includeAll: false },
                { id: 'timetable-semester', includeAll: false },
                { id: 'academic-semester', includeAll: false },
                { id: 'current-semester', includeAll: false }
            ];
            
            // Populate all dropdowns
            for (const dropdown of semesterDropdowns) {
                await populateSemesterDropdown(dropdown.id, dropdown.includeAll);
            }
        }

        // Academic Settings Functions
        async function loadAcademicSettings() {
            if (!window.COLLEGE_SLUG) return;
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/academic-settings/`, {
                    headers: {
                        'X-CSRFToken': window.csrftoken
                    }
                });
                
                // Handle 403 silently (unauthorized access - lecturers don't have access)
                if (response.status === 403) {
                    return;
                }
                
                const data = await response.json();
                
                if (data.error) {
                    return; // Silently handle errors
                }
                
                // Update form fields with null checks
                const semestersPerYearInput = document.getElementById('semesters-per-year');
                const academicYearInput = document.getElementById('academic-year');
                
                if (semestersPerYearInput) {
                    semestersPerYearInput.value = data.semesters_per_year || 2;
                }
                if (academicYearInput) {
                    academicYearInput.value = data.current_academic_year || '';
                }
                
                // Update semester dropdown
                updateSemesterDropdown('academic-semester', data.semesters_per_year || 2, data.current_semester);
            } catch (error) {
                // Silently handle errors
            }
        }

        function updateSemesterDropdown(selectId, maxSemesters, selectedValue = null) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const currentValue = selectedValue || select.value;
            select.innerHTML = '<option value="">Select Semester</option>';
            
            for (let i = 1; i <= maxSemesters; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Semester ${i}`;
                select.appendChild(option);
            }
            
            if (currentValue) {
                select.value = currentValue;
            }
        }

        document.getElementById('semesters-per-year')?.addEventListener('change', function() {
            const maxSemesters = parseInt(this.value) || 2;
            updateSemesterDropdown('academic-semester', maxSemesters);
        });

        async function handleAcademicSettingsSubmit(e) {
            e.preventDefault();
            if (!window.COLLEGE_SLUG) return;
            
            const semestersPerYear = parseInt(document.getElementById('semesters-per-year').value);
            const academicYear = document.getElementById('academic-year').value.trim();
            const semester = document.getElementById('academic-semester').value;
            
            // Validation
            if (!semestersPerYear || semestersPerYear < 1 || semestersPerYear > 12) {
                showToast('error', 'Semesters per year must be between 1 and 12');
                return;
            }
            
            if (academicYear && !/^\d{4}\/\d{4}$/.test(academicYear)) {
                showToast('error', 'Academic year must be in format YYYY/YYYY (e.g., 2024/2025)');
                return;
            }
            
            if (semester && (parseInt(semester) < 1 || parseInt(semester) > semestersPerYear)) {
                showToast('error', `Semester must be between 1 and ${semestersPerYear}`);
                return;
            }
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/academic-settings/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken
                    },
                    body: JSON.stringify({
                        semesters_per_year: semestersPerYear,
                        current_academic_year: academicYear || null,
                        current_semester: semester ? parseInt(semester) : null
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showToast('error', data.error);
                    return;
                }
                
                showToast('success', 'Academic settings saved successfully');
                // Clear cache and refresh all semester dropdowns across the application
                cachedSemestersPerYear = null;
                await populateAllSemesterDropdowns();
                await loadAcademicSettings();
            } catch (error) {
                console.error('Error saving academic settings:', error);
                showToast('error', 'Error saving academic settings');
            }
        }

        // Grading System Functions
        async function loadGradingSystem() {
            if (!window.COLLEGE_SLUG) return;
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/grading-system/`, {
                    headers: {
                        'X-CSRFToken': window.csrftoken
                    }
                });
                
                // Handle 403 silently (unauthorized access)
                if (response.status === 403) {
                    return;
                }
                
                const data = await response.json();
                
                if (data.error) {
                    showToast('error', data.error);
                    return;
                }
                
                const criteria = data.grading_criteria;
                
                // Update form fields with null checks
                const catWeightInput = document.getElementById('cat-weight');
                const examWeightInput = document.getElementById('exam-weight');
                const passMarkInput = document.getElementById('pass-mark');
                
                if (catWeightInput) catWeightInput.value = criteria.cat_weight || 30;
                if (examWeightInput) examWeightInput.value = criteria.exam_weight || 70;
                if (passMarkInput) passMarkInput.value = criteria.pass_mark || 50;
                
                // Render grade thresholds
                renderGradeThresholds(criteria.grades || {});
            } catch (error) {
                // Silently handle errors
            }
        }

        function renderGradeThresholds(grades) {
            const container = document.getElementById('grade-thresholds-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Default grades if none provided
            if (!grades || Object.keys(grades).length === 0) {
                grades = {
                    'A': {min: 70, max: 100},
                    'B': {min: 60, max: 69},
                    'C': {min: 50, max: 59},
                    'D': {min: 40, max: 49},
                    'F': {min: 0, max: 39}
                };
            }
            
            // Sort grades by min value descending
            const sortedGrades = Object.entries(grades).sort((a, b) => b[1].min - a[1].min);
            
            sortedGrades.forEach(([gradeName, range]) => {
                const gradeDiv = document.createElement('div');
                gradeDiv.style.cssText = 'display: grid; grid-template-columns: 60px 1fr 1fr; gap: 12px; align-items: end;';
                gradeDiv.innerHTML = `
                    <label style="font-weight: 600; padding: 8px 0;">${gradeName}:</label>
                    <div>
                        <input type="number" class="form-input grade-min" data-grade="${gradeName}" 
                               min="0" max="100" step="0.1" value="${range.min}" 
                               placeholder="Min" style="width: 100%;">
                    </div>
                    <div>
                        <input type="number" class="form-input grade-max" data-grade="${gradeName}" 
                               min="0" max="100" step="0.1" value="${range.max}" 
                               placeholder="Max" style="width: 100%;">
                    </div>
                `;
                container.appendChild(gradeDiv);
            });
        }

        async function handleGradingSystemSubmit(e) {
            e.preventDefault();
            if (!window.COLLEGE_SLUG) return;
            
            const catWeight = parseFloat(document.getElementById('cat-weight').value);
            const examWeight = parseFloat(document.getElementById('exam-weight').value);
            const passMark = parseFloat(document.getElementById('pass-mark').value);
            
            // Collect grade thresholds
            const grades = {};
            const minInputs = document.querySelectorAll('.grade-min');
            const maxInputs = document.querySelectorAll('.grade-max');
            
            minInputs.forEach(minInput => {
                const gradeName = minInput.dataset.grade;
                const maxInput = document.querySelector(`.grade-max[data-grade="${gradeName}"]`);
                
                if (gradeName && minInput.value && maxInput.value) {
                    grades[gradeName] = {
                        min: parseFloat(minInput.value),
                        max: parseFloat(maxInput.value)
                    };
                }
            });
            
            // Validation
            if (isNaN(catWeight) || isNaN(examWeight) || isNaN(passMark)) {
                showToast('error', 'All fields must be valid numbers');
                return;
            }
            
            const totalWeight = catWeight + examWeight;
            if (Math.abs(totalWeight - 100) > 0.01) {
                showToast('error', `CAT and Exam weights must sum to 100% (current: ${totalWeight.toFixed(1)}%)`);
                return;
            }
            
            if (passMark < 0 || passMark > 100) {
                showToast('error', 'Pass mark must be between 0 and 100');
                return;
            }
            
            if (Object.keys(grades).length === 0) {
                showToast('error', 'At least one grade threshold must be defined');
                return;
            }
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/grading-system/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken
                    },
                    body: JSON.stringify({
                        cat_weight: catWeight,
                        exam_weight: examWeight,
                        pass_mark: passMark,
                        grades: grades
                    })
                });
                
                // Handle 403 silently (unauthorized access)
                if (response.status === 403) {
                    return;
                }
                
                const data = await response.json();
                
                if (data.error) {
                    showToast('error', data.error);
                    return;
                }
                
                showToast('success', 'Grading system saved successfully');
                await loadGradingSystem();
            } catch (error) {
                console.error('Error saving grading system:', error);
                showToast('error', 'Error saving grading system');
            }
        }

        // Nominal Roll Sign-In Settings Functions
        async function loadNominalRollSettings() {
            if (!window.COLLEGE_SLUG) return;
            
            try {
                // Load all settings data in a single combined API call
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/nominal-roll/settings/?include_stats=true`, {
                    headers: {
                        'X-CSRFToken': window.csrftoken
                    }
                });
                
                // Handle 403 silently (unauthorized access - lecturers don't have access)
                if (response.status === 403) {
                    return;
                }
                
                const data = await response.json();
                
                if (data.error) {
                    return; // Silently handle errors
                }
                
                // Update form fields with null checks
                const enabledCheckbox = document.getElementById('nominal-roll-enabled');
                if (enabledCheckbox) {
                    enabledCheckbox.checked = data.nominal_roll_signin_enabled;
                }
                
                // Update semester dropdown and academic year from combined academic settings
                if (data.academic_settings) {
                    updateSemesterDropdown('current-semester', data.academic_settings.semesters_per_year || 2, data.current_semester);
                    const academicYearInput = document.getElementById('current-academic-year');
                    if (academicYearInput) {
                        academicYearInput.value = data.academic_settings.current_academic_year || '';
                    }
                }
                
                toggleNominalRollFields();
                
                // Update stats if included in response
                if (data.stats) {
                    const totalStudentsEl = document.getElementById('stat-total-students');
                    const signedInEl = document.getElementById('stat-signed-in');
                    const notSignedInEl = document.getElementById('stat-not-signed-in');
                    const percentageEl = document.getElementById('stat-percentage');
                    const statsContainer = document.getElementById('nominal-roll-stats');
                    
                    if (totalStudentsEl) totalStudentsEl.textContent = data.stats.total_students || 0;
                    if (signedInEl) signedInEl.textContent = data.stats.signed_in_count || 0;
                    if (notSignedInEl) notSignedInEl.textContent = data.stats.not_signed_in_count || 0;
                    if (percentageEl) percentageEl.textContent = (data.stats.signin_percentage || 0) + '%';
                    if (statsContainer) statsContainer.style.display = 'block';
                }
            } catch (error) {
                // Silently handle errors
            }
        }

        function toggleNominalRollFields() {
            const enabled = document.getElementById('nominal-roll-enabled').checked;
            const fields = document.getElementById('nominal-roll-fields');
            const stats = document.getElementById('nominal-roll-stats');
            
            if (enabled) {
                fields.style.display = 'block';
                loadNominalRollStats();
            } else {
                fields.style.display = 'none';
                stats.style.display = 'none';
            }
        }

        // Report Template Mapping Functions
        async function loadReportTemplateMapping() {
            if (!window.COLLEGE_SLUG) return;
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/report-template-mapping/`, {
                    headers: {
                        'X-CSRFToken': window.csrftoken
                    }
                });
                
                if (response.status === 403) {
                    return;
                }
                
                const data = await response.json();
                
                if (data.error) {
                    showToast('error', data.error);
                    return;
                }
                
                // Populate template dropdowns
                const transcriptSelect = document.getElementById('transcript-template-select');
                const feeStructureSelect = document.getElementById('fee-structure-template-select');
                const examCardSelect = document.getElementById('exam-card-template-select');
                
                // Clear and populate all dropdowns
                [transcriptSelect, feeStructureSelect, examCardSelect].forEach(select => {
                    if (select) {
                        select.innerHTML = '<option value="">-- Select Template --</option>';
                        data.templates.forEach(template => {
                            const option = document.createElement('option');
                            option.value = template.id;
                            option.textContent = template.name;
                            select.appendChild(option);
                        });
                    }
                });
                
                // Set selected values
                if (transcriptSelect && data.mapping.transcript_template_id) {
                    transcriptSelect.value = data.mapping.transcript_template_id;
                }
                if (feeStructureSelect && data.mapping.fee_structure_template_id) {
                    feeStructureSelect.value = data.mapping.fee_structure_template_id;
                }
                if (examCardSelect && data.mapping.exam_card_template_id) {
                    examCardSelect.value = data.mapping.exam_card_template_id;
                }
            } catch (error) {
                console.error('Error loading report template mapping:', error);
                showToast('error', 'Failed to load report template mappings');
            }
        }
        
        async function handleReportTemplateMappingSubmit(e) {
            e.preventDefault();
            if (!window.COLLEGE_SLUG) return;
            
            const transcriptTemplateId = document.getElementById('transcript-template-select').value;
            const feeStructureTemplateId = document.getElementById('fee-structure-template-select').value;
            const examCardTemplateId = document.getElementById('exam-card-template-select').value;
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/report-template-mapping/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken
                    },
                    body: JSON.stringify({
                        transcript_template_id: transcriptTemplateId || null,
                        fee_structure_template_id: feeStructureTemplateId || null,
                        exam_card_template_id: examCardTemplateId || null
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showToast('error', data.error);
                    return;
                }
                
                if (data.success) {
                    showToast('success', data.message || 'Report template mappings saved successfully');
                }
            } catch (error) {
                console.error('Error saving report template mapping:', error);
                showToast('error', 'Failed to save report template mappings');
            }
        }

        async function handleNominalRollSettingsSubmit(e) {
            e.preventDefault();
            if (!window.COLLEGE_SLUG) return;
            
            const enabled = document.getElementById('nominal-roll-enabled').checked;
            const academicYear = document.getElementById('current-academic-year').value.trim();
            const semester = document.getElementById('current-semester').value;
            
            // Validation
            if (enabled) {
                if (!academicYear) {
                    showToast('error', 'Academic year is required');
                    return;
                }
                if (!/^\d{4}\/\d{4}$/.test(academicYear)) {
                    showToast('error', 'Academic year must be in format YYYY/YYYY (e.g., 2024/2025)');
                    return;
                }
                if (!semester) {
                    showToast('error', 'Current semester is required');
                    return;
                }
            }
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/nominal-roll/settings/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken
                    },
                    body: JSON.stringify({
                        nominal_roll_signin_enabled: enabled,
                        current_academic_year: enabled ? academicYear : '',
                        current_semester: enabled ? parseInt(semester) : null
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showToast('error', data.error);
                    return;
                }
                
                showToast('success', 'Settings saved successfully');
                
                // Reload stats if enabled
                if (enabled) {
                    loadNominalRollStats();
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast('error', 'Error saving settings');
            }
        }

        async function loadNominalRollStats() {
            if (!window.COLLEGE_SLUG) return;
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/nominal-roll/stats/`, {
                    headers: {
                        'X-CSRFToken': window.csrftoken
                    }
                });
                const data = await response.json();
                
                if (data.error) {
                    return;
                }
                
                // Update stats display
                document.getElementById('stat-total-students').textContent = data.total_students || 0;
                document.getElementById('stat-signed-in').textContent = data.signed_in_count || 0;
                document.getElementById('stat-not-signed-in').textContent = data.not_signed_in_count || 0;
                document.getElementById('stat-percentage').textContent = (data.signin_percentage || 0) + '%';
                
                document.getElementById('nominal-roll-stats').style.display = 'block';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Nominal Roll List State
        const nominalRollListState = {
            currentPage: 1,
            pageSize: 20,
            filters: {
                academic_year: '',
                semester: '',
                course_id: '',
                year_of_study: '',
                status: '',
                search: ''
            }
        };

        async function viewNominalRollList() {
            if (!window.COLLEGE_SLUG) {
                showToast('error', 'College slug not found');
                return;
            }
            
            // Open modal first to show loading state immediately
            openModal('nominal-roll-list-modal');
            
            // Show loading overlay immediately
            const loadingOverlay = document.getElementById('nominal-roll-loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.classList.remove('hidden');
            }
            
            // Reset summary counts to show loading
            const totalEl = document.getElementById('nominal-roll-total-count');
            const signedInEl = document.getElementById('nominal-roll-signed-in-count');
            const notSignedInEl = document.getElementById('nominal-roll-not-signed-in-count');
            if (totalEl) totalEl.textContent = '...';
            if (signedInEl) signedInEl.textContent = '...';
            if (notSignedInEl) notSignedInEl.textContent = '...';
            
            // Load filters and data in parallel for better performance
            try {
                await Promise.all([
                    loadNominalRollFilters(),
                    fetchNominalRollList()
                ]);
            } catch (error) {
                console.error('Error loading nominal roll data:', error);
                showToast('error', 'Failed to load sign-in list');
            }
        }

        async function loadNominalRollFilters() {
            if (!window.COLLEGE_SLUG) return;
            
            try {
                // Load all filter data in a single combined API call
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/nominal-roll/filters/`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error loading filters:', data.error);
                    return;
                }
                
                // Update academic years dropdown
                const yearSelect = document.getElementById('nominal-roll-year-filter');
                if (yearSelect && data.academic_years) {
                    yearSelect.innerHTML = '<option value="">All Years</option>';
                    data.academic_years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        yearSelect.appendChild(option);
                    });
                }
                
                // Update courses dropdown
                const courseSelect = document.getElementById('nominal-roll-course-filter');
                if (courseSelect && data.courses) {
                    courseSelect.innerHTML = '<option value="">All Courses</option>';
                    data.courses.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = course.name;
                        courseSelect.appendChild(option);
                    });
                }
                
                // Update semester dropdown using the semester data from the combined response
                if (data.semester_data) {
                    const semesterSelect = document.getElementById('nominal-roll-semester-filter');
                    if (semesterSelect) {
                        const includeAll = true;
                        const firstOptionText = includeAll ? 'All Semesters' : 'Select Semester';
                        semesterSelect.innerHTML = `<option value="">${firstOptionText}</option>`;
                        
                        const maxSemesters = data.semester_data.semesters_per_year || 2;
                        for (let i = 1; i <= maxSemesters; i++) {
                            const option = document.createElement('option');
                            option.value = i;
                            option.textContent = `Semester ${i}`;
                            semesterSelect.appendChild(option);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading nominal roll filters:', error);
            }
        }

        async function fetchNominalRollList() {
            if (!window.COLLEGE_SLUG) return;
            
            const tbody = document.getElementById('nominal-roll-list-tbody');
            const loadingOverlay = document.getElementById('nominal-roll-loading-overlay');
            const tableContainer = document.getElementById('nominal-roll-table-container');
            
            if (!tbody) return;
            
            // Show loading overlay
            if (loadingOverlay) {
                loadingOverlay.classList.remove('hidden');
            }
            
            // Disable table interaction during loading
            if (tableContainer) {
                tableContainer.style.pointerEvents = 'none';
            }
            
            // Show loading state in tbody as fallback
            tbody.innerHTML = '<tr><td colspan="8" class="loading-row"><div class="loading-state-content"><i class="fas fa-spinner fa-spin"></i><span>Loading sign-in records...</span></div></td></tr>';
            
            try {
                const params = new URLSearchParams({
                    page: nominalRollListState.currentPage,
                    page_size: nominalRollListState.pageSize
                });
                
                if (nominalRollListState.filters.academic_year) {
                    params.append('academic_year', nominalRollListState.filters.academic_year);
                }
                if (nominalRollListState.filters.semester) {
                    params.append('semester', nominalRollListState.filters.semester);
                }
                if (nominalRollListState.filters.course_id) {
                    params.append('course_id', nominalRollListState.filters.course_id);
                }
                if (nominalRollListState.filters.year_of_study) {
                    params.append('year_of_study', nominalRollListState.filters.year_of_study);
                }
                if (nominalRollListState.filters.status) {
                    params.append('status', nominalRollListState.filters.status);
                }
                if (nominalRollListState.filters.search) {
                    params.append('search', nominalRollListState.filters.search);
                }
                
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/nominal-roll/list/?${params.toString()}`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                
                const data = await response.json();
                
                // Hide loading overlay
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                }
                if (tableContainer) {
                    tableContainer.style.pointerEvents = 'auto';
                }
                
                if (data.error) {
                    tbody.innerHTML = `<tr><td colspan="8" class="empty-row">${data.error}</td></tr>`;
                    return;
                }
                
                // Update results count
                const countEl = document.getElementById('nominal-roll-results-count');
                if (countEl) {
                    countEl.textContent = data.count || 0;
                }
                
                // Update summary counts
                updateNominalRollSummary(data);
                
                // Render table
                if (data.results && data.results.length > 0) {
                    tbody.innerHTML = data.results.map(signin => {
                        const signedInDate = new Date(signin.signed_in_at);
                        const formattedDate = signedInDate.toLocaleString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        return `
                            <tr>
                                <td>${signin.admission_number || '-'}</td>
                                <td>${signin.full_name || '-'}</td>
                                <td>${signin.course_name || '-'}</td>
                                <td>${signin.academic_year || '-'}</td>
                                <td>Semester ${signin.semester || '-'}</td>
                                <td>Year ${signin.year_of_study_at_signin || '-'}</td>
                                <td>${formattedDate}</td>
                                <td>
                                    <span class="badge badge-success">Signed In</span>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    
                    // Render pagination
                    renderNominalRollPagination(data);
                    
                    // Show table, hide empty state
                    const emptyState = document.getElementById('nominal-roll-empty-state');
                    if (emptyState) emptyState.style.display = 'none';
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-row">No sign-ins found</td></tr>';
                    document.getElementById('nominal-roll-list-pagination').innerHTML = '';
                    
                    // Show empty state
                    const emptyState = document.getElementById('nominal-roll-empty-state');
                    if (emptyState) emptyState.style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching nominal roll list:', error);
                
                // Hide loading overlay on error
                if (loadingOverlay) {
                    loadingOverlay.classList.add('hidden');
                }
                if (tableContainer) {
                    tableContainer.style.pointerEvents = 'auto';
                }
                
                tbody.innerHTML = '<tr><td colspan="8" class="empty-row">Error loading sign-in list. Please try again.</td></tr>';
                showToast('error', 'Failed to load sign-in list');
            }
        }

        function renderNominalRollPagination(data) {
            const paginationEl = document.getElementById('nominal-roll-list-pagination');
            if (!paginationEl) return;
            
            if (data.total_pages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }
            
            let html = '<div class="pagination-controls">';
            
            // Previous button
            if (data.previous) {
                html += `<button class="pagination-btn" onclick="nominalRollListState.currentPage = ${data.previous}; fetchNominalRollList();">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>`;
            } else {
                html += '<button class="pagination-btn" disabled><i class="fas fa-chevron-left"></i> Previous</button>';
            }
            
            // Page info
            html += `<span class="pagination-info">Page ${data.page} of ${data.total_pages}</span>`;
            
            // Next button
            if (data.next) {
                html += `<button class="pagination-btn" onclick="nominalRollListState.currentPage = ${data.next}; fetchNominalRollList();">
                    Next <i class="fas fa-chevron-right"></i>
                </button>`;
            } else {
                html += '<button class="pagination-btn" disabled>Next <i class="fas fa-chevron-right"></i></button>';
            }
            
            html += '</div>';
            paginationEl.innerHTML = html;
        }

        function filterNominalRollList() {
            const yearFilter = document.getElementById('nominal-roll-year-filter');
            const semesterFilter = document.getElementById('nominal-roll-semester-filter');
            const courseFilter = document.getElementById('nominal-roll-course-filter');
            const yearStudyFilter = document.getElementById('nominal-roll-year-study-filter');
            const statusFilter = document.getElementById('nominal-roll-status-filter');
            const searchInput = document.getElementById('nominal-roll-search');
            
            nominalRollListState.filters.academic_year = yearFilter ? yearFilter.value : '';
            nominalRollListState.filters.semester = semesterFilter ? semesterFilter.value : '';
            nominalRollListState.filters.course_id = courseFilter ? courseFilter.value : '';
            nominalRollListState.filters.year_of_study = yearStudyFilter ? yearStudyFilter.value : '';
            nominalRollListState.filters.status = statusFilter ? statusFilter.value : '';
            nominalRollListState.filters.search = searchInput ? searchInput.value.trim() : '';
            
            nominalRollListState.currentPage = 1;
            fetchNominalRollList();
        }

        function clearNominalRollFilters() {
            document.getElementById('nominal-roll-year-filter').value = '';
            document.getElementById('nominal-roll-semester-filter').value = '';
            document.getElementById('nominal-roll-course-filter').value = '';
            document.getElementById('nominal-roll-year-study-filter').value = '';
            const statusFilter = document.getElementById('nominal-roll-status-filter');
            if (statusFilter) statusFilter.value = '';
            const searchInput = document.getElementById('nominal-roll-search');
            if (searchInput) searchInput.value = '';
            const clearBtn = document.getElementById('nominal-roll-search-clear');
            if (clearBtn) clearBtn.style.display = 'none';
            
            nominalRollListState.filters = {
                academic_year: '',
                semester: '',
                course_id: '',
                year_of_study: '',
                status: '',
                search: ''
            };
            
            nominalRollListState.currentPage = 1;
            fetchNominalRollList();
        }

        // Load settings when settings tab is opened
        // Initialize marks entry system on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load academic year options for unit selection
            if (document.getElementById('unit-selection-year-filter')) {
                loadAcademicYearOptions();
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            // Populate all semester dropdowns on page load
            if (window.COLLEGE_SLUG) {
                populateAllSemesterDropdowns();
            }
            
            // Debug: Check if college settings elements exist
            console.log('College Settings Elements Check:');
            console.log('Academic tab button:', document.getElementById('academic-settings-inner-tab'));
            console.log('Academic content:', document.getElementById('academic-settings-tab-content'));
            console.log('Grading tab button:', document.getElementById('grading-system-inner-tab'));
            console.log('Grading content:', document.getElementById('grading-system-tab-content'));
            console.log('Nominal roll tab button:', document.getElementById('nominal-roll-inner-tab'));
            console.log('Nominal roll content:', document.getElementById('nominal-roll-tab-content'));
            console.log('Transcript tab button:', document.getElementById('transcript-template-inner-tab'));
            console.log('Transcript content:', document.getElementById('transcript-template-tab-content'));
            
            // Load all settings when college settings tab is clicked
            const collegeSettingsTab = document.getElementById('college-settings-tab');
            if (collegeSettingsTab) {
                collegeSettingsTab.addEventListener('click', function() {
                    setTimeout(() => {
                        if (typeof loadAcademicSettings === 'function') {
                            loadAcademicSettings();
                        }
                        if (typeof loadGradingSystem === 'function') {
                            loadGradingSystem();
                        }
                        if (typeof loadNominalRollSettings === 'function') {
                            loadNominalRollSettings();
                        }
                    }, 100);
                });
            }
        });

        async function handleProfileSubmit(e) {
            e.preventDefault();
            
            if (!window.COLLEGE_SLUG) {
                showToast('error', 'College slug not found');
                return;
            }
            
            const email = document.getElementById('profile-email').value.trim();
            const phone = document.getElementById('profile-phone').value.trim();
            const password = document.getElementById('profile-password').value;
            
            // Basic validation
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showToast('error', 'Please enter a valid email address');
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            try {
                const payload = {
                    email: email,
                    phone: phone
                };
                
                if (password) {
                    payload.password = password;
                }
                
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/profile/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': window.csrftoken
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showToast('success', data.message || 'Profile updated successfully');
                    // Clear password field
                    document.getElementById('profile-password').value = '';
                } else {
                    showToast('error', data.error || 'Failed to update profile');
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast('error', 'An error occurred while updating profile');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        // Update edit functions to set modal title
        const originalEditStudent = window.editStudent;
        window.editStudent = async function(id) {
            document.getElementById('student-modal-title').textContent = 'Edit Student';
            await originalEditStudent(id);
        };

        const originalEditCourse = window.editCourse;
        window.editCourse = async function(id) {
            document.getElementById('course-modal-title').textContent = 'Edit Course';
            await originalEditCourse(id);
        };

        const originalEditUnit = window.editUnit;
        window.editUnit = async function(id) {
            document.getElementById('unit-modal-title').textContent = 'Edit Unit';
            await originalEditUnit(id);
        };

        const originalEditDepartment = window.editDepartment;
        window.editDepartment = async function(id) {
            document.getElementById('department-modal-title').textContent = 'Edit Department';
            await originalEditDepartment(id);
        };

        const originalEditLecturer = window.editLecturer;
        window.editLecturer = async function(id) {
            document.getElementById('lecturer-modal-title').textContent = 'Edit Lecturer';
            document.getElementById('lecturer-password-group').style.display = 'none';
            document.getElementById('lecturer-password').required = false;
            
            // Update submit button text
            const submitBtn = document.getElementById('lecturer-submit-btn');
            const btnText = submitBtn ? submitBtn.querySelector('.btn-text') : null;
            if (btnText) {
                btnText.textContent = 'Save Changes';
            }
            
            await originalEditLecturer(id);
            
            // Set up role change listener to update button text
            // Note: The role change handler in landing-data.js will handle the confirmation UI
            // We just need to update the button text here
            setTimeout(() => {
                const roleSelect = document.getElementById('lecturer-role');
                if (roleSelect && btnText) {
                    // Add listener to update button text when role changes
                    roleSelect.addEventListener('change', function() {
                        const originalRole = document.getElementById('lecturer-form').dataset.originalRole;
                        const newRole = roleSelect.value;
                        if (newRole !== originalRole) {
                            btnText.textContent = 'Save Changes & Update Role';
                        } else {
                            btnText.textContent = 'Save Changes';
                        }
                    });
                }
            }, 100);
        };

        const originalEditEnrollment = window.editEnrollment;
        window.editEnrollment = async function(id) {
            document.getElementById('enrollment-modal-title').textContent = 'Edit Enrollment';
            await originalEditEnrollment(id);
        };

        const originalEditResult = window.editResult;
        window.editResult = async function(enrollmentId) {
            await originalEditResult(enrollmentId);
            calculateTotal();
        };

        // Profile dropdown toggle
        document.getElementById('profile-btn').addEventListener('click', function(e) {
            e.stopPropagation();
            const menu = document.getElementById('profile-menu');
            menu.classList.toggle('active');
        });

        // Close profile menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.profile-dropdown')) {
                document.getElementById('profile-menu').classList.remove('active');
            }
        });

        // Notification dropdown toggle
        document.getElementById('notification-btn').addEventListener('click', function(e) {
            e.stopPropagation();
            const menu = document.getElementById('notification-menu');
            menu.classList.toggle('active');
            if (menu.classList.contains('active')) {
                loadNotificationDropdown();
            }
        });

        // Load notification count on page load
        loadNotificationCount();
        // Refresh notification count every 5 minutes
        setInterval(loadNotificationCount, 5 * 60 * 1000);

        // Close notification menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.notifications')) {
                document.getElementById('notification-menu').classList.remove('active');
            }
        });

        // Mobile sidebar toggle
        document.getElementById('sidebar-toggle').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('open');
        });

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeModal(e.target.id);
            }
        });

        // Global unit search event listeners
        const globalUnitSearch = document.getElementById('unit-global-unit-search');
        if (globalUnitSearch) {
            globalUnitSearch.addEventListener('input', handleGlobalUnitSearch);
            globalUnitSearch.addEventListener('focus', function() {
                if (this.value.trim().length >= 2) {
                    handleGlobalUnitSearch();
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.global-unit-select-wrapper')) {
                    document.getElementById('unit-global-unit-dropdown').style.display = 'none';
                }
            });
        }
        
        // Create new unit from search button
        const createNewUnitBtn = document.getElementById('create-new-unit-from-search');
        if (createNewUnitBtn) {
            createNewUnitBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('unit-global-unit-search').value.trim();
                // Close global unit dropdown
                document.getElementById('unit-global-unit-dropdown').style.display = 'none';
                // Pre-fill unit name if search term exists
                if (searchTerm) {
                    document.getElementById('unit-name').value = searchTerm;
                }
                // Focus on unit code field
                document.getElementById('unit-code').focus();
            });
        }

        // Global course search event listeners
        const globalCourseSearch = document.getElementById('course-global-course-search');
        if (globalCourseSearch) {
            globalCourseSearch.addEventListener('input', handleGlobalCourseSearch);
            globalCourseSearch.addEventListener('focus', function() {
                if (this.value.trim().length >= 2) {
                    handleGlobalCourseSearch();
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.global-course-select-wrapper')) {
                    document.getElementById('course-global-course-dropdown').style.display = 'none';
                }
            });
        }
        
        // Create new course from search button
        const createNewCourseBtn = document.getElementById('create-new-course-from-search');
        if (createNewCourseBtn) {
            createNewCourseBtn.addEventListener('click', function() {
                const searchTerm = document.getElementById('course-global-course-search').value.trim();
                // Close global course dropdown
                document.getElementById('course-global-course-dropdown').style.display = 'none';
                // Pre-fill course name if search term exists
                if (searchTerm) {
                    document.getElementById('course-name').value = searchTerm;
                }
                // Focus on course name field
                document.getElementById('course-name').focus();
            });
        }

        // CourseUnits Management Functions - Restructured
        let courseUnitsManagementData = {};
        let allCoursesList = [];

        // Initialize on page load
        async function initializeCourseUnitManagement() {
            await loadCoursesForSelector();
        }

        // Load courses for dropdown (only once)
        async function loadCoursesForSelector() {
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/courses/`);
                const data = await response.json();
                allCoursesList = data.results || [];
                
                const selector = document.getElementById('courseunits-course-selector');
                if (!selector) return;
                
                selector.innerHTML = '<option value="">Select a Course</option>';
                allCoursesList.forEach(course => {
                    selector.innerHTML += `<option value="${course.id}">${course.name}</option>`;
                });
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }

        // Load course unit management data (single optimized call)
        async function loadCourseUnitManagement() {
            const courseId = document.getElementById('courseunits-course-selector').value;
            const emptyState = document.getElementById('course-units-empty');
            const loadingState = document.getElementById('course-units-loading');
            const infoDisplay = document.getElementById('course-info-display');
            const container = document.getElementById('course-units-container');
            
            if (!courseId) {
                emptyState.style.display = 'block';
                loadingState.style.display = 'none';
                infoDisplay.style.display = 'none';
                return;
            }
            
            // Show loading
            emptyState.style.display = 'none';
            loadingState.style.display = 'block';
            infoDisplay.style.display = 'none';
            
            try {
                // Single API call to get all course units for this course
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/courseunits/?course=${courseId}&page_size=1000`);
                const data = await response.json();
                const courseUnits = data.results || [];
                
                // Get selected course info
                const selectedCourse = allCoursesList.find(c => c.id === parseInt(courseId));
                
                if (selectedCourse) {
                    document.getElementById('selected-course-name').textContent = selectedCourse.name;
                    document.getElementById('selected-course-duration').textContent = 
                        `Duration: ${selectedCourse.duration_years || 5} years`;
                }
                
                // Organize units by year and semester
                const organizedUnits = organizeUnitsByYearSemester(courseUnits);
                
                // Render the form-based display
                renderCourseUnitsForm(organizedUnits, selectedCourse);
                
                // Show display, hide loading
                loadingState.style.display = 'none';
                infoDisplay.style.display = 'block';
                
                // Cache the data
                courseUnitsManagementData[courseId] = {
                    course: selectedCourse,
                    units: courseUnits,
                    organized: organizedUnits
                };
                
            } catch (error) {
                console.error('Error loading course units:', error);
                loadingState.style.display = 'none';
                container.innerHTML = '<div class="error-message" style="padding: 20px; text-align: center; color: #dc3545;">Failed to load course units. Please try again.</div>';
                infoDisplay.style.display = 'block';
            }
        }

        // Organize units by year and semester
        function organizeUnitsByYearSemester(courseUnits) {
            const organized = {};
            
            courseUnits.forEach(unit => {
                const year = unit.year_of_study;
                const semester = unit.semester;
                const key = `year_${year}_sem_${semester}`;
                
                if (!organized[key]) {
                    organized[key] = {
                        year: year,
                        semester: semester,
                        units: []
                    };
                }
                
                organized[key].units.push(unit);
            });
            
            // Sort by year, then semester
            return Object.values(organized).sort((a, b) => {
                if (a.year !== b.year) return a.year - b.year;
                return a.semester - b.semester;
            });
        }

        // Render form-based display
        function renderCourseUnitsForm(organizedUnits, course) {
            const container = document.getElementById('course-units-container');
            const isAdmin = '{{ user.role }}' === 'college_admin';
            
            if (organizedUnits.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #b0b0b0;">
                        <i class="fas fa-book-open" style="font-size: 32px; margin-bottom: 12px; opacity: 0.3;"></i>
                        <p>No units assigned to this course yet.</p>
                        ${isAdmin ? '<button class="btn btn-primary" onclick="openCourseUnitModal()" style="margin-top: 16px;">Assign Units</button>' : ''}
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            organizedUnits.forEach(group => {
                html += `
                    <div class="year-semester-group" style="margin-bottom: 32px; border: 1px solid #3a3a3a; border-radius: 8px; overflow: hidden;">
                        <div class="group-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 20px;">
                            <h5 style="margin: 0; font-size: 16px; font-weight: 600;">
                                Year ${group.year} - Semester ${group.semester}
                                <span style="font-size: 14px; font-weight: 400; opacity: 0.9; margin-left: 12px;">
                                    (${group.units.length} unit${group.units.length !== 1 ? 's' : ''})
                                </span>
                            </h5>
                        </div>
                        <div class="group-body" style="padding: 20px; background: #1e1e1e;">
                            <div class="units-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                `;
                
                group.units.forEach(unit => {
                    html += `
                        <div class="unit-card" style="border: 1px solid #3a3a3a; border-radius: 6px; padding: 16px; background: #2a2a2a; transition: all 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #ffffff; margin-bottom: 4px;">${(unit.unit_code || '').toUpperCase()}</div>
                                    <div style="font-size: 14px; color: #b0b0b0; margin-bottom: 8px;">${unit.unit_name}</div>
                                    ${unit.lecturer_name ? `
                                        <div style="font-size: 12px; color: #d0d0d0; margin-top: 8px;">
                                            <i class="fas fa-chalkboard-teacher" style="margin-right: 4px;"></i>
                                            ${unit.lecturer_name}
                                        </div>
                                    ` : '<div style="font-size: 12px; color: #888888;"><i class="fas fa-user-slash" style="margin-right: 4px;"></i>No lecturer assigned</div>'}
                                </div>
                            </div>
                            ${isAdmin ? `
                                <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #3a3a3a;">
                                    <button class="btn-icon btn-primary" onclick="editCourseUnit(${unit.id}, event)" title="Edit" style="flex: 1; padding: 6px 12px; font-size: 12px;">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn-icon btn-danger" onclick="deleteCourseUnit(${unit.id})" title="Delete" style="flex: 1; padding: 6px 12px; font-size: 12px;">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function openCourseUnitModal(assignmentId = null, assignmentData = null, courseData = null) {
            const modal = document.getElementById('courseunit-modal');
            const form = document.getElementById('courseunit-form');
            const title = document.getElementById('courseunit-modal-title');
            
            // Ensure course units section stays visible
            const courseUnitsSection = document.getElementById('courseunits-section');
            if (courseUnitsSection) {
                courseUnitsSection.classList.add('active');
            }
            
            // Check if modal is already open - if so, just update it instead of closing/reopening
            const isModalOpen = modal && modal.classList.contains('active');
            
            // Only reset form if modal wasn't already open (to avoid flicker)
            if (!isModalOpen) {
                resetCourseUnitForm();
            } else {
                // Just clear the edit ID if modal is already open
                form.dataset.editId = '';
            }
            
            // Only load courses if not already loaded
            if (allCoursesList.length === 0) {
                await loadCoursesForSelector();
            }
            
            // Populate course dropdown from cache
            await loadCourseUnitOptions();
            
            // Ensure semester dropdown is populated with college's semesters_per_year
            await populateSemesterDropdown('courseunit-semester', false);
            
            if (assignmentId) {
                // Editing mode
                form.dataset.editId = assignmentId;
                title.textContent = 'Edit Course-Unit Assignment';
                
                // Use provided data if available, otherwise find from cached data
                let assignment = assignmentData;
                if (!assignment) {
                    const courseId = document.getElementById('courseunits-course-selector').value;
                    const cached = courseUnitsManagementData[courseId];
                    if (cached) {
                        assignment = cached.units.find(u => u.id === assignmentId);
                    }
                }
                
                if (assignment) {
                    // Set form values
                    document.getElementById('courseunit-course').value = assignment.course_id;
                    // Update year options based on course duration and populate semester dropdown
                    updateCourseUnitYearOptions();
                    await populateSemesterDropdown('courseunit-semester', false);
                    // Wait a bit for options to populate
                    setTimeout(() => {
                        document.getElementById('courseunit-year').value = assignment.year_of_study;
                        document.getElementById('courseunit-semester').value = assignment.semester;
                        // Trigger handlers to show sections and load units
                        handleCourseSelection();
                        handleYearSemesterChange();
                    }, 100);
                } else {
                    showToast('error', 'Assignment not found');
                    return;
                }
            } else {
                // Creating mode - start fresh
                form.dataset.editId = '';
                title.textContent = 'Assign Units to Course';
            }
            
            // Only open modal if it's not already open (prevents flicker)
            if (!isModalOpen) {
                openModal('courseunit-modal');
            }
        }

        async function loadCourseUnitOptions() {
            // Use cached courses if available, otherwise load
            if (allCoursesList.length === 0) {
                await loadCoursesForSelector();
            }
            
            const courseSelect = document.getElementById('courseunit-course');
            if (!courseSelect) return;
            
            courseSelect.innerHTML = '<option value="">Select Course</option>';
            
            allCoursesList.forEach(course => {
                const option = `<option value="${course.id}" data-duration="${course.duration || course.duration_years || 5}">${course.name}</option>`;
                courseSelect.innerHTML += option;
            });
        }

        function updateCourseUnitYearOptions() {
            const courseId = document.getElementById('courseunit-course').value;
            const yearSelect = document.getElementById('courseunit-year');
            
            yearSelect.innerHTML = '<option value="">Select Year</option>';
            
            if (courseId) {
                // Get course duration from data attribute
                const courseSelect = document.getElementById('courseunit-course');
                const selectedOption = courseSelect.options[courseSelect.selectedIndex];
                const duration = parseInt(selectedOption.getAttribute('data-duration')) || 5;
                
                for (let i = 1; i <= duration; i++) {
                    yearSelect.innerHTML += `<option value="${i}">Year ${i}</option>`;
                }
            }
        }

        // goToStep function removed - no longer needed with single form view

        function updateUnitsSelectionInfo() {
            const courseSelect = document.getElementById('courseunit-course');
            const yearSelect = document.getElementById('courseunit-year');
            const semesterSelect = document.getElementById('courseunit-semester');
            
            const courseName = courseSelect.options[courseSelect.selectedIndex]?.text || '';
            const year = yearSelect.value || '';
            const semester = semesterSelect.value || '';
            
            document.getElementById('selected-course-name').textContent = courseName;
            document.getElementById('selected-year').textContent = year;
            document.getElementById('selected-semester').textContent = semester;
        }

        async function handleCourseSelection() {
            const courseId = document.getElementById('courseunit-course').value;
            const yearSemesterSection = document.getElementById('year-semester-section');
            const unitsSection = document.getElementById('units-selection-section');
            
            if (courseId) {
                // Update year options based on course duration
                updateCourseUnitYearOptions();
                // Ensure semester dropdown is populated with college's semesters_per_year
                await populateSemesterDropdown('courseunit-semester', false);
                // Show year/semester section
                yearSemesterSection.style.display = 'block';
                // Hide units section until year and semester are selected
                unitsSection.style.display = 'none';
                // Clear year and semester values
                document.getElementById('courseunit-year').value = '';
                document.getElementById('courseunit-semester').value = '';
            } else {
                // Hide both sections if no course selected
                yearSemesterSection.style.display = 'none';
                unitsSection.style.display = 'none';
            }
        }
        
        function handleYearSemesterChange() {
            const courseId = document.getElementById('courseunit-course').value;
            const year = document.getElementById('courseunit-year').value;
            const semester = document.getElementById('courseunit-semester').value;
            const unitsSection = document.getElementById('units-selection-section');
            
            if (courseId && year && semester) {
                // Show units section and load units
                unitsSection.style.display = 'block';
                updateUnitsSelectionInfo();
                loadUnitsForSelection();
            } else {
                // Hide units section if year or semester is not selected
                unitsSection.style.display = 'none';
            }
        }

        function resetCourseUnitForm() {
            const form = document.getElementById('courseunit-form');
            form.reset();
            form.dataset.editId = ''; // Clear edit ID
            
            // Hide all sections
            document.getElementById('year-semester-section').style.display = 'none';
            document.getElementById('units-selection-section').style.display = 'none';
            
            // Reset units container
            document.getElementById('units-selection-container').innerHTML = '';
            document.getElementById('units-loading').style.display = 'none';
            document.getElementById('units-empty').style.display = 'none';
            
            // Reset all form fields explicitly
            document.getElementById('courseunit-course').value = '';
            document.getElementById('courseunit-year').value = '';
            document.getElementById('courseunit-semester').value = '';
            document.getElementById('selected-course-name').textContent = '';
            document.getElementById('selected-year').textContent = '';
            document.getElementById('selected-semester').textContent = '';
        }

        async function loadUnitsForSelection() {
            const courseId = document.getElementById('courseunit-course').value;
            const year = document.getElementById('courseunit-year').value;
            const semester = document.getElementById('courseunit-semester').value;
            
            const container = document.getElementById('units-selection-container');
            const loading = document.getElementById('units-loading');
            const empty = document.getElementById('units-empty');
            
            // Show loading state
            container.style.display = 'none';
            empty.style.display = 'none';
            loading.style.display = 'block';
            
            if (!courseId || !year || !semester) {
                loading.style.display = 'none';
                return;
            }
            
            try {
                // Fetch all available units for the college
                const unitsResponse = await fetch(`/api/${window.COLLEGE_SLUG}/units/`);
                const unitsData = await unitsResponse.json();
                const allUnits = unitsData.results || unitsData.units || [];
                
                // Fetch already assigned units for this course/year/semester
                const assignedResponse = await fetch(
                    `/api/${window.COLLEGE_SLUG}/courseunits/?course=${courseId}&year=${year}&semester=${semester}`
                );
                const assignedData = await assignedResponse.json();
                const assignedUnitIds = (assignedData.results || []).map(a => a.unit_id || a.unit?.id);
                
                // Render units as cards
                if (allUnits.length === 0) {
                    loading.style.display = 'none';
                    empty.style.display = 'block';
                    return;
                }
                
                container.innerHTML = allUnits.map(unit => {
                    const isAssigned = assignedUnitIds.includes(unit.id);
                    return `
                        <div class="unit-selection-card ${isAssigned ? 'already-assigned' : ''}" 
                             data-unit-id="${unit.id}">
                            <label style="display: flex; align-items: flex-start; cursor: pointer; width: 100%;">
                                <input type="checkbox" 
                                       name="selected-units" 
                                       value="${unit.id}" 
                                       ${isAssigned ? 'disabled' : ''}
                                       onchange="toggleUnitSelection(this)">
                                <div style="flex: 1;">
                                    <div class="unit-code">
                                        ${(unit.code || '').toUpperCase()}
                                    </div>
                                    <div class="unit-name">
                                        ${unit.name}
                                    </div>
                                    ${unit.assigned_lecturer ? `
                                        <div class="unit-lecturer">
                                            <i class="fas fa-chalkboard-teacher"></i> ${unit.assigned_lecturer}
                                        </div>
                                    ` : ''}
                                </div>
                            </label>
                        </div>
                    `;
                }).join('');
                
                loading.style.display = 'none';
                container.style.display = 'grid';
                
            } catch (error) {
                console.error('Error loading units:', error);
                loading.style.display = 'none';
                container.innerHTML = '<div class="error-message">Failed to load units. Please try again.</div>';
                container.style.display = 'block';
            }
        }

        function toggleUnitSelection(checkbox) {
            const card = checkbox.closest('.unit-selection-card');
            if (checkbox.checked) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        }

        async function handleCourseUnitSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const assignmentId = form.dataset.editId;
            
            const courseId = document.getElementById('courseunit-course').value;
            const year = document.getElementById('courseunit-year').value;
            const semester = document.getElementById('courseunit-semester').value;
            const selectedUnits = Array.from(document.querySelectorAll('input[name="selected-units"]:checked'))
                .map(cb => parseInt(cb.value));
            
            if (!courseId || !year || !semester) {
                showToast('error', 'Please complete all steps');
                return;
            }
            
            if (assignmentId) {
                // Editing mode - single unit (keep old behavior for editing)
                const unitId = selectedUnits.length > 0 ? selectedUnits[0] : null;
                if (!unitId) {
                    showToast('error', 'Please select a unit');
                    return;
                }
                
                const formData = {
                    course_id: parseInt(courseId),
                    unit_id: unitId,
                    year_of_study: parseInt(year),
                    semester: parseInt(semester)
                };
                
                try {
                    const response = await fetch(`/api/${window.COLLEGE_SLUG}/courseunits/`, {
                        method: 'PUT',
                        headers: {
                            'X-CSRFToken': window.csrftoken,
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({ ...formData, id: parseInt(assignmentId) })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to update assignment');
                    }
                    
                    showToast('success', 'Assignment updated successfully');
                    closeModal('courseunit-modal');
                    // Clear edit ID and reset form
                    form.dataset.editId = '';
                    resetCourseUnitForm();
                    // Reload course units list
                    await loadCourseUnits(courseUnitsCurrentPage);
                } catch (error) {
                    console.error('Error updating assignment:', error);
                    showToast('error', error.message || 'Failed to update assignment');
                }
            } else {
                // Creating mode - multiple units
                if (selectedUnits.length === 0) {
                    showToast('error', 'Please select at least one unit to assign');
                    return;
                }
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const btnText = submitBtn.querySelector('.btn-text');
                const btnLoader = submitBtn.querySelector('.btn-loader');
                
                btnText.style.display = 'none';
                btnLoader.style.display = 'inline-block';
                submitBtn.disabled = true;
                
                try {
                    // Assign units one by one
                    const assignments = [];
                    const errors = [];
                    
                    for (const unitId of selectedUnits) {
                        try {
                            const response = await fetch(`/api/${window.COLLEGE_SLUG}/courseunits/`, {
                                method: 'POST',
                                headers: {
                                    'X-CSRFToken': window.csrftoken,
                                    'Content-Type': 'application/json'
                                },
                                credentials: 'same-origin',
                                body: JSON.stringify({
                                    course_id: parseInt(courseId),
                                    unit_id: unitId,
                                    year_of_study: parseInt(year),
                                    semester: parseInt(semester)
                                })
                            });
                            
                            if (response.ok) {
                                assignments.push(await response.json());
                            } else {
                                const error = await response.json();
                                errors.push(`Unit ${unitId}: ${error.error || 'Failed'}`);
                            }
                        } catch (error) {
                            errors.push(`Unit ${unitId}: ${error.message || 'Error'}`);
                        }
                    }
                    
                    if (assignments.length > 0) {
                        showToast('success', `Successfully assigned ${assignments.length} unit(s) to the course`);
                        closeModal('courseunit-modal');
                        // Clear any edit ID and reset form
                        form.dataset.editId = '';
                        resetCourseUnitForm();
                        // Reload course units list if a course is selected
                        const selectedCourseId = document.getElementById('courseunits-course-selector').value;
                        if (selectedCourseId) {
                            await loadCourseUnitManagement();
                        }
                    } else {
                        showToast('error', 'Failed to assign units. ' + (errors.length > 0 ? errors.join('; ') : 'Please try again.'));
                    }
                    
                    if (errors.length > 0 && assignments.length > 0) {
                        console.warn('Some units failed to assign:', errors);
                    }
                    
                } catch (error) {
                    console.error('Error submitting form:', error);
                    showToast('error', 'An error occurred. Please try again.');
                } finally {
                    btnText.style.display = 'inline';
                    btnLoader.style.display = 'none';
                    submitBtn.disabled = false;
                }
            }
        }

        // Optimized edit function - uses cached data
        async function editCourseUnit(id, event) {
            // Prevent event bubbling to avoid triggering section navigation
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            // Ensure course units section stays visible
            const courseUnitsSection = document.getElementById('courseunits-section');
            if (courseUnitsSection) {
                courseUnitsSection.classList.add('active');
            }
            
            const courseId = document.getElementById('courseunits-course-selector').value;
            if (!courseId) {
                showToast('error', 'Please select a course first');
                return;
            }
            
            // Find the unit from cached data
            const cached = courseUnitsManagementData[courseId];
            if (!cached) {
                // If not cached, reload and retry
                await loadCourseUnitManagement();
                const retryCached = courseUnitsManagementData[courseId];
                if (retryCached) {
                    const assignment = retryCached.units.find(u => u.id === id);
                    if (assignment) {
                        await openCourseUnitModal(id, assignment, retryCached.course);
                    } else {
                        showToast('error', 'Assignment not found');
                    }
                } else {
                    showToast('error', 'Failed to load course data');
                }
                return;
            }
            
            const assignment = cached.units.find(u => u.id === id);
            if (!assignment) {
                showToast('error', 'Assignment not found');
                return;
            }
            
            // Open modal with pre-loaded data (no API calls needed)
            await openCourseUnitModal(id, assignment, cached.course);
        }

        // Delete function with immediate UI update
        async function deleteCourseUnit(id, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            if (!confirm('Are you sure you want to remove this unit assignment?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/courseunits/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': window.csrftoken,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ id: id })
                });
                
                if (response.ok || response.status === 204) {
                    showToast('success', 'Unit assignment removed successfully');
                    // Reload current course view
                    if (currentSelectedCourse) {
                        await loadCourseUnitsForDetail(currentSelectedCourse.id, currentSelectedCourse);
                    } else {
                        await loadCourseUnitManagement();
                    }
                } else {
                    const error = await response.json().catch(() => ({ error: 'Failed to delete' }));
                    throw new Error(error.error || 'Failed to delete assignment');
                }
            } catch (error) {
                console.error('Error deleting course unit:', error);
                showToast('error', error.message || 'Failed to remove unit assignment');
            }
        }

        // ============================================
        // Redesigned Course-Unit Assignment Functions
        // ============================================
        
        let currentSelectedCourse = null;
        let allUnitsList = [];
        let filteredUnitsInDialog = [];
        let selectedUnitsInDialog = new Set();
        let coursesPaginationState = {
            currentPage: 1,
            pageSize: 12,
            totalPages: 1,
            totalCount: 0,
            allCourses: [],
            filteredCourses: []
        };
        let collegeSemestersPerYear = 2; // Default, will be fetched

        // Get college semesters per year
        async function getCollegeSemestersPerYear() {
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/admin/academic-settings/`, {
                    headers: { 'X-CSRFToken': window.csrftoken }
                });
                const data = await response.json();
                if (data && !data.error && data.semesters_per_year) {
                    collegeSemestersPerYear = data.semesters_per_year;
                }
            } catch (error) {
                console.error('Error fetching semesters per year:', error);
            }
            return collegeSemestersPerYear;
        }

        // Load and display all courses with pagination
        async function loadAllCourses(page = 1, searchTerm = '') {
            const container = document.getElementById('courses-list-container');
            if (!container) return;

            container.innerHTML = '<div class="loading-state" style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Loading courses...</div>';

            try {
                // Build API URL with search parameter if provided
                let url = `/api/${window.COLLEGE_SLUG}/courses/?page=${page}&page_size=${coursesPaginationState.pageSize}`;
                if (searchTerm) {
                    url += `&search=${encodeURIComponent(searchTerm)}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                // Normalize course data - API returns 'duration' but we use 'duration_years'
                const normalizedCourses = (data.results || []).map(course => {
                    if (course.duration && !course.duration_years) {
                        course.duration_years = course.duration;
                    }
                    return course;
                });
                
                coursesPaginationState.allCourses = normalizedCourses;
                coursesPaginationState.totalCount = data.count || 0;
                coursesPaginationState.totalPages = data.total_pages || Math.ceil(coursesPaginationState.totalCount / coursesPaginationState.pageSize);
                coursesPaginationState.currentPage = page;
                coursesPaginationState.filteredCourses = [...normalizedCourses];

                renderCoursesGrid(coursesPaginationState.allCourses);
                renderCoursesPagination();
            } catch (error) {
                console.error('Error loading courses:', error);
                container.innerHTML = `
                    <div class="error-message" style="padding: 20px; text-align: center; color: var(--error-color);">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load courses. Please try again.
                    </div>
                `;
            }
        }

        // Render courses grid
        function renderCoursesGrid(courses) {
            const container = document.getElementById('courses-list-container');
            if (!container) return;

            if (courses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <i class="fas fa-graduation-cap" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                        <p style="font-size: 16px; margin: 0;">No courses found</p>
                    </div>
                `;
                return;
            }

            // Add style for course card animations if not already added
            if (!document.getElementById('course-card-animations-style')) {
                const style = document.createElement('style');
                style.id = 'course-card-animations-style';
                style.textContent = `
                    .course-card-animated {
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        padding: 20px;
                        background: var(--bg-card);
                        cursor: pointer;
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                    }
                    .course-card-animated:hover {
                        border-color: var(--primary-color) !important;
                        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
                        transform: translateY(-4px);
                    }
                    .course-card-animated::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: -100%;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
                        transition: left 0.5s;
                    }
                    .course-card-animated:hover::before {
                        left: 100%;
                    }
                `;
                document.head.appendChild(style);
            }

            container.innerHTML = `
                <div class="courses-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                    ${courses.map(course => `
                        <div class="course-card-animated" onclick="showCourseDetail(${course.id})">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-color); font-size: 18px; margin-bottom: 8px;">${course.name}</div>
                                    <div style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">
                                        <i class="fas fa-calendar-alt" style="margin-right: 4px;"></i>
                                        Duration: ${course.duration_years || course.duration || 1} year${(course.duration_years || course.duration || 1) !== 1 ? 's' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Render courses pagination
        function renderCoursesPagination() {
            const container = document.getElementById('courses-pagination');
            if (!container) return;

            if (coursesPaginationState.totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            if (coursesPaginationState.currentPage > 1) {
                html += `<button class="btn-pagination" onclick="loadAllCoursesPage(${coursesPaginationState.currentPage - 1})">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>`;
            }

            html += `<span class="page-info">Page ${coursesPaginationState.currentPage} of ${coursesPaginationState.totalPages}</span>`;

            if (coursesPaginationState.currentPage < coursesPaginationState.totalPages) {
                html += `<button class="btn-pagination" onclick="loadAllCoursesPage(${coursesPaginationState.currentPage + 1})">
                    Next <i class="fas fa-chevron-right"></i>
                </button>`;
            }

            container.innerHTML = html;
        }

        // Load courses page
        function loadAllCoursesPage(page) {
            loadAllCourses(page);
        }

        // Filter courses by search - uses API search for full dataset
        let searchTimeout = null;
        function filterCourses() {
            const searchInput = document.getElementById('courses-search-input');
            const searchTerm = (searchInput?.value || '').trim();
            
            // Debounce search
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            searchTimeout = setTimeout(async () => {
                if (!searchTerm) {
                    // Reset to show all courses from page 1
                    await loadAllCourses(1, '');
                    return;
                }
                
                // Use API search to search across all courses
                await loadAllCourses(1, searchTerm);
            }, 300);
        }

        // Show courses list view
        function showCoursesList() {
            document.getElementById('courses-list-view').style.display = 'block';
            document.getElementById('course-detail-view').style.display = 'none';
            currentSelectedCourse = null;
        }

        // Show course detail view
        async function showCourseDetail(courseId) {
            // Find course in all courses list or fetch it
            let course = coursesPaginationState.allCourses.find(c => c.id === courseId) ||
                        coursesPaginationState.filteredCourses.find(c => c.id === courseId);
            
            if (!course) {
                // Try to fetch the course
                try {
                    const response = await fetch(`/api/${window.COLLEGE_SLUG}/courses/${courseId}/`);
                    const data = await response.json();
                    course = data;
                    // API returns 'duration' field, ensure duration_years is set
                    if (!course.duration_years && course.duration) {
                        course.duration_years = course.duration;
                    }
                } catch (error) {
                    showToast('error', 'Course not found');
                    return;
                }
            } else {
                // Ensure duration_years is set for cached course (API returns 'duration')
                if (!course.duration_years && course.duration) {
                    course.duration_years = course.duration;
                }
            }

            currentSelectedCourse = course;

            // Update UI
            document.getElementById('courses-list-view').style.display = 'none';
            document.getElementById('course-detail-view').style.display = 'block';
            document.getElementById('course-detail-title').textContent = course.name;
            document.getElementById('course-detail-name').textContent = course.name;

            // Get college semesters per year
            await getCollegeSemestersPerYear();

            // Load course units
            await loadCourseUnitsForDetail(courseId, course);
        }

        // Load course units for detail view
        async function loadCourseUnitsForDetail(courseId, course = null) {
            const container = document.getElementById('course-units-container');
            const loading = document.getElementById('course-units-loading');
            
            container.innerHTML = '';
            loading.style.display = 'block';

            // Get course object if not provided
            if (!course) {
                course = currentSelectedCourse;
                if (!course) {
                    // Try to find in all courses
                    course = coursesPaginationState.allCourses.find(c => c.id === courseId) ||
                            coursesPaginationState.filteredCourses.find(c => c.id === courseId);
                }
            }
            
            // Ensure duration_years is set (API returns 'duration' field)
            if (course && !course.duration_years && course.duration) {
                course.duration_years = course.duration;
            }

            if (!course) {
                loading.style.display = 'none';
                container.innerHTML = `
                    <div class="error-message" style="padding: 20px; text-align: center; color: var(--error-color);">
                        <i class="fas fa-exclamation-triangle"></i>
                        Course information not available.
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/courseunits/?course=${courseId}&page_size=1000`);
                const data = await response.json();
                const courseUnits = data.results || [];

                // Populate year and semester filters
                await populateCourseUnitFilters(course, courseUnits);

                // Render units
                renderCourseUnitsDetail(courseUnits, course);

                loading.style.display = 'none';
            } catch (error) {
                console.error('Error loading course units:', error);
                loading.style.display = 'none';
                container.innerHTML = `
                    <div class="error-message" style="padding: 20px; text-align: center; color: var(--error-color);">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load course units. Please try again.
                    </div>
                `;
            }
        }

        // Populate year and semester filter dropdowns
        async function populateCourseUnitFilters(course, courseUnits) {
            const yearFilter = document.getElementById('course-units-year-filter');
            const semesterFilter = document.getElementById('course-units-semester-filter');

            if (!course) {
                course = currentSelectedCourse;
            }

            if (!yearFilter || !semesterFilter || !course) return;

            // Get college semesters per year
            const semestersPerYear = await getCollegeSemestersPerYear();

            // Populate year filter based on course duration (use duration_years or duration field)
            yearFilter.innerHTML = '<option value="">All Years</option>';
            const courseDuration = course.duration_years || course.duration || 1;
            if (courseDuration && courseDuration > 0) {
                for (let i = 1; i <= courseDuration; i++) {
                    yearFilter.innerHTML += `<option value="${i}">Year ${i}</option>`;
                }
            }

            // Populate semester filter based on college's semesters_per_year setting
            semesterFilter.innerHTML = '<option value="">All Semesters</option>';
            for (let i = 1; i <= semestersPerYear; i++) {
                semesterFilter.innerHTML += `<option value="${i}">Semester ${i}</option>`;
            }
        }

        // Render course units in detail view
        function renderCourseUnitsDetail(courseUnits, course) {
            const container = document.getElementById('course-units-container');
            const yearFilter = document.getElementById('course-units-year-filter');
            const semesterFilter = document.getElementById('course-units-semester-filter');

            const selectedYear = yearFilter.value;
            const selectedSemester = semesterFilter.value;

            // Filter units
            let filteredUnits = courseUnits;
            if (selectedYear) {
                filteredUnits = filteredUnits.filter(cu => cu.year_of_study === parseInt(selectedYear));
            }
            if (selectedSemester) {
                filteredUnits = filteredUnits.filter(cu => cu.semester === parseInt(selectedSemester));
            }

            // Organize by year and semester
            const organized = {};
            filteredUnits.forEach(cu => {
                const key = `year_${cu.year_of_study}_sem_${cu.semester}`;
                if (!organized[key]) {
                    organized[key] = {
                        year: cu.year_of_study,
                        semester: cu.semester,
                        units: []
                    };
                }
                organized[key].units.push(cu);
            });

            const groups = Object.values(organized).sort((a, b) => {
                if (a.year !== b.year) return a.year - b.year;
                return a.semester - b.semester;
            });

            if (groups.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
                        <i class="fas fa-book-open" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                        <p style="font-size: 16px; margin: 0;">No units found for the selected filters</p>
                    </div>
                `;
                return;
            }

            let html = '';
            groups.forEach(group => {
                html += `
                    <div class="year-semester-group" style="margin-bottom: 32px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; background: var(--bg-card);">
                        <div class="group-header" style="background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%); color: white; padding: 16px 20px;">
                            <h4 style="margin: 0; font-size: 16px; font-weight: 600;">
                                Year ${group.year} - Semester ${group.semester}
                            </h4>
                        </div>
                        <div style="padding: 20px;">
                            <div class="units-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                                ${group.units.map(unit => `
                                    <div class="unit-card" style="border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; background: var(--bg-card-hover);">
                                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: var(--text-color); font-size: 14px; margin-bottom: 4px;">${(unit.unit_code || '').toUpperCase()}</div>
                                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">${unit.unit_name}</div>
                                                ${unit.lecturer_name ? `
                                                    <div style="font-size: 12px; color: var(--text-secondary);">
                                                        <i class="fas fa-chalkboard-teacher" style="margin-right: 4px;"></i>
                                                        ${unit.lecturer_name}
                                                    </div>
                                                ` : ''}
                                            </div>
                                            ${(window.USER_ROLE === 'registrar' || window.USER_ROLE === 'principal' || window.USER_ROLE === 'director') ? `
                                                <button class="btn btn-sm btn-danger" onclick="deleteCourseUnit(${unit.id}, event)" style="padding: 4px 8px; font-size: 12px; min-width: auto;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Filter course units
        function filterCourseUnits() {
            if (!currentSelectedCourse) return;
            loadCourseUnitsForDetail(currentSelectedCourse.id, currentSelectedCourse);
        }

        // Open Add Unit dialog
        async function openAddUnitDialog() {
            if (!currentSelectedCourse) {
                showToast('error', 'Please select a course first');
                return;
            }

            // Reset dialog
            selectedUnitsInDialog.clear();
            document.getElementById('add-unit-search').value = '';
            document.getElementById('selected-units-count').textContent = '0';
            document.getElementById('add-unit-year').value = '';
            document.getElementById('add-unit-semester').value = '';

            // Get college semesters per year
            const semestersPerYear = await getCollegeSemestersPerYear();

            // Populate year dropdown based on course duration (use duration_years or duration field)
            const yearSelect = document.getElementById('add-unit-year');
            yearSelect.innerHTML = '<option value="">Select Year</option>';
            const courseDuration = currentSelectedCourse.duration_years || currentSelectedCourse.duration || 1;
            if (courseDuration && courseDuration > 0) {
                for (let i = 1; i <= courseDuration; i++) {
                    yearSelect.innerHTML += `<option value="${i}">Year ${i}</option>`;
                }
            }

            // Populate semester dropdown based on college's semesters_per_year
            const semesterSelect = document.getElementById('add-unit-semester');
            semesterSelect.innerHTML = '<option value="">Select Semester</option>';
            for (let i = 1; i <= semestersPerYear; i++) {
                semesterSelect.innerHTML += `<option value="${i}">Semester ${i}</option>`;
            }

            // Load all units
            await loadAllUnitsForDialog();

            openModal('add-unit-dialog');
        }

        // Load all units for dialog
        async function loadAllUnitsForDialog() {
            const container = document.getElementById('add-unit-units-container');
            container.innerHTML = '<div class="loading-state" style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Loading units...</div>';

            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/units/?page_size=1000`);
                const data = await response.json();
                allUnitsList = data.results || [];
                filteredUnitsInDialog = [...allUnitsList];

                renderUnitsInDialog();
            } catch (error) {
                console.error('Error loading units:', error);
                container.innerHTML = `
                    <div class="error-message" style="padding: 20px; text-align: center; color: var(--error-color);">
                        <i class="fas fa-exclamation-triangle"></i>
                        Failed to load units. Please try again.
                    </div>
                `;
            }
        }

        // Render units in dialog
        function renderUnitsInDialog() {
            const container = document.getElementById('add-unit-units-container');
            const searchTerm = document.getElementById('add-unit-search').value.toLowerCase();

            // Filter units by search term
            filteredUnitsInDialog = allUnitsList.filter(unit => {
                const code = (unit.code || '').toLowerCase();
                const name = (unit.name || '').toLowerCase();
                return code.includes(searchTerm) || name.includes(searchTerm);
            });

            if (filteredUnitsInDialog.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-search" style="font-size: 32px; margin-bottom: 12px; opacity: 0.3;"></i>
                        <p>No units found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; gap: 12px;">
                    ${filteredUnitsInDialog.map(unit => {
                        const isSelected = selectedUnitsInDialog.has(unit.id);
                        return `
                            <label style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; background: ${isSelected ? 'var(--primary-color)' : 'var(--bg-card-hover)'}; cursor: pointer; transition: all 0.2s;">
                                <input type="checkbox" value="${unit.id}" ${isSelected ? 'checked' : ''} onchange="toggleUnitSelection(${unit.id}, this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: ${isSelected ? 'white' : 'var(--text-color)'}; font-size: 14px;">${(unit.code || '').toUpperCase()}</div>
                                    <div style="font-size: 13px; color: ${isSelected ? 'rgba(255,255,255,0.9)' : 'var(--text-secondary)'}; margin-top: 4px;">${unit.name}</div>
                                </div>
                            </label>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Filter units in dialog
        function filterUnitsInDialog() {
            renderUnitsInDialog();
        }

        // Toggle unit selection
        function toggleUnitSelection(unitId, checked) {
            if (checked) {
                selectedUnitsInDialog.add(unitId);
            } else {
                selectedUnitsInDialog.delete(unitId);
            }
            document.getElementById('selected-units-count').textContent = selectedUnitsInDialog.size;
            renderUnitsInDialog();
        }

        // Save units to course
        async function saveUnitsToCourse() {
            const year = document.getElementById('add-unit-year').value;
            const semester = document.getElementById('add-unit-semester').value;

            if (!year || !semester) {
                showToast('error', 'Please select year and semester');
                return;
            }

            if (selectedUnitsInDialog.size === 0) {
                showToast('error', 'Please select at least one unit');
                return;
            }

            if (!currentSelectedCourse) {
                showToast('error', 'Course not selected');
                return;
            }

            const saveBtn = document.getElementById('save-units-btn');
            const btnText = saveBtn.querySelector('.btn-text');
            const btnLoader = saveBtn.querySelector('.btn-loader');

            btnText.style.display = 'none';
            btnLoader.style.display = 'inline-block';
            saveBtn.disabled = true;

            try {
                const unitIds = Array.from(selectedUnitsInDialog);
                let successCount = 0;
                let errorCount = 0;

                // Save each unit
                for (const unitId of unitIds) {
                    try {
                        const response = await fetch(`/api/${window.COLLEGE_SLUG}/courseunits/`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': window.csrftoken || ''
                            },
                            credentials: 'same-origin',
                            body: JSON.stringify({
                                course_id: currentSelectedCourse.id,
                                unit_id: unitId,
                                year_of_study: parseInt(year),
                                semester: parseInt(semester)
                            })
                        });

                        if (response.ok) {
                            successCount++;
                        } else {
                            const errorData = await response.json().catch(() => ({}));
                            if (errorData.error && errorData.error.includes('already assigned')) {
                                // Skip if already assigned
                                successCount++;
                            } else {
                                errorCount++;
                            }
                        }
                    } catch (error) {
                        errorCount++;
                    }
                }

                btnText.style.display = 'inline-block';
                btnLoader.style.display = 'none';
                saveBtn.disabled = false;

                if (successCount > 0) {
                    showToast('success', 'Saved successfully');
                    closeModal('add-unit-dialog');
                    // Reload course units
                    await loadCourseUnitsForDetail(currentSelectedCourse.id, currentSelectedCourse);
                } else {
                    showToast('error', 'Failed to save units');
                }
            } catch (error) {
                console.error('Error saving units:', error);
                btnText.style.display = 'inline-block';
                btnLoader.style.display = 'none';
                saveBtn.disabled = false;
                showToast('error', 'Failed to save units');
            }
        }

        // Expose Course Units functions globally
        window.openCourseUnitModal = openCourseUnitModal;
        window.handleCourseSelection = handleCourseSelection;
        window.handleYearSemesterChange = handleYearSemesterChange;
        window.editCourseUnit = editCourseUnit;
        window.deleteCourseUnit = deleteCourseUnit;
        window.loadCourseUnitManagement = loadCourseUnitManagement;
        window.initializeCourseUnitManagement = initializeCourseUnitManagement;
        window.toggleUnitSelection = toggleUnitSelection;
        
        // New redesigned functions
        window.loadAllCourses = loadAllCourses;
        window.loadAllCoursesPage = loadAllCoursesPage;
        window.filterCourses = filterCourses;
        window.showCoursesList = showCoursesList;
        window.showCourseDetail = showCourseDetail;
        window.filterCourseUnits = filterCourseUnits;
        window.openAddUnitDialog = openAddUnitDialog;
        window.filterUnitsInDialog = filterUnitsInDialog;
        window.saveUnitsToCourse = saveUnitsToCourse;

        // Initialize on page load
        if (document.getElementById('courseunits-section')) {
            initializeCourseUnitManagement().then(async () => {
                await getCollegeSemestersPerYear();
                await loadAllCourses(1);
            });
        }

        // Load lecturer announcements
        async function loadLecturerAnnouncements() {
            const container = document.getElementById('lecturer-announcements-container');
            if (!container) return;

            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/lecturer/announcements/`);
                const data = await response.json();
                
                if (data.announcements && data.announcements.length > 0) {
                    const now = new Date();
                    const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    
                    container.innerHTML = data.announcements.map(ann => {
                        const createdDate = new Date(ann.created_at);
                        const isNew = createdDate > sevenDaysAgo;
                        const priorityClass = ann.priority === 'urgent' ? 'urgent' : ann.priority === 'high' ? 'high' : 'normal';
                        const isExpanded = ann.priority === 'urgent' || ann.priority === 'high';
                        
                        return `
                            <div class="announcement-card ${priorityClass}" style="margin-bottom: 20px; padding: 20px; background: var(--bg-card); border-radius: 8px; border-left: 4px solid ${ann.priority === 'urgent' ? '#334155' : ann.priority === 'high' ? '#475569' : '#64748b'};">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                    <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: var(--text-color);">${escapeHtml(ann.title)}</h3>
                                    <div style="display: flex; gap: 8px;">
                                        ${ann.priority === 'urgent' ? '<span style="padding: 4px 10px; background: rgba(51, 65, 85, 0.2); color: #334155; border-radius: 12px; font-size: 11px; font-weight: 600;"><i class="fas fa-exclamation-circle"></i> Urgent</span>' : ''}
                                        ${ann.priority === 'high' ? '<span style="padding: 4px 10px; background: rgba(71, 85, 105, 0.2); color: #475569; border-radius: 12px; font-size: 11px; font-weight: 600;"><i class="fas fa-exclamation-triangle"></i> High</span>' : ''}
                                        ${isNew ? '<span style="padding: 4px 10px; background: rgba(100, 116, 139, 0.2); color: #64748b; border-radius: 12px; font-size: 11px; font-weight: 600;">New</span>' : ''}
                                    </div>
                                </div>
                                <div style="font-size: 12px; color: var(--text-light); margin-bottom: 12px;">
                                    <i class="fas fa-calendar"></i> ${formatDate(ann.created_at)}
                                    ${ann.expires_at ? ` | <i class="fas fa-clock"></i> Expires: ${formatDate(ann.expires_at)}` : ''}
                                </div>
                                <div class="announcement-content-lecturer ${isExpanded ? 'expanded' : ''}" style="color: var(--text-color); line-height: 1.6; max-height: ${isExpanded ? '1000px' : '100px'}; overflow: hidden; transition: max-height 0.3s; white-space: pre-wrap;">${escapeHtml(ann.content).replace(/\n/g, '<br>')}</div>
                                ${!isExpanded ? '<button onclick="toggleLecturerAnnouncement(this)" style="margin-top: 12px; padding: 8px 16px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Read more <i class="fas fa-chevron-down"></i></button>' : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 80px 20px;">
                            <i class="fas fa-bullhorn" style="font-size: 64px; opacity: 0.3; margin-bottom: 20px;"></i>
                            <p style="font-size: 18px; color: var(--text-light);">No announcements at this time</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading announcements:', error);
                container.innerHTML = `
                    <div class="empty-state" style="padding: 80px 20px;">
                        <i class="fas fa-exclamation-circle" style="font-size: 64px; opacity: 0.3; margin-bottom: 20px;"></i>
                        <p style="font-size: 18px; color: var(--text-light);">Failed to load announcements</p>
                    </div>
                `;
            }
        }

        function toggleLecturerAnnouncement(btn) {
            const card = btn.closest('.announcement-card');
            const content = card.querySelector('.announcement-content-lecturer');
            const isExpanded = content.classList.contains('expanded');
            
            if (isExpanded) {
                content.classList.remove('expanded');
                content.style.maxHeight = '100px';
                btn.innerHTML = 'Read more <i class="fas fa-chevron-down"></i>';
            } else {
                content.classList.add('expanded');
                content.style.maxHeight = '1000px';
                btn.innerHTML = 'Read less <i class="fas fa-chevron-up"></i>';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Make functions globally available
        window.toggleLecturerAnnouncement = toggleLecturerAnnouncement;

        // Function to show a specific section (used by notification dropdown)
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.content-section');
            const navItems = document.querySelectorAll('.nav-item[data-section]');
            
            // Hide all sections
            sections.forEach(function(section) {
                section.classList.remove('active');
            });

            // Show target section
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
            }

            // Update active state in sidebar
            navItems.forEach(function(item) {
                item.classList.remove('active');
            });
            
            const activeNavItem = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }

            // Update active state in top navigation menu
            document.querySelectorAll('.top-nav-menu-link').forEach(function(link) {
                link.classList.remove('active');
            });
            const activeTopNavLink = document.querySelector(`.top-nav-menu-link[data-section="${sectionId}"]`);
            if (activeTopNavLink) {
                activeTopNavLink.classList.add('active');
            }

            // Close mobile sidebar if open
            const sidebar = document.getElementById('sidebar');
            if (sidebar && sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
            }

            // Scroll to top of main content
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                mainContent.scrollTop = 0;
            }

            // Load announcements if navigating to announcements section
            if (sectionId === 'announcements-section') {
                setTimeout(() => {
                    // Switch to view tab by default
                    if (typeof switchAnnouncementsTab === 'function') {
                        switchAnnouncementsTab('view');
                    }
                    // Load lecturer announcements
                    if (typeof loadLecturerAnnouncements === 'function') {
                        loadLecturerAnnouncements();
                    }
                }, 100);
            }

            // Load academic settings if navigating to academic settings section
            if (sectionId === 'academic-settings-section') {
                setTimeout(() => {
                    if (typeof loadAcademicSettings === 'function') {
                        loadAcademicSettings();
                    }
                }, 100);
            }
        }

        // Make showSection globally available
        window.showSection = showSection;

        // Load announcements when section is shown
        // Initialize marks entry system on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load academic year options for unit selection
            if (document.getElementById('unit-selection-year-filter')) {
                loadAcademicYearOptions();
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('.nav-link[data-section="announcements-section"], .top-nav-menu-link[data-section="announcements-section"]');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    setTimeout(() => {
                        // Switch to view tab by default
                        if (typeof switchAnnouncementsTab === 'function') {
                            switchAnnouncementsTab('view');
                        }
                    }, 100);
                });
            });

            // Handle top navigation menu links
            const topNavLinks = document.querySelectorAll('.top-nav-menu-link[data-section]');
            topNavLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    if (sectionId) {
                        showSection(sectionId);
                        // Update active state in top nav
                        document.querySelectorAll('.top-nav-menu-link').forEach(l => l.classList.remove('active'));
                        this.classList.add('active');
                    }
                });
            });

            // Load academic config when section is clicked
            const academicLinks = document.querySelectorAll('.nav-link[data-section="academic-config-section"], .top-nav-menu-link[data-section="academic-config-section"]');
            academicLinks.forEach(link => {
                link.addEventListener('click', function() {
                    setTimeout(() => {
                        // Load the active tab's content
                        const activeTab = document.querySelector('#academic-config-section .tab-btn.active');
                        if (activeTab) {
                            if (activeTab.id === 'academic-settings-top-tab' && typeof loadAcademicSettings === 'function') {
                                loadAcademicSettings();
                            } else if (activeTab.id === 'grading-system-top-tab' && typeof loadGradingSystem === 'function') {
                                loadGradingSystem();
                            } else if (activeTab.id === 'nominal-roll-top-tab' && typeof loadNominalRollSettings === 'function') {
                                loadNominalRollSettings();
                            } else if (activeTab.id === 'transcript-template-top-tab' && typeof loadTranscriptTemplate === 'function') {
                                loadTranscriptTemplate();
                            }
                        } else {
                            // Default to academic settings
                            if (typeof loadAcademicSettings === 'function') {
                                loadAcademicSettings();
                            }
                        }
                    }, 100);
                });
            });
        });

        // ============================================
        // Announcements Management Functions
        // ============================================
        
        let announcementsManagementData = [];
        let announcementsCurrentPage = 1;
        const announcementsItemsPerPage = 10;
        let announcementsStudentsList = [];
        let announcementsLecturersList = [];
        let editingAnnouncementId = null;
        let searchAnnouncementsTimeout = null;
        
        function switchAnnouncementsTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('#announcements-section .tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#announcements-section .tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'view') {
                document.getElementById('view-announcements-tab').classList.add('active');
                document.getElementById('view-announcements-tab-content').classList.add('active');
                loadLecturerAnnouncements();
            } else if (tabName === 'manage') {
                document.getElementById('manage-announcements-tab').classList.add('active');
                document.getElementById('manage-announcements-tab-content').classList.add('active');
                loadAnnouncementsManagement();
                if (announcementsStudentsList.length === 0 || announcementsLecturersList.length === 0) {
                    loadAnnouncementsStudentsAndLecturers();
                }
            }
        }
        
        function debounceSearchAnnouncements() {
            clearTimeout(searchAnnouncementsTimeout);
            searchAnnouncementsTimeout = setTimeout(() => {
                loadAnnouncementsManagement();
            }, 300);
        }
        
        function loadAnnouncementsManagement() {
            if (!window.COLLEGE_SLUG) return;
            
            const tbody = document.getElementById('announcements-tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '<tr><td colspan="7" class="loading-row"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
            
            const params = new URLSearchParams({
                page: announcementsCurrentPage,
                page_size: announcementsItemsPerPage
            });
            
            const search = document.getElementById('announcements-search-input')?.value || '';
            if (search) params.append('search', search);
            
            const targetType = document.getElementById('announcements-target-type-filter')?.value || '';
            if (targetType) params.append('target_type', targetType);
            
            const priority = document.getElementById('announcements-priority-filter')?.value || '';
            if (priority) params.append('priority', priority);
            
            const status = document.getElementById('announcements-status-filter')?.value || '';
            if (status !== '') params.append('is_active', status);
            
            fetch(`/api/${window.COLLEGE_SLUG}/announcements/?${params}`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': window.csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data && data.results) {
                    announcementsManagementData = data.results;
                    renderAnnouncementsManagementTable(announcementsManagementData);
                    renderAnnouncementsPagination(data);
                    const countEl = document.getElementById('announcements-count');
                    if (countEl) {
                        countEl.textContent = `${data.count} announcement${data.count !== 1 ? 's' : ''}`;
                    }
                } else {
                    announcementsManagementData = [];
                    renderAnnouncementsManagementTable([]);
                    renderAnnouncementsPagination({ page: 1, total_pages: 1 });
                    const countEl = document.getElementById('announcements-count');
                    if (countEl) countEl.textContent = '0 announcements';
                }
            })
            .catch(error => {
                console.error('Error loading announcements:', error);
                showToast('error', 'Failed to load announcements');
                tbody.innerHTML = '<tr><td colspan="7" class="error-row">Error loading announcements</td></tr>';
            });
        }
        
        function renderAnnouncementsManagementTable(announcements) {
            const tbody = document.getElementById('announcements-tbody');
            if (!tbody) return;
            
            if (announcements.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-row">No announcements found</td></tr>';
                return;
            }
            
            tbody.innerHTML = announcements.map(ann => {
                const studentsCount = ann.targeted_students ? ann.targeted_students.length : 0;
                const lecturersCount = ann.targeted_users ? ann.targeted_users.length : 0;
                const targetBadge = ann.target_type === 'all_students' 
                    ? '<span class="badge badge-success">All Students</span>'
                    : ann.target_type === 'all_lecturers'
                    ? '<span class="badge badge-primary">All Lecturers</span>'
                    : `<span class="badge badge-warning">Individual (${studentsCount} students, ${lecturersCount} lecturers)</span>`;
                
                const priorityBadge = ann.priority === 'urgent'
                    ? '<span class="badge badge-danger">Urgent</span>'
                    : ann.priority === 'high'
                    ? '<span class="badge badge-warning">High</span>'
                    : '<span class="badge badge-secondary">Normal</span>';
                
                const statusBadge = ann.is_active
                    ? '<span class="badge badge-success">Active</span>'
                    : '<span class="badge badge-secondary">Inactive</span>';
                
                return `
                    <tr>
                        <td><strong>${escapeHtml(ann.title)}</strong></td>
                        <td>${targetBadge}</td>
                        <td>${priorityBadge}</td>
                        <td>${ann.created_by || 'Unknown'}</td>
                        <td>${formatDate(ann.created_at)}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-icon" onclick="viewAnnouncementDetails(${ann.id})" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn-icon" onclick="editAnnouncement(${ann.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn-icon btn-danger" onclick="deleteAnnouncement(${ann.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function renderAnnouncementsPagination(data) {
            const pagination = document.getElementById('announcements-pagination');
            if (!pagination) return;
            
            if (data.total_pages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '<div class="pagination-controls">';
            if (data.previous) {
                html += `<button class="btn btn-sm" onclick="announcementsCurrentPage = ${data.previous}; loadAnnouncementsManagement();">Previous</button>`;
            }
            html += `<span>Page ${data.page} of ${data.total_pages}</span>`;
            if (data.next) {
                html += `<button class="btn btn-sm" onclick="announcementsCurrentPage = ${data.next}; loadAnnouncementsManagement();">Next</button>`;
            }
            html += '</div>';
            pagination.innerHTML = html;
        }
        
        function loadAnnouncementsStudentsAndLecturers() {
            if (!window.COLLEGE_SLUG) return;
            
            // Load students
            fetch(`/api/${window.COLLEGE_SLUG}/students/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': window.csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                announcementsStudentsList = data.results || [];
                const select = document.getElementById('announcement-targeted-students');
                if (select) {
                    select.innerHTML = announcementsStudentsList.map(s => 
                        `<option value="${s.id}">${escapeHtml(s.admission_number)} - ${escapeHtml(s.full_name)}</option>`
                    ).join('');
                }
            })
            .catch(error => console.error('Error loading students:', error));
            
            // Load lecturers
            fetch(`/api/${window.COLLEGE_SLUG}/lecturers/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': window.csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                announcementsLecturersList = data.results || [];
                const select = document.getElementById('announcement-targeted-users');
                if (select) {
                    select.innerHTML = announcementsLecturersList.map(l => 
                        `<option value="${l.id}">${escapeHtml(l.full_name)} (${escapeHtml(l.email)})</option>`
                    ).join('');
                }
            })
            .catch(error => console.error('Error loading lecturers:', error));
        }
        
        function openAnnouncementCreateModal() {
            editingAnnouncementId = null;
            const modal = document.getElementById('announcement-management-modal');
            const title = document.getElementById('announcement-modal-title');
            const form = document.getElementById('announcement-management-form');
            const submitBtn = document.getElementById('announcement-submit-btn');
            
            if (!modal) return;
            
            // Reset form
            form.reset();
            document.getElementById('announcement-id').value = '';
            document.getElementById('individual-targeting-section').style.display = 'none';
            document.getElementById('announcement-target-type').value = '';
            document.getElementById('announcement-priority').value = 'normal';
            updateAnnouncementSelectedCount();
            
            title.textContent = 'Create New Announcement';
            submitBtn.querySelector('.btn-text').textContent = 'Create Announcement';
            
            modal.classList.add('active');
            modal.style.display = 'flex';
            
            // Load students and lecturers if not loaded
            if (announcementsStudentsList.length === 0 || announcementsLecturersList.length === 0) {
                loadAnnouncementsStudentsAndLecturers();
            }
        }
        
        function handleAnnouncementTargetTypeChange() {
            const targetType = document.getElementById('announcement-target-type').value;
            const individualSection = document.getElementById('individual-targeting-section');
            
            if (targetType === 'individual') {
                individualSection.style.display = 'block';
            } else {
                individualSection.style.display = 'none';
                // Clear selections
                document.getElementById('announcement-targeted-students').selectedIndex = -1;
                document.getElementById('announcement-targeted-users').selectedIndex = -1;
                updateAnnouncementSelectedCount();
            }
        }
        
        function switchAnnouncementTargetTab(tabName) {
            document.querySelectorAll('#individual-targeting-section .tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#individual-targeting-section .tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'students') {
                document.querySelector('#individual-targeting-section .tab-btn[onclick*="students"]').classList.add('active');
                document.getElementById('students-target-tab').classList.add('active');
            } else if (tabName === 'lecturers') {
                document.querySelector('#individual-targeting-section .tab-btn[onclick*="lecturers"]').classList.add('active');
                document.getElementById('lecturers-target-tab').classList.add('active');
            }
            
            updateAnnouncementSelectedCount();
        }
        
        function updateAnnouncementSelectedCount() {
            const studentsSelect = document.getElementById('announcement-targeted-students');
            const usersSelect = document.getElementById('announcement-targeted-users');
            const countEl = document.getElementById('announcement-selected-count');
            
            if (!countEl) return;
            
            const studentsCount = studentsSelect ? studentsSelect.selectedOptions.length : 0;
            const lecturersCount = usersSelect ? usersSelect.selectedOptions.length : 0;
            
            document.getElementById('selected-students-count').textContent = `${studentsCount} students`;
            document.getElementById('selected-lecturers-count').textContent = `${lecturersCount} lecturers`;
            
            // Add event listeners if not already added
            if (studentsSelect && !studentsSelect.dataset.listenerAdded) {
                studentsSelect.addEventListener('change', updateAnnouncementSelectedCount);
                studentsSelect.dataset.listenerAdded = 'true';
            }
            if (usersSelect && !usersSelect.dataset.listenerAdded) {
                usersSelect.addEventListener('change', updateAnnouncementSelectedCount);
                usersSelect.dataset.listenerAdded = 'true';
            }
        }
        
        function handleAnnouncementFormSubmit(event) {
            event.preventDefault();
            
            if (!window.COLLEGE_SLUG) return;
            
            const form = event.target;
            const submitBtn = document.getElementById('announcement-submit-btn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoader = submitBtn.querySelector('.btn-loader');
            
            // Get form values
            const title = document.getElementById('announcement-title').value.trim();
            const content = document.getElementById('announcement-content').value.trim();
            const targetType = document.getElementById('announcement-target-type').value;
            const priority = document.getElementById('announcement-priority').value;
            const expiresAt = document.getElementById('announcement-expires-at').value;
            
            // Validation
            if (!title || !content || !targetType) {
                showToast('error', 'Please fill in all required fields');
                return;
            }
            
            if (targetType === 'individual') {
                const studentsSelect = document.getElementById('announcement-targeted-students');
                const usersSelect = document.getElementById('announcement-targeted-users');
                const studentsSelected = studentsSelect ? Array.from(studentsSelect.selectedOptions).map(o => parseInt(o.value)) : [];
                const usersSelected = usersSelect ? Array.from(usersSelect.selectedOptions).map(o => parseInt(o.value)) : [];
                
                if (studentsSelected.length === 0 && usersSelected.length === 0) {
                    showToast('error', 'Please select at least one student or lecturer for individual targeting');
                    return;
                }
            }
            
            // Build request data
            const requestData = {
                title: title,
                content: content,
                target_type: targetType,
                priority: priority
            };
            
            if (expiresAt) {
                requestData.expires_at = expiresAt;
            }
            
            if (targetType === 'individual') {
                const studentsSelect = document.getElementById('announcement-targeted-students');
                const usersSelect = document.getElementById('announcement-targeted-users');
                requestData.targeted_students = studentsSelect ? Array.from(studentsSelect.selectedOptions).map(o => parseInt(o.value)) : [];
                requestData.targeted_users = usersSelect ? Array.from(usersSelect.selectedOptions).map(o => parseInt(o.value)) : [];
            }
            
            const isEdit = editingAnnouncementId !== null;
            const url = isEdit 
                ? `/api/${window.COLLEGE_SLUG}/announcements/${editingAnnouncementId}/`
                : `/api/${window.COLLEGE_SLUG}/announcements/`;
            const method = isEdit ? 'PUT' : 'POST';
            
            // Show loading
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline-block';
            
            fetch(url, {
                method: method,
                headers: {
                    'X-CSRFToken': window.csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast('error', data.error);
                    submitBtn.disabled = false;
                    btnText.style.display = 'inline-block';
                    btnLoader.style.display = 'none';
                    return;
                }
                
                showToast('success', isEdit ? 'Announcement updated successfully' : 'Announcement created successfully');
                closeModal('announcement-management-modal');
                loadAnnouncementsManagement();
            })
            .catch(error => {
                console.error('Error saving announcement:', error);
                showToast('error', 'Error saving announcement');
            })
            .finally(() => {
                submitBtn.disabled = false;
                btnText.style.display = 'inline-block';
                btnLoader.style.display = 'none';
            });
        }
        
        function editAnnouncement(announcementId) {
            if (!window.COLLEGE_SLUG) return;
            
            editingAnnouncementId = announcementId;
            const modal = document.getElementById('announcement-management-modal');
            const title = document.getElementById('announcement-modal-title');
            const submitBtn = document.getElementById('announcement-submit-btn');
            
            if (!modal) return;
            
            fetch(`/api/${window.COLLEGE_SLUG}/announcements/${announcementId}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': window.csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast('error', data.error);
                    return;
                }
                
                // Populate form
                document.getElementById('announcement-id').value = data.id;
                document.getElementById('announcement-title').value = data.title || '';
                document.getElementById('announcement-content').value = data.content || '';
                document.getElementById('announcement-target-type').value = data.target_type || '';
                document.getElementById('announcement-priority').value = data.priority || 'normal';
                
                if (data.expires_at) {
                    const expiresDate = new Date(data.expires_at);
                    const localDate = new Date(expiresDate.getTime() - expiresDate.getTimezoneOffset() * 60000);
                    document.getElementById('announcement-expires-at').value = localDate.toISOString().slice(0, 16);
                }
                
                handleAnnouncementTargetTypeChange();
                
                // Set individual targeting if applicable
                if (data.target_type === 'individual') {
                    if (data.targeted_students && data.targeted_students.length > 0) {
                        const studentsSelect = document.getElementById('announcement-targeted-students');
                        data.targeted_students.forEach(studentId => {
                            const option = studentsSelect.querySelector(`option[value="${studentId}"]`);
                            if (option) option.selected = true;
                        });
                    }
                    if (data.targeted_users && data.targeted_users.length > 0) {
                        const usersSelect = document.getElementById('announcement-targeted-users');
                        data.targeted_users.forEach(userId => {
                            const option = usersSelect.querySelector(`option[value="${userId}"]`);
                            if (option) option.selected = true;
                        });
                    }
                    updateAnnouncementSelectedCount();
                }
                
                title.textContent = 'Edit Announcement';
                submitBtn.querySelector('.btn-text').textContent = 'Update Announcement';
                
                modal.classList.add('active');
                modal.style.display = 'flex';
                
                // Load students and lecturers if not loaded
                if (announcementsStudentsList.length === 0 || announcementsLecturersList.length === 0) {
                    loadAnnouncementsStudentsAndLecturers();
                }
            })
            .catch(error => {
                console.error('Error loading announcement:', error);
                showToast('error', 'Error loading announcement details');
            });
        }
        
        function viewAnnouncementDetails(announcementId) {
            if (!window.COLLEGE_SLUG) return;
            
            const modal = document.getElementById('announcement-view-modal');
            const content = document.getElementById('announcement-view-content');
            const title = document.getElementById('announcement-view-title');
            
            if (!modal) return;
            
            fetch(`/api/${window.COLLEGE_SLUG}/announcements/${announcementId}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': window.csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast('error', data.error);
                    return;
                }
                
                const studentsCount = data.targeted_students ? data.targeted_students.length : 0;
                const lecturersCount = data.targeted_users ? data.targeted_users.length : 0;
                const targetInfo = data.target_type === 'all_students'
                    ? 'All Students'
                    : data.target_type === 'all_lecturers'
                    ? 'All Lecturers'
                    : `Individual (${studentsCount} students, ${lecturersCount} lecturers)`;
                
                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="margin: 0 0 12px 0; color: var(--text-color);">${escapeHtml(data.title)}</h3>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
                            <span class="badge badge-${data.priority === 'urgent' ? 'danger' : data.priority === 'high' ? 'warning' : 'secondary'}">${data.priority || 'Normal'}</span>
                            <span class="badge badge-${data.is_active ? 'success' : 'secondary'}">${data.is_active ? 'Active' : 'Inactive'}</span>
                            <span class="badge badge-primary">${targetInfo}</span>
                        </div>
                        <div style="font-size: 14px; color: var(--text-light);">
                            <p style="margin: 4px 0;"><strong>Created by:</strong> ${data.created_by || 'Unknown'}</p>
                            <p style="margin: 4px 0;"><strong>Created at:</strong> ${formatDate(data.created_at)}</p>
                            ${data.expires_at ? `<p style="margin: 4px 0;"><strong>Expires at:</strong> ${formatDate(data.expires_at)}</p>` : ''}
                        </div>
                    </div>
                    <div style="padding: 16px; background: var(--bg-hover); border-radius: 8px; white-space: pre-wrap; color: var(--text-color);">
                        ${escapeHtml(data.content).replace(/\n/g, '<br>')}
                    </div>
                `;
                
                title.textContent = 'Announcement Details';
                modal.classList.add('active');
                modal.style.display = 'flex';
            })
            .catch(error => {
                console.error('Error loading announcement:', error);
                showToast('error', 'Error loading announcement details');
            });
        }
        
        function deleteAnnouncement(announcementId) {
            if (!confirm('Are you sure you want to delete this announcement?')) return;
            if (!window.COLLEGE_SLUG) return;
            
            fetch(`/api/${window.COLLEGE_SLUG}/announcements/${announcementId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': window.csrftoken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast('error', data.error);
                    return;
                }
                
                showToast('success', 'Announcement deleted successfully');
                loadAnnouncementsManagement();
            })
            .catch(error => {
                console.error('Error deleting announcement:', error);
                showToast('error', 'Error deleting announcement');
            });
        }
        
        // Make functions globally available
        window.switchAnnouncementsTab = switchAnnouncementsTab;
        window.openAnnouncementCreateModal = openAnnouncementCreateModal;
        window.handleAnnouncementTargetTypeChange = handleAnnouncementTargetTypeChange;
        window.switchAnnouncementTargetTab = switchAnnouncementTargetTab;
        window.handleAnnouncementFormSubmit = handleAnnouncementFormSubmit;
        window.editAnnouncement = editAnnouncement;
        window.viewAnnouncementDetails = viewAnnouncementDetails;
        window.deleteAnnouncement = deleteAnnouncement;
        window.debounceSearchAnnouncements = debounceSearchAnnouncements;
        window.loadAnnouncementsManagement = loadAnnouncementsManagement;

        // Load notification count
        async function loadNotificationCount() {
            if (!window.COLLEGE_SLUG) return;
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/lecturer/announcements/new-count/`);
                const data = await response.json();
                
                const badge = document.getElementById('notification-count');
                if (badge) {
                    if (data.new_count > 0) {
                        badge.textContent = data.new_count > 99 ? '99+' : data.new_count;
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                        badge.textContent = '0';
                    }
                }
            } catch (error) {
                console.error('Error loading notification count:', error);
            }
        }

        // Load notification dropdown content
        async function loadNotificationDropdown() {
            if (!window.COLLEGE_SLUG) return;
            
            const list = document.getElementById('notification-list');
            if (!list) return;
            
            list.innerHTML = '<div class="no-notifications"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/lecturer/announcements/`);
                const data = await response.json();
                
                if (data.announcements && data.announcements.length > 0) {
                    const now = new Date();
                    const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    
                    // Filter to only show announcements from last 7 days
                    const recentAnnouncements = data.announcements.filter(ann => {
                        const createdDate = new Date(ann.created_at);
                        return createdDate > sevenDaysAgo;
                    }).slice(0, 5); // Show max 5 recent announcements
                    
                    if (recentAnnouncements.length > 0) {
                        list.innerHTML = recentAnnouncements.map(ann => {
                            const priorityClass = ann.priority === 'urgent' ? 'priority-urgent' : ann.priority === 'high' ? 'priority-high' : '';
                            const createdDate = new Date(ann.created_at);
                            const timeAgo = getTimeAgo(createdDate);
                            
                            return `
                                <div class="notification-item ${priorityClass}" onclick="showSection('announcements-section'); document.getElementById('notification-menu').classList.remove('active');">
                                    <div style="font-weight: 600; font-size: 14px; color: var(--text-color, #ffffff); margin-bottom: 6px; line-height: 1.3;">${escapeHtml(ann.title)}</div>
                                    <div style="font-size: 12px; color: var(--text-light, #b0b0b0); line-height: 1.5; margin-bottom: 8px; word-wrap: break-word; overflow-wrap: break-word; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${escapeHtml(ann.content.substring(0, 100))}${ann.content.length > 100 ? '...' : ''}</div>
                                    <div style="font-size: 11px; color: var(--text-light, #888888); margin-top: 4px; display: flex; align-items: center; gap: 4px;">
                                        <i class="fas fa-clock" style="font-size: 10px;"></i>
                                        <span>${timeAgo}</span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        list.innerHTML = '<div class="no-notifications">No new announcements</div>';
                    }
                } else {
                    list.innerHTML = '<div class="no-notifications">No new announcements</div>';
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                list.innerHTML = '<div class="no-notifications">Error loading announcements</div>';
            }
        }

        // Helper function to get time ago
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            return formatDate(date);
        }
        // ==================== Report Editor Functions ====================
        
        // Helper functions to get active editor elements (support main editor, modal, and embedded editors)
        function getActiveEditorPrefix() {
            const modal = document.getElementById('report-editor-modal');
            if (modal && modal.style.display === 'flex') {
                return 'modal-';
            }
            const embeddedEditor = document.getElementById('embedded-report-editor');
            if (embeddedEditor && embeddedEditor.style.display !== 'none') {
                return 'embedded-';
            }
            return '';
        }
        
        function getElement(id) {
            const prefix = getActiveEditorPrefix();
            const prefixedId = prefix ? prefix + id : id;
            const mainId = id;
            
            // Try prefixed first if prefix exists, then main
            if (prefix) {
                const elem = document.getElementById(prefixedId);
                if (elem) return elem;
            }
            return document.getElementById(mainId);
        }
        let currentReportTemplate = null;
        let selectedElement = null;
        let reportElements = [];
        let elementIdCounter = 0;
        let canEditReports = false;

        // Page size dimensions in pixels (width  height at 96 DPI)
        const PAGE_DIMENSIONS = {
            'A4': { width: 794, height: 1123 },
            'A3': { width: 1123, height: 1587 },
            'A5': { width: 559, height: 794 },
            'Letter': { width: 816, height: 1056 }
        };

        // Load templates list
        async function loadReportTemplates() {
            if (!window.COLLEGE_SLUG) return;
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/reports/templates/`, {
                    headers: {
                        'X-CSRFToken': window.csrftoken
                    }
                });
                const data = await response.json();
                
                if (data.error) {
                    showToast('error', data.error);
                    return;
                }
                
                canEditReports = data.can_edit || false;
                const templatesList = document.getElementById('report-templates-list');
                const modalTemplatesList = document.getElementById('modal-report-templates-list');
                
                if (!templatesList) return;
                
                if (data.templates.length === 0) {
                    templatesList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-light);">No templates found</div>';
                    return;
                }
                
                templatesList.innerHTML = data.templates.map(template => `
                    <div class="template-item" onclick="selectReportTemplate(${template.id})" style="padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s; ${currentReportTemplate && currentReportTemplate.id === template.id ? 'background: var(--primary-blue-light); border-color: var(--primary-blue);' : ''}" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='${currentReportTemplate && currentReportTemplate.id === template.id ? 'var(--primary-blue-light)' : 'transparent'}'">
                        <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(template.name)}</div>
                        <div style="font-size: 12px; color: var(--text-light);">${template.report_type}  ${template.is_active ? 'Active' : 'Inactive'}</div>
                    </div>
                `).join('');
                
                // Also update modal templates list if it exists
                if (modalTemplatesList) {
                    modalTemplatesList.innerHTML = templatesList.innerHTML;
                }
            } catch (error) {
                console.error('Error loading templates:', error);
                showToast('error', 'Error loading report templates');
            }
        }

        // Select a template
        async function selectReportTemplate(templateId) {
            if (!window.COLLEGE_SLUG) return;
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/reports/templates/${templateId}/`, {
                    headers: {
                        'X-CSRFToken': window.csrftoken
                    }
                });
                const data = await response.json();
                
                if (data.error) {
                    showToast('error', data.error);
                    return;
                }
                
                currentReportTemplate = data;
                reportElements = data.elements || [];
                elementIdCounter = reportElements.length > 0 ? Math.max(...reportElements.map(e => e.id || 0)) + 1 : 1;
                
                // Update UI (using helper function to support modal and main editors)
                const nameInput = getElement('template-name');
                const descInput = getElement('template-description');
                const typeInput = getElement('template-report-type');
                
                if (nameInput) nameInput.value = data.name || '';
                if (descInput) descInput.value = data.description || '';
                if (typeInput) typeInput.value = data.report_type || 'custom';
                
                // Set page size (default to A4 if not set)
                const pageSize = data.page_size || 'A4';
                const pageSizeSelector = getElement('page-size-selector') || document.getElementById('page-size-selector');
                const pageSizeSelectorSidebar = getElement('page-size-selector-sidebar') || document.getElementById('page-size-selector-sidebar');
                const modalPageSizeSelector = document.getElementById('modal-page-size-selector');
                
                if (pageSizeSelector) pageSizeSelector.value = pageSize;
                if (pageSizeSelectorSidebar) pageSizeSelectorSidebar.value = pageSize;
                if (modalPageSizeSelector) modalPageSizeSelector.value = pageSize;
                
                // Update canvas dimensions
                const widthInput = getElement('canvas-width');
                const heightInput = getElement('canvas-height');
                
                const canvasWidth = data.canvas_width || PAGE_DIMENSIONS[pageSize].width;
                const canvasHeight = data.canvas_height || PAGE_DIMENSIONS[pageSize].height;
                
                if (widthInput) widthInput.value = canvasWidth;
                if (heightInput) heightInput.value = canvasHeight;
                
                updateCanvasSize();
                updateCanvasGuides();
                renderReportElements();
                
                // Show/hide tools based on permissions
                const toolsPanel = getElement('report-editor-tools') || document.getElementById('report-editor-tools');
                const modalToolsPanel = document.getElementById('modal-report-editor-tools');
                if (toolsPanel) {
                    toolsPanel.style.display = data.can_edit ? 'block' : 'none';
                }
                if (modalToolsPanel) {
                    modalToolsPanel.style.display = data.can_edit ? 'block' : 'none';
                }
                
                // Reload templates list to update active state
                loadReportTemplates();
            } catch (error) {
                console.error('Error loading template:', error);
                showToast('error', 'Error loading template');
            }
        }

        // Handle page size change
        function handlePageSizeChange() {
            // Check all page size selectors (toolbar, sidebar, modal)
            const pageSizeSelector = document.getElementById('page-size-selector');
            const pageSizeSelectorSidebar = document.getElementById('page-size-selector-sidebar');
            const pageSizeSelectorToolbar = document.getElementById('page-size-selector-toolbar');
            const modalPageSizeSelector = document.getElementById('modal-page-size-selector');
            const modalPageSizeSelectorSidebar = document.getElementById('modal-page-size-selector-sidebar');
            
            // Get the value from whichever selector was changed
            const selectedPageSize = pageSizeSelectorToolbar ? pageSizeSelectorToolbar.value : 
                                    (pageSizeSelector ? pageSizeSelector.value : 
                                    (pageSizeSelectorSidebar ? pageSizeSelectorSidebar.value : 
                                    (modalPageSizeSelector ? modalPageSizeSelector.value :
                                    (modalPageSizeSelectorSidebar ? modalPageSizeSelectorSidebar.value : 'A4'))));
            
            // Sync all selectors
            if (pageSizeSelector) pageSizeSelector.value = selectedPageSize;
            if (pageSizeSelectorSidebar) pageSizeSelectorSidebar.value = selectedPageSize;
            if (pageSizeSelectorToolbar) pageSizeSelectorToolbar.value = selectedPageSize;
            if (modalPageSizeSelector) modalPageSizeSelector.value = selectedPageSize;
            if (modalPageSizeSelectorSidebar) modalPageSizeSelectorSidebar.value = selectedPageSize;
            if (pageSizeSelector && pageSizeSelectorSidebar) {
                pageSizeSelector.value = selectedPageSize;
                pageSizeSelectorSidebar.value = selectedPageSize;
            }
            
            // Get dimensions for selected page size
            const dimensions = PAGE_DIMENSIONS[selectedPageSize] || PAGE_DIMENSIONS['A4'];
            
            // Update canvas dimensions
            document.getElementById('canvas-width').value = dimensions.width;
            document.getElementById('canvas-height').value = dimensions.height;
            
            // Update canvas size
            updateCanvasSize();
        }

        // Update canvas size
        function updateCanvasSize() {
            const canvas = getElement('report-canvas');
            // Check both toolbar and sidebar inputs
            const widthInput = getElement('canvas-width') || document.getElementById('canvas-width-toolbar');
            const heightInput = getElement('canvas-height') || document.getElementById('canvas-height-toolbar');
            const width = widthInput ? parseInt(widthInput.value) || PAGE_DIMENSIONS['A4'].width : PAGE_DIMENSIONS['A4'].width;
            const height = heightInput ? parseInt(heightInput.value) || PAGE_DIMENSIONS['A4'].height : PAGE_DIMENSIONS['A4'].height;
            
            // Sync all width/height inputs
            const allWidthInputs = document.querySelectorAll('#canvas-width, #canvas-width-toolbar, #modal-canvas-width');
            const allHeightInputs = document.querySelectorAll('#canvas-height, #canvas-height-toolbar, #modal-canvas-height');
            allWidthInputs.forEach(input => { if (input) input.value = width; });
            allHeightInputs.forEach(input => { if (input) input.value = height; });
            
            if (canvas) {
                canvas.style.width = width + 'px';
                canvas.style.height = height + 'px';
                // Update guide lines when canvas size changes
                updateCanvasGuides();
            }
        }

        // Draw alignment guides on canvas with full grid pattern
        function updateCanvasGuides() {
            const canvas = getElement('report-canvas');
            if (!canvas) return;
            
            const guidesContainer = document.getElementById('canvas-guides') || document.getElementById('modal-canvas-guides');
            if (!guidesContainer) return;
            
            // Check if grid is enabled
            const gridToggle = document.getElementById('toggle-grid') || document.getElementById('modal-toggle-grid');
            const gridEnabled = gridToggle ? gridToggle.checked : true;
            
            const width = parseInt(canvas.style.width) || canvas.offsetWidth || 794;
            const height = parseInt(canvas.style.height) || canvas.offsetHeight || 1123;
            
            // Default margin (72 points = 1 inch, converted to pixels at 96 DPI = 96px)
            const margin = 96;
            const gridSpacing = 20; // Grid spacing in pixels
            
            // Clear existing guides
            guidesContainer.innerHTML = '';
            
            if (!gridEnabled) {
                return; // Don't render grid if disabled
            }
            
            // Create SVG overlay for guides - positioned above canvas background but below content
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.style.position = 'absolute';
            svg.style.top = '0';
            svg.style.left = '0';
            svg.style.width = '100%';
            svg.style.height = '100%';
            svg.style.pointerEvents = 'none';
            svg.style.zIndex = '1'; // Above canvas background, below content
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.setAttribute('class', 'canvas-grid-overlay');
            svg.setAttribute('data-print-ignore', 'true'); // Mark for print exclusion
            
            // Draw full grid pattern (vertical and horizontal lines)
            // Vertical grid lines
            for (let x = 0; x <= width; x += gridSpacing) {
                const gridLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                gridLine.setAttribute('x1', x);
                gridLine.setAttribute('y1', 0);
                gridLine.setAttribute('x2', x);
                gridLine.setAttribute('y2', height);
                gridLine.setAttribute('stroke', 'rgba(0,0,0,0.15)');
                gridLine.setAttribute('stroke-width', '1');
                svg.appendChild(gridLine);
            }
            
            // Horizontal grid lines
            for (let y = 0; y <= height; y += gridSpacing) {
                const gridLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                gridLine.setAttribute('x1', 0);
                gridLine.setAttribute('y1', y);
                gridLine.setAttribute('x2', width);
                gridLine.setAttribute('y2', y);
                gridLine.setAttribute('stroke', 'rgba(0,0,0,0.15)');
                gridLine.setAttribute('stroke-width', '1');
                svg.appendChild(gridLine);
            }
            
            // Center lines (vertical + horizontal) - more visible
            const centerX = width / 2;
            const centerY = height / 2;
            
            // Vertical center line
            const vCenterLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            vCenterLine.setAttribute('x1', centerX);
            vCenterLine.setAttribute('y1', 0);
            vCenterLine.setAttribute('x2', centerX);
            vCenterLine.setAttribute('y2', height);
            vCenterLine.setAttribute('stroke', 'rgba(0,0,0,0.15)');
            vCenterLine.setAttribute('stroke-width', '1');
            svg.appendChild(vCenterLine);
            
            // Horizontal center line
            const hCenterLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            hCenterLine.setAttribute('x1', 0);
            hCenterLine.setAttribute('y1', centerY);
            hCenterLine.setAttribute('x2', width);
            hCenterLine.setAttribute('y2', centerY);
            hCenterLine.setAttribute('stroke', 'rgba(0,0,0,0.15)');
            hCenterLine.setAttribute('stroke-width', '1');
            svg.appendChild(hCenterLine);
            
            // Margin guide lines - more visible (rgba(0,0,0,0.3))
            // Top margin
            const topMargin = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            topMargin.setAttribute('x1', 0);
            topMargin.setAttribute('y1', margin);
            topMargin.setAttribute('x2', width);
            topMargin.setAttribute('y2', margin);
            topMargin.setAttribute('stroke', 'rgba(0,0,0,0.3)');
            topMargin.setAttribute('stroke-width', '1');
            svg.appendChild(topMargin);
            
            // Bottom margin
            const bottomMargin = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            bottomMargin.setAttribute('x1', 0);
            bottomMargin.setAttribute('y1', height - margin);
            bottomMargin.setAttribute('x2', width);
            bottomMargin.setAttribute('y2', height - margin);
            bottomMargin.setAttribute('stroke', 'rgba(0,0,0,0.3)');
            bottomMargin.setAttribute('stroke-width', '1');
            svg.appendChild(bottomMargin);
            
            // Left margin
            const leftMargin = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            leftMargin.setAttribute('x1', margin);
            leftMargin.setAttribute('y1', 0);
            leftMargin.setAttribute('x2', margin);
            leftMargin.setAttribute('y2', height);
            leftMargin.setAttribute('stroke', 'rgba(0,0,0,0.3)');
            leftMargin.setAttribute('stroke-width', '1');
            svg.appendChild(leftMargin);
            
            // Right margin
            const rightMargin = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            rightMargin.setAttribute('x1', width - margin);
            rightMargin.setAttribute('y1', 0);
            rightMargin.setAttribute('x2', width - margin);
            rightMargin.setAttribute('y2', height);
            rightMargin.setAttribute('stroke', 'rgba(0,0,0,0.3)');
            rightMargin.setAttribute('stroke-width', '1');
            svg.appendChild(rightMargin);
            
            guidesContainer.appendChild(svg);
        }
        
        // Toggle grid visibility
        function toggleGrid() {
            const gridToggle = document.getElementById('toggle-grid') || document.getElementById('modal-toggle-grid');
            if (gridToggle) {
                updateCanvasGuides();
            }
        }
        
        // Toggle margins visibility
        function toggleMargins() {
            // Margins are always shown when grid is enabled
            updateCanvasGuides();
        }

        // Snap element to nearest guide
        function snapToGuides(x, y, canvasWidth, canvasHeight) {
            const snapEnabled = document.getElementById('snap-to-guides')?.checked || 
                               document.getElementById('modal-snap-to-guides')?.checked || 
                               true;
            
            if (!snapEnabled) return { x: x, y: y };
            
            const snapThreshold = 10; // pixels
            const margin = 96;
            const centerX = canvasWidth / 2;
            const centerY = canvasHeight / 2;
            
            let snappedX = x;
            let snappedY = y;
            
            // Snap to vertical center
            if (Math.abs(x - centerX) < snapThreshold) {
                snappedX = centerX;
            }
            
            // Snap to horizontal center
            if (Math.abs(y - centerY) < snapThreshold) {
                snappedY = centerY;
            }
            
            // Snap to margins
            if (Math.abs(x - margin) < snapThreshold) {
                snappedX = margin;
            } else if (Math.abs(x - (canvasWidth - margin)) < snapThreshold) {
                snappedX = canvasWidth - margin;
            }
            
            if (Math.abs(y - margin) < snapThreshold) {
                snappedY = margin;
            } else if (Math.abs(y - (canvasHeight - margin)) < snapThreshold) {
                snappedY = canvasHeight - margin;
            }
            
            return { x: snappedX, y: snappedY };
        }

        // Render report elements on canvas
        function renderReportElements() {
            const canvas = getElement('report-canvas');
            if (!canvas) return;
            
            // Preserve guides overlay when clearing canvas
            const guidesContainer = canvas.querySelector('#canvas-guides') || canvas.querySelector('#modal-canvas-guides');
            const emptyMessage = canvas.querySelector('div[style*="text-align: center"]');
            
            // Clear canvas
            canvas.innerHTML = '';
            
            // Restore guides overlay if it exists
            if (guidesContainer) {
                canvas.appendChild(guidesContainer);
            }
            
            // Restore empty message if no elements
            if (reportElements.length === 0 && emptyMessage) {
                canvas.appendChild(emptyMessage);
            }
            
            // Render each element
            reportElements.forEach(element => {
                const elementDiv = document.createElement('div');
                elementDiv.id = `element-${element.id}`;
                elementDiv.className = 'report-element';
                elementDiv.style.position = 'absolute';
                elementDiv.style.left = element.x + 'px';
                elementDiv.style.top = element.y + 'px';
                elementDiv.style.fontFamily = element.fontFamily || 'Arial';
                elementDiv.style.fontSize = (element.fontSize || 12) + 'px';
                elementDiv.style.textAlign = element.textAlign || 'left';
                elementDiv.style.cursor = canEditReports ? 'move' : 'default';
                elementDiv.style.border = canEditReports ? '2px dashed transparent' : 'none';
                elementDiv.style.padding = '4px';
                elementDiv.style.minWidth = '20px';
                elementDiv.style.minHeight = '20px';
                // Ensure content is above grid layer
                elementDiv.style.zIndex = '10';
                
                if (element.type === 'text' || element.type === 'placeholder') {
                    // Check if it's a data-bound placeholder
                    if (element.isDataBound && element.dataKey) {
                        const placeholderInfo = PLACEHOLDER_CATALOG[element.dataKey] || { label: element.dataKey };
                        const displayText = '[' + placeholderInfo.label + ']';
                        elementDiv.innerHTML = '<span style="background: #fff3cd; padding: 2px 6px; border-radius: 3px; border: 1px dashed #ffc107; font-weight: 500;">' + displayText + '</span>';
                        elementDiv.style.color = element.color || '#856404';
                        elementDiv.title = 'Data Key: ' + element.dataKey;
                    } else if (element.isPlaceholder || (element.content && element.content.includes('{{'))) {
                        // Legacy placeholder format
                        elementDiv.innerHTML = '<span style="background: #fff3cd; padding: 2px 6px; border-radius: 3px; border: 1px dashed #ffc107;">' + (element.content || '') + '</span>';
                        elementDiv.style.color = element.color || '#856404';
                    } else {
                    elementDiv.textContent = element.content || '';
                    elementDiv.style.color = element.color || '#000000';
                    }
                } else if (element.type === 'image' || element.type === 'logo') {
                    const img = document.createElement('img');
                    img.src = element.content || '';
                    img.style.maxWidth = (element.width || 200) + 'px';
                    img.style.maxHeight = (element.height || 200) + 'px';
                    img.style.objectFit = 'contain';
                    elementDiv.appendChild(img);
                } else if (element.type === 'table') {
                    // Render table placeholder with column structure
                    // Force white background and black text (ignore theme colors)
                    const tableInfo = PLACEHOLDER_CATALOG[element.dataKey || element.placeholder] || { label: 'Table' };
                    const tableWidth = element.width || 600;
                    const tableHeight = element.height || 200;
                    const tableConfig = element.tableConfig || {};
                    const columns = tableConfig.columns || [];
                    
                    // Build table preview HTML - FORCE white background, black text, and visible borders
                    // Use actual HTML table with explicit borders for better print/export support
                    let tableHTML = '<div style="background: #ffffff !important; padding: 8px; border-radius: 3px; border: 1px solid #000000 !important; min-width: ' + tableWidth + 'px; min-height: ' + tableHeight + 'px; color: #000000 !important;">';
                    tableHTML += '<div style="font-weight: 600; margin-bottom: 8px; font-size: 12px; color: #000000 !important;"><i class="fas fa-table"></i> ' + tableInfo.label + '</div>';
                    
                    if (columns.length > 0) {
                        // Use actual HTML table with explicit borders
                        tableHTML += '<table style="width: 100%; border-collapse: collapse; border: 1px solid #000000 !important; background: #ffffff !important;">';
                        
                        // Render header row with borders
                        tableHTML += '<thead><tr style="background: #ffffff !important;">';
                        columns.forEach(function(col) {
                            const colWidth = col.width || 80;
                            const alignment = col.alignment || 'left';
                            tableHTML += '<th style="border: 1px solid #000000 !important; padding: 4px 8px; text-align: ' + alignment + '; font-weight: 600; font-size: 11px; color: #000000 !important; background: #ffffff !important; min-width: ' + colWidth + 'px;">' + (col.header || col.field || '') + '</th>';
                        });
                        tableHTML += '</tr></thead>';
                        
                        // Render sample data row with borders
                        tableHTML += '<tbody><tr style="background: #ffffff !important;">';
                        columns.forEach(function(col) {
                            const colWidth = col.width || 80;
                            const alignment = col.alignment || 'left';
                            tableHTML += '<td style="border: 1px solid #000000 !important; padding: 4px 8px; text-align: ' + alignment + '; font-size: 10px; color: #000000 !important; background: #ffffff !important; min-width: ' + colWidth + 'px;">...</td>';
                        });
                        tableHTML += '</tr></tbody>';
                        
                        tableHTML += '</table>';
                    } else {
                        tableHTML += '<div style="color: #000000 !important; font-size: 11px; padding: 8px;">No columns defined. Add columns in the properties panel.</div>';
                    }
                    
                    tableHTML += '</div>';
                    elementDiv.innerHTML = tableHTML;
                    elementDiv.style.width = (element.width || 600) + 'px';
                    elementDiv.style.height = (element.height || 200) + 'px';
                    // Force white background on the element div itself
                    elementDiv.style.backgroundColor = '#ffffff';
                    elementDiv.style.color = '#000000';
                    // Ensure table borders are always visible
                    elementDiv.style.border = canEditReports ? '2px dashed transparent' : 'none';
                    // Set z-index to be above grid
                    elementDiv.style.zIndex = '10';
                }
                
                // Set width and height if specified
                if (element.width) elementDiv.style.width = element.width + 'px';
                if (element.height) elementDiv.style.height = element.height + 'px';
                
                if (canEditReports) {
                    elementDiv.addEventListener('click', (e) => {
                        e.stopPropagation();
                        selectElement(element.id);
                    });
                    
                    elementDiv.addEventListener('mouseenter', () => {
                        if (selectedElement !== element.id) {
                            elementDiv.style.borderColor = '#3b82f6';
                        }
                    });
                    
                    elementDiv.addEventListener('mouseleave', () => {
                        if (selectedElement !== element.id) {
                            elementDiv.style.borderColor = 'transparent';
                        }
                    });
                    
                    // Make draggable
                    makeElementDraggable(elementDiv, element.id);
                    addResizeHandles(elementDiv, element.id);
                }
                
                canvas.appendChild(elementDiv);
            });
        }

        // Add resize handles to element
        function addResizeHandles(elementDiv, elementId) {
            if (!canEditReports) return;

            const element = reportElements.find(el => el.id === elementId);
            if (!element) return;

            // Only add resize handles for elements that support resizing
            if (element.type === 'image' || element.type === 'logo' || element.type === 'table' || element.type === 'placeholder') {
                const handle = document.createElement('div');
                handle.className = 'resize-handle';
                handle.style.position = 'absolute';
                handle.style.width = '10px';
                handle.style.height = '10px';
                handle.style.background = '#3b82f6';
                handle.style.border = '2px solid white';
                handle.style.borderRadius = '50%';
                handle.style.cursor = 'nwse-resize';
                handle.style.bottom = '-5px';
                handle.style.right = '-5px';
                handle.style.zIndex = '1000';
                handle.style.display = selectedElement === elementId ? 'block' : 'none';

                let isResizing = false;
                let startX, startY, startWidth, startHeight;

                handle.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    isResizing = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = element.width || 200;
                    startHeight = element.height || 200;
                    document.addEventListener('mousemove', handleResize);
                    document.addEventListener('mouseup', stopResize);
                });

                function handleResize(e) {
                    if (!isResizing) return;
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    element.width = Math.max(50, startWidth + deltaX);
                    element.height = Math.max(20, startHeight + deltaY);
                    elementDiv.style.width = element.width + 'px';
                    elementDiv.style.height = element.height + 'px';
                    renderReportElements();
                }

                function stopResize() {
                    isResizing = false;
                    document.removeEventListener('mousemove', handleResize);
                    document.removeEventListener('mouseup', stopResize);
                }

                elementDiv.appendChild(handle);

                // Show/hide handle on selection
                if (selectedElement === elementId) {
                    handle.style.display = 'block';
                }
            }
        }

        // Make element draggable
        function makeElementDraggable(elementDiv, elementId) {
            let isDragging = false;
            let startX, startY, initialX, initialY;
            
            elementDiv.addEventListener('mousedown', (e) => {
                if (!canEditReports) return;
                // Don't start dragging if clicking on resize handle
                if (e.target.classList.contains('resize-handle')) {
                    return;
                }
                
                isDragging = true;
                selectElement(elementId);
                
                const canvas = getElement('report-canvas') || document.getElementById('report-canvas');
                if (!canvas) return;
                
                const canvasRect = canvas.getBoundingClientRect();
                const elementRect = elementDiv.getBoundingClientRect();
                
                // Store initial mouse position relative to canvas
                const mouseX = e.clientX - canvasRect.left;
                const mouseY = e.clientY - canvasRect.top;
                
                // Store initial element position
                const element = reportElements.find(el => el.id === elementId);
                if (element) {
                    initialX = element.x || 0;
                    initialY = element.y || 0;
                    
                    // Calculate offset from where mouse was clicked on the element
                    // This is the distance from the element's top-left to where the mouse was clicked
                    startX = mouseX - initialX;
                    startY = mouseY - initialY;
                } else {
                    startX = mouseX;
                    startY = mouseY;
                }
                
                e.preventDefault();
                e.stopPropagation();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging || !canEditReports) return;
                
                const element = reportElements.find(el => el.id === elementId);
                if (!element) return;
                
                const canvas = getElement('report-canvas') || document.getElementById('report-canvas');
                if (!canvas) return;
                
                    const canvasRect = canvas.getBoundingClientRect();
                
                // Convert current mouse position to canvas-relative coordinates
                const currentX = e.clientX - canvasRect.left;
                const currentY = e.clientY - canvasRect.top;
                
                // Calculate new position: mouse position minus the offset
                    const elementRect = elementDiv.getBoundingClientRect();
                const elementWidth = elementRect.width || 50;
                const elementHeight = elementRect.height || 20;
                
                let newX = Math.max(0, Math.min(currentX - startX, canvasRect.width - elementWidth));
                let newY = Math.max(0, Math.min(currentY - startY, canvasRect.height - elementHeight));
                
                // Snap to guides if enabled
                const snapped = snapToGuides(newX, newY, canvasRect.width, canvasRect.height);
                newX = snapped.x;
                newY = snapped.y;
                
                // Update element position
                    element.x = newX;
                    element.y = newY;
                    
                // Update visual position
                    elementDiv.style.left = newX + 'px';
                    elementDiv.style.top = newY + 'px';
                
                // Update input fields in real-time
                const xInput = getElement('element-x');
                const yInput = getElement('element-y');
                if (xInput) xInput.value = Math.round(newX);
                if (yInput) yInput.value = Math.round(newY);
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        }

        // Select an element
        function selectElement(elementId) {
            selectedElement = elementId;
            const element = reportElements.find(el => el.id === elementId);
            
            if (!element) return;
            
            // Update properties panel
            const fontFamilyInput = getElement('element-font-family');
            const fontSizeInput = getElement('element-font-size');
            const xInput = getElement('element-x');
            const yInput = getElement('element-y');
            const contentInput = getElement('element-content');
            
            if (fontFamilyInput) fontFamilyInput.value = element.fontFamily || 'Arial';
            if (fontSizeInput) fontSizeInput.value = element.fontSize || 12;
            if (xInput) xInput.value = element.x || 0;
            if (yInput) yInput.value = element.y || 0;
            // For data-bound placeholders, show the data key instead of content
            if (contentInput) {
                if (element.isDataBound && element.dataKey) {
                    const placeholderInfo = PLACEHOLDER_CATALOG[element.dataKey] || { label: element.dataKey };
                    contentInput.value = '[' + placeholderInfo.label + ']';
                    contentInput.disabled = true;
                    contentInput.title = 'Data-bound variable: ' + element.dataKey;
                } else {
                    contentInput.value = element.content || '';
                    contentInput.disabled = false;
                    contentInput.title = '';
                }
            }
            
            // Show/hide table columns section for table elements
            const tableColumnsSection = document.getElementById('table-columns-section');
            const modalTableColumnsSection = document.getElementById('modal-table-columns-section');
            if (element.type === 'table') {
                if (tableColumnsSection) tableColumnsSection.style.display = 'block';
                if (modalTableColumnsSection) modalTableColumnsSection.style.display = 'block';
                renderTableColumns(element);
            } else {
                if (tableColumnsSection) tableColumnsSection.style.display = 'none';
                if (modalTableColumnsSection) modalTableColumnsSection.style.display = 'none';
            }
            
            // Show properties panel
            const propertiesPanel = getElement('element-properties-panel') || document.getElementById('element-properties-panel');
            const modalPropertiesPanel = document.getElementById('modal-element-properties-panel');
            if (propertiesPanel) propertiesPanel.style.display = 'block';
            if (modalPropertiesPanel) modalPropertiesPanel.style.display = 'block';
            
            // Update visual selection
            document.querySelectorAll('.report-element').forEach(el => {
                el.style.borderColor = 'transparent';
                const handle = el.querySelector('.resize-handle');
                if (handle) handle.style.display = 'none';
            });
            const selectedDiv = document.getElementById(`element-${elementId}`);
            if (selectedDiv) {
                selectedDiv.style.borderColor = '#3b82f6';
                const handle = selectedDiv.querySelector('.resize-handle');
                if (handle) handle.style.display = 'block';
            }
        }

        // Available data fields for table columns (based on results/units/fees structure)
        const TABLE_DATA_FIELDS = {
            'table.results': [
                { field: 'unit_code', label: 'Unit Code' },
                { field: 'unit_name', label: 'Unit Name' },
                { field: 'academic_year', label: 'Academic Year' },
                { field: 'semester', label: 'Semester' },
                { field: 'cat_marks', label: 'CAT Marks' },
                { field: 'exam_marks', label: 'Exam Marks' },
                { field: 'total_marks', label: 'Total Marks' },
                { field: 'grade', label: 'Grade' }
            ],
            'table.registered_units': [
                { field: 'unit_code', label: 'Unit Code' },
                { field: 'unit_name', label: 'Unit Name' },
                { field: 'academic_year', label: 'Academic Year' },
                { field: 'semester', label: 'Semester' },
                { field: 'exam_registered_at', label: 'Registered Date' }
            ],
            'table.fee_structure': [
                { field: 'semester', label: 'Semester' },
                { field: 'fee_type', label: 'Fee Type' },
                { field: 'amount', label: 'Amount' }
            ]
        };

        // Render table columns in the properties panel
        function renderTableColumns(element) {
            if (!element || element.type !== 'table') return;
            
            const columnsList = document.getElementById('table-columns-list');
            const modalColumnsList = document.getElementById('modal-table-columns-list');
            
            if (!columnsList && !modalColumnsList) return;
            
            const tableConfig = element.tableConfig || {};
            const columns = tableConfig.columns || [];
            const dataKey = element.dataKey || element.placeholder || '';
            const availableFields = TABLE_DATA_FIELDS[dataKey] || [];
            
            // Clear existing columns
            if (columnsList) columnsList.innerHTML = '';
            if (modalColumnsList) modalColumnsList.innerHTML = '';
            
            // Render each column
            columns.forEach((col, index) => {
                const colDiv = document.createElement('div');
                colDiv.className = 'table-column-item';
                colDiv.style.cssText = 'padding: 8px; background: var(--bg-hover); border-radius: 4px; border: 1px solid var(--border-color);';
                
                const headerInput = document.createElement('input');
                headerInput.type = 'text';
                headerInput.value = col.header || col.field || '';
                headerInput.placeholder = 'Column Header';
                headerInput.style.cssText = 'width: 100%; margin-bottom: 6px; padding: 4px; font-size: 12px; border: 1px solid var(--border-color); border-radius: 3px;';
                headerInput.onchange = () => {
                    col.header = headerInput.value;
                    updateTableElement();
                };
                
                const fieldSelect = document.createElement('select');
                fieldSelect.style.cssText = 'width: 100%; margin-bottom: 6px; padding: 4px; font-size: 12px; border: 1px solid var(--border-color); border-radius: 3px;';
                fieldSelect.innerHTML = '<option value="">-- Select Field --</option>' +
                    availableFields.map(f => '<option value="' + f.field + '" ' + (col.field === f.field ? 'selected' : '') + '>' + f.label + '</option>').join('');
                fieldSelect.onchange = () => {
                    col.field = fieldSelect.value;
                    if (!col.header && fieldSelect.value) {
                        const fieldInfo = availableFields.find(f => f.field === fieldSelect.value);
                        if (fieldInfo) {
                            col.header = fieldInfo.label;
                            headerInput.value = fieldInfo.label;
                        }
                    }
                    updateTableElement();
                };
                
                const widthInput = document.createElement('input');
                widthInput.type = 'number';
                widthInput.value = col.width || 80;
                widthInput.min = 20;
                widthInput.max = 300;
                widthInput.placeholder = 'Width';
                widthInput.style.cssText = 'width: 60px; margin-right: 4px; padding: 4px; font-size: 12px; border: 1px solid var(--border-color); border-radius: 3px;';
                widthInput.onchange = () => {
                    col.width = parseInt(widthInput.value) || 80;
                    updateTableElement();
                };
                
                const alignSelect = document.createElement('select');
                alignSelect.style.cssText = 'width: 70px; margin-right: 4px; padding: 4px; font-size: 12px; border: 1px solid var(--border-color); border-radius: 3px;';
                alignSelect.innerHTML = 
                    '<option value="left" ' + (col.alignment === 'left' ? 'selected' : '') + '>Left</option>' +
                    '<option value="center" ' + (col.alignment === 'center' ? 'selected' : '') + '>Center</option>' +
                    '<option value="right" ' + (col.alignment === 'right' ? 'selected' : '') + '>Right</option>';
                alignSelect.onchange = () => {
                    col.alignment = alignSelect.value;
                    updateTableElement();
                };
                
                const controlsDiv = document.createElement('div');
                controlsDiv.style.cssText = 'display: flex; align-items: center; gap: 4px; margin-top: 6px;';
                
                const moveUpBtn = document.createElement('button');
                moveUpBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
                moveUpBtn.className = 'btn btn-secondary';
                moveUpBtn.style.cssText = 'padding: 4px 8px; font-size: 10px;';
                moveUpBtn.disabled = index === 0;
                moveUpBtn.onclick = () => {
                    if (index > 0) {
                        const temp = columns[index];
                        columns[index] = columns[index - 1];
                        columns[index - 1] = temp;
                        renderTableColumns(element);
                        updateTableElement();
                    }
                };
                
                const moveDownBtn = document.createElement('button');
                moveDownBtn.innerHTML = '<i class="fas fa-arrow-down"></i>';
                moveDownBtn.className = 'btn btn-secondary';
                moveDownBtn.style.cssText = 'padding: 4px 8px; font-size: 10px;';
                moveDownBtn.disabled = index === columns.length - 1;
                moveDownBtn.onclick = () => {
                    if (index < columns.length - 1) {
                        const temp = columns[index];
                        columns[index] = columns[index + 1];
                        columns[index + 1] = temp;
                        renderTableColumns(element);
                        updateTableElement();
                    }
                };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.style.cssText = 'padding: 4px 8px; font-size: 10px;';
                deleteBtn.onclick = () => {
                    columns.splice(index, 1);
                    renderTableColumns(element);
                    updateTableElement();
                };
                
                controlsDiv.appendChild(moveUpBtn);
                controlsDiv.appendChild(moveDownBtn);
                controlsDiv.appendChild(deleteBtn);
                
                colDiv.appendChild(headerInput);
                colDiv.appendChild(fieldSelect);
                const widthAlignDiv = document.createElement('div');
                widthAlignDiv.style.cssText = 'display: flex; align-items: center;';
                widthAlignDiv.appendChild(widthInput);
                widthAlignDiv.appendChild(alignSelect);
                colDiv.appendChild(widthAlignDiv);
                colDiv.appendChild(controlsDiv);
                
                if (columnsList) columnsList.appendChild(colDiv.cloneNode(true));
                if (modalColumnsList) modalColumnsList.appendChild(colDiv);
            });
        }

        // Add a new column to the selected table
        function addTableColumn() {
            if (!selectedElement || !canEditReports) return;
            
            const element = reportElements.find(el => el.id === selectedElement);
            if (!element || element.type !== 'table') return;
            
            if (!element.tableConfig) {
                element.tableConfig = {
                    startX: 50,
                    startY: 50,
                    rowHeight: 20,
                    fontSize: 10,
                    headerRowHeight: 25,
                    headerFontSize: 11,
                    headerBold: true,
                    columns: []
                };
            }
            
            if (!element.tableConfig.columns) {
                element.tableConfig.columns = [];
            }
            
            element.tableConfig.columns.push({
                header: 'New Column',
                field: '',
                width: 80,
                alignment: 'left'
            });
            
            renderTableColumns(element);
            updateTableElement();
        }

        // Update table element and re-render
        function updateTableElement() {
            if (!selectedElement) return;
            renderReportElements();
            selectElement(selectedElement);
        }

        // Toggle font style (bold, italic, underline)
        function toggleFontStyle(style) {
            if (!selectedElement || !canEditReports) return;
            
            const element = reportElements.find(el => el.id === selectedElement);
            if (!element) return;
            
            const btn = document.getElementById('element-' + style + '-btn');
            
            if (style === 'bold') {
                element.fontWeight = element.fontWeight === 'bold' ? 'normal' : 'bold';
                element.bold = element.fontWeight === 'bold';
                if (btn) btn.classList.toggle('active', element.fontWeight === 'bold');
            } else if (style === 'italic') {
                element.fontStyle = element.fontStyle === 'italic' ? 'normal' : 'italic';
                element.italic = element.fontStyle === 'italic';
                if (btn) btn.classList.toggle('active', element.fontStyle === 'italic');
            } else if (style === 'underline') {
                element.textDecoration = element.textDecoration === 'underline' ? 'none' : 'underline';
                element.underline = element.textDecoration === 'underline';
                if (btn) btn.classList.toggle('active', element.textDecoration === 'underline');
            }
            
            renderReportElements();
            selectElement(selectedElement);
        }

        // Update color from hex input
        function updateColorFromHex(type) {
            if (!selectedElement || !canEditReports) return;
            
            const element = reportElements.find(el => el.id === selectedElement);
            if (!element) return;
            
            if (type === 'text') {
                const hexInput = document.getElementById('element-text-color-hex');
                const colorInput = document.getElementById('element-text-color');
                if (hexInput && colorInput) {
                    const hexValue = hexInput.value.trim();
                    if (/^#[0-9A-F]{6}$/i.test(hexValue)) {
                        colorInput.value = hexValue;
                        element.color = hexValue;
                    }
                }
            } else if (type === 'bg') {
                const hexInput = document.getElementById('element-bg-color-hex');
                const colorInput = document.getElementById('element-bg-color');
                if (hexInput && colorInput) {
                    const hexValue = hexInput.value.trim();
                    if (/^#[0-9A-F]{6}$/i.test(hexValue)) {
                        colorInput.value = hexValue;
                        element.backgroundColor = hexValue;
                    }
                }
            }
            
            renderReportElements();
            selectElement(selectedElement);
        }

        // Add text element
        function addTextElement() {
            if (!canEditReports) {
                showToast('error', 'You do not have permission to edit reports');
                return;
            }
            
            const newElement = {
                id: elementIdCounter++,
                type: 'text',
                content: 'New Text',
                x: 50,
                y: 50,
                fontFamily: 'Arial',
                fontSize: 12,
                textAlign: 'left',
                color: '#000000'
            };
            
            reportElements.push(newElement);
            renderReportElements();
            selectElement(newElement.id);
        }

        // Add image element
        function addImageElement() {
            if (!canEditReports) {
                showToast('error', 'You do not have permission to edit reports');
                return;
            }
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const newElement = {
                            id: elementIdCounter++,
                            type: 'image',
                            content: event.target.result,
                            x: 50,
                            y: 50,
                            width: 200,
                            height: 200
                        };
                        
                        reportElements.push(newElement);
                        renderReportElements();
                        selectElement(newElement.id);
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        // Add logo element
        function addLogoElement() {
            addImageElement(); // Same as image for now
        }

        // Update selected element
        function updateSelectedElement() {
            if (!selectedElement || !canEditReports) return;
            
            const element = reportElements.find(el => el.id === selectedElement);
            if (!element) return;
            
            const fontFamilyInput = getElement('element-font-family');
            const fontSizeInput = getElement('element-font-size');
            const xInput = getElement('element-x');
            const yInput = getElement('element-y');
            const contentInput = getElement('element-content');
            
            if (fontFamilyInput) element.fontFamily = fontFamilyInput.value;
            if (fontSizeInput) element.fontSize = parseInt(fontSizeInput.value) || 12;
            if (xInput) element.x = parseInt(xInput.value) || 0;
            if (yInput) element.y = parseInt(yInput.value) || 0;
            
            // Update colors
            const textColorInput = document.getElementById('element-text-color');
            const bgColorInput = document.getElementById('element-bg-color');
            if (textColorInput) element.color = textColorInput.value;
            if (bgColorInput && (element.type === 'table' || element.type === 'image' || element.type === 'logo')) {
                element.backgroundColor = bgColorInput.value;
            }
            
            // Update size for resizable elements
            const widthInput = document.getElementById('element-width');
            const heightInput = document.getElementById('element-height');
            if (widthInput && (element.type === 'image' || element.type === 'logo' || element.type === 'table')) {
                element.width = parseInt(widthInput.value) || 200;
            }
            if (heightInput && (element.type === 'image' || element.type === 'logo' || element.type === 'table')) {
                element.height = parseInt(heightInput.value) || 200;
            }
            
            // Don't update content for data-bound placeholders (it's read-only)
            if (contentInput && !element.isDataBound) {
                element.content = contentInput.value;
            }
            
            renderReportElements();
            selectElement(selectedElement);
        }

        // Set text alignment
        function setTextAlignment(alignment) {
            if (!selectedElement || !canEditReports) return;
            
            const element = reportElements.find(el => el.id === selectedElement);
            if (element && (element.type === 'text' || element.type === 'placeholder')) {
                element.textAlign = alignment;
                renderReportElements();
                selectElement(selectedElement);
            }
        }

        // Delete selected element
        function deleteSelectedElement() {
            if (!selectedElement || !canEditReports) {
                showToast('error', 'You do not have permission to edit reports');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this element?')) return;
            
            reportElements = reportElements.filter(el => el.id !== selectedElement);
            selectedElement = null;
            document.getElementById('element-properties-panel').style.display = 'none';
            renderReportElements();
        }

        // Save report template
        async function saveReportTemplate() {
            if (!window.COLLEGE_SLUG || !canEditReports) {
                showToast('error', 'You do not have permission to save reports');
                return;
            }
            
            // Get template name - check both main and modal versions
            const nameInput = getElement('template-name') || document.getElementById('modal-template-name');
            const name = nameInput ? nameInput.value.trim() : '';
            if (!name) {
                showToast('error', 'Please enter a template name');
                return;
            }
            
            // Get page size from any available selector (check both main and modal)
            const pageSizeSelector = getElement('page-size-selector') || 
                                    document.getElementById('page-size-selector') ||
                                    document.getElementById('page-size-selector-sidebar') ||
                                    document.getElementById('modal-page-size-selector') ||
                                    document.getElementById('modal-page-size-selector-sidebar');
            const pageSize = pageSizeSelector ? (pageSizeSelector.value || 'A4') : 'A4';
            
            // Get inputs - check both main and modal versions
            const descInput = getElement('template-description') || document.getElementById('modal-template-description');
            const typeInput = getElement('template-report-type') || document.getElementById('modal-template-report-type');
            const widthInput = getElement('canvas-width') || document.getElementById('modal-canvas-width');
            const heightInput = getElement('canvas-height') || document.getElementById('modal-canvas-height');
            
            const templateData = {
                name: name,
                description: descInput ? descInput.value.trim() : '',
                report_type: typeInput ? typeInput.value : 'custom',
                page_size: pageSize,
                canvas_width: widthInput ? parseInt(widthInput.value) || PAGE_DIMENSIONS[pageSize].width : PAGE_DIMENSIONS[pageSize].width,
                canvas_height: heightInput ? parseInt(heightInput.value) || PAGE_DIMENSIONS[pageSize].height : PAGE_DIMENSIONS[pageSize].height,
                elements: reportElements,
                is_active: currentReportTemplate ? currentReportTemplate.is_active : true
            };
            
            try {
                const url = currentReportTemplate
                    ? `/api/${window.COLLEGE_SLUG}/reports/templates/${currentReportTemplate.id}/`
                    : `/api/${window.COLLEGE_SLUG}/reports/templates/`;
                const method = currentReportTemplate ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'X-CSRFToken': window.csrftoken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(templateData)
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showToast('error', data.error);
                    return;
                }
                
                showToast('success', data.message || 'Template saved successfully');
                currentReportTemplate = data.template;
                loadReportTemplates();
            } catch (error) {
                console.error('Error saving template:', error);
                showToast('error', 'Error saving template');
            }
        }

        // Save template elements only (quick save)
        async function saveTemplateElements() {
            if (!window.COLLEGE_SLUG || !canEditReports) {
                showToast('error', 'You do not have permission to save reports');
                return;
            }
            
            if (!currentReportTemplate || !currentReportTemplate.id) {
                showToast('error', 'Please select or create a template first');
                return;
            }
            
            try {
                const response = await fetch(`/api/${window.COLLEGE_SLUG}/reports/templates/${currentReportTemplate.id}/`, {
                    method: 'PUT',
                    headers: {
                        'X-CSRFToken': window.csrftoken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        elements: reportElements
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    showToast('error', data.error);
                    return;
                }
                
                showToast('success', 'Elements saved successfully');
                // Update current template with latest data
                if (data.template) {
                    currentReportTemplate = data.template;
                    currentReportTemplate.elements = reportElements;
                }
            } catch (error) {
                console.error('Error saving elements:', error);
                showToast('error', 'Error saving elements: ' + error.message);
            }
        }

        // Load report template (reload current)
        function loadReportTemplate() {
            if (currentReportTemplate) {
                selectReportTemplate(currentReportTemplate.id);
            } else {
                showToast('info', 'No template selected');
            }
        }

        // Placeholder data catalog
        const PLACEHOLDER_CATALOG = {
            // Student fields
            'student.full_name': { label: 'Student Name', icon: 'fa-user', type: 'text' },
            'student.admission_number': { label: 'Admission Number', icon: 'fa-id-card', type: 'text' },
            'student.course_name': { label: 'Course Name', icon: 'fa-graduation-cap', type: 'text' },
            'student.year_of_study': { label: 'Year of Study', icon: 'fa-calendar-alt', type: 'text' },
            // College fields
            'college.name': { label: 'College Name', icon: 'fa-building', type: 'text' },
            'college.address': { label: 'College Address', icon: 'fa-map-marker-alt', type: 'text' },
            // Date fields
            'generation_date': { label: 'Generation Date', icon: 'fa-calendar', type: 'text' },
            'academic_year': { label: 'Academic Year', icon: 'fa-calendar-check', type: 'text' },
            'semester': { label: 'Semester', icon: 'fa-calendar-week', type: 'text' },
            // Tables
            'table.results': { label: 'Results Table', icon: 'fa-table', type: 'table', columns: ['unit_code', 'unit_name', 'academic_year', 'semester', 'cat_marks', 'exam_marks', 'total_marks', 'grade'] },
            'table.registered_units': { label: 'Registered Units Table', icon: 'fa-list', type: 'table', columns: ['unit_code', 'unit_name', 'academic_year', 'semester', 'exam_registered_at'] },
            'table.fee_structure': { label: 'Fee Structure Table', icon: 'fa-money-bill-wave', type: 'table', columns: ['semester', 'fee_type', 'amount'] },
        };

        // Initialize placeholder buttons
        function initPlaceholderButtons() {
            document.querySelectorAll('.placeholder-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const placeholder = this.getAttribute('data-placeholder');
                    const type = this.getAttribute('data-type') || 'text';
                    addPlaceholderElement(placeholder, type);
                });
            });
        }

        // Add placeholder element to canvas
        function addPlaceholderElement(placeholder, type) {
            if (!canEditReports) {
                showToast('error', 'You do not have permission to edit reports');
                return;
            }

            const placeholderInfo = PLACEHOLDER_CATALOG[placeholder];
            if (!placeholderInfo) return;

            const newElement = {
                id: elementIdCounter++,
                type: type === 'table' ? 'table' : 'placeholder',
                dataKey: placeholder,  // Store as data key reference, not text token
                placeholder: placeholder,  // Keep for backward compatibility
                content: '',  // Content will be resolved during export/preview
                x: 50,
                y: 50,
                width: type === 'table' ? 600 : 200,
                height: type === 'table' ? 200 : 30,
                fontFamily: 'Arial',
                fontSize: 12,
                textAlign: 'left',
                color: '#000000',
                isPlaceholder: true,
                isDataBound: true  // Mark as data-bound variable
            };

            if (type === 'table') {
                // Initialize table config with structured column definitions
                const defaultColumns = placeholderInfo.columns || [];
                newElement.tableConfig = {
                    startX: 50,
                    startY: 50,
                    rowHeight: 20,
                    fontSize: 10,
                    headerRowHeight: 25,
                    headerFontSize: 11,
                    headerBold: true,
                    columns: defaultColumns.map((col, idx) => {
                        // If columns are strings, convert to structured format
                        if (typeof col === 'string') {
                            return {
                                header: col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                                field: col,
                                width: 80,
                                alignment: 'left'
                            };
                        }
                        // If already structured, use as-is
                        return col;
                    })
                };
            }

            reportElements.push(newElement);
            renderReportElements();
            selectElement(newElement.id);
        }

        // Open More Data dialog
        function openMoreDataDialog() {
            const dialog = document.getElementById('more-data-dialog');
            const listContainer = document.getElementById('data-objects-list');
            
            if (!dialog || !listContainer) return;

            // Clear previous content
            listContainer.innerHTML = '';

            // Group data objects by category
            const categories = {
                'Student Information': [
                    'student.full_name', 'student.admission_number', 'student.course_name', 'student.year_of_study'
                ],
                'College Information': [
                    'college.name', 'college.address'
                ],
                'Date & Time': [
                    'generation_date', 'academic_year', 'semester'
                ],
                'Data Tables': [
                    'table.results', 'table.registered_units', 'table.fee_structure'
                ]
            };

            // Render categories and items
            Object.keys(categories).forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.style.marginBottom = '20px';
                
                const categoryTitle = document.createElement('h4');
                categoryTitle.textContent = category;
                categoryTitle.style.margin = '0 0 12px 0';
                categoryTitle.style.fontSize = '14px';
                categoryTitle.style.fontWeight = '600';
                categoryTitle.style.color = 'var(--text-dark)';
                categoryDiv.appendChild(categoryTitle);

                categories[category].forEach(placeholder => {
                    const info = PLACEHOLDER_CATALOG[placeholder];
                    if (!info) return;

                    const itemDiv = document.createElement('div');
                    itemDiv.style.display = 'flex';
                    itemDiv.style.alignItems = 'center';
                    itemDiv.style.padding = '8px';
                    itemDiv.style.marginBottom = '4px';
                    itemDiv.style.borderRadius = '4px';
                    itemDiv.style.cursor = 'pointer';
                    itemDiv.style.transition = 'background 0.2s';
                    itemDiv.className = 'data-object-item';
                    
                    itemDiv.onmouseenter = () => itemDiv.style.background = 'var(--bg-hover)';
                    itemDiv.onmouseleave = () => itemDiv.style.background = 'transparent';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = placeholder;
                    checkbox.id = 'data-obj-' + placeholder.replace(/\./g, '-');
                    checkbox.style.marginRight = '12px';
                    itemDiv.appendChild(checkbox);

                    const icon = document.createElement('i');
                    icon.className = 'fas ' + info.icon;
                    icon.style.marginRight = '8px';
                    icon.style.color = 'var(--primary)';
                    itemDiv.appendChild(icon);

                    const label = document.createElement('span');
                    label.textContent = info.label;
                    label.style.fontSize = '13px';
                    itemDiv.appendChild(label);

                    categoryDiv.appendChild(itemDiv);
                });

                listContainer.appendChild(categoryDiv);
            });

            dialog.style.display = 'flex';
        }

        // Close More Data dialog
        function closeMoreDataDialog() {
            const dialog = document.getElementById('more-data-dialog');
            if (dialog) {
                dialog.style.display = 'none';
            }
        }

        // Add selected data objects
        function addSelectedDataObjects() {
            const checkboxes = document.querySelectorAll('#data-objects-list input[type="checkbox"]:checked');
            let added = 0;

            checkboxes.forEach(checkbox => {
                const placeholder = checkbox.value;
                const info = PLACEHOLDER_CATALOG[placeholder];
                if (info) {
                    addPlaceholderElement(placeholder, info.type);
                    added++;
                }
            });

            if (added > 0) {
                showToast('success', `Added ${added} data object(s) to canvas`);
            } else {
                showToast('info', 'No objects selected');
            }

            closeMoreDataDialog();
        }

        // Open new template modal
        function openNewTemplateModal() {
            currentReportTemplate = null;
            reportElements = [];
            selectedElement = null;
            elementIdCounter = 1;
            
            const nameInput = getElement('template-name');
            const descInput = getElement('template-description');
            const typeInput = getElement('template-report-type');
            
            if (nameInput) nameInput.value = '';
            if (descInput) descInput.value = '';
            if (typeInput) typeInput.value = 'custom';
            
            // Reset to A4 default
            const pageSizeSelector = getElement('page-size-selector') || document.getElementById('page-size-selector');
            const pageSizeSelectorSidebar = getElement('page-size-selector-sidebar') || document.getElementById('page-size-selector-sidebar');
            if (pageSizeSelector) pageSizeSelector.value = 'A4';
            if (pageSizeSelectorSidebar) pageSizeSelectorSidebar.value = 'A4';
            
            const a4Dimensions = PAGE_DIMENSIONS['A4'];
            const widthInput = getElement('canvas-width');
            const heightInput = getElement('canvas-height');
            if (widthInput) widthInput.value = a4Dimensions.width;
            if (heightInput) heightInput.value = a4Dimensions.height;
            
            const propertiesPanel = getElement('element-properties-panel') || document.getElementById('element-properties-panel');
            const modalPropertiesPanel = document.getElementById('modal-element-properties-panel');
            if (propertiesPanel) propertiesPanel.style.display = 'none';
            if (modalPropertiesPanel) modalPropertiesPanel.style.display = 'none';
            
            updateCanvasSize();
            updateCanvasGuides();
            renderReportElements();
            
            const canvas = getElement('report-canvas');
            if (canvas) {
                canvas.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-light);"><i class="fas fa-file-alt" style="font-size: 48px; margin-bottom: 16px;"></i><p>Start adding elements to create a new template</p></div>';
            }
        }

        // Open Report Editor Modal
        function openReportEditorModal() {
            const modal = document.getElementById('report-editor-modal');
            if (modal) {
                modal.style.display = 'flex';
                // Load templates when modal is opened
                setTimeout(() => {
                    loadReportTemplates();
                    // Initialize canvas guides after modal is shown
                    updateCanvasGuides();
                }, 100);
                // Prevent body scroll when modal is open
                document.body.style.overflow = 'hidden';
            }
        }

        // Close Report Editor Modal
        function closeReportEditorModal() {
            const modal = document.getElementById('report-editor-modal');
            if (modal) {
                modal.style.display = 'none';
                // Restore body scroll
                document.body.style.overflow = '';
            }
        }
        
        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('report-editor-modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeReportEditorModal();
                    }
                });
            }
            
            // Initialize placeholder buttons
            initPlaceholderButtons();
            
            // Initialize canvas guides
            setTimeout(() => {
                updateCanvasGuides();
            }, 100);
        });


        // Initialize report editor when section is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Load templates when report section is accessed
            const reportSectionLink = document.querySelector('.nav-link[data-section="report-section"]');
            if (reportSectionLink) {
                reportSectionLink.addEventListener('click', function() {
                    setTimeout(() => {
                        loadReportTemplates();
                    }, 100);
                });
            }
        });
    </script>
    <script src="{% static 'js/admin/landing-navigation.js' %}?v={{ timestamp|default:'1' }}"></script>
    <script src="{% static 'js/admin/landing-data.js' %}?v={{ timestamp|default:'1' }}" 
            onload="console.log('landing-data.js loaded, LandingData available:', typeof window.LandingData);"
            onerror="console.error('ERROR: Failed to load landing-data.js');"></script>
    <script>
        // Nominal Roll Sign-In List Enhanced Functions
        function toggleNominalRollFilters() {
            const filtersContent = document.getElementById('nominal-roll-filters-content');
            const toggleBtn = document.querySelector('.nominal-roll-filters-toggle');
            if (filtersContent && toggleBtn) {
                filtersContent.classList.toggle('collapsed');
                toggleBtn.classList.toggle('rotated');
            }
        }

        function clearNominalRollSearch() {
            const searchInput = document.getElementById('nominal-roll-search');
            const clearBtn = document.getElementById('nominal-roll-search-clear');
            if (searchInput) {
                searchInput.value = '';
                filterNominalRollList();
            }
            if (clearBtn) {
                clearBtn.style.display = 'none';
            }
        }

        // Show/hide search clear button
        // Initialize marks entry system on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load academic year options for unit selection
            if (document.getElementById('unit-selection-year-filter')) {
                loadAcademicYearOptions();
            }
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('nominal-roll-search');
            const clearBtn = document.getElementById('nominal-roll-search-clear');
            
            if (searchInput && clearBtn) {
                searchInput.addEventListener('input', function() {
                    clearBtn.style.display = this.value ? 'flex' : 'none';
                });
            }
        });

        function exportNominalRollList() {
            const tbody = document.getElementById('nominal-roll-list-tbody');
            if (!tbody) {
                showToast('error', 'No data to export');
                return;
            }

            const rows = tbody.querySelectorAll('tr:not(.loading-row)');
            if (rows.length === 0) {
                showToast('error', 'No data to export');
                return;
            }

            // Get headers
            const headers = ['Admission No.', 'Full Name', 'Course', 'Academic Year', 'Semester', 'Year of Study', 'Signed In At', 'Status'];
            
            // Build CSV content
            let csvContent = headers.join(',') + '\n';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0 && !row.classList.contains('loading-row')) {
                    const rowData = [];
                    cells.forEach((cell, index) => {
                        if (index < headers.length) {
                            let text = cell.textContent.trim();
                            // Remove status badge text, keep only status
                            if (index === 7) {
                                text = text.replace(/\s+/g, ' ').trim();
                            }
                            // Escape commas and quotes
                            text = text.replace(/"/g, '""');
                            rowData.push('"' + text + '"');
                        }
                    });
                    csvContent += rowData.join(',') + '\n';
                }
            });

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `nominal-roll-sign-in-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('success', 'Nominal roll list exported successfully');
        }

        function printNominalRollList() {
            const modal = document.getElementById('nominal-roll-list-modal');
            if (!modal) return;

            // Create a print-friendly version
            const printWindow = window.open('', '_blank');
            const table = modal.querySelector('.nominal-roll-table');
            const title = modal.querySelector('.modal-title').textContent;
            
            if (!table) {
                showToast('error', 'No data to print');
                return;
            }

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #1e293b; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background: #f8fafc; padding: 12px; text-align: left; border: 1px solid #e2e8f0; font-weight: 600; }
                        td { padding: 10px; border: 1px solid #e2e8f0; }
                        tr:nth-child(even) { background: #f8fafc; }
                        @media print {
                            body { padding: 0; }
                            @page { margin: 1cm; }
                        }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <p>Generated on: ${new Date().toLocaleString()}</p>
                    ${table.outerHTML}
</body>
</html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        // Update summary counts when data is loaded
        function updateNominalRollSummary(data) {
            const totalCount = data.count || 0;
            let signedInCount = 0;
            let notSignedInCount = 0;

            if (data.results) {
                data.results.forEach(item => {
                    if (item.signed_in_at) {
                        signedInCount++;
                    } else {
                        notSignedInCount++;
                    }
                });
            }

            const totalEl = document.getElementById('nominal-roll-total-count');
            const signedInEl = document.getElementById('nominal-roll-signed-in-count');
            const notSignedInEl = document.getElementById('nominal-roll-not-signed-in-count');

            if (totalEl) totalEl.textContent = totalCount.toLocaleString();
            if (signedInEl) signedInEl.textContent = signedInCount.toLocaleString();
            if (notSignedInEl) notSignedInEl.textContent = notSignedInCount.toLocaleString();
        }

        // Override openTimetableModal to add null checks for missing elements
        function openTimetableModal(timetableId = null) {
            const modal = document.getElementById('timetable-modal');
            const title = document.getElementById('timetable-modal-title');
            const form = document.getElementById('timetable-form');
            const submitBtn = document.getElementById('timetable-submit-btn');
            
            if (!modal) {
                console.error('Timetable modal not found');
                return;
            }
            
            // Reset form if it exists
            if (form) {
                form.reset();
            }
            
            // Hide preview if it exists (using the correct ID)
            const preview = document.getElementById('timetable-upload-preview');
            if (preview) {
                preview.style.display = 'none';
            }
            
            // Hide course group if it exists
            const courseGroup = document.getElementById('timetable-course-group');
            if (courseGroup) {
                courseGroup.style.display = 'none';
            }
            
            // Set general radio button if it exists
            const generalRadio = document.querySelector('input[name="timetable-type"][value="general"]');
            if (generalRadio) {
                generalRadio.checked = true;
            }
            
            // Hide error message if it exists
            const errorDiv = document.getElementById('timetable-upload-error');
            if (errorDiv) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
            
            if (timetableId) {
                if (title) title.textContent = 'Edit Timetable';
                if (submitBtn) {
                    const btnText = submitBtn.querySelector('.btn-text');
                    if (btnText) btnText.textContent = 'Update Timetable';
                }
                // Call the original function if it exists for loading timetable data
                // Check both window.LandingData and direct function availability
                if (typeof loadTimetableForEdit === 'function') {
                    loadTimetableForEdit(timetableId);
                } else if (window.LandingData && typeof window.LandingData.loadTimetableForEdit === 'function') {
                    window.LandingData.loadTimetableForEdit(timetableId);
                }
            } else {
                if (title) title.textContent = 'Upload Timetable';
                if (submitBtn) {
                    const btnText = submitBtn.querySelector('.btn-text');
                    if (btnText) btnText.textContent = 'Upload Timetable';
                }
            }
            
            modal.classList.add('active');
        }
        
        // Make function globally available
        window.openTimetableModal = openTimetableModal;

        // Verify LandingData is loaded after scripts
        (function() {
            function checkLandingData() {
                if (window.LandingData) {
                    console.log(' LandingData is available:', Object.keys(window.LandingData));
                    return true;
                }
                return false;
            }
            
            // Check immediately
            if (!checkLandingData()) {
                console.warn('LandingData not available immediately, will check on load event');
            }
            
            // Check on window load
            window.addEventListener('load', function() {
                console.log('Page fully loaded. LandingData status:', {
                    exists: typeof window.LandingData !== 'undefined',
                    type: typeof window.LandingData,
                    hasFetchStudents: window.LandingData && typeof window.LandingData.fetchStudents === 'function',
                    COLLEGE_SLUG: window.COLLEGE_SLUG
                });
                
                // If LandingData is still not available, log error
                if (!window.LandingData) {
                    console.error('CRITICAL: LandingData is not available after page load.');
                    console.error('Check:');
                    console.error('1. Is landing-data.js loading? (Check Network tab)');
                    console.error('2. Are there JavaScript errors in landing-data.js? (Check Console)');
                    console.error('3. Is COLLEGE_SLUG set?', window.COLLEGE_SLUG);
                } else {
                    console.log(' LandingData successfully loaded and available');
                }
            });
        })();
    </script>
    
    <!-- Suspended College Modal -->
    {% if college_is_suspended %}
    {% include 'education/suspended_modal.html' %}
    {% endif %}
</body>
</html>


