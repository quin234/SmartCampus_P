{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Director Dashboard - SmartCampus{% endblock %}
{% block icon %}user-tie{% endblock %}
{% block page_title %}Director Dashboard{% endblock %}
{% block page_subtitle %}Managerial Overview & Analytics{% endblock %}

{% block content %}
<!-- Campus Selection Dropdown (only show if branches exist) -->
{% if all_colleges|length > 1 %}
<div class="campus-selector" style="margin-bottom: 24px; padding: 16px; background: var(--bg-card); border-radius: var(--border-radius); border: 1px solid var(--border-color);">
    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
        <label for="campus-select" style="font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-building"></i>
            <span>Select Campus:</span>
        </label>
        <select id="campus-select" class="form-input" style="flex: 1; min-width: 200px; max-width: 400px;" onchange="switchCampus(this.value)">
            {% for campus in all_colleges %}
            <option value="{{ campus.id }}" {% if campus.id == selected_campus.id %}selected{% endif %}>
                {{ campus.name }}{% if campus.id == main_college.id %} (Main){% endif %}
            </option>
            {% endfor %}
        </select>
        <div style="color: var(--text-secondary); font-size: 14px;">
            <i class="fas fa-info-circle"></i>
            <span>Viewing data for: <strong>{{ selected_campus.name }}</strong></span>
        </div>
    </div>
</div>
{% endif %}

<!-- Tab Navigation -->
<div class="tab-navigation" style="margin-bottom: 24px;">
    <!-- <button class="tab-btn active" data-tab="overview">
        <i class="fas fa-chart-pie"></i> Overview
    </button> -->
    <button class="tab-btn" data-tab="principal">
        <i class="fas fa-user-graduate"></i> Principal Analytics
    </button>
    <button class="tab-btn" data-tab="registrar">
        <i class="fas fa-clipboard-list"></i> Registrar Analytics
    </button>
    <button class="tab-btn" data-tab="accountant">
        <i class="fas fa-calculator"></i> Accountant Analytics
    </button>
    <button class="tab-btn" data-tab="branches">
        <i class="fas fa-building"></i> Branch Colleges
    </button>
    <button class="tab-btn" data-tab="users">
        <i class="fas fa-users-cog"></i> User Management
    </button>
</div>

<!-- Overview Tab -->
<div class="tab-content active" id="overview-tab">
    <div class="stats-grid">
        <div class="stat-card stat-primary">
            <div class="stat-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ selected_campus.name }}</div>
                <div class="stat-label">{% if selected_campus.id == main_college.id %}Main Campus{% else %}Branch Campus{% endif %}</div>
            </div>
        </div>

        <div class="stat-card stat-info">
            <div class="stat-icon">
                <i class="fas fa-code-branch"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ branch_colleges|length }}</div>
                <div class="stat-label">Branch Colleges</div>
            </div>
        </div>

        <div class="stat-card stat-success">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ principal_analytics.total_students }}</div>
                <div class="stat-label">Total Students</div>
            </div>
        </div>

        <div class="stat-card stat-warning">
            <div class="stat-icon">
                <i class="fas fa-chalkboard-teacher"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ principal_analytics.total_lecturers }}</div>
                <div class="stat-label">Total Lecturers</div>
            </div>
        </div>
    </div>

    <div class="content-card" style="margin-top: 24px;">
        <div class="card-header">
            <h3 class="card-title"><i class="fas fa-info-circle"></i> Quick Overview</h3>
        </div>
        <div class="card-body">
            <div class="dashboard-grid">
                <div>
                    <h4><i class="fas fa-user-graduate"></i> Academic Summary</h4>
                    <ul class="info-list">
                        <li><strong>Total Courses:</strong> {{ principal_analytics.total_courses }}</li>
                        <li><strong>Total Units:</strong> {{ principal_analytics.total_units }}</li>
                        <li><strong>Total Enrollments:</strong> {{ principal_analytics.total_enrollments }}</li>
                        <li><strong>Completed Results:</strong> {{ principal_analytics.completed_results }}</li>
                    </ul>
                </div>
                <div>
                    <h4><i class="fas fa-money-bill-wave"></i> Financial Summary</h4>
                    <ul class="info-list">
                        <li><strong>Total Expected:</strong> KES {{ accountant_analytics.total_expected|floatformat:2 }}</li>
                        <li><strong>Total Paid:</strong> KES {{ accountant_analytics.total_paid|floatformat:2 }}</li>
                        <li><strong>Outstanding:</strong> KES {{ accountant_analytics.total_outstanding|floatformat:2 }}</li>
                        <li><strong>Collection Rate:</strong> {{ accountant_analytics.collection_rate|floatformat:1 }}%</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Principal Analytics Tab -->
<div class="tab-content" id="principal-tab">
    <div class="stats-grid">
        <div class="stat-card stat-primary">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ principal_analytics.total_students }}</div>
                <div class="stat-label">Total Students</div>
            </div>
        </div>

        <div class="stat-card stat-success">
            <div class="stat-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ principal_analytics.active_students }}</div>
                <div class="stat-label">Active Students</div>
            </div>
        </div>

        <div class="stat-card stat-info">
            <div class="stat-icon">
                <i class="fas fa-book"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ principal_analytics.total_courses }}</div>
                <div class="stat-label">Total Courses</div>
            </div>
        </div>

        <div class="stat-card stat-warning">
            <div class="stat-icon">
                <i class="fas fa-book-open"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ principal_analytics.total_units }}</div>
                <div class="stat-label">Total Units</div>
            </div>
        </div>

        <div class="stat-card stat-secondary">
            <div class="stat-icon">
                <i class="fas fa-chalkboard-teacher"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ principal_analytics.total_lecturers }}</div>
                <div class="stat-label">Total Lecturers</div>
            </div>
        </div>

        <div class="stat-card stat-primary">
            <div class="stat-icon">
                <i class="fas fa-clipboard-check"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ principal_analytics.total_enrollments }}</div>
                <div class="stat-label">Total Enrollments</div>
            </div>
        </div>
    </div>

    <div class="content-card" style="margin-top: 24px;">
        <div class="card-header">
            <h3 class="card-title"><i class="fas fa-chart-bar"></i> Academic Performance</h3>
        </div>
        <div class="card-body">
            <div class="dashboard-grid">
                <div>
                    <h4>Enrollment Statistics</h4>
                    <p><strong>Total Enrollments:</strong> {{ principal_analytics.total_enrollments }}</p>
                    <p><strong>Results Entered:</strong> {{ principal_analytics.completed_results }}</p>
                    <p><strong>Completion Rate:</strong> 
                        {% if principal_analytics.total_enrollments > 0 %}
                            {% widthratio principal_analytics.completed_results principal_analytics.total_enrollments 100 %}%
                        {% else %}
                            0%
                        {% endif %}
                    </p>
                </div>
                <div>
                    <h4>Staff Overview</h4>
                    <p><strong>Total Lecturers:</strong> {{ principal_analytics.total_lecturers }}</p>
                    <p><strong>Principals:</strong> {{ principals|length }}</p>
                    <p><strong>Registrars:</strong> {{ registrars|length }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Registrar Analytics Tab -->
<div class="tab-content" id="registrar-tab">
    <div class="stats-grid">
        <div class="stat-card stat-primary">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ registrar_analytics.total_students }}</div>
                <div class="stat-label">Total Students</div>
            </div>
        </div>

        <div class="stat-card stat-success">
            <div class="stat-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ registrar_analytics.active_students }}</div>
                <div class="stat-label">Active Students</div>
            </div>
        </div>

        <div class="stat-card stat-warning">
            <div class="stat-icon">
                <i class="fas fa-user-slash"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ registrar_analytics.suspended_students }}</div>
                <div class="stat-label">Suspended</div>
            </div>
        </div>

        <div class="stat-card stat-info">
            <div class="stat-icon">
                <i class="fas fa-pause-circle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ registrar_analytics.deferred_students }}</div>
                <div class="stat-label">Deferred</div>
            </div>
        </div>

        <div class="stat-card stat-secondary">
            <div class="stat-icon">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ registrar_analytics.graduated_students }}</div>
                <div class="stat-label">Graduated</div>
            </div>
        </div>

        <div class="stat-card stat-primary">
            <div class="stat-icon">
                <i class="fas fa-user-plus"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ registrar_analytics.new_students_this_month }}</div>
                <div class="stat-label">New This Month</div>
            </div>
        </div>
    </div>

    <div class="content-card" style="margin-top: 24px;">
        <div class="card-header">
            <h3 class="card-title"><i class="fas fa-chart-line"></i> Student Management Overview</h3>
        </div>
        <div class="card-body">
            <div class="dashboard-grid">
                <div>
                    <h4>Student Status Breakdown</h4>
                    <ul class="info-list">
                        <li><strong>Active:</strong> {{ registrar_analytics.active_students }}</li>
                        <li><strong>Suspended:</strong> {{ registrar_analytics.suspended_students }}</li>
                        <li><strong>Deferred:</strong> {{ registrar_analytics.deferred_students }}</li>
                        <li><strong>Graduated:</strong> {{ registrar_analytics.graduated_students }}</li>
                    </ul>
                </div>
                <div>
                    <h4>Current Semester</h4>
                    <ul class="info-list">
                        <li><strong>Enrollments:</strong> {{ registrar_analytics.enrollments_this_semester }}</li>
                        <li><strong>New Students:</strong> {{ registrar_analytics.new_students_this_month }}</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Accountant Analytics Tab -->
<div class="tab-content" id="accountant-tab">
    <div class="stats-grid">
        <div class="stat-card stat-primary">
            <div class="stat-icon">
                <i class="fas fa-calculator"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">KES {{ accountant_analytics.total_expected|floatformat:0 }}</div>
                <div class="stat-label">Total Expected</div>
            </div>
        </div>

        <div class="stat-card stat-success">
            <div class="stat-icon">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">KES {{ accountant_analytics.total_paid|floatformat:0 }}</div>
                <div class="stat-label">Total Paid</div>
            </div>
        </div>

        <div class="stat-card stat-danger">
            <div class="stat-icon">
                <i class="fas fa-balance-scale"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">KES {{ accountant_analytics.total_outstanding|floatformat:0 }}</div>
                <div class="stat-label">Outstanding</div>
            </div>
        </div>

        <div class="stat-card stat-info">
            <div class="stat-icon">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ accountant_analytics.collection_rate|floatformat:1 }}%</div>
                <div class="stat-label">Collection Rate</div>
            </div>
        </div>

        <div class="stat-card stat-secondary">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ accountant_analytics.active_students }}</div>
                <div class="stat-label">Active Students</div>
            </div>
        </div>

        <div class="stat-card stat-warning">
            <div class="stat-icon">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">KES {{ accountant_analytics.payments_this_month|floatformat:0 }}</div>
                <div class="stat-label">This Month</div>
            </div>
        </div>
    </div>

    <div class="content-card" style="margin-top: 24px;">
        <div class="card-header">
            <h3 class="card-title"><i class="fas fa-chart-pie"></i> Financial Overview</h3>
        </div>
        <div class="card-body">
            <div class="progress-section">
                <div class="progress-info">
                    <div class="progress-label">
                        <span>Fee Collection Progress</span>
                        <span class="progress-percentage">{{ accountant_analytics.collection_rate|floatformat:1 }}%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: {{ accountant_analytics.collection_rate }}%">
                            <span class="progress-text">KES {{ accountant_analytics.total_paid|floatformat:2 }} / KES {{ accountant_analytics.total_expected|floatformat:2 }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="dashboard-grid" style="margin-top: 24px;">
                <div>
                    <h4>Payment Statistics</h4>
                    <ul class="info-list">
                        <li><strong>Total Payments:</strong> {{ accountant_analytics.total_payments_count }}</li>
                        <li><strong>This Month:</strong> KES {{ accountant_analytics.payments_this_month|floatformat:2 }}</li>
                        <li><strong>Outstanding:</strong> KES {{ accountant_analytics.total_outstanding|floatformat:2 }}</li>
                    </ul>
                </div>
                <div>
                    <h4>Student Financial Status</h4>
                    <ul class="info-list">
                        <li><strong>Active Students:</strong> {{ accountant_analytics.active_students }}</li>
                        <li><strong>Collection Rate:</strong> {{ accountant_analytics.collection_rate|floatformat:1 }}%</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Branch Colleges Tab -->
<div class="tab-content" id="branches-tab">
    <div class="content-card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title"><i class="fas fa-building"></i> Branch Colleges</h3>
            <button class="btn btn-primary" onclick="openCreateBranchModal()">
                <i class="fas fa-plus"></i> Create Branch
            </button>
        </div>
        <div class="card-body">
            {% if branch_colleges %}
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Status</th>
                                <th>Students</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for branch in branch_colleges %}
                            <tr>
                                <td>{{ branch.name }}</td>
                                <td>{{ branch.email }}</td>
                                <td>{{ branch.phone }}</td>
                                <td>
                                    <span class="badge badge-{% if branch.registration_status == 'active' %}success{% elif branch.registration_status == 'pending' %}warning{% else %}danger{% endif %}">
                                        {{ branch.get_registration_status_display }}
                                    </span>
                                </td>
                                <td>{{ branch.students.count }}</td>
                                <td>
                                    <a href="{% url 'college_landing' college_slug=branch.get_slug %}" class="btn btn-sm btn-info">
                                        <i class="fas fa-eye"></i> View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-building" style="font-size: 48px; color: var(--text-muted); margin-bottom: 16px;"></i>
                    <p>No branch colleges created yet.</p>
                    <button class="btn btn-primary" onclick="openCreateBranchModal()">
                        <i class="fas fa-plus"></i> Create First Branch
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- User Management Tab -->
<div class="tab-content" id="users-tab">
    <div class="content-card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title"><i class="fas fa-users-cog"></i> User Management</h3>
            <button class="btn btn-primary" onclick="openCreateUserModal()">
                <i class="fas fa-user-plus"></i> Create User
            </button>
        </div>
        <div class="card-body">
            <div class="dashboard-grid">
                <div class="content-card">
                    <h4><i class="fas fa-user-graduate"></i> Principals ({{ principals|length }})</h4>
                    {% if principals %}
                        <ul class="user-list">
                            {% for principal in principals %}
                            <li class="user-card clickable" data-user-id="{{ principal.id }}" onclick="openEditUserModal({{ principal.id }})">
                                <div class="user-card-content">
                                    <strong>{{ principal.get_full_name|default:principal.username }}</strong>
                                    <span class="badge badge-primary">{{ principal.get_role_display }}</span>
                                    <small>{{ principal.college.name }}</small>
                                </div>
                                <i class="fas fa-chevron-right user-card-arrow"></i>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">No principals created yet.</p>
                    {% endif %}
                </div>

                <div class="content-card">
                    <h4><i class="fas fa-clipboard-list"></i> Registrars ({{ registrars|length }})</h4>
                    {% if registrars %}
                        <ul class="user-list">
                            {% for registrar in registrars %}
                            <li class="user-card clickable" data-user-id="{{ registrar.id }}" onclick="openEditUserModal({{ registrar.id }})">
                                <div class="user-card-content">
                                    <strong>{{ registrar.get_full_name|default:registrar.username }}</strong>
                                    <span class="badge badge-info">{{ registrar.get_role_display }}</span>
                                    <small>{{ registrar.college.name }}</small>
                                </div>
                                <i class="fas fa-chevron-right user-card-arrow"></i>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">No registrars created yet.</p>
                    {% endif %}
                </div>

                <div class="content-card">
                    <h4><i class="fas fa-calculator"></i> Accountants ({{ accountants|length }})</h4>
                    {% if accountants %}
                        <ul class="user-list">
                            {% for accountant in accountants %}
                            <li class="user-card clickable" data-user-id="{{ accountant.id }}" onclick="openEditUserModal({{ accountant.id }})">
                                <div class="user-card-content">
                                    <strong>{{ accountant.get_full_name|default:accountant.username }}</strong>
                                    <span class="badge badge-success">{{ accountant.get_role_display }}</span>
                                    <small>{{ accountant.college.name }}</small>
                                </div>
                                <i class="fas fa-chevron-right user-card-arrow"></i>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">No accountants created yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Branch Modal -->
<div id="create-branch-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-building"></i> Create Branch College</h3>
            <button class="modal-close" type="button" onclick="event.preventDefault(); event.stopPropagation(); closeModal('create-branch-modal');">&times;</button>
        </div>
        <form id="create-branch-form" method="post" action="{% url 'director_dashboard' %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_branch">
            <div class="modal-body">
                <div class="form-group">
                    <label>College Name *</label>
                    <input type="text" name="name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Phone *</label>
                    <input type="text" name="phone" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Address *</label>
                    <textarea name="address" class="form-input" required></textarea>
                </div>
                <div class="form-group">
                    <label>County *</label>
                    <input type="text" name="county" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Principal Name *</label>
                    <input type="text" name="principal_name" class="form-input" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="event.preventDefault(); event.stopPropagation(); closeModal('create-branch-modal');">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Branch</button>
            </div>
        </form>
    </div>
</div>

<!-- Create User Modal -->
<div id="create-user-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Create User</h3>
            <button class="modal-close" type="button" onclick="event.preventDefault(); event.stopPropagation(); closeModal('create-user-modal');">&times;</button>
        </div>
        <form id="create-user-form" method="post" action="{% url 'director_dashboard' %}">
            {% csrf_token %}
            <input type="hidden" name="action" value="create_user">
            <div class="modal-body">
                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" name="username" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" name="first_name" class="form-input">
                </div>
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" name="last_name" class="form-input">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" name="phone" class="form-input">
                </div>
                <div class="form-group">
                    <label>Role *</label>
                    <select name="role" class="form-input" required>
                        <option value="">-- Select Role --</option>
                        <option value="principal">Principal</option>
                        <option value="registrar">Registrar</option>
                        <option value="accounts_officer">Accountant</option>
                    </select>
                    <small class="form-text">Director can create: Principal, Registrar, or Accountant</small>
                </div>
                <div class="form-group">
                    <label>College</label>
                    <select name="college_id" class="form-input">
                        <option value="{{ college.id }}">{{ college.name }}</option>
                        {% for branch in branch_colleges %}
                        <option value="{{ branch.id }}">{{ branch.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Password *</label>
                    <input type="password" name="password" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Confirm Password *</label>
                    <input type="password" name="password_confirm" class="form-input" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="event.preventDefault(); event.stopPropagation(); closeModal('create-user-modal');">Cancel</button>
                <button type="submit" class="btn btn-primary">Create User</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit User Modal -->
<div id="edit-user-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-edit"></i> Edit User Details</h3>
            <button class="modal-close" type="button" onclick="event.preventDefault(); event.stopPropagation(); closeModal('edit-user-modal');">&times;</button>
        </div>
        <form id="edit-user-form" method="post">
            {% csrf_token %}
            <input type="hidden" id="edit-user-id" name="user_id">
            <div class="modal-body">
                <div id="edit-user-loading" class="loading-state" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Loading user details...
                </div>
                <div id="edit-user-content">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="edit-username" class="form-input" disabled>
                        <small class="form-text">Username cannot be changed</small>
                    </div>
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" id="edit-first-name" name="first_name" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" id="edit-last-name" name="last_name" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="edit-email" name="email" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" id="edit-phone" name="phone" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Role *</label>
                        <select id="edit-role" name="role" class="form-input" required>
                            <option value="principal">Principal</option>
                            <option value="registrar">Registrar</option>
                            <option value="accounts_officer">Accountant</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Institution</label>
                        <select id="edit-college" name="college_id" class="form-input">
                            <option value="{{ college.id }}">{{ college.name }}</option>
                            {% for branch in branch_colleges %}
                            <option value="{{ branch.id }}">{{ branch.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="edit-is-active" name="is_active" checked>
                            <span>Account is Active</span>
                        </label>
                        <small class="form-text">Uncheck to disable this account</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="event.preventDefault(); event.stopPropagation(); closeModal('edit-user-modal');">Cancel</button>
                <button type="submit" class="btn btn-primary" id="edit-user-submit">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.tab-navigation {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 8px;
}

.tab-btn {
    padding: 12px 24px;
    background: var(--bg-card);
    border: none;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-light);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.tab-btn:hover {
    background: var(--light-color);
    color: var(--primary-color);
}

.tab-btn.active {
    background: var(--primary-color);
    color: white;
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.info-list {
    list-style: none;
    padding: 0;
}

.info-list li {
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color);
}

.info-list li:last-child {
    border-bottom: none;
}

.user-list {
    list-style: none;
    padding: 0;
}

.user-list li {
    padding: 12px;
    background: var(--bg-card);
    border-radius: 8px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}

.user-card {
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
}

.user-card:hover {
    background: var(--light-color) !important;
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.user-card-content {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
}

.user-card-arrow {
    color: var(--text-muted);
    transition: all 0.2s ease;
    margin-left: auto;
}

.user-card:hover .user-card-arrow {
    color: var(--primary-color);
    transform: translateX(4px);
}

.loading-state {
    text-align: center;
    padding: 24px;
    color: var(--text-secondary);
}

.loading-state i {
    font-size: 24px;
    margin-bottom: 12px;
    display: block;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-weight: normal;
}

.checkbox-label input[type="checkbox"] {
    width: auto;
    margin: 0;
    cursor: pointer;
}

.empty-state {
    text-align: center;
    padding: 48px 24px;
    color: var(--text-muted);
}
</style>

<script>
// Base URL for edit user endpoint - construct from pattern
const EDIT_USER_BASE_URL = '/director/users/';

// Campus switching functionality
function switchCampus(campusId) {
    if (campusId) {
        const url = new URL(window.location);
        url.searchParams.set('campus_id', campusId);
        window.location.href = url.toString();
    }
}

// Tab switching functionality
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const tabName = this.getAttribute('data-tab');
        
        // Remove active class from all tabs and buttons
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked button and corresponding content
        this.classList.add('active');
        document.getElementById(tabName + '-tab').classList.add('active');
    });
});

function openCreateBranchModal() {
    document.getElementById('create-branch-modal').style.display = 'block';
}

function openCreateUserModal() {
    document.getElementById('create-user-modal').style.display = 'block';
}

function openEditUserModal(userId) {
    const modal = document.getElementById('edit-user-modal');
    const loadingDiv = document.getElementById('edit-user-loading');
    const contentDiv = document.getElementById('edit-user-content');
    const form = document.getElementById('edit-user-form');
    
    // Show modal and loading state
    modal.style.display = 'block';
    loadingDiv.style.display = 'block';
    contentDiv.style.display = 'none';
    
    // Construct URL
    const editUrl = EDIT_USER_BASE_URL + userId + '/edit/';
    
    // Fetch user data
    fetch(editUrl, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const user = data.user;
            
            // Populate form fields
            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-username').value = user.username || '';
            document.getElementById('edit-first-name').value = user.first_name || '';
            document.getElementById('edit-last-name').value = user.last_name || '';
            document.getElementById('edit-email').value = user.email || '';
            document.getElementById('edit-phone').value = user.phone || '';
            document.getElementById('edit-role').value = user.role;
            document.getElementById('edit-college').value = user.college_id || '';
            document.getElementById('edit-is-active').checked = user.is_active;
            
            // Update college dropdown if needed
            const collegeSelect = document.getElementById('edit-college');
            if (data.colleges) {
                collegeSelect.innerHTML = '';
                data.colleges.forEach(college => {
                    const option = document.createElement('option');
                    option.value = college.id;
                    option.textContent = college.name;
                    if (college.id === user.college_id) {
                        option.selected = true;
                    }
                    collegeSelect.appendChild(option);
                });
            }
            
            // Hide loading, show content
            loadingDiv.style.display = 'none';
            contentDiv.style.display = 'block';
        } else {
            alert('Error loading user details: ' + (data.message || 'Unknown error'));
            closeModal('edit-user-modal');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error loading user details. Please try again.');
        closeModal('edit-user-modal');
    });
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        // Reset form if it exists
        const form = modal.querySelector('form');
        if (form) {
            form.reset();
        }
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}

// Handle edit user form submission
document.addEventListener('DOMContentLoaded', function() {
    const editUserForm = document.getElementById('edit-user-form');
    if (editUserForm) {
        editUserForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('edit-user-submit');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            const userId = document.getElementById('edit-user-id').value;
            const formData = new FormData(editUserForm);
            
            // Construct URL
            const editUrl = EDIT_USER_BASE_URL + userId + '/edit/';
            
            fetch(editUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    alert('User updated successfully!');
                    // Close modal
                    closeModal('edit-user-modal');
                    // Reload page to refresh user list
                    window.location.reload();
                } else {
                    alert('Error updating user: ' + (data.message || 'Unknown error'));
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating user. Please try again.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });
    }
});
</script>

<!-- Suspended College Modal -->
{% if college_is_suspended %}
{% include 'education/suspended_modal.html' %}
{% endif %}
{% endblock %}

