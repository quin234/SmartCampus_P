{% extends 'superadmin/base.html' %}
{% load static %}

{% block title %}Analytics - Super Admin{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">System Analytics</h1>
    <p class="page-subtitle">Comprehensive system-wide analytics and insights</p>
</div>

<!-- Overview Cards -->
<div class="analytics-grid">
    <div class="analytics-card">
        <div class="card-icon total-colleges">
            <i class="fas fa-school"></i>
        </div>
        <div class="card-info">
            <h3 class="card-label">Total Colleges</h3>
            <p class="card-value" id="analytics-total-colleges">0</p>
            <span class="card-change positive">
                <i class="fas fa-building"></i> System-wide
            </span>
        </div>
    </div>

    <div class="analytics-card">
        <div class="card-icon total-students">
            <i class="fas fa-user-graduate"></i>
        </div>
        <div class="card-info">
            <h3 class="card-label">Total Students</h3>
            <p class="card-value" id="analytics-total-students">0</p>
            <span class="card-change positive">
                <i class="fas fa-users"></i> Across all colleges
            </span>
        </div>
    </div>

    <div class="analytics-card">
        <div class="card-icon total-lecturers">
            <i class="fas fa-chalkboard-teacher"></i>
        </div>
        <div class="card-info">
            <h3 class="card-label">Total Lecturers</h3>
            <p class="card-value" id="analytics-total-lecturers">0</p>
            <span class="card-change neutral">
                <i class="fas fa-users"></i> System-wide
            </span>
        </div>
    </div>

    <div class="analytics-card">
        <div class="card-icon total-courses">
            <i class="fas fa-book"></i>
        </div>
        <div class="card-info">
            <h3 class="card-label">Total Courses</h3>
            <p class="card-value" id="analytics-total-courses">0</p>
            <span class="card-change neutral">
                <i class="fas fa-book"></i> All colleges
            </span>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="charts-grid">
    <div class="chart-card">
        <div class="card-header">
            <h3 class="card-title">Colleges Growth Over Time</h3>
        </div>
        <div class="card-body">
            <canvas id="colleges-growth-chart"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <div class="card-header">
            <h3 class="card-title">Student Distribution by College</h3>
        </div>
        <div class="card-body">
            <canvas id="student-distribution-chart"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <div class="card-header">
            <h3 class="card-title">College Status Distribution</h3>
        </div>
        <div class="card-body">
            <canvas id="status-distribution-chart"></canvas>
        </div>
    </div>

    <div class="chart-card">
        <div class="card-header">
            <h3 class="card-title">Lecturers per College</h3>
        </div>
        <div class="card-body">
            <canvas id="lecturers-by-college-chart"></canvas>
        </div>
    </div>
</div>

<!-- Data Tables -->
<div class="content-card">
    <div class="card-header">
        <h3 class="card-title">Top Colleges by Student Count</h3>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>College Name</th>
                        <th>Students</th>
                        <th>Lecturers</th>
                        <th>Courses</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="top-colleges-tbody">
                    <tr>
                        <td colspan="7" class="loading-row">
                            <i class="fas fa-spinner fa-spin"></i> Loading...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="content-card">
    <div class="card-header">
        <h3 class="card-title">Recent Registrations</h3>
    </div>
    <div class="card-body">
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>School Name</th>
                        <th>Type</th>
                        <th>Owner/Principal</th>
                        <th>Email</th>
                        <th>Date Registered</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="recent-registrations-tbody">
                    <tr>
                        <td colspan="7" class="loading-row">
                            <i class="fas fa-spinner fa-spin"></i> Loading...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Analytics page initialization
    document.addEventListener('DOMContentLoaded', function() {
        loadAnalyticsData();
    });

    async function loadAnalyticsData() {
        try {
            const data = await apiCall('/analytics');
            if (data) {
                updateOverviewCards(data.overview);
                renderCharts(data);
                populateTopColleges(data.top_colleges);
                populateRecentRegistrations(data.recent_registrations);
            }
        } catch (error) {
            console.error('Error loading analytics:', error);
        }
    }

    function updateOverviewCards(overview) {
        document.getElementById('analytics-total-colleges').textContent = overview.total_colleges || 0;
        document.getElementById('analytics-total-students').textContent = overview.total_students || 0;
        document.getElementById('analytics-total-lecturers').textContent = overview.total_lecturers || 0;
        document.getElementById('analytics-total-courses').textContent = overview.total_courses || 0;
    }

    function renderCharts(data) {
        // Colleges Growth Chart
        const collegesGrowthCtx = document.getElementById('colleges-growth-chart');
        if (collegesGrowthCtx) {
            new Chart(collegesGrowthCtx, {
                type: 'line',
                data: {
                    labels: data.growth_trends.colleges.map(item => item.month),
                    datasets: [{
                        label: 'Colleges',
                        data: data.growth_trends.colleges.map(item => item.count),
                        borderColor: '#1e40af',
                        backgroundColor: 'rgba(30, 64, 175, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Student Distribution Chart
        const studentDistCtx = document.getElementById('student-distribution-chart');
        if (studentDistCtx) {
            new Chart(studentDistCtx, {
                type: 'bar',
                data: {
                    labels: data.distributions.students_by_college.map(item => item.college),
                    datasets: [{
                        label: 'Students',
                        data: data.distributions.students_by_college.map(item => item.students),
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Status Distribution Chart
        const statusDistCtx = document.getElementById('status-distribution-chart');
        if (statusDistCtx) {
            new Chart(statusDistCtx, {
                type: 'pie',
                data: {
                    labels: ['Active', 'Pending', 'Inactive'],
                    datasets: [{
                        data: [
                            data.status_breakdown.active,
                            data.status_breakdown.pending,
                            data.status_breakdown.inactive
                        ],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Lecturers by College Chart
        const lecturersCtx = document.getElementById('lecturers-by-college-chart');
        if (lecturersCtx) {
            new Chart(lecturersCtx, {
                type: 'bar',
                data: {
                    labels: data.distributions.lecturers_by_college.map(item => item.college),
                    datasets: [{
                        label: 'Lecturers',
                        data: data.distributions.lecturers_by_college.map(item => item.lecturers),
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    }

    function populateTopColleges(colleges) {
        const tbody = document.getElementById('top-colleges-tbody');
        if (!tbody) return;

        if (colleges && colleges.length > 0) {
            tbody.innerHTML = colleges.map((college, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${college.name}</td>
                    <td>${college.students_count}</td>
                    <td>${college.lecturers_count}</td>
                    <td>${college.courses_count}</td>
                    <td><span class="badge badge-${college.status}">${college.status}</span></td>
                    <td>
                        <button class="btn-icon btn-info" onclick="viewCollege(${college.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No colleges found</td></tr>';
        }
    }

    function populateRecentRegistrations(registrations) {
        const tbody = document.getElementById('recent-registrations-tbody');
        if (!tbody) return;

        if (registrations && registrations.length > 0) {
            tbody.innerHTML = registrations.map(reg => `
                <tr>
                    <td>${reg.school_name}</td>
                    <td>${reg.school_type}</td>
                    <td>${reg.owner_name}</td>
                    <td>${reg.email}</td>
                    <td>${reg.date}</td>
                    <td><span class="badge badge-${reg.status}">${reg.status}</span></td>
                    <td>
                        <button class="btn-icon btn-info" onclick="viewRegistration(${reg.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No registrations found</td></tr>';
        }
    }

    function viewCollege(collegeId) {
        window.location.href = `/superadmin/colleges/?id=${collegeId}`;
    }

    function viewRegistration(regId) {
        // Handle registration view
        console.log('View registration:', regId);
    }
</script>
{% endblock %}
