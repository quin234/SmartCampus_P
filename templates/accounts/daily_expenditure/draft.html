{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Daily Expenditure Draft - SmartCampus{% endblock %}
{% block icon %}receipt{% endblock %}
{% block page_title %}Daily Expenditure Draft{% endblock %}
{% block page_subtitle %}Create and manage daily expenditure entries (Draft Mode){% endblock %}

{% block header_actions %}
<div style="display: flex; gap: 12px; align-items: center;">
    <div style="background: var(--light-color); padding: 8px 16px; border-radius: 6px; font-weight: 600; color: var(--primary-color);">
        <i class="fas fa-calendar-day"></i> {{ today|date:"F d, Y" }}
    </div>
    <div style="background: var(--success-color); color: white; padding: 8px 16px; border-radius: 6px; font-weight: 600;">
        <i class="fas fa-coins"></i> Total: KES {{ draft_total|floatformat:2 }}
    </div>
    {% if today_drafts %}
    <button type="button" class="btn btn-primary" id="submit-btn" style="display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-paper-plane"></i> Submit All
    </button>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="content-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
    <!-- Form Section -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-{% if expenditure %}edit{% else %}plus-circle{% endif %}"></i>
                {% if expenditure %}Edit Entry{% else %}Add New Entry{% endif %}
            </h3>
        </div>
        <div class="card-body">
            <form method="post" id="expenditure-form">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="{{ form.description.id_for_label }}">
                        <i class="fas fa-align-left"></i> Expense Description <span class="text-danger">*</span>
                    </label>
                    {{ form.description }}
                    {% if form.description.errors %}
                        <div class="error-message">{{ form.description.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.amount.id_for_label }}">
                        <i class="fas fa-money-bill-wave"></i> Amount (KES) <span class="text-danger">*</span>
                    </label>
                    {{ form.amount }}
                    {% if form.amount.errors %}
                        <div class="error-message">{{ form.amount.errors }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group" style="background: var(--light-color); padding: 12px; border-radius: 6px; margin-top: 16px;">
                    <small style="color: var(--text-light);">
                        <i class="fas fa-info-circle"></i> 
                        Date & Time: <strong>{{ today|date:"F d, Y" }} - {{ "now"|date:"H:i" }}</strong> (Auto-set, not editable)
                    </small>
                </div>
                
                <div class="form-actions" style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Entry
                    </button>
                    {% if expenditure %}
                    <a href="{% url 'accounts:daily_expenditure_draft' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
    
    <!-- Draft Entries List -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-list"></i> Today's Draft Entries
                <span class="badge" style="background: var(--warning-color); color: white; margin-left: 8px;">
                    {{ today_drafts|length }}
                </span>
            </h3>
        </div>
        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
            {% if today_drafts %}
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for draft in today_drafts %}
                        <tr>
                            <td>{{ draft.description|truncatewords:10 }}</td>
                            <td><strong>KES {{ draft.amount|floatformat:2 }}</strong></td>
                            <td>{{ draft.created_at|date:"H:i" }}</td>
                            <td>
                                <div style="display: flex; gap: 8px;">
                                    <a href="{% url 'accounts:daily_expenditure_edit' pk=draft.pk %}" class="btn btn-sm btn-primary" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-sm btn-danger delete-entry" data-id="{{ draft.pk }}" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr style="background: var(--light-color); font-weight: 600;">
                            <td colspan="2">Total:</td>
                            <td colspan="2"><strong>KES {{ draft_total|floatformat:2 }}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div style="text-align: center; padding: 40px; color: var(--text-light);">
                <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                <p>No draft entries for today. Add your first entry using the form on the left.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Submit Confirmation Modal -->
<div id="submit-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-paper-plane"></i> Submit Daily Expenditure</h3>
            <button type="button" class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to submit all <strong>{{ today_drafts|length }}</strong> draft entr{{ today_drafts|length|pluralize:"y,ies" }}?</p>
            <p style="color: var(--text-light); margin-top: 12px;">
                <i class="fas fa-exclamation-triangle"></i> 
                Once submitted, entries cannot be edited.
            </p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="button" class="btn btn-primary" id="confirm-submit-btn">
                <i class="fas fa-check"></i> Yes, Submit
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Submit button handler
    const submitBtn = document.getElementById('submit-btn');
    const confirmSubmitBtn = document.getElementById('confirm-submit-btn');
    const submitModal = document.getElementById('submit-modal');
    
    if (submitBtn) {
        submitBtn.addEventListener('click', function() {
            submitModal.style.display = 'block';
        });
    }
    
    function closeModal() {
        submitModal.style.display = 'none';
    }
    
    // Close modal on outside click
    window.onclick = function(event) {
        if (event.target == submitModal) {
            closeModal();
        }
    }
    
    // Confirm submit
    if (confirmSubmitBtn) {
        confirmSubmitBtn.addEventListener('click', function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            
            fetch('{% url "accounts:submit_daily_expenditure" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to submit'));
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-check"></i> Yes, Submit';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while submitting.');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check"></i> Yes, Submit';
            });
        });
    }
    
    // Delete entry handler
    document.querySelectorAll('.delete-entry').forEach(btn => {
        btn.addEventListener('click', function() {
            const entryId = this.getAttribute('data-id');
            if (confirm('Are you sure you want to delete this entry?')) {
                // Create a form to delete
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '{% url "accounts:daily_expenditure_draft" %}';
                
                const csrf = document.createElement('input');
                csrf.type = 'hidden';
                csrf.name = 'csrfmiddlewaretoken';
                csrf.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
                form.appendChild(csrf);
                
                const deleteInput = document.createElement('input');
                deleteInput.type = 'hidden';
                deleteInput.name = 'delete_id';
                deleteInput.value = entryId;
                form.appendChild(deleteInput);
                
                document.body.appendChild(form);
                form.submit();
            }
        });
    });
    
    // Auto-update total when amount changes
    const amountInput = document.getElementById('{{ form.amount.id_for_label }}');
    if (amountInput) {
        amountInput.addEventListener('input', function() {
            // Could add real-time total update here if needed
        });
    }
});
</script>

<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: var(--bg-card);
    margin: 10% auto;
    padding: 0;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-light);
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

@media (max-width: 768px) {
    .content-grid {
        grid-template-columns: 1fr !important;
    }
}
</style>
{% endblock %}

